

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Steps to define a task on Bio-Data Processor &mdash; Bio-Data Processor  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Bio-Data Processor
          

          
            
            <img src="../_static/bdp-logo-dark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.8.beta
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Concept</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial-full-step-pipelines.html">Full steps to construct a pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial-task-deploy-GCP.html">Task deployment on Google Cloud Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/mongodb-non-root-installation.html">Non-root MongoDB Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial-full-step-pipelines.html">Full steps to construct a pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial-task-deploy-GCP.html">Task deployment on Google Cloud Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/mongodb-non-root-installation.html">Non-root MongoDB Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">System Administrations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../administration/allow-google-sign-in.html">Enable Google 3rd party sign-in</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bio-Data Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Steps to define a task on Bio-Data Processor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/pipieline-development/task-definition.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="steps-to-define-a-task-on-bio-data-processor">
<h1>Steps to define a task on Bio-Data Processor<a class="headerlink" href="#steps-to-define-a-task-on-bio-data-processor" title="Permalink to this headline">¶</a></h1>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<div class="line-block">
<div class="line"><strong>Targeted readers</strong>: pipeline developers.</div>
<div class="line"><strong>Prerequisites</strong>: programs/scripts were already containerized inside Docker container(s).</div>
</div>
</div>
<p>Bio-Data Processor considers a task as strings of commands and nothing more. Each command contains 1) the executable binary path, 2) the scripts, and 3) arguments that are separated by spaces.</p>
<ol class="arabic simple">
<li><p>The web platform passes the arguments to a task adapter (the 1st argument passing).</p></li>
<li><p>The task adapter then organized the arguments and then forms executable command(s) to run container(s) to execute the desired programs/scripts (the 2nd argument passing).</p></li>
<li><p>If the task requires a batch execution, the task adapter will automatically create multiple commands based on user specifications. Sequential or parallel executions of these commands are determined based on the end-user environments instead of developers settings.</p></li>
</ol>
<div class="section" id="step-1-create-a-task-on-the-bio-data-processor-web-platform">
<h2>Step 1. Create a task on the Bio-Data Processor web platform<a class="headerlink" href="#step-1-create-a-task-on-the-bio-data-processor-web-platform" title="Permalink to this headline">¶</a></h2>
<p>In this step, you will use a graphical user interface to define a task on the web platform.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Setting the task on the web platform.</p>
</div>
</div>
<div class="section" id="step-2-task-definitions-for-the-task-adapter">
<h2>Step 2. Task definitions for the task adapter.<a class="headerlink" href="#step-2-task-definitions-for-the-task-adapter" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-basic-settings-for-a-task-template">
<h3>2.1. The basic settings for a task template<a class="headerlink" href="#the-basic-settings-for-a-task-template" title="Permalink to this headline">¶</a></h3>
<p>You can define tasks by simply writing task template in the YAML format to define tasks in JavaScripts. Again, to simplify the configurations, the above mentioned 3 things are mainly required. A task is simply defined by filling the fields of <strong>task name</strong>, <strong>dockerImage</strong>, <strong>exec</strong>, <strong>args</strong>, and <strong>option</strong> as the following basic example.</p>
<p>Say we want to calculate the PI to the <cite>2000</cite> digits after the decimal point. We could execute the following perl command using the perl Docker container:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>perl -Mbigum<span class="o">=</span>bpi -wle print <span class="s1">&#39;bpi(2000)&#39;</span>
</pre></div>
</div>
<p>We can write a task template for that command:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="c1"># file path: ./tasks/calculate-pi.yaml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">task-template</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pi</span>
    <span class="nt">dockerImage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">perl</span>
    <span class="nt">exec</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">perl</span>
    <span class="nt">args</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;-Mbignum=bpi&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;-wle&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;&#39;print</span><span class="nv"> </span><span class="s">bpi(2000)&#39;&quot;</span>
    <span class="nt">option</span><span class="p">:</span>
    <span class="nt">setUser</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>Then, we have to declare this task template file in the <cite>task-index.yaml</cite>. which may be looked like this:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="c1"># file path: ./task-index.yaml</span>
<span class="nt">tasks</span><span class="p">:</span>
<span class="nt">calculate-pi</span><span class="p">:</span> <span class="s">&#39;./tasks/calculate-pi.yaml&#39;</span>
</pre></div>
</div>
<p>We put the <strong>task name</strong> <code class="docutils literal notranslate"><span class="pre">calculate-pi</span></code> and its task path that is relative to the path of <code class="docutils literal notranslate"><span class="pre">task-index.yaml</span></code>.
The <code class="docutils literal notranslate"><span class="pre">task-index.yaml</span></code> will be automatically parsed by our task reader in <code class="docutils literal notranslate"><span class="pre">task-portal.js</span></code>. Based on the given <strong>task name</strong>, we will know where to find the task template file.</p>
<p>The above example is a non-configurable (no arguments allowed) job which uses <code class="docutils literal notranslate"><span class="pre">perl</span></code> to calculate pi to the given 2000 accuracy (the number of digits after the decimal point).</p>
<p>To make this example configurable, meaning to allow configuring the accuracy of pi, we can rewrite the above example as:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="c1"># file path: ./tasks/calculate-pi.yaml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">task-template</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pi</span>
    <span class="nt">dockerImage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">perl</span>
    <span class="nt">exec</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">perl</span>
    <span class="nt">args</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;-Mbignum=bpi&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;-wle&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;&#39;print</span><span class="nv"> </span><span class="s">bpi({{</span><span class="nv"> </span><span class="s">argv[0]</span><span class="nv"> </span><span class="s">}})&#39;&quot;</span> <span class="c1"># Change the 2000 to {{argv[0]}}</span>
    <span class="nt">option</span><span class="p">:</span>
    <span class="nt">setUser</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>You see that we changed the <code class="docutils literal notranslate"><span class="pre">bpi(2000)</span></code> to <code class="docutils literal notranslate"><span class="pre">bpi({{argv[0]}})</span></code>. The <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">...</span> <span class="pre">}}</span></code> will be recognized by the template engine, Nunjucks. With this template engine, your template can be resolved with some data, e.g. task arguments, environment variables, etc. Hence, the <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">argv[0]</span> <span class="pre">}}</span></code> will be replaced with the value of the first argumen of your task on Bio-Data Processor.</p>
<div class="section" id="what-is-the-argv">
<h4>What is the <cite>argv</cite>?<a class="headerlink" href="#what-is-the-argv" title="Permalink to this headline">¶</a></h4>
<p>Under the hood, Bio-Data Processor will execute a command line like this:
.. code-block:: shell</p>
<blockquote>
<div><dl class="simple">
<dt>node task-portal.js calculate-pi 3000</dt><dd><p>^^^^^^^^^^^^ ^^^^
taskName     argv[0] is the first argument</p>
</dd>
</dl>
</div></blockquote>
<p>The <strong>task name</strong> is <code class="docutils literal notranslate"><span class="pre">calculate-pi</span></code>, and the <code class="docutils literal notranslate"><span class="pre">3000</span></code> is the first argument. The argument index starts with 0, so the first argument is <code class="docutils literal notranslate"><span class="pre">argv[0]</span></code>. Then thetemplate engine will replace the <code class="docutils literal notranslate"><span class="pre">{{argv[0]}}</span></code> with <cite>3000</cite>, so the core job command is
.. code-block:: shell</p>
<blockquote>
<div><p>perl -Mbignum=bpi -wle ‘print bpi(3000)’</p>
</div></blockquote>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Depending on the selected adapter, the adapter will help you to form the corresponding command. For example, a Docker adapter will form this command that stats with <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">...</span></code> and do all the volume mappings for you. A PBS adapter will form the command with <code class="docutils literal notranslate"><span class="pre">qsub</span> <span class="pre">...</span></code>. The actual run-time environment should not be defined by developers. Let the task adapters do the favor!</p>
</div>
<p>The following lists the two situations to define tasks that were <strong>pre-containerized by 3rd party</strong> or containerized <strong>inside a BDP package container</strong>.</p>
</div>
</div>
<div class="section" id="the-program-was-containerized-by-3rd-party-e-g-biocontainers">
<h3>2.2. The program was containerized by 3rd-party (e.g. biocontainers)<a class="headerlink" href="#the-program-was-containerized-by-3rd-party-e-g-biocontainers" title="Permalink to this headline">¶</a></h3>
<p>We use the MS-GF+ as our example. This MS-GF+ program has a pre-containerized Docker image. See <a class="reference external" href="https://omics.pnl.gov/software/ms-gf">here</a> for the usage of this program. A task template may be looked like:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">task-template</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;run-msgf-plus&#39;</span>
    <span class="nt">dockerImage</span><span class="p">:</span> <span class="s">&quot;quay.io/biocontainers/msgf_plus:2017.07.21--py36_0&quot;</span>
    <span class="nt">exec</span><span class="p">:</span> <span class="s">&#39;msgf_plus&#39;</span>
    <span class="nt">args</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">option.mem</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">prefix(&#39;-Xmx&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># setting memory</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-s&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[0]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># argv[9] the input file</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-d&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[1]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># argv[1] The database file path</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-o&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[8]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># argv[8]: The output file path</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-mod&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[2]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># argv[2] modification file</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-t&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{argv[3]}}&quot;</span> <span class="c1"># argv[3]: precursorMassTolerance</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-inst&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{argv[4]}}&quot;</span> <span class="c1"># argv[4]: MS2DetectorID</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-m&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{argv[5]}}&quot;</span> <span class="c1"># argv[5]: fragmentation</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-ntt&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{argv[6]}}&quot;</span> <span class="c1"># argv[6]: ntt (number of tolerable termini)</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-tda&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{argv[7]}}&quot;</span>  <span class="c1"># argv[7]: [-tda 0/1] (0: don&#39;t search decoy database (Default), 1: search decoy database)</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-thread&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">option.cpus</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">option</span><span class="p">:</span>
    <span class="nt">setUser</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>The above template demonstrates the MS-GF+ program that is pre-containerized in the <code class="docutils literal notranslate"><span class="pre">quay.io/biocontainers/msgf_plus:2017.07.21--py36_0</span></code> image. By specifying the <code class="docutils literal notranslate"><span class="pre">dockerImage</span></code> field, you can run other containerized program.</p>
<div class="section" id="what-does-the-pipe-mean">
<h4>What does the pipe (|) mean?<a class="headerlink" href="#what-does-the-pipe-mean" title="Permalink to this headline">¶</a></h4>
<p>You may notice that we use <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">argv[0]</span> <span class="pre">|</span> <span class="pre">pathMapping</span> <span class="pre">}}</span></code> for the input file path. In fact, we use <code class="docutils literal notranslate"><span class="pre">|</span> <span class="pre">pathMapping</span></code> to transform all path related arguments. This is because the path outside the container may not be seen inside container. Bio-Data Processor handles the volume mapping when using Docker. This <cite>pathMapping</cite> <strong>filter function</strong> transforms the external path to internal path. Thus, the program inside the container can access the input files/folders.</p>
</div>
<div class="section" id="what-is-the-filter-function">
<h4>What is the filter function?<a class="headerlink" href="#what-is-the-filter-function" title="Permalink to this headline">¶</a></h4>
<p>The filter function is defined by the <a class="reference external" href="https://mozilla.github.io/nunjucks/templating.html#filters">Nunjucks template engine</a>
The filter function transforms the value before the pipe <code class="docutils literal notranslate"><span class="pre">|</span></code>. Under the hood, a filter function is a registered JavaScript function for Nunjucks. The value before the pipe <code class="docutils literal notranslate"><span class="pre">|</span></code> will be considered as the first argument of the filter function. You may define your own filter function  in <code class="docutils literal notranslate"><span class="pre">task-portal.js</span></code>. In this task-portal.js, you can use our programming API to define tasks or define the filter function.</p>
<p>In addition to the default filter functions of Nunjucks, we provide our set of filter functions, such as the <code class="docutils literal notranslate"><span class="pre">pathMapping</span></code> filter. A user manual containing the list of available filter functions will be available.</p>
<p>You can pipe multiple filter functions in sequential.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{{ argv[0] | pathMapping |  suffix(&#39;/&#39; + argv[1] + &#39;_concatenated.fasta&#39;)}}
</pre></div>
</div>
<p>In the above example for piping filter functions, the <code class="docutils literal notranslate"><span class="pre">argv[0]</span></code> is a folder path. It firstly transforms to the path inside container and than a suffix was added. The suffix was composed as <code class="docutils literal notranslate"><span class="pre">'/'</span> <span class="pre">+</span> <span class="pre">argv[1]</span> <span class="pre">+</span> <span class="pre">'_concatenated.fasta'</span></code>. This makes a new file path under the <code class="docutils literal notranslate"><span class="pre">argv[0]</span></code> folder and the file is named <code class="docutils literal notranslate"><span class="pre">argv[1]</span> <span class="pre">+</span> <span class="pre">_concatenated.fasta</span></code>. The <code class="docutils literal notranslate"><span class="pre">argv[1]</span></code> may be considered as a given sample name.</p>
</div>
</div>
<div class="section" id="the-program-script-was-containerized-inside-a-package-container-of-bio-data-processor">
<h3>2.3. The program/script was containerized inside a package container of Bio-Data Processor.<a class="headerlink" href="#the-program-script-was-containerized-inside-a-package-container-of-bio-data-processor" title="Permalink to this headline">¶</a></h3>
<p>Most of the time, you write your own scripts/programs that do not have containerized by others. We recommended you to wrap your scripts/programs inside a BDP package container. We provide <cite>simple instructions (preparing)</cite> for you to build the package container easily. The following example demonstrate the task template for the decoyPYrat python script. You can also find more information about <a class="reference external" href="https://www.sanger.ac.uk/science/tools/decoypyrat">decoyPYrat here</a>. In this example, we wrapped this python script inside a BDP package container. This script becomes one step of our constructed pipelines.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">task-template</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;run-decoy-pyrat&#39;</span>
    <span class="nt">dockerImage</span><span class="p">:</span> <span class="s">&quot;{{env.DOCKER_IMG}}&quot;</span> <span class="c1"># using the BDP-package container</span>
    <span class="nt">exec</span><span class="p">:</span> <span class="s">&#39;decoy-pyrat&#39;</span>
    <span class="nt">args</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;--cleavage_sites&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[1]</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># -c CSITES A list of amino acids at which to cleave during digestion. Default = KR</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;--anti_cleavage_sites&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[2]</span><span class="nv"> </span><span class="s">}}&quot;</span>  <span class="c1"># -a NOC A list of amino acids at which not to cleave if following cleavage site ie. Proline. // Default = none</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;--cleavage_position&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{%</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">argv[3]</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;c&#39;</span><span class="nv"> </span><span class="s">%}c{%</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">%}n{%</span><span class="nv"> </span><span class="s">endif</span><span class="nv"> </span><span class="s">%}&quot;</span> <span class="c1"># -p {c,n} Set cleavage to be c or n terminal of specified cleavage sites. Default = c</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;--min_peptide_length&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[4]</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># -l MINLEN Set minimum length of peptides to compare between target and decoy. Default = 5</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;--max_iterations&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[5]</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># -n MAXIT Set maximum number of times to shuffle a peptide to make it non-target before failing. // Default=100</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">&#39;--do_not_shuffle&#39;</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">argv[6]</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;true&#39;}}&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">&#39;--do_not_switch&#39;</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">argv[7]</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;true&#39;}}&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;--decoy_prefix&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[8]</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">&#39;--no_isobaric&#39;</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">argv[9]</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;true&#39;</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;--output_fasta&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">path.parse(argv[0]).dir</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">suffix(&#39;/&#39;</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">path.parse(argv[0]).name</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">&#39;_decoy.fasta&#39;)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;--temp_file&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;/tmp/tmp.fasta&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[0]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># The input database sequence in fasta format (argv[0])</span>
    <span class="nt">option</span><span class="p">:</span>
    <span class="nt">setUser</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<div class="section" id="what-are-the-available-variables-in-the-task-template">
<h4>What are the available variables in the <cite>task-template</cite>?<a class="headerlink" href="#what-are-the-available-variables-in-the-task-template" title="Permalink to this headline">¶</a></h4>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">argv</span></code>, the <code class="docutils literal notranslate"><span class="pre">path</span></code> or the <code class="docutils literal notranslate"><span class="pre">option</span></code> variables, the <code class="docutils literal notranslate"><span class="pre">env</span></code> and <code class="docutils literal notranslate"><span class="pre">url</span></code> are also provided. That’s all. Usually you use <code class="docutils literal notranslate"><span class="pre">argv</span></code> and <code class="docutils literal notranslate"><span class="pre">env</span></code> to form commands to execute. The <code class="docutils literal notranslate"><span class="pre">option</span></code> is usually used when you need some run-time information, such as cpu cores, memory, etc. As for the <code class="docutils literal notranslate"><span class="pre">path</span></code> and <code class="docutils literal notranslate"><span class="pre">url</span></code>, they are from NodeJS (see <a class="reference external" href="https://nodejs.org/dist/latest-v10.x/docs/api/path.html">path</a> and <a class="reference external" href="https://nodejs.org/dist/latest-v10.x/docs/api/url.html">url</a>. They help you to parse the path and URL strings, respectively.</p>
<p>There is one additional variable, <code class="docutils literal notranslate"><span class="pre">item</span></code>, in the <code class="docutils literal notranslate"><span class="pre">task-template</span></code>. The <code class="docutils literal notranslate"><span class="pre">item</span></code> is available only when this <code class="docutils literal notranslate"><span class="pre">batch-items</span></code> is defined. Please see the next section about the batch tasks.</p>
</div>
<div class="section" id="what-does-the-mean">
<h4>What does the <cite>{% … %}</cite> mean?<a class="headerlink" href="#what-does-the-mean" title="Permalink to this headline">¶</a></h4>
<p>The template allows you to handle some loops or if-else conditions. You can use them to form the desired arguments for your tasks. Please see the <cite>documentation &lt;https://mozilla.github.io/nunjucks/templating.html&gt;_</cite> for more details about <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">%}</span></code>.</p>
</div>
<div class="section" id="empty-strings-are-ignored">
<h4>Empty strings are ignored.<a class="headerlink" href="#empty-strings-are-ignored" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">args</span></code> field is an array of strings. Each element of this array starts with the <code class="docutils literal notranslate"><span class="pre">-</span></code> character. However, you might have some optional arguments for your scripts/programs. Use an empty string for an undesired argument.For example, you may configure an argument as <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">'optional-argument'</span> <span class="pre">if</span> <span class="pre">argv[3]</span> <span class="pre">==</span> <span class="pre">'true'</span> <span class="pre">}}</span></code>. This will leave an empty string when the <code class="docutils literal notranslate"><span class="pre">argv[3]</span></code> is not equal to the string <cite>true</cite>. The empty string will be ignored.</p>
</div>
<div class="section" id="no-rich-features-for-argument-validations">
<h4>No rich features for argument validations<a class="headerlink" href="#no-rich-features-for-argument-validations" title="Permalink to this headline">¶</a></h4>
<p>To simplify the complexity, we do NOT check the value types but you could write your own validations using the if-else condition in the <code class="docutils literal notranslate"><span class="pre">task-template</span></code>. We do NOT    provide any interpretation for Boolean or number values. All elements in the <code class="docutils literal notranslate"><span class="pre">argv</span></code> array are strings.</p>
</div>
</div>
<div class="section" id="handling-batch-tasks">
<h3>2.4. Handling batch tasks<a class="headerlink" href="#handling-batch-tasks" title="Permalink to this headline">¶</a></h3>
<p>A batch task contains multiple jobs that execute the same program/script. Usually, these jobs have similar arguments. For example, you have multiple RNA sequencing <code class="docutils literal notranslate"><span class="pre">fasta</span></code> files in a folder, and you need to perform sequence alignment for each file. Therefore, you execute the same program many times for these files.</p>
<p>The concept here is to configure a <code class="docutils literal notranslate"><span class="pre">batch-items</span></code> field with a Nunjucks template that <code class="docutils literal notranslate"><span class="pre">dump</span></code> an array at the end for our task reader to generate items. Then, for each item, the <code class="docutils literal notranslate"><span class="pre">task-template</span></code> will be applied and given the <cite>item</cite> variable. For example, you may want to execute a task that requires to iterate all <code class="docutils literal notranslate"><span class="pre">*.mzML</span></code> files in a folder. The template may be looked like this:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">batch-items</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[0]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">fileglob([&#39;*.mzML&#39;,</span><span class="nv"> </span><span class="s">&#39;!*.mgf&#39;])</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">sort</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">dump</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>In this example, the <code class="docutils literal notranslate"><span class="pre">argv[0]</span></code> is a folder path. This path is then piped into the <code class="docutils literal notranslate"><span class="pre">fileglob</span></code> filter function. This function helps you to retrieve all file paths of <code class="docutils literal notranslate"><span class="pre">*.mzML</span></code> and not <code class="docutils literal notranslate"><span class="pre">*.mgf</span></code> files under the <code class="docutils literal notranslate"><span class="pre">argv[0]</span></code> folder. The output of <code class="docutils literal notranslate"><span class="pre">fileglob</span></code> is an array of these file paths. We then <code class="docutils literal notranslate"><span class="pre">sort</span></code> this list and <code class="docutils literal notranslate"><span class="pre">dump</span></code> this list finally.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sort</span></code> here is a built-in filter function of Nunjucks. You may find a full list of <a class="reference external" href="https://mozilla.github.io/nunjucks/templating.html#builtin-filters">built-in filter functions</a>.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code class="docutils literal notranslate"><span class="pre">fileglob</span></code> filter function is provided from BDP task reader. You may find a full list of official filter functions of BDP [here (preparing)](<a class="reference external" href="https://">https://</a>). We will provide more filter functions that can help you to generate <code class="docutils literal notranslate"><span class="pre">batch-items</span></code>. For example, we may have <code class="docutils literal notranslate"><span class="pre">getListFromCSV</span></code> and <code class="docutils literal notranslate"><span class="pre">getListFromXLSX</span></code> filter functions that can extract a list of strings from csv or xlsx files, respectively. Then, the <cite>task-template</cite> can be applied many times with each <code class="docutils literal notranslate"><span class="pre">item</span></code> in the list.</p>
</div>
<p>A full example for the MS-GF+ peptide search engine is shown below:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">task-template</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;run-msgf-plus&#39;</span>
    <span class="c1">#dockerImage: &quot;biocontainers/crux:2.1&quot;</span>
    <span class="nt">dockerImage</span><span class="p">:</span> <span class="s">&quot;quay.io/biocontainers/msgf_plus:2017.07.21--py36_0&quot;</span>
    <span class="nt">exec</span><span class="p">:</span> <span class="s">&#39;msgf_plus&#39;</span>
    <span class="nt">args</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">option.mem</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">prefix(&#39;-Xmx&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># setting memory</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-s&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping}}&quot;</span> <span class="c1"># item: the input file</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-d&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[1]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping</span><span class="nv"> </span><span class="s">|</span><span class="nv">  </span><span class="s">suffix(&#39;/&#39;</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">argv[2]</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">&#39;_concatenated.fasta&#39;)}}&quot;</span> <span class="c1"># argv[1] (folder); argv[2] database name : the reference fasta file</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-o&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[8]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">suffix(&#39;/&#39;</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">path.parse(item).name</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">&#39;-msgf_plus.mzid&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span> <span class="c1"># argv[11]: output folder</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-mod&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[3]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pathMapping}}&quot;</span> <span class="c1"># argv[3] modification file</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-t&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{argv[4]}}&quot;</span> <span class="c1"># argv[4]: precursorMassTolerance</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-inst&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{argv[5]}}&quot;</span> <span class="c1"># argv[5]: MS2DetectorID</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-m&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{argv[6]}}&quot;</span> <span class="c1"># argv[6]: fragmentation</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-ntt&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{argv[7]}}&quot;</span> <span class="c1"># argv[7]: ntt (number of tolerable termini)</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-tda&quot;</span> <span class="c1"># target-decoy</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;0&quot;</span> <span class="c1"># The target-decoy database is pre-generated. We are not using the buildSA function in msgf+.</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-thread&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">option.cpus</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">option</span><span class="p">:</span>
    <span class="nt">setUser</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">batch-items</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">argv[0]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">fileglob([&#39;*.mzML&#39;])</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">sort</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">dump</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-3-move-task-definition-files-into-bdp-package-container">
<h2>Step 3. Move task definition files into BDP package container<a class="headerlink" href="#step-3-move-task-definition-files-into-bdp-package-container" title="Permalink to this headline">¶</a></h2>
<p>Once you have defined all tasks, you have many task definition YAML files and one task-index file. Move these files under the folder <code class="docutils literal notranslate"><span class="pre">./bdp-package/scripts</span></code>. This <code class="docutils literal notranslate"><span class="pre">./bdp-package</span></code> folder is relative to the package folder that contains a <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>. Then, it is ready to build your BDP package!</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Please see [here](<a class="reference external" href="https://">https://</a>) to build BDP package containers.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Chi Yang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>