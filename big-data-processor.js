!function(e,t){for(var a in t)e[a]=t[a]}(exports,function(e){var t={};function a(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,a),i.l=!0,i.exports}return a.m=e,a.c=t,a.d=function(e,t,s){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(s,i,function(t){return e[t]}.bind(null,i));return s},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=31)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=require("express")},function(e,t,a){const s=a(0),i=a(50),r=s.model("Project",i);e.exports=r},function(e,t,a){var s=a(0),i=a(51),r=s.model("DataFile",i);e.exports=r},function(e,t,a){const s=a(0),i=a(47),r=s.model("Account",i);e.exports=r},function(e,t){e.exports=require("path-is-inside")},function(e,t,a){var s=a(0),i=a(52),r=s.model("Result",i);e.exports=r},function(e,t,a){const s=a(0),i=a(25),r=s.model("Task",i);e.exports=r},function(e,t,a){const s=a(0),i=a(54),r=s.model("Package",i);e.exports=r},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("socket.io")},function(e,t,a){var s=a(0),i=a(55),r=s.model("ResultHistory",i);e.exports=r},function(e,t){e.exports=require("dashify")},function(e,t){e.exports=require("child_process")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("readline")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("js-yaml")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("passport")},function(e,t,a){const s=a(0),i=a(49),r=s.model("SystemError",i);e.exports=r},function(e,t,a){const s=a(0),i=s.Schema,r=a(53),o=a(18),n=new s.Schema({name:{type:String,default:""},key:{type:String,default:""},desc:{type:String,default:""},package:{type:i.Types.ObjectId,ref:"Package"},img:{type:String,default:""},thumbnail:{type:String,default:""},script:{type:String},exec:{type:String},cwd:{type:String},type:{type:String},arguments:[r],tags:[{type:String}],mapper:[{type:i.Types.Mixed}],stepNames:[{type:String}],version:{type:String},proxy:{enabled:{type:Boolean,default:!1},protocol:{type:String,default:"http"},pathRewrite:Boolean,port:Number,entryPath:{type:String,default:"/"}}},{timestamps:!0}),c=function(e){let t=String(e);return t=t.replace(/\\/g,"\\").replace(/\'/g,"'").replace(/\"/g,'"').replace(/\|/g,"|").replace(/\;/g,";").replace(/\(/g,"(").replace(/\)/g,")"),t="win32"===o.platform()?'"'+t+'"':"'"+t+"'",t};n.methods.getScriptPath=function(e,t,a){return this.script?this.script.match(/^\$PackageFolder/)&&e?this.script.replace(/^\$PackageFolder/,e):this.script.match(/^\$ScriptFolder/)?this.script.replace(/^\$ScriptFolder/,a):this.script.match(/^\$ProjectFolder/)&&t?this.script.replace(/^\$ProjectFolder/,t):this.script.match(/^\$SystemFolder/)?this.script.replace(/^\$SystemFolder/,process.env.BDP_SYSTEM_FOLDER):this.script:""},n.methods.compose=function(e,t,a,s){const i=this.arguments;let r=[];const o=[];"workflow"!==this.type&&(r=[this.exec,'"'+this.getScriptPath(t,a,s)+'"']);for(let t=0;t<i.length;t++){const a=i[t],s=a.type;if(a.hidden)continue;const r=a.listSplitter?a.listSplitter:",";if(a.option&&o.push(a.option),"value"===s){if(a.optional&&(null===e[t][s]||void 0===e[t][s])){a.option&&o.pop();continue}o.push(c(String(e[t][s])))}else if("static"===s)o.push(c(String(e[t][s])));else if("list"===s){if(a.optional&&(null===e[t][s]||void 0===e[t][s]||0===e[t][s].length)){a.option&&o.pop();continue}o.push(e[t][s].map(e=>c(e)).join(r))}else{if(a.optional&&(null===e[t][s]||void 0===e[t][s]||""===e[t][s])){a.option&&o.pop();continue}o.push(c(e[t][s]))}}return{command:r.join(" "),commandArgs:o}},n.methods.outputProvider=function(){const e=[];for(let t=0;t<this.arguments.length;t++){const a=this.arguments[t];"outFile"==a.type&&(a.dependOn&&a.default?e.push({format:a.format,tags:a.tags,index:t,name:a.name,dependOn:a.dependOn,default:a.default[0],outPreFolder:a.outPreFolder,outFolderStyle:a.outFolderStyle}):e.push({format:a.format,tags:a.tags,index:t,name:a.name,outPreFolder:a.outPreFolder,dependOn:null,default:"",outFolderStyle:a.outFolderStyle}))}return e},n.methods.getModel=function(e){return{id:this.id,name:this.name,desc:this.desc,key:this.key,package:this.package&&this.package.getModel?this.package.getModel():this.package,script:this.script,img:this.img,thumbnail:this.thumbnail,exec:this.exec,cwd:this.cwd,type:this.type,arguments:this.arguments,mapper:this.mapper,stepNames:Array.isArray(this.stepNames)?this.stepNames:[],version:this.version,workflowPlaybook:e||"",proxy:this.proxy&&this.proxy.enabled?{protocol:this.proxy.protocol,pathRewrite:!!this.proxy.pathRewrite,port:this.proxy.port,entryPath:this.proxy.entryPath||"/"}:null}},n.methods.getModelForViewer=function(){return{id:this.id,name:this.name,desc:this.desc,key:this.key,package:this.package&&this.package.getModel?this.package.getModel():this.package,img:this.img,thumbnail:this.thumbnail,type:this.type,arguments:this.arguments,mapper:this.mapper,stepNames:Array.isArray(this.stepNames)?this.stepNames:[],version:this.version,proxy:this.proxy&&this.proxy.enabled?{protocol:this.proxy.protocol,pathRewrite:!!this.proxy.pathRewrite,port:this.proxy.port,entryPath:this.proxy.entryPath||"/"}:null}},e.exports=n},function(e,t){e.exports=require("@big-data-processor/utilities")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("multer")},function(e,t){e.exports=require("filenamify")},function(e,t){e.exports=require("archiver")},function(e,t,a){"use strict";const s=a(3),i=a(1),r=a(32),o=a(11),n=a(19),c=a(2),d=a(33),l=a(20),p=a(21),u=a(34),h=a(15),g=function(e,t,a){return new Promise((s,i)=>{process.stderr.write(`[${(new Date).toString()}] ${a} starting.\n`),process.stderr.write(`[command] ${e} ${t.join(" ")}\n`);const r=h.spawn(e,t,{cwd:process.cwd(),stdio:"inherit",shell:!0});r.on("error",e=>{process.stderr.write(`[${(new Date).toString()}] ${a} has errors."`),process.stderr.write(JSON.stringify(e)),i(a+" failed.")}),r.on("exit",e=>(process.stderr.write(`[${(new Date).toString()}] ${a} Finished.\n`),e?i(a+" failed."):s(a+" Finished."))),r.on("SIGTERM",()=>r.kill()),r.on("SIGINT",()=>r.kill())})},f=e=>new Promise(t=>setTimeout(()=>t(),e)),m=function(e){console.log("step 3. Connect to mongoDB.");const t=e.chiConfig;return new Promise((s,i)=>{const r=t.mongoDB;if(r){const t=`mongodb://${r.mongoUser}:${r.mongoPwd}@${r.mongoHost}:${r.mongoPort}/`,o=r.db_name,n=a(0);n.Promise=global.Promise,n.connect(t+o,{autoIndex:!1,useNewUrlParser:!0});const c=n.connection;c.on("error",e=>{c.close(),i(e)}),c.once("open",(function(){console.log("mongoDB connected!"),s(e)}))}else i("Invalid mongoDB configurations")})},w=async function(){try{const e=await async function(){console.log("step 1. Reading configs");const e={encryption:{saltBits:256,algorithm:"aes-256-cbc",iterations:5},integrity:{saltBits:256,algorithm:"sha256",iterations:2},ttl:0,timestampSkewSec:60,localtimeOffsetMsec:0};let t;const a=await c.pathExists("./configs/server-config.yaml"),s=await c.pathExists("./configs/server-config-template.yaml");!a&&s&&await c.copy("./configs/server-config-template.yaml","./configs/server-config.yaml");try{t=l.safeLoad(r.readFileSync("./configs/server-config.yaml","utf8"))}catch(a){const s=await c.readJson("./configs/server-config.encrypt");if(!s)throw"No config file.";const i=await c.readFile("./configs/server-config.key");return t=await d.unseal(s.config,i.toString(),e),t}if(!t)throw"Invalid server-config.json file.";const o=n.randomBytes(256).toString("base64"),p=await d.seal(t,o,e);return await c.writeFile("./configs/server-config.key",o),await c.writeJson("./configs/server-config.encrypt",{config:p}),process.stdout.write("[Important]\n"),process.stdout.write('Please copy the files "./server-config.json" and "./server-config.key" to remote place(s).\n'),process.stdout.write('Each time you need to start the server, just copy the remote "./server-config.key" file to this folder.\n'),process.stdout.write('If you have updated version of "./server-config.json" file, just copy the updated config file to this folder.\n'),process.stdout.write('A new key "./server-config.key" will be generated for you.\n'),t.system||(t.system={docker_path:"docker",dataFilePath:"./datasets",scriptFolder:"./scripts",uploadFolder:"./uploads",packageFolder:"./packages",taskLogFolder:"./taskLogs",fileLimits:1/0,concurrentProcNumber:3}),t.system.dataFilePath=i.resolve(__dirname,t.system.dataFilePath),t.system.scriptFolder=i.resolve(__dirname,t.system.scriptFolder),t.system.uploadFolder=i.resolve(__dirname,t.system.uploadFolder),t.system.packageFolder=i.resolve(__dirname,t.system.packageFolder),t.system.taskLogFolder=i.resolve(__dirname,t.system.taskLogFolder),t.system.fileLimits=parseFloat(t.system.fileLimits),t.system.concurrentProcNumber=parseFloat(t.system.concurrentProcNumber),t}();await c.ensureDir(i.resolve(e.system.dataFilePath)),await c.ensureDir(i.resolve(e.system.scriptFolder)),await c.ensureDir(i.resolve(e.system.uploadFolder)),await c.ensureDir(i.resolve(e.system.packageFolder)),await c.ensureDir(i.resolve(e.system.taskLogFolder));const t=await function(e){console.log("step 2. Create server app.");const t=a(22).URL;return process.env.BDP_SYSTEM_FOLDER=i.resolve(__dirname),console.log(process.env.BDP_SYSTEM_FOLDER),new Promise((n,d)=>{let l;const p=s();if(p.use(a(21)()),p.enable("trust proxy"),"https:"===new t(e.serverConfig.site_domain).protocol)if(e.https&&e.https.credentialKey&&e.https.credentialCertificate){const t={key:r.readFileSync(e.https.credentialKey),cert:r.readFileSync(e.https.credentialCertificate)};l=o.createServer(t,p);const s=a(12)(l);n({chiServer:l,chiConfig:e,app:p,io:s,helpers:{}})}else if(e.certbot){console.log("Using greenlock-expresss to start the https service.");const s=i.join(e.certbot.certbotStore,"config.json");c.ensureDir(i.dirname(s)).then(()=>c.pathExists(s)).then(a=>{if(!a){let a;try{const s=new t(e.serverConfig.site_domain);a=""+s.hostname,s.port&&(a+=":"+s.port)}catch(e){throw e}return c.writeJSON(s,{defaults:{},sites:[{subject:a}]})}}).then(()=>{a(35).init({cluster:!1,packageRoot:i.resolve("./"),packageAgent:`${u.name}/${u.version}`,maintainerEmail:e.serverConfig.admin_email,configDir:e.certbot.certbotStore,staging:!e.certbot.certbot_production}).ready((function(t){l=t.httpsServer(null,p),t.httpServer().listen(80,(function(t){if(t)return d(t);console.log("Listening for ACME http-01 challenges on",this.address());const s=a(12)(l);n({chiServer:l,chiConfig:e,app:p,io:s,helpers:{}})}))}))}).catch(e=>{d(e)})}else{console.log("Invalid https configurations. Switch to http protocol."),l=a(16).createServer(p);const t=a(12)(l);n({chiServer:l,chiConfig:e,app:p,io:t,helpers:{}})}else{l=a(16).createServer(p);const t=a(12)(l);n({chiServer:l,chiConfig:e,app:p,io:t,helpers:{}})}})}(e);try{await m(t)}catch(a){if(console.log(a),console.log("No database connections."),e.mongoDB.containerName){try{console.log("Trying to start "+e.mongoDB.containerName);const t=e.system.docker_path;await g(t,["start",e.mongoDB.containerName],"try-to-start-bdp-mongo")}catch(a){e.mongoDB.dockerVolumeName?(console.log("Trying to initiate a new MongoDB for you."),await async function(e){const t=e.chiConfig.mongoDB,a=e.chiConfig.system.docker_path,s=t.mongoUser,i=t.mongoPwd,r=t.db_name,o=t.dockerVolumeName,n=t.containerName,c=t.mongoPort;if(!o)throw"No dockerVolumeName to create the volume automatically.";try{await g(a,["volume","create",o],"create-docker-volume")}catch(e){console.log(e)}const d=`${n}-${(new Date).getTime()}-${Math.floor(1e6*Math.random())}`;await g(a,["run","-d","-v",o+":/data/db","--name",d,"mongo"],"create-a-temp-mongodb"),await f(1e4),console.log("Wait 10 sec for the docker service...");try{await g(a,["exec",d,"mongo",r,"--eval",'"db.createUser({ user: \\"'+s+'\\", pwd: \\"'+i+'\\", roles: [ { role: \\"readWrite\\", db: \\"'+r+'\\" } ] });"'],"create-db-user")}catch(e){console.log(e)}await g(a,["stop",d],"stop-the-temp-mongo"),await g(a,["rm",d],"remove-the-temp-mongo"),await g(a,["run","-d","-v",o+":/data/db","--restart","always","--name",n,"-p","127.0.0.1:"+c+":27017","mongo","--port",27017,"--auth"],"create-mongo-database")}(t)):console.log("You can set the mongoDB.dockerVolumeName to create a mongoDB database automatically (using Docker).")}console.log("Wait 10s for the mongoDB service..."),await f(1e4),await m(t)}else console.log("You can set the mongoDB.dockerVolumeName and the mongoDB.containerName in the server-config.yaml file. Then, we will use Docker MongoDB container to create the database for you.")}return await async function(e){const t=e.chiConfig,s=e.app,o=a(36);if(t.serverConfig.accessLog){console.log("step 4. Enable access logging.");const e=/^\/(admin|data|dataFile|user|project|result)\//;await c.ensureFile(i.resolve(t.serverConfig.accessLog));const a=r.createWriteStream(i.resolve(t.serverConfig.accessLog),{flags:"a"});o.token("route-api-route",(function(t){const a=e.exec(t.originalUrl);return a?a[1]:"public"})),o.token("ips",(function(e){return e.ips.join(",")})),o.token("ip",(function(e){return e.ip})),o.token("realclfdate",(function(){const e=function(e){const t=String(e);return(1===t.length?"0":"")+t},t=new Date,a=t.getDate(),s=t.getHours(),i=t.getMinutes(),r=t.getSeconds(),o=t.getFullYear();let n=t.getTimezoneOffset();const c=n>0?"-":"+";n=parseInt(Math.abs(n)/60);const d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getUTCMonth()];return e(a)+"/"+d+"/"+o+":"+e(s)+":"+e(i)+":"+e(r)+" "+c+e(n)+"00"})),s.use(o("[:realclfdate]\t:route-api-route\t:method\t:url\t:status\t:res[content-length]\t:response-time\t:ip\t:ips\t:referrer\t:user-agent",{stream:a})),process.stderr.write("Logging enabled. The log file: "+i.resolve(t.serverConfig.accessLog)+"\n")}else console.log("step 4. Disabled access logging: no setting the accessLog file path in serverConfig.");return e}(t),await async function(e){console.log("step 5. Setting middlewares.");const t=e.chiConfig,s=e.app,i=a(37),r=a(38),o=a(23),n=a(39),c=a(40)(n),d=a(41);s.use(p()),s.use((function(e,a,s){t.serverConfig.development&&(a.header("Access-Control-Allow-Origin",t.serverConfig.devSite+(t.serverConfig.devPort?":"+t.serverConfig.devPort:"")),a.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),a.header("Access-Control-Allow-Headers","X-Requested-With, X-HTTP-Method-Override, Content-Type, Accept"),a.header("Access-Control-Allow-Credentials",!0)),s()})),s.use(d({filter:function(e,t){return!t.get("x-no-compression")&&d.filter(e,t)}})),s.use(r.urlencoded({extended:!1})),s.use(r.json()),s.use(r.raw()),s.use(i(t.serverConfig.sessionSecret));const l=t.mongoDB;l?s.use(n({secret:t.serverConfig.sessionSecret,store:new c({url:`mongodb://${l.mongoUser}:${l.mongoPwd}@${l.mongoHost}:${l.mongoPort}/${l.db_name}`}),saveUninitialized:!1,resave:!0,cookie:{maxAge:t.serverConfig.cookieMaxAge||void 0,secure:0===t.serverConfig.site_domain.indexOf("https://")}})):console.log("No mongoDB configs, so sessions are not used. Maybe i will add 3rd party session store options."),s.use(o.initialize()),s.use(o.session());const u=a(42)({title:"Big Data Processor server status",path:"",websocket:e.io});s.use(u.middleware),s.get("/server-status",(e,t,a)=>e.isAuthenticated()?a():t.redirect("/"),u.pageRoute),e.proxyMapper={},e.helpers=await a(43)(e);const h=await a(58)(e);e.helpers.setTaskRunner(h);const g=t.system.concurrentProcNumber||3;return h.setConcurrentProcesses(g),e}(t),await function(e){console.log("step 6. Reading routing information");const t=e.app;return t.use(s.static(i.resolve("./public"))),t.use("/account",a(62)(e)),t.use("/admin",a(65)(e)),t.use("/project",a(66)(e)),t.use("/result",a(67)(e)),t.use("/data",a(69)(e)),t.use("/dataFile",a(73)(e)),t.use("/task",a(77)(e)),t.use("/page",a(80)(e)),t.use("/system",a(81)(e)),t.get("*",(e,t)=>t.status(200).sendFile(i.resolve("./public/index.html"))),e}(t),function(e){console.log("step 7. Enable socket connections.");const t=e.io;if(!t)throw"No socket.io";const a=function(){return Object.keys(t.sockets.sockets).length};t.on("connection",(function(s){s.on("signIn",(function(e){s.join(e)})),s.on("signOut",(function(e){s.to(e).emit("signOut",{user:e}),s.leave(e,(function(){}))}));const i=e.taskRunner;s.on("disconnect",()=>t.emit("serverStatus",{queue:i.getCurrentQueueNumber(),running:i.getCurrentProcessNumber(),online:a()})),t.emit("serverStatus",{queue:i.getCurrentQueueNumber(),running:i.getCurrentProcessNumber(),online:a()})}))}(t),t.chiServer.listen(e.serverConfig.port,(function(){console.log(`${e.serverConfig.title} server (${e.serverConfig.site_domain}) listening on port ${e.serverConfig.port}`),console.log(this.address())})),t}catch(e){console.log("Cannot create the server due to the error(s):"),console.log(e),process.exit(1)}};(async()=>{try{const e=await w();process.on("SIGTERM",()=>{console.log("Receiving stop signal SIGTERM.\n"),e.io.emit("message",{code:"default",name:"Server is shutting down",type:"default",details:"Please do not create new tasks."}),e.taskRunner.stopAllWithSIGINT().catch(e=>console.log(e)).finally(()=>process.exit(1)),setTimeout(()=>{console.log("Server stopped."),process.exit(0)},3e4)}),process.on("SIGINT",()=>{console.log("Receiving stop signal SIGINT. Stopping server now.\n"),e.io.emit("message",{code:"default",name:"Server is shutting down",type:"default",details:"Please do not create new tasks."}),e.taskRunner.stopAllWithSIGINT().catch(e=>console.log(e)).finally(()=>process.exit(1)),setTimeout(()=>{console.log("Server stopped."),process.exit(0)},3e5)}),process.on("uncaughtException",(function(e){console.log("Caught exception: "+e)}))}catch(e){console.log(e)}})()},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("@hapi/iron")},function(e){e.exports=JSON.parse('{"name":"big-data-processor","version":"1.0.0","description":"The next generation data science workbench","main":"index.js","scripts":{"start":"node big-data-processor.js","build":"webpack --config webpack.config.js","test":"echo \\"Error: no test specified\\" && exit 1"},"author":"Chi Yang","license":"MIT","dependencies":{"@big-data-processor/task-adapter-docker":"^0.8.8","@big-data-processor/task-reader":"^0.8.6","@big-data-processor/utilities":"^0.8.6","@hapi/iron":"^6.0.0","archiver":"^3.1.1","body-parser":"^1.19.0","compression":"^1.7.4","connect-mongo":"^3.2.0","content-disposition":"^0.5.3","cookie-parser":"^1.4.4","cors":"^2.8.5","dashify":"^1.0.0","detect-port":"^1.3.0","express":"^4.17.1","express-session":"^1.17.0","express-status-monitor":"^1.3.2","filenamify":"^4.1.0","find-package-json":"^1.2.0","fs-extra":"^8.1.0","globby":"^11.0.0","googleapis":"^47.0.0","greenlock-express":"^4.0.3","helmet":"^3.21.3","http-proxy":"^1.18.1","js-yaml":"^3.13.1","mime-types":"^2.1.26","mongoose":"^5.9.3","morgan":"^1.9.1","multer":"^1.4.2","natural-orderby":"^2.0.3","nodemailer":"^6.4.4","passport":"^0.4.1","passport-google-oauth20":"^2.0.0","passport-local":"^1.0.0","path-is-inside":"^1.0.2","request":"^2.88.2","sanitize-filename":"^1.6.3","serve-index":"^1.9.1","socket.io":"^2.3.0","unzipper":"^0.10.10","uuid":"^3.4.0"},"devDependencies":{"@babel/compat-data":"^7.9.0","@babel/core":"^7.9.0","@babel/plugin-transform-runtime":"^7.8.3","@babel/preset-env":"^7.8.7","babel-loader":"^8.0.6","webpack":"^4.42.1","webpack-cli":"^3.3.11","webpack-node-externals":"^1.7.2"}}')},function(e,t){e.exports=require("greenlock-express")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("connect-mongo")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("express-status-monitor")},function(e,t,a){const s=a(44),i=a(45),r=a(2),o=a(1),n=a(11),c=a(17),d=a(46),l=a(18),p=a(15),u=a(6),h=a(24),g=a(4),f=a(5),m=a(8),w=a(9),y=a(10),k=a(13),v=a(14),b=a(20),x=a(56),S=a(57),O=a(26).httpGet;e.exports=async function(e){const t=e.io,a=e.chiConfig,I=a.system.docker_path,j=a.system.dataFilePath,F=a.system.taskLogFolder,P=await u.findOne({"auths.base":9}).exec(),T=async function(e,t){let a=-1;t&&(a=t.dataFiles.indexOf(e.id));try{await e.unlinkFileAndRemove(j),a>=0&&t.dataFiles.splice(a,1),A.socketBroadcast(t.getListeners(),"dataChange",{type:"remove",target:"DataFile",data:e.getModel()})}catch(e){console.log("Deleting files has errors"),console.log(e)}},D=async function(t){await e.taskRunner.deleteTaskInQueue(t.id),await e.taskRunner.stopRunningTask(t.pid)},$=async function(e){const t=await g.findOne({_id:e.project}).populate("owner managers runners viewers").exec();if(t||console.log("Can not find the project"),await D(e))return;const a=e.outFiles,s=t.results.indexOf(e.id);s>=0&&t.results.splice(s,1),t.dataFiles=t.dataFiles.filter(e=>{for(const t of a)if(e.toString()===t.toString())return!1;return!0});const i=o.resolve(F,e.id);await r.pathExists(i)&&await r.remove(i),await t.save();const n=[],c=[];for(let e=0;e<a.length;e++)n[e]=a[e].getModel(),c[e]=a[e].unlinkFileAndRemove(j);for(let e=0;e<c.length;e++)await c[e],A.socketBroadcast(t.getListeners(),"dataChange",{type:"remove",target:"DataFile",data:n[e]});const d=e.getModel();await e.remove(),A.socketBroadcast(t.getListeners(),"dataChange",{type:"remove",target:"Result",data:d})},A={setTaskRunner:function(t){e.taskRunner=t},getCode:function(e,t){const a=s[e]?e:"unknown";return t&&t.attached&&(t.attached=t.attached.stack?t.attached.stack:JSON.stringify(t.attached)),{code:a,name:t&&t.name?t.name:s[a].name,type:t&&t.type?t.type:s[a].type,details:t&&t.details?t.details:s[a].details,attached:t&&t.attached?t.attached:void 0}},errorHandler:function(e,t){return e.errors||(e.errors=[]),Array.isArray(t)?e.errors.push.apply(e.errors,t):t&&(console.log(t),"MongoError"===t.name?e.errors.push(A.getCode("s003",{attached:t.stack?t.stack:t})):e.errors.push(A.getCode("s002",{details:"Errors occur during this request. Please try again or report issues.",attached:t.stack?t.stack:t}))),e},isAuthenticated:async function(e,t,a){let s=e.query.authToken,i=null;if(s){s=s.toString();const e=await u.findOne({authToken:s});if(e){const t=e.authTime;((new Date).getTime()-t.getTime())/864e5<=3&&(i=e)}}if(!i&&e.isAuthenticated())try{const s=e.session.passport.user.id;i=await A.getAuthAsync(s,t||"base",a||2)}catch(e){console.log(e)}return i},escapeText:function(e){let t=String(e);return t=t.replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\"/g,'\\"').replace(/\|/g,"\\|").replace(/\;/g,"\\;").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\ /g,"\\ "),"win32"===l.platform()?`"${t}"`:`'${t}'`},logMessages:async function(e,a,s){const i=[];for(const t of a){const a=new h({account:e,code:t.code,name:t.name,type:t.type,routePath:s,details:t.details,attached:t.attached});i.push(a.save())}const r=i.map(async e=>{const t=await e;return h.findOne({_id:t.id}).populate("account").exec()});if(P&&P.id)for(const e of r){const a=await e;t.to(P.id).emit("dataChange",{type:"insert",target:"system-error",data:a.getModel()})}},async getTaskByMap(e){let t=await w.findOne({_id:e.id,key:e.key}).populate("package").exec();if(t)return t;if(t=await w.findOne({_id:e.id}).populate("package").exec(),t)return t;const a=A.pkgNameFormatter(e.pkg+"-"+e.ver).split("-").slice(0,-1).join("-"),s=await y.find({$or:[{_id:e.pkgid},{name:{$regex:"^"+a}}]}).exec();if(0===s.length)return null;let i;const r=s.filter(t=>t.id===e.pkgid);if(1===r.length)i=r[0].id;else{const t=s.filter(t=>0===t.name.indexOf(e.pkg));if(1===t.length)i=t[0].id;else if(t.length>1){const a=t.filter(t=>t.name.split("-").slice(-1)[0]===e.ver);i=1===a.length?a[0].id:S(t,[e=>e.name.split("-").slice(-1)[0]],"desc")[0].id}}return t=await w.findOne({key:e.key,package:i}).populate("package").exec(),t||null},chiAsyncWrap:function(e){return e.length<=3?function(t,a,s){return e(t,a,s).catch(e=>{let a={errors:[]};if(a=A.errorHandler(a,e),a.errors.length>0){const e=t.isAuthenticated()?t.session.passport.user.id:null;A.logMessages(e,a.errors,t.originalUrl).catch(console.log)}return a}).then(e=>e?a.json(e):"").catch(s)}:function(t,a,s,i){return e(t,a,s,i).catch(e=>{let t={errors:[]};if(t=A.errorHandler(t,e),t.errors.length>0){const e=a.isAuthenticated()?a.session.passport.user.id:null;A.logMessages(e,t.errors,a.originalUrl).catch(console.log)}return t}).then(s.json).catch(i)}},getAuthAsync:async function(e,t,a){let s;try{s=await u.findOne({_id:e})}catch(e){throw[A.getCode("s003",{attached:e})]}if(s){if(s.auths[t]<a)throw[A.getCode("a017")];return s}throw[A.getCode("a015")]},reCAPTCHA:function(e){const t={secret:a.reCaptcha.reCaptchaSecret,response:e},s=i.stringify(t),r={hostname:"www.google.com",port:443,path:"/recaptcha/api/siteverify",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":s.length}};return new Promise((e,t)=>{const a=n.request(r,a=>{let s="";a.on("data",e=>{s+=e}),a.on("end",(function(){const a=JSON.parse(s);return a.success?e(a):t([A.getCode("a012")])}))});a.write(s),a.end()})},sendVerifyEmail:function(e,t){if(a.email&&a.email.smtpConfig){const s=a.serverConfig.site_domain+"/account/email-verify?authToken="+t,i=x.createTransport(a.email.smtpConfig),r={to:e,from:"chiyang@mail.cgu.edu.tw",subject:"Verify your email for Bio-Data Processor",html:`${a.email.verificationContent||""}<hr><p>This is a verfication email for Bio-Data Processor.<br>\n            If you did not register to Bio-Data Processor, please skip this email and DO NOT click the following link.<br><br>\n            </p><br> <b><a target=_blank href='${s}'>Verify this email</a></b><br><br>Sincerely,<br>Big-Data Processor<br>`};return new Promise((e,t)=>i.sendMail(r,a=>a?t([{code:"a021",attached:a}]):e()))}return Promise.resolve()},userInList:function(e,t){for(let a=0;a<e.length;a++)if(e[a]===t||e[a]._id===t||e[a].id===t)return!0;return!1},makeResultStopped:async function(e){try{if(await k.errorRun(e.id),"workflow"===e.type){console.log("Starting to stop the workflow");const t=await m.find({parent:e.id}).populate("owner inFiles outFiles task").exec(),a=[];for(const e of t)a.push(D(e));for(const e of a)await e}await D(e),"workflow"===e.type&&(e.status=3),await e.save()}catch(e){console.log(e)}},makeResultDeleted:async function(t){try{if(t.status=4,await t.save(),await k.deleteRun(t.id),"workflow"===t.type){console.log("Start deleting workflow"),await e.taskRunner.deleteWorkflow(t.id);const a=await m.find({parent:t.id}).populate("owner inFiles outFiles task").exec(),s=[];for(const e of a)s.push(D(e));for(const e of s)await e;for(const e of a)4!==e.status&&(console.log("remove children, status: "+e.status),await $(e))}console.log("remove result, status: "+t.status),await $(t),console.log("Result removed")}catch(e){console.log(e)}},runProcessAsync:function(e,t,a){return new Promise((s,i)=>{process.stderr.write(`[${(new Date).toString()}] ${a} starting.\n`),process.stderr.write(`[command] ${e} ${t.join(" ")}\n`);const r=p.spawn(e,t,{cwd:process.cwd(),stdio:"inherit",shell:!0});r.on("error",e=>{process.stderr.write(`[${(new Date).toString()}] ${a} has errors.\n`),process.stderr.write(JSON.stringify(e)),i(a+" failed.")}),r.on("exit",e=>(process.stderr.write(`[${(new Date).toString()}] ${a} finished.\n`),e?i(a+" failed."):s(a+" Finished."))),r.on("SIGTERM",()=>r.kill()),r.on("SIGINT",()=>r.kill())})},getContainerIP:async function(e){return e?new Promise(t=>{let a="";const s=p.spawn(I,["inspect","--format='{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}'",e],{stdio:"pipe",shell:!0});s.on("error",()=>t(null)),s.stdout.on("data",e=>{a+=e.toString()}),s.on("exit",e=>t(0===e?a.replace(/\'/g,"").replace(/\n/g,""):null)),s.on("SIGTERM",()=>{s.kill(),t(null)}),s.on("SIGINT",()=>{s.kill(),t(null)})}):null},issueAvailablePort:async function(t,a){const s=e.proxyMapper,i=Object.keys(s),r={};for(let e=0;e<i.length;e++){const t=s[i[e]].hostPort;r[t]?r[t]++:r[t]=1}if(a&&a>0)return r[a]?null:(s[t]={hostPort:a},a);for(let e=20200;e<65535;e++){if(r[e])continue;const a=await d(e);if(!r[a])return s[t]={hostPort:a},a}return null},makeDataFileDeleted:async function(e,t){if("Folder"!==e.format)await T(e,t);else{const a=await f.find({parent:e.id}).exec();for(let e=0;e<a.length;e++)await T(a[e],t);await T(e,t)}return t.save()},getProjectByID:async function(e){return await g.findOne({_id:e}).populate("owner managers runners viewers package packages").populate({path:"dataFiles",populate:{path:"owner"}}).populate({path:"results",populate:{path:"owner"}}).populate({path:"packages",populate:{path:"owner"}}).exec()},socketBroadcast:function(e,a,s){if(Array.isArray(e)){if(0===e.length)t.emit(a,s);else if(e.length>=1){let i;e.forEach(e=>{i=t.to(e)}),i.emit(a,s)}}else e?t.to(e).emit(a,s):t.emit(a,s)},pkgNameFormatter:function(e){let t="";if(e.indexOf("-")<0)t=v(e,{condense:!0}).slice(0,24)+"-nover";else{const a=e.split("-"),s=a.pop();t=v(a.join("-"),{condense:!0}).slice(0,24)+"-"+s.slice(0,7)}return t},playbookHandler:async function(e,t,a,s){if(a&&(a=v(a,{condense:!0})).length>32)throw"The Task Key is too long. Please use a shorter text.";const i=await r.pathExists(e);let n={tasks:{}};if(i||"create"!==t){if(!i&&"created"!==t)throw"Task index file not found";{const t=await r.readFile(e,"utf8");n=b.safeLoad(t)}}else await r.ensureFile(e);n.tasks||(n={tasks:{}});const c=n.tasks;if("read"===t){if(!n.tasks[a])throw`The task key, ${a}, is not existed in the task-index file ${e}`;let t="";try{return t=await r.readFile(o.resolve(o.dirname(e),n.tasks[a]),"utf8"),t}catch(e){t=""}return t}switch(t){case"create":if(c[a])throw`The task key, ${a}, is existed in the task index file: ${e}`;c[a]="./tasks/"+a+".yaml",await r.outputFile(o.resolve(e,"../tasks/",a+".yaml"),s);break;case"update":c[a]="./tasks/"+a+".yaml",await r.outputFile(o.resolve(e,"../tasks/",a+".yaml"),s);break;case"delete":let t="";t=c[a]?o.resolve(o.dirname(e),c[a]):o.resolve(e,"../tasks/"+a+".yaml"),await r.pathExists(t)&&await r.remove(t),delete c[a]}await r.outputFile(e,b.safeDump(n))},readTaskLogIndex:function(e,t,a){const s="stdout"===a?7:"stderr"===a?8:1;return new Promise(a=>{let i="";const o=r.createReadStream(e),n=c.createInterface({input:o});n.on("line",e=>{const a=e.split("\t");a[0]===t&&(i=a[s],n.close())}),n.on("close",()=>{o.close(),a(i)})})},getFirstTaskName:async function(e){if(!await r.pathExists(e))return null;let t=null;return new Promise(a=>{const s=r.createReadStream(e),i=c.createInterface({input:s});i.on("line",e=>{const a=e.split("\t");"process"!==a[0]&&null===t&&"null"==a[10]&&(t=a[0],i.close())}),i.on("close",()=>{s.close(),a(t)})})},viewNpmPkg:async function(e,t){const a="https://registry.npmjs.com/"+e;try{new URL(a)}catch(e){throw A.getCode("s004",{attached:e})}let s;try{s=await O(a)}catch(e){return{}}const i=JSON.parse(s),r=i["dist-tags"]&&i["dist-tags"].latest?i["dist-tags"].latest:null;let o=null;if(t?i.versions[t]&&(o=i.versions[t]):r&&i.versions[r]&&(o=i.versions[r]),!o)throw A.getCode("s004",{details:`Sorry, we cannot find the version, ${t}, of the package ${e}.`});delete o.dist;const n=o["big-data-processor"]||{},c="string"==typeof o.author?o.author:o.author?o.author.name:"",d=o.author&&o.author.email?o.author.email:null;return{versions:Object.keys(i.versions).reverse(),latest:r,pkgInfo:{name:o.name,version:o.version,description:n.description||o.description,author:n.author||c,email:n.email||d,link:"https://npmjs.com/package/"+o.name},bdp:n.type?n:null}}};return A}},function(e,t){e.exports=require("./public/assets/message-code-table.js")},function(e,t){e.exports=require("querystring")},function(e,t){e.exports=require("detect-port")},function(e,t,a){const s=a(0),i=s.Schema,r=a(19),o=a(48),n=new s.Schema({name:{type:String,default:""},email:{type:String,match:/[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+(?:[A-Z]{2}|com|org|net|edu|gov|mil|biz|info|mobi|name|aero|asia|jobs|museum)\b/},passwd:{type:String},isLoggedIn:{type:Boolean,default:!1},lastLoggedIn:{type:Date,default:Date.now()},auths:{base:{type:Number,default:0},bdp:{type:Number,default:0}},authToken:{type:String},authTime:{type:Date,default:Date.now()},providers:[{type:String,default:"local"}],providerIDs:{Google:{type:i.Types.Mixed},BaseSpace:{type:i.Types.Mixed}}},{timestamps:!0});n.methods.verifyPassword=function(e){return r.createHash("sha256","panelSelectionUser").update(e).digest("base64")===this.passwd},n.methods.register=async function(){const e=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if("local"===this.providers[0]){if(!e.test(this.email))throw[{code:"a002",details:"The email format has errors"}];if("string"!=typeof this.passwd||this.passwd.length<8||this.passwd.length>64)throw[{code:"a003",details:"The password has errors"}]}if(await this.model("Account").findOne({email:this.email}))throw[{code:1,msg:"The email has been used."}];if("local"===this.providers[0]){const e=r.createHash("sha256","panelSelectionUser"),t=this.passwd;this.passwd=e.update(t).digest("base64")}0===await this.model("Account").count({})&&(this.auths.base=9,this.auths.bdp=9),await this.save();return this.getModel()},n.methods.getModel=function(){const e=this.email.match(/((...).+?)\@(.*)\.(.*)/);return Array.isArray(e),{id:this.id,name:this.name,email:this.email,lastLoggedIn:this.lastLoggedIn.getTime(),isLoggedIn:this.isLoggedIn,auths:this.auths,chiblogAuth:this.chiblogAuth,providers:this.providers,createdAt:this.createdAt,updatedAt:this.updatedAt,chiblogAuth:this.chiblogAuth}},n.methods.getSlimModel=function(){return{id:this.id,name:this.name,lastLoggedIn:this.lastLoggedIn}},n.methods.getSimpleModel=function(){return{id:this.id,email:this.email,name:this.name,lastLoggedIn:this.lastLoggedIn}},n.methods.setAuthToken=async function(){for(;;){const e=o(this.email+this.id,o.URL);if(this.authTime=Date.now(),0===(await this.model("Account").find({authToken:e})).length)return this.authToken=e,await this.save()}},n.methods.verifyEmail=async function(e){const t=await this.model("Account").count({}),a=await this.model("Account").findOne({authToken:e});if(!a)throw[{code:"a004",details:"Invalid auth token."}];const s=new Date,i=a.authTime;if((s.getTime()-i.getTime())/864e5>7)throw[{code:"a005",name:"Expired auth token",details:"This token has been expired. We have generated a new token for you. Please sign in and go to user profile page to resend the new token."}];return this.auths.base=1===t?9:1,await this.save(),this.getModel()},n.methods.signIn=async function(){return this.set("isLoggedIn",!0),await this.save(),this.getModel()},n.methods.signOut=async function(){return this.set("isLoggedIn",!1),await this.save(),!0},e.exports=n},function(e,t){e.exports=require("uuid/v5")},function(e,t,a){const s=a(0),i=s.Schema,r=new s.Schema({account:{type:i.Types.ObjectId,ref:"Account"},code:String,type:String,name:String,details:String,routePath:String,attached:i.Types.Mixed},{timestamps:!0});r.methods.getModel=function(){return{id:this._id,account:this.account?this.account.getSimpleModel():null,code:this.code,type:this.type,name:this.name,details:this.details,attached:this.attached,routePath:this.routePath,createdAt:this.createdAt}},e.exports=r},function(e,t,a){const s=a(0),i=s.Schema,r=function(e,t){if(!t)return!1;for(let a=0;a<e.length;a++)if(e[a]==t||e[a]._id==t||e[a].id==t)return!0;return!1},o=new s.Schema({name:{type:String,default:""},owner:{type:i.Types.ObjectId,ref:"Account"},desc:{type:String,default:""},dataFiles:[{type:i.Types.ObjectId,ref:"DataFile"}],results:[{type:i.Types.ObjectId,ref:"Result"}],type:[{type:i.Types.String,default:""}],package:{type:i.Types.ObjectId,ref:"Package"},packages:[{type:i.Types.ObjectId,ref:"Package"}],managers:[{type:i.Types.ObjectId,ref:"Account"}],runners:[{type:i.Types.ObjectId,ref:"Account"}],viewers:[{type:i.Types.ObjectId,ref:"Account"}],public:{type:Boolean,default:!1},open:{type:Boolean,default:!1}},{timestamps:!0});o.methods.getModel=function(e){const t=function(t){return t.getSimpleModel||t.getSlimModel?e&&e.canSetMember?t.getSimpleModel():t.getSlimModel():t},a={id:this.id,name:this.name,desc:this.desc,type:this.type,packages:this.packages.map(e=>e&&e.getModel?e.getModel():e),dataFiles:this.dataFiles.map(e=>e&&e.getModel?e.getModel():e),results:this.results.map(e=>e&&e.getModel?e.getModel():e),owner:{},viewers:this.viewers.map(t),managers:this.managers.map(t),runners:this.runners.map(t),public:!!this.public,privilege:e||{},createdAt:this.createdAt,updatedAt:this.updatedAt};return this.owner&&(this.owner.getSimpleModel||this.owner.getSlimModel?a.owner=e&&e.setMember?this.owner.getSimpleModel():this.owner.getSlimModel():a.owner=this.owner),a},o.methods.getListeners=function(e){let t=[];return this.public||(this.owner&&this.owner._id?t.push(this.owner._id.toString()):this.owner&&t.push(this.owner),t.push.apply(t,this.managers.map(e=>e._id?e._id:e)),t.push.apply(t,this.runners.map(e=>e._id?e._id:e)),t.push.apply(t,this.viewers.map(e=>e._id?e._id:e)),t=t.map(e=>e.toString())),e&&Array.isArray(e)&&t.push.apply(t,e),t.length>=1?t:[]},o.methods.formatChecked=function(e){return this.rawData=e,this.formatCheck=1,this.save(),this},o.methods.getPrivilege=function(e){const t=e.auths.bdp,a=!(!this.owner||this.owner.toString()!==e.id&&this.owner.id!==e.id),s=r(this.managers,e.id),i=r(this.runners,e.id),o=r(this.viewers,e.id),n={canView:!1,canRun:!1,canEdit:!1,canDelete:!1,canDeleteResult:!1,canEditResult:!1,canDeleteFile:!1,canAddFile:!1,canEditFile:!1,canSetMember:!1,isOwner:a,isManager:s,isRunner:i,isViewer:o};return 9===t?Object.assign(n,{canView:!0,canRun:!0,canEdit:!0,canDelete:!0,canDeleteResult:!0,canEditResult:!0,canDeleteFile:!0,canAddFile:!0,canEditFile:!0,canSetMember:!0}):(n.canView=t>=2&&(a||s||i||o||this.public),n.canRun=t>=2&&(a||s||i),n.canEdit=t>=2&&(a||s),n.canDelete=t>=2&&a,n.canEditResult=t>=2&&(a||s||i),n.canDeleteResult=t>=2&&(a||s),n.canDeleteFile=t>=2&&(a||s||i),n.canAddFile=t>=2&&(a||s||i),n.canEditFile=t>=2&&(a||s||i),n.canSetMember=t>=2&&(a||s),n)},e.exports=o},function(e,t,a){const s=a(0),i=s.Schema,r=a(2),o=a(7),n=a(1),c=new s.Schema({name:{type:String,default:""},desc:{type:String,default:""},format:{type:String,default:""},path:{type:String,default:""},realPath:{type:String,default:""},tags:[String],parent:{type:i.Types.ObjectId},project:{type:i.Types.ObjectId,ref:"Project"},owner:{type:i.Types.ObjectId,ref:"Account"},result:{type:i.Types.ObjectId,ref:"Result"},status:{type:Number,default:0},additionInfo:{type:i.Types.Mixed,default:{}},size:{type:Number,default:0},hidden:{type:Boolean,default:!1},readOnly:{type:Boolean,default:!1},prefix:{type:String,default:""},suffix:{type:String,default:""}},{timestamps:!0});c.methods.getName=function(){return this.name?this.name:this.id},c.methods.getModel=function(e){return{id:this.id,name:this.name,desc:this.desc,format:this.format,tags:this.tags,project:this.project&&this.project.getModel&&e?this.project.getModel(e):this.project,result:this.result&&this.result.getModel?this.result.getModel(e):this.result,status:this.status,addition:this.addition,parent:this.parent,hidden:this.hidden,size:this.size,path:this.path,realPath:this.realPath,owner:this.owner&&this.owner.getSlimModel?this.owner.getSlimModel():this.owner,prefix:this.prefix,suffix:this.suffix,createdAt:this.createdAt,updatedAt:this.updatedAt}},c.methods.checkFile=async function(){let e=!1,t=4;if(await r.pathExists(this.path))try{e=await r.stat(this.path),t=1}catch(e){t=4}else t=4;return t!==this.status&&(this.status=t,await this.save()),e},c.methods.ensureFile=async function(e){let t=!1,a=4,s=!1;if(await r.pathExists(this.path))try{t=await r.stat(this.path),a=1}catch(e){a=4}else a=4;if(4===a){const i=this.project._id?this.project._id.toString():this.project,o=this._id.toString(),c="Folder"===this.format?n.resolve(e,i,o):n.resolve(e,i,`${o}.${this.format}`);if(await r.pathExists(c))try{t=await r.stat(c),a=1,this.path=c,s=!0}catch(e){a=4}}return(a!==this.status||s)&&await this.save(),t},c.methods.unlinkFileAndRemove=async function(e){this.status=3;const t=await this.save();if(e){if(o(n.resolve(t.path),n.resolve(e)))try{let a="";a="Folder"===this.format?n.resolve(e,"shared",this.id):n.resolve(e,"shared",this.id+"."+this.format),await r.pathExists(a)&&await r.remove(a),await r.remove(t.path)}catch(e){console.log(e)}else console.log("The Path: "+t.path+" is outside of "+e)}await this.remove()},c.methods.move=async function(e){const t=this.path;this.status=2,await this.save(),await r.move(t,e)},c.methods.extractInfo=function(){this.tags.indexOf("subset")},e.exports=c},function(e,t,a){const s=a(0),i=s.Schema,r=a(25),o=new s.Schema({name:{type:String,required:!0},type:{type:String},desc:{type:String,default:""},owner:{type:i.Types.ObjectId,ref:"Account"},project:{type:i.Types.ObjectId,ref:"Project"},script:{type:String,default:""},children:[{type:i.Types.Mixed}],task:{type:i.Types.ObjectId,ref:"Task"},taskSnapshot:r,parent:{type:i.Types.ObjectId,ref:"Result"},arguments:[{type:i.Types.Mixed}],cwd:{type:String},command:{type:String,default:""},commandArgs:[{type:String}],outFiles:[{type:i.Types.ObjectId,ref:"DataFile"}],inFiles:[{type:i.Types.ObjectId,ref:"DataFile"}],status:{type:Number,default:-1},stdErr:{type:String,default:""},stdOut:{type:String,default:""},error:{type:i.Types.Mixed},readOnly:{type:Boolean,default:!1},timer:[{type:Date}],pid:{type:Number},workflowProgress:[],prefix:{type:String,default:""},suffix:{type:String,default:""}},{timestamps:!0});o.methods.getModel=function(e){return{id:this.id,name:this.name,type:this.type,desc:this.desc,owner:this.owner&&this.owner.getSlimModel?this.owner.getSlimModel():this.owner,project:this.project&&this.project.getModel&&e?this.project.getModel(e):this.project,task:this.task&&this.task.getModel?this.task.getModel():this.task,taskSnapshot:this.taskSnapshot&&this.taskSnapshot.getModel?this.taskSnapshot.getModel():this.taskSnapshot,parent:this.parent,children:this.children,arguments:this.arguments,commandArgs:this.commandArgs,cwd:this.cwd,command:this.command,inFiles:this.inFiles.map(e=>e&&e.getModel?e.getModel():e),outFiles:this.outFiles.map(e=>e&&e.getModel?e.getModel():e),status:this.status,stdErr:this.stdErr,stdOut:this.stdOut,error:this.error,timer:this.timer,readOnly:this.readOnly,pid:this.pid,workflowProgress:[],createdAt:this.createdAt,updatedAt:this.updatedAt,prefix:this.prefix||"",suffix:this.suffix||""}},e.exports=o},function(e,t,a){const s=a(0),i=s.Schema,r=s.Schema({name:String,desc:String,type:{type:String,enum:["static","value","list","inFile","outFile","inDir","outDir"]},format:String,tags:[String],tagMatchRule:{type:String,enum:["or","and","all"],default:"or"},option:{type:String,default:""},optional:{type:Boolean,default:!1},multiple:{type:Boolean,default:!1},default:[{type:i.Types.Mixed}],list:[String],dependOn:String,listType:String,listSplitter:{type:String,default:","},component:{type:String,default:"default"},preview:Boolean,hidden:{type:Boolean,default:!1},outFolderStyle:{type:String,enum:["name","path"],default:"path"},outPreFolder:{type:Boolean,default:!1}},{_id:!1});e.exports=r},function(e,t,a){const s=a(0),i=s.Schema,r=s.Schema({ext:{type:String},tags:[{type:String}]},{_id:!1}),o=function(e,t){if(!t)return!1;for(let a=0;a<e.length;a++)if(e[a]==t||e[a]._id==t||e[a].id==t)return!0;return!1},n=function(e,t){return e.getSimpleModel||e.getSlimModel?t&&t.canSetMember?e.getSimpleModel():e.getSlimModel():e},c=new s.Schema({name:{type:String,required:!0,index:!0,unique:!0},desc:{type:String,default:""},author:{type:String,default:""},email:{type:String,default:""},category:{type:String,default:""},img:{type:String,default:""},thumbnail:{type:String,default:""},path:{type:String,required:!0},fromPath:{type:String,required:!1},scope:[{type:String}],status:{type:Number,default:0},allowedFormats:[{type:String,default:""}],formatMapping:[r],backups:[{type:String}],setupSteps:{type:Number,default:0},stdOut:{type:String},stdErr:{type:String},error:{type:i.Types.Mixed},link:{type:String,default:""},sheetID:{type:String,default:""},sheetName:{type:String,default:""},pages:{indexPages:[{name:{type:String,default:""},desc:{type:String,default:""},path:{type:String,default:""},thumbnail:{type:String,default:""},key:{type:String,default:""},img:{type:String,default:""}}],resultPages:[{name:{type:String,default:""},desc:{type:String,default:""},path:{type:String,default:""},tasks:[{type:String}],thumbnail:{type:String,default:""},key:{type:String,default:""},img:{type:String,default:""}}],filePages:[{name:{type:String,default:""},desc:{type:String,default:""},path:{type:String,default:""},tags:[{type:String}],rules:{type:String,default:"or"},format:{type:String,default:""},thumbnail:{type:String,default:""},key:{type:String,default:""},img:{type:String,default:""}}]},owner:{type:i.Types.ObjectId,ref:"Account"},managers:[{type:i.Types.ObjectId,ref:"Account"}],viewers:[{type:i.Types.ObjectId,ref:"Account"}],runners:[{type:i.Types.ObjectId,ref:"Account"}],public:{type:Boolean,default:!1},open:{type:Boolean,default:!1}},{timestamps:!0});c.methods.setPages=function(e){const t={indexPages:[],resultPages:[],filePages:[]};e&&(Array.isArray(e.indexPages)&&(t.indexPages=e.indexPages.map(e=>({name:e.name||"",desc:e.desc||"",path:e.path||"/assets/pages/index.html",thumbnail:e.thumbnail,key:e.key||"",img:e.img}))),Array.isArray(e.resultPages)&&(t.resultPages=e.resultPages.map(e=>({name:e.name||"",desc:e.desc||"",path:e.path||"/assets/pages/index.html",thumbnail:e.thumbnail,key:e.key||"",img:e.img,tasks:Array.isArray(e.tasks)?e.tasks:[]}))),Array.isArray(e.filePages)&&(t.filePages=e.filePages.map(e=>({name:e.name||"",desc:e.desc||"",path:e.path||"/assets/pages/index.html",thumbnail:e.thumbnail,key:e.key||"",img:e.img,tags:Array.isArray(e.tags)?e.tags.map(e=>e.replace(/[^a-z0-9\-\_]/g,"")):[],rules:-1===["and","or","all"].indexOf(e.rules)?"or":e.rules,format:e.format||""})))),this.pages=t},c.methods.getModel=function(e){const t={id:this.id,name:this.name.split("-").slice(0,-1).join("-"),desc:this.desc,author:this.author,email:this.email,img:this.img,thumbnail:this.thumbnail,status:this.status,scope:this.scope,allowedFormats:this.allowedFormats,formatMapping:this.formatMapping,pages:this.pages,version:this.name.split("-").slice(-1)[0],createdAt:this.createdAt,updatedAt:this.updatedAt,link:this.link,setupSteps:this.setupSteps,privilege:e||this.privilege||{},sheetID:this.sheetID,sheetName:this.sheetName,owner:{},viewers:this.viewers.map(n,e),managers:this.managers.map(n,e),runners:this.runners.map(n,e),public:this.public};return this.owner&&(this.owner.getSimpleModel||this.owner.getSlimModel?t.owner=e&&e.setMember?this.owner.getSimpleModel():this.owner.getSlimModel():t.owner=this.owner),t},c.methods.getDetailModel=function(e){const t={id:this.id,name:this.name.split("-").slice(0,-1).join("-"),desc:this.desc,author:this.author,email:this.email,status:this.status,img:this.img,thumbnail:this.thumbnail,scope:this.scope,allowedFormats:this.allowedFormats,formatMapping:this.formatMapping,pages:this.pages,version:this.name.split("-").slice(-1)[0],backups:this.backups,createdAt:this.createdAt,updatedAt:this.updatedAt,setupSteps:this.setupSteps,stdOut:this.stdOut,stdErr:this.stdErr,error:this.error,link:this.link,sheetID:this.sheetID,sheetName:this.sheetName,privilege:e||{},owner:{},viewers:this.viewers.map(n,e),managers:this.managers.map(n,e),runners:this.runners.map(n,e),public:this.public};return this.owner&&(this.owner.getSimpleModel||this.owner.getSlimModel?t.owner=e&&e.setMember?this.owner.getSimpleModel():this.owner.getSlimModel():t.owner=this.owner),t},c.methods.getListeners=function(e){let t=[];return this.public||(this.owner&&this.owner._id?t.push(this.owner._id.toString()):this.owner&&t.push(this.owner),t.push.apply(t,this.managers.map(e=>e._id?e._id:e)),t.push.apply(t,this.runners.map(e=>e._id?e._id:e)),t.push.apply(t,this.viewers.map(e=>e._id?e._id:e))),e&&Array.isArray(e)&&t.push.apply(t,e),t=t.map(e=>e.toString()),t.length>=1?t:[]},c.methods.getPrivilege=function(e){e&&e.auths||(e={id:"",auths:{bdp:0}});const t=e.auths.bdp,a=!(!this.owner||this.owner.toString()!==e.id&&this.owner.id!==e.id),s=o(this.managers,e.id),i=o(this.viewers,e.id),r=o(this.runners,e.id),n={canView:!1,canRun:!(this.runners&&this.runners.length>0),canEdit:!1,canDelete:!1,canSetMember:!1,isOwner:a,isManager:s,isRunner:r,isViewer:i};return 9===t?Object.assign(n,{canView:!0,canRun:!0,canEdit:!0,canDelete:!0,canSetMember:!0}):(n.canView=t>=7&&(a||s||i||this.public),n.canRun=t>=2&&(a||s||r||this.public),n.canEdit=t>=7&&(a||s),n.canDelete=t>=8&&a,n.canSetMember=t>=8&&(a||s),n)},e.exports=c},function(e,t,a){const s=a(0),i=s.Schema,r=new s.Schema({result:{type:i.Types.ObjectId,ref:"Result"},user:{type:i.Types.ObjectId,ref:"Account"},project:{type:i.Types.ObjectId,ref:"Project"},projectName:{type:String,default:""},projectDesc:{type:String,default:""},taskName:{type:String,default:""},title:{type:String,default:""},desc:{type:String,default:""},status:{type:Number,default:0},timer:[{type:Date}]},{timestamps:!0});r.methods.getModel=function(){return{id:this.id,title:this.title,desc:this.desc,status:this.status,timer:this.timer,taskName:this.taskName,projectName:this.projectName,projectDesc:this.projectDesc,project:this.project,result:this.result,user:this.user.getModel()}},r.statics.startRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1}).exec();return t.length>0&&(t[0].status=1,t[0].timer=[t[0].timer[0],new Date],t[0].markModified("timer"),await t[0].save())},r.statics.finishRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1}).exec();return t.length>0&&(t[0].status=2,t[0].timer=[t[0].timer[0],t[0].timer[1],new Date],t[0].markModified("timer"),await t[0].save())},r.statics.errorRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1}).exec();return t.length>0&&(t[0].status=3,t[0].timer=[t[0].timer[0],t[0].timer[1],new Date],t[0].markModified("timer"),await t[0].save())},r.statics.deleteRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1}).exec();return t.length>0&&(t[0].status=4,t[0].timer=[t[0].timer[0],t[0].timer[1],t[0].timer[2],new Date],t[0].markModified("timer"),await t[0].save())},e.exports=r},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("natural-orderby")},function(e,t,a){const s=a(15),i=a(5),r=a(8),o=a(59),n=a(9),c=a(4),d=a(6),l=a(13),p=a(18),u=a(14),h=a(2),g=a(1),f=a(61),m=function(e){switch(e){case 0:return"st";case 1:return"nd";case 2:return"rd";default:return"th"}};e.exports=async function(e){let t=[];const a={},w={},y={},k={};let v=10;const b=new f;let x=!1;const S=e.chiConfig,O=e.proxyMapper,I=S.system.dataFilePath,j=S.system.scriptFolder,F=S.system.taskLogFolder,P=e.io,T=e.helpers,D=T.getCode,$=T.makeResultDeleted,A=T.socketBroadcast,_=T.getTaskByMap,M=T.issueAvailablePort,C={setConcurrentProcesses:function(e){v=e},pause:function(){x=!0},start:function(){x=!1,N().catch(e=>console.log(e))},addToQueue:async e=>{try{const a={id:e.id,cmd:e.command,args:e.commandArgs,cwd:e.cwd,type:e.type,user:e.owner,project:e.project,env:e.env,extDirs:e.extDirs};"workflow"!==a.type?(t.push(a),await o.updateOne({},{taskQueue:t}).exec().catch(e=>console.log(e)),x||await N(),P.emit("serverStatus",{queue:C.getCurrentQueueNumber(),running:C.getCurrentProcessNumber()})):await R(a)}catch(e){console.log(e)}},getQueue:function(){return t},getCurrentQueueNumber:function(){return t.length},getCurrentProcessNumber:function(){return Object.keys(a).length},getProcess:function(e){return a[e]},getCurrentStdOutput:function(e){return k[e]},deleteTaskInQueue:async e=>{for(let a=0;a<t.length;a++)if(t[a].id===e)return t.splice(a,1),P.emit("serverStatus",{queue:C.getCurrentQueueNumber(),running:C.getCurrentProcessNumber()}),void await o.update({},{taskQueue:t}).exec()},stopAllWithSIGINT:async function(){x=!0;const e=Object.keys(a),t=e.length,s=[];for(let i=0;i<t;i++){const t=a[e[i]],r=t.pid;t&&s.push(new Promise(e=>{t.on("exit",()=>{console.log("pid exit: "+r),e()}),t.kill("SIGINT")}))}console.log(s.length+"tasks to be stopped"),await Promise.all(s).catch(e=>console.log(e))},stopRunningTask:function(e){const t=a[e];if(t){if(process.stdout.write("kill process "+e+"\n"),"win32"===p.platform()){try{t.stdin.write("bdp stop task\n")}catch(e){process.stdout.write((e.message?e.message:"")+"\n"+(e.stacks?e.stacks:e)+"\n")}setTimeout(()=>t&&t.kill?t.kill("SIGTERM"):"",3e5)}else t.kill("SIGTERM");setTimeout(()=>{if(!t||!t.killed){const t=w[e];if(!t)return;(async()=>{const a=await c.findOne({_id:t.project}).exec(),s=a?a.getListeners():[];await E("The process kill signal cannot be sent.",e,t.id,s),N().catch(e=>console.log(e))})().catch(e=>console.log(e))}},3e5)}return t},deleteWorkflow:async function(e){delete y[e],await o.updateOne({},{workflowProcess:y})}},E=async(e,t,s,i)=>{const n=await r.findOne({_id:s}).populate("owner inFiles outFiles task").exec();if(n){if(t){const e=a[t];n.stdOut=k[e.pid].stdOut,n.stdErr=k[e.pid].stdErr}else n.stdErr="Can not spawn the child process\n"+e.toString();await n.save();const s=t?k[a[t].pid].stdOut:"",r=t?k[a[t].pid].stdErr:"";A(i,"resultOut",{type:"stdOut",target:n.project+":"+n.id,data:s}),A(i,"resultOut",{type:"stdErr",target:n.project+":"+n.id,data:r}),4===n.status?await $(n):await V(n,n.stdOut,n.stdErr,e)}delete w[t],delete a[t],delete k[t],await o.updateOne({},{processing:w}),P.emit("serverStatus",{queue:C.getCurrentQueueNumber(),running:C.getCurrentProcessNumber()})},N=async function(){try{if(x)return;if(Object.keys(a).length<v&&t.length>0){const e=t.shift();await o.updateOne({},{taskQueue:t});const i=await c.findOne({_id:e.project}).exec(),d=i?i.getListeners():[],f=await r.findOne({_id:e.id}).populate("owner").exec();if(console.log(f?f.id:"cannot find result id: "+e.id),!f)return void await l.deleteRun(e.id);await l.startRun(f.id);const m=e.env,y=Object.keys(process.env);for(let e=0;e<y.length;e++){const t=y[e];m[t]=process.env[t]}m.EXTERNAL_FOLDERS=e.extDirs.join(","),m.TASKLOG_FOLDER=F,m.RESULT_ID=f.id;const v=await n.findOne({_id:f.task}).populate("package").exec();let b;v&&(m.TASK_ID=v.id,m.TASK_NAME=u(v.name,{condense:!0}),v.package&&(m.PACKAGE_FOLDER=g.resolve(v.package.path))),await h.pathExists(e.cwd)||(e.cwd=p.tmpdir());try{b=s.spawn(e.cmd,e.args,{cwd:e.cwd,shell:!0,env:m,windowsHide:!0})}catch(t){return console.log("Child Process failed to spawn"),console.log(t),void E(t,null,e.id,d).then(N).catch(e=>console.log(e))}k[b.pid]={stdOut:"",stdErr:"",err:{}},b.stdout.on("readable",()=>{const e=b.stdout.read();if(e&&k[b.pid]){k[b.pid].stdOut+=e.toString(),k[b.pid].stdOut.length>=1e4&&(k[b.pid].stdOut="====== Skipped ======\n..."+k[b.pid].stdOut.slice(-1e4)),A(d,"resultOut",{type:"stdOut",target:f.project+":"+f.id,data:k[b.pid].stdOut})}}),b.stderr.on("readable",()=>{const e=b.stderr.read();if(e&&k[b.pid]){k[b.pid].stdErr+=e.toString(),k[b.pid].stdErr.length>=1e4&&(k[b.pid].stdErr="====== Skipped ======\n..."+k[b.pid].stdErr.slice(-1e4)),A(d,"resultOut",{type:"stdErr",target:f.project+":"+f.id,data:k[b.pid].stdErr})}});const S=await r.findOneAndUpdate({_id:e.id},{pid:b.pid,status:1,$push:{timer:new Date}},{new:!0}).populate("owner inFiles outFiles task").exec();S&&(A(d,"dataChange",{type:"update",target:"Result",data:S.getModel()}),P.emit("serverStatus",{queue:C.getCurrentQueueNumber(),running:C.getCurrentProcessNumber()})),b.on("error",t=>{console.log("process error:"+b.pid),E(t,b.pid,e.id,d).then(N).catch(console.log)}),b.on("exit",(t,s)=>{console.log("process exiting: "+t+"-"+s),delete O[f.id],w[b.pid]&&!x&&(0!==t?(console.log("process error:"+b.pid),E("Exit code is not 0.",b.pid,e.id,d).then(N).catch(console.log)):(async(e,t,s,i)=>{const n=a[s],c=w[s],d=await r.findOne({_id:c.id}).populate("owner inFiles outFiles task").exec();if(d){const a=k[n.pid].stdOut,s=k[n.pid].stdErr;if(d.stdOut=a,d.stdErr=s,await d.save(),A(i,"resultOut",{type:"stdOut",target:d.project+":"+d.id,data:a}),A(i,"resultOut",{type:"stdErr",target:d.project+":"+d.id,data:s}),4===d.status)await $(d);else if(0!==e||t){const i={code:e,signal:t};await V(d,a,s,i)}else await L(d,a,s)}delete w[s],delete a[s],delete k[s],await o.updateOne({},{processing:w}),P.emit("serverStatus",{queue:C.getCurrentQueueNumber(),running:C.getCurrentProcessNumber()})})(t,s,b.pid,d).then(N).catch(console.log))}),a[b.pid]=b,w[b.pid]=e,await o.updateOne({},{processing:w}).exec(),N().catch(e=>console.log(e))}}catch(e){console.log(e)}},R=async function(e){try{if("workflow"!==e.type)return;const t=await r.findOne({_id:e.id}).populate("project owner inFiles outFiles task").exec();if(!t)return;const a=t.project,s=a?a.getListeners():[],i=t.task.mapper,n=[];for(let e=0;e<i.length;e++){n[e]=[];for(let t=0;t<i[e].length;t++)n[e][t]=i[e][t].args}const c=[];for(let e=0;e<i.length;e++){if(!Array.isArray(i[e]))throw[D("32",{details:`This workflow has undefined step ${e}. Please check if the workflow is corrected set.`})];const t=[];for(let a=0;a<i[e].length;a++){const s=i[e][a];t.push(_(s))}const a=Promise.all(t);for(let t=0;t<a.length;t++){a[t]||c.push(`At step ${e}, we cannot find the ${t+1}${m(t)} task. It requires the task-key ${i[e][t].key} in the package ${i[e][t].pkg}`)}}c.length>0&&console.log("The workflow task has errors"),t.status=1,await l.startRun(e.id),A(s,"dataChange",{type:"update",target:"Result",data:t.getModel()});const d={id:e.id,name:e.name,desc:e.desc,user:e.user,project:e.project,mapper:i,args:t.arguments,argValues:n,progress:0,finished:[],commands:[],results:[],resultStatus:[],env:e.env};y[e.id]=d;for(let e=0;e<i.length;e++)d.results[e]=Array.isArray(t.children[e])?t.children[e]:[];await o.updateOne({},{workflowProcess:y}).exec(),await q(d)}catch(e){console.log(e)}},q=async function(e){try{const t=e.progress,a=e.id,s=e.mapper[t],n=e.user,l=e.project,p=await c.findOne({_id:l}).exec(),f=p?p.getListeners():[],m=await d.findOne({_id:n}).exec();if(!p)return console.log("Cannot find the project, the workflow will be deleted!"),void delete y[a];const w=[],k=await r.findOne({_id:a}).populate("owner inFiles outFiles task").exec(),v=k.children,x=v[t];e.results[t]=v[t]||[],Array.isArray(e.resultStatus[t])||(e.resultStatus[t]=[]);let S={};const O=k.prefix||"",F=k.suffix||"";for(let o=0;o<s.length;o++){const c=s[o],d=await _(c);if(null===d){console.log("Cannot find the task by the task mapper object: "),console.log(c),e.resultStatus[t][o]=3,await V(k,"","Cannot find the task by the task mapper object: \n"+JSON.stringify(c,void 0,4));break}d.package||(e.resultStatus[t][o]=3,await V(k,"","Cannot find the task's package by the task mapper object: \n"+JSON.stringify(c,void 0,4))),d.package.getPrivilege(m).canRun||await V(k,"",`You have no privileges to execute the task, ${d.name}, at the step ${t}-${o+1}`);const y=d.getModel();let v,P;if(y.package=d.package.id,S=d.arguments,x&&x[o]&&(v=await r.findOne({_id:x[o]}).exec(),v.parent.toString()===a&&2===v.status)){e.results[t][o]=v.id,e.resultStatus[t][o]=2,v.arguments.forEach((a,s)=>{const i=Object.keys(a)[0];e.argValues[t][o][s]=a[i]}),b.emit("taskFinished",v);continue}P=new r({name:d.name,desc:d.desc,type:"child",task:d.id,taskSnapshot:y,parent:e.id,project:l,owner:n,script:d.script,cwd:d.cwd,status:0,readOnly:!1,timer:[new Date],inFiles:[],outFiles:[],arguments:[],prefix:O,suffix:F});const T=[];for(let a=0;a<S.length;a++){const i=S[a];P.arguments[a]={};const r=i.type;if("static"===r){P.arguments[a][r]=i.default[0];continue}const n=s[o].args[a].split(".");let c;if("argv"===n[0]){if(void 0===e.args[+n[1]])return void await V(k,"",`The workflow has undefined argument of position ${n[1]}. \n                Probably, the task has been updated so the argument does not match. This result cannot be resumed. \n                Please execute another NEW Task instead of resume this result.`);c=null==e.args[+n[1]][r]?e.args[+n[1]].static:e.args[+n[1]][r],e.argValues[t][o][a]=c,P.arguments[a][r]="outFile"===i.type&&"name"===i.outFolderStyle?g.basename(c):c}else if("map"===n[0]){try{c=e.argValues[+n[1]][+n[2]][+n[3]]}catch(e){return void await V(k,"","The task mapper may be updated. This result cannot be resumed. Please execute another NEW task instead of resume this result.")}e.argValues[t][o][a]=c,P.arguments[a][r]=c}"inFile"===r&&c&&T.push(c)}const D=[],$=await i.find({project:l,path:{$in:T}}).exec(),E={};$.forEach(e=>{P.inFiles.push(e.id),E[e.path]=e.id,e.realPath&&D.push(e.realPath)});const N=d.outputProvider(),R=[],q=[],L={};let W=0;for(let a=0;a<N.length;a++){const r=N[a].index;if(L[N[a].index]=a,"outFile"===s[o].args[r].split(".")[0]){const s=new i(N[a]);if(N[a].dependOn&&N[a].default){let i="";const r=N[a].dependOn.split(".");if("argv"!==r[0]){console.log("Error");continue}{const n=d.arguments[+r[1]];if("outFile"===n.type&&"Folder"===n.format){const e=R[L[+r[1]]];if(!e)continue;i=e.path,s.parent=e.id}else"inFile"===n.type&&"Folder"===n.format&&(i=e.argValues[t][o][+r[1]],s.parent=E[i]);N[a].default.indexOf("{$FolderName}")>=0&&(N[a].default=N[a].default.replace(/\{\$FolderName\}/g,g.basename(i))),s.path=g.resolve(i,N[a].default)}}else s.path=g.resolve(`${I}/${l}/${s.id}`);"Folder"!==s.format&&(s.path+="."+s.format),N[a].outPreFolder&&"Folder"===N[a].format&&q.push(s.path),s.owner=m,s.project=l,s.result=P.id,s.hidden=!0,s.prefix=O,s.suffix=F,P.outFiles[W]=s.id,W++,R[a]=s,e.argValues[t][o][r]=s.path,"Folder"===s.format&&"name"===N[a].outFolderStyle&&"$ProjectFolder"===d.cwd?P.arguments[r]={outFile:g.basename(s.path)}:("Folder"===s.format&&N[a].outFolderStyle,P.arguments[r]={outFile:s.path})}}const z=d.compose(P.arguments,d.package.path,e.env.PROJECT_FOLDER,j);if(P.command=z.command,P.commandArgs=z.commandArgs,v){P=v,P.status=0,P.timer=[new Date],P.arguments.forEach((a,s)=>e.argValues[t][o][s]=a[Object.keys(a)[0]]);const a=d.compose(P.arguments,d.package.path,e.env.PROJECT_FOLDER,j);P.command=a.command,P.commandArgs=a.commandArgs}else{const e=R.filter(e=>e).map(e=>(p.dataFiles.push(e.id),e.save()));for(let t=0;t<e.length;t++)await e[t],R[t]&&R[t].getModel&&A(f,"dataChange",{type:"insert",target:"DataFile",data:R[t].getModel()})}if("$ProjectFolder"===d.cwd)P.cwd=I+"/"+p.id;else if(d.cwd.match(/^\$ScriptFolder/))P.cwd=g.resolve(d.cwd.replace(/^\$ScriptFolder/,j));else if(0===d.cwd.indexOf("argv")){const e=d.cwd.split("."),t=parseInt(e[1]);if(isNaN(t))return await P.save(),void b.emit("taskError",P);if(!d.arguments[t]||"inFile"!==d.arguments[t].type||"Folder"!==d.arguments[t].format)return await P.save(),void b.emit("taskError",P);P.cwd=P.arguments[t].inFile}if(q.length>0){const e=[];for(let t=0;t<q.length;t++){const a=q[t];try{await h.ensureDir(a)}catch(t){e.push(t)}}if(e.length>0)return await P.save(),void b.emit("taskError",P)}await P.save();const B=await r.findOne({_id:P.id}).populate("owner outFiles inFiles task project").exec(),G=B.getModel(B.project.getPrivilege(m));if(A(f,"dataChange",{type:"insert",target:"Result",data:G}),0==P.status){let t;if(d.proxy&&d.proxy.enabled&&(t=await M(P.id,d.proxy.port||void 0),!t)){b.emit("taskError",P);continue}P.env={PROJECT_FOLDER:e.env.PROJECT_FOLDER,SHARED_FOLDER:g.resolve(I,"shared"),PACKAGE_FOLDER:d.package?d.package.path:e.env.PACKAGE_FOLDER,TASK_ID:d.id,TASK_KEY:d.key,TASK_NAME:u(d.name,{condense:!0}),DOCKER_PATH:e.env.DOCKER_PATH,RESULT_ID:P.id,BDP_SYSTEM_FOLDER:process.env.BDP_SYSTEM_FOLDER,BDP_HOST_PORT:t},P.extDirs=D,await C.addToQueue(P)}w.push(P.id),e.results[t][o]=P.id,e.resultStatus[t][o]=0}const P=await r.findOneAndUpdate({_id:e.id},{children:e.results},{new:!0}).populate("owner outFiles inFiles task").exec();P&&A(f,"dataChange",{type:"update",target:"Result",data:P.getModel()}),p.results.push.apply(p.results,w),await p.save(),await o.updateOne({},{workflowProcess:y})}catch(e){console.log(e)}};b.on("taskFinished",e=>{if(e.parent){const t=y[e.parent];if(!t)return;const a=t.progress,s=t.mapper[a].map(e=>e.id);if(t.results[a].forEach((s,i)=>{s===e.id&&(t.resultStatus[a][i]=e.status)}),t.resultStatus[a].filter(e=>2===e).length===s.length){t.progress++;const e={};e["workflowProcess."+t.id]=t,async function(){if(await o.update({},e).exec(),t.progress<t.mapper.length)q(t).catch(e=>console.log(e));else if(t.progress===t.mapper.length){const e=await r.findOne({_id:t.id}).populate("owner inFiles outFiles task").exec();e&&await L(e)}}().catch(e=>console.log(e))}}}),b.on("taskError",e=>{if(e&&e.parent){console.log("Workflow Error");const t=y[e.parent];if(t){const a=t.progress;t.results[a].forEach((s,i)=>{s===e.id&&(t.resultStatus[a][i]=e.status)})}(async function(){const t=await r.findOne({_id:e.parent}).populate("owner inFiles outFiles task").exec();await V(t)})().catch(e=>console.log(e))}});const L=async function(e,t,a){e.timer.push(new Date),t&&(e.stdOut=t),a&&(e.stdErr=a),await l.finishRun(e.id);const s=await c.findOne({_id:e.project}).exec(),i=s?s.getListeners():[],r=e.owner.getSlimModel(),n=e.outFiles,d=[];for(const e of n){if(!await e.checkFile()){d.push(e.id);continue}const t=e.getModel();t.owner=r,A(i,"dataChange",{type:"update",target:"DataFile",data:t})}e.status=0===d.length?2:3,d.length>0&&(e.error||(e.error={}),e.error.notes=["The task is correctly executed BUT NOT ALL outputs are generated. Please check if the corresponding task is correctly configured."]);const p=await e.save(),u=e.name?e.name:e.id;if(A(i,"dataChange",{type:"update",target:"Result",data:p.getModel()}),e.parent||2!==e.status?e.parent||3!==e.status||A(i,"message",D("34",{details:`The task: <b>${e.task?e.task.name:"(unknown)"}</b> is failed.Some output files are not existed as expected.Please see the error messages on the result page (<b>${u}</b>)`})):A(i,"message",D("33",{details:`The task: <b>${e.task?e.task.name:"(unknown)"} </b> is performed and finished.The result, <b>${u}</b> , is created and ready for visualization.`})),"workflow"!==e.type)return 2===p.status?b.emit("taskFinished",e):b.emit("taskError",e);delete y[e.id],await o.update({},{workflowProcess:y})},V=async function(e,t,a,s){e.error=s,e.stdOut=t||"",e.stdErr=a||"",e.timer.push(new Date),e.status=3,await l.errorRun(e.id);const i=await c.findOne({_id:e.project}).exec(),r=i?i.getListeners():[],n=e.outFiles,d=n.map(e=>e.checkFile());for(let e=0;e<n.length;e++)await d[e],A(r,"dataChange",{type:"update",target:"DataFile",data:n[e].getModel()});const p=await e.save(),u=p.name?p.name:p.id;A(r,"dataChange",{type:"update",target:"Result",data:p.getModel()}),e.parent||A(r,"message",D("34",{details:`The task: <b>${e.task&&e.task.name?e.task.name:"(unknown)"}</b> is failed.Please see the error messages on the result info page (<b>"${u}</b>)`,attached:s})),e.parent||"workflow"!==e.type?b.emit("taskError",e):(delete y[e.id],await o.update({},{workflowProcess:y}).exec())};try{const e=await o.findOne({});if(e){const a=e.processing,s=e.taskQueue,i=e.workflowProcess,r=[],o=Object.keys(a);for(let e=0;e<o.length;e++){const t=a[o[e]];r.push(t)}if(i){const e=Object.keys(i);if(e.length>0)for(let t=0;t<e.length;t++){const a=i[e[t]];y[a.id]=a}}s.forEach(e=>{r.push(e)}),t=r,e.taskQueue=t,e.processing={},0===e.taskQueue.length&&(e.workflowProcess={}),e.markModified("processing"),await e.save(),N().catch(e=>console.log(e))}else{const e=new o;await e.save()}}catch(e){console.log(e)}return C}},function(e,t,a){var s=a(0),i=a(60),r=s.model("taskQueue",i);e.exports=r},function(e,t,a){const s=a(0),i=s.Schema,r=new s.Schema({taskQueue:[],processing:{type:i.Types.Mixed,default:{}},workflowProcess:{type:i.Types.Mixed,default:{}}});e.exports=r},function(e,t){e.exports=require("events")},function(e,t,a){const s=a(3),i=a(23),r=a(27),o=a(63).Strategy,n=a(64).Strategy;e.exports=function(e){const t=e.chiConfig,c=e.io,d=e.helpers,l=d.chiAsyncWrap,p=d.sendVerifyEmail,u=d.reCAPTCHA,h=d.getCode,g=d.getAuthAsync,f=s.Router(),m=a(6);i.serializeUser((function(e,t){t(null,{id:e.id,auth:e.auths.base})})),i.deserializeUser((function(e,t){m.findById(e.id,(function(e,a){t(e,a)}))})),i.use("local",new n({usernameField:"email",passwordField:"passwd"},(function(e,t,a){m.findOne({email:e},(function(e,s){return e?a(e):s&&s.verifyPassword(t)?a(null,s):a(null,!1)}))})));const w=function(e,t){return new Promise((a,s)=>{e.login(t,e=>e?s([h("a009",{details:"Failed to login. Please try again.",attached:e})]):a())})};if(t.GoogleAuth&&t.GoogleAuth.clientID&&t.GoogleAuth.clientSecret){let e="";e=0===t.serverConfig.site_domain.indexOf("http://")&&80===t.serverConfig.port||0===t.serverConfig.site_domain.indexOf("https://")&&443===t.serverConfig.port?t.serverConfig.site_domain+"/account/auth/google/callback":t.serverConfig.site_domain+":"+t.serverConfig.port+"/account/auth/google/callback",i.use(new o({clientID:t.GoogleAuth.clientID,clientSecret:t.GoogleAuth.clientSecret,callbackURL:e},(function(e,t,a,s){const i=a.emails[0].value,r=a.displayName;m.findOne({email:i},(function(o,n){if(n){if(-1!==n.providers.indexOf("Google"))return s(o,n.getModel());n.providers.push("Google"),n.providerIDs.Google={id:a.id,accessToken:e,refreshToken:t},n.save((function(){return s(o,n.getModel())}))}else{new m({email:i,name:r,auths:{base:1},providerIDs:{Google:{id:a.id,accessToken:e,refreshToken:t}},providers:["Google"]}).register().then(e=>s(null,e)).catch(e=>{s(e)})}}))}))),f.get("/auth/google",i.authenticate("google",{scope:["email","openid"]})),f.get("/auth/google/callback",i.authenticate("google",{failureRedirect:"/account/signIn"}),(function(e,t){t.redirect("/project/list")}),(function(e,t,a,s){e&&(console.log("XD"),console.log(e)),s()}))}return f.post("/register",l(async e=>{const a={errors:[]},s=e.body.token;if(t.reCaptcha&&t.reCaptcha.reCaptchaSecret){if(!(await u(s)).success)throw[h("a004",{name:"reCaptcha challenge failed",details:"We do not accept a robot to sign up our site."})]}const i=await new m({email:e.body.email,passwd:e.body.passwd,providers:["local"]});await i.register();const r=await i.setAuthToken();return t.email&&t.email.smtpConfig?await p(r.email,r.authToken):9!==i.auths.base&&(i.auths.base=1,await i.save()),await w(e,r),a.success=await r.signIn(),a})),f.get("/email-resend",l(async e=>{const a={errors:[]};if(!e.isAuthenticated())throw[h("a011")];const s=e.session.passport.user.id,i=await m.findById(s);if(!i)return e.logout(),a.success={isLoggedIn:!1},a;if(0!==i.auths.base||!t.email||!t.email.smtpConfig)throw 0===i.auths.base?(i.auths.base=1,await i.save(),c.to(i.id).emit("dataChange",{type:"update",target:"User",data:i.getModel()}),[h("a008")]):[h("a008")];return await p(i.email,i.authToken),a.success={resend:!0},a})),f.get("/email-verify",l(async(e,t)=>{const a=e.query.authToken;if(void 0!==e.query.authToken){const e=await m.findOne({authToken:a});if(e)if(0===e.auths.base){try{await e.verifyEmail(a)}catch(e){if(!Array.isArray(e))throw e;t.redirect("/account/email-verifying?code="+e[0].code)}t.redirect("/account/email-verifying?code=a006")}else t.redirect("/account/email-verifying?code=a008");else t.redirect("/account/email-verifying?code=a004")}else t.redirect("/account/email-verifying")})),f.post("/rename",l(async e=>{const t={errors:[]};if(!e.isAuthenticated())throw[h("a011")];const a=e.session.passport.user.id,s=e.body.newName,i=await m.findById(a);if(!i)throw[h("a015",{details:"The user account does not exist. Please check if you use the correct user ID."})];return s?s.length>60?t.errors.push(h("a022",{details:"The new name is too long. Please use a name with fewer than 61 characters."})):s.length<2?t.errors.push(h("a022",{details:"The new name is too short. Please use a name with more than 5 characters."})):(i.name=s,await i.save(),t.success=i.getModel()):t.errors.push(h("a022",{details:"The new name is empty. Please specify at least 6 characters as your name."})),t})),f.get("/checkSignIn",l(async e=>{const t={errors:[]};if(!e.isAuthenticated())return e.logout(),t.success={isLoggedIn:!1},t;e.session.touch();const a=await m.findById(e.session.passport.user.id);return a?t.success=await a.signIn():(e.logout(),t.success={isLoggedIn:!1}),t})),f.get("/signOut",l(async e=>{if(e.isAuthenticated()){const t=e.session.passport.user.id;await m.update({_id:t},{$set:{isLoggedIn:!1}})}e.logout();const t={errors:[],success:{isLoggedIn:!1}};return t})),f.post("/signIn",l(async(e,a,s)=>{const r={errors:[]},o=e.body.token;if(t.reCaptcha&&t.reCaptcha.reCaptchaSecret){if(!(await u(o)).success)throw[h("a004",{name:"reCaptcha challenge failed",details:"We do not accept a robot to sign up our site."})]}const n=await function(e,t,a,s){return new Promise((r,o)=>{i.authenticate(e,(e,t)=>e?o([h("a009",{details:"Failed to authenticate your account. Please try again.",attached:e})]):r(t))(t,a,s)})}("local",e,a,s);if(!n)throw[h("a009")];return await w(e,n),r.success=await n.signIn(),r})),f.get("/api/login",r(),l(async e=>{const t=e.query.authToken.toString();if(!t)throw[h("a009")];const a=await m.findOne({authToken:t});if(!a)throw[h("a009",{details:"Invalid auth token."})];const s=a.authTime;if(((new Date).getTime()-s.getTime())/864e5>7)throw[h("a009",{details:"The auth token is expired."})];if(!a.auths||a.auths.base<2||a.auths.bdp<2)throw[h("a009",{details:"Sorry, you do not have privileges to login with the authToken."})];return await w(e,a),{errors:[],success:await a.signIn()}})),f.get("/api/search",l(async e=>{const t={errors:[]},a=decodeURIComponent(e.query.q),s=e.session.passport.user.id;await g(s,"base",2);const i=new RegExp(a),r=await m.find({name:{$regex:i,$options:"i"}});return t.success=r.map(e=>e.getSlimModel()),t})),f.get("/api/getAuthToken",l(async e=>{if(!e.isAuthenticated())throw[h("12")];const t=e.session.passport.user.id;let a=await g(t,"base",2);if(a.auths.bdp<2)throw[h("a017",{details:"Sorry, you do not have enough priviledges to get the auth token."})];const s=a.authTime;return((new Date).getTime()-s.getTime())/864e5>3&&(a=await a.setAuthToken()),{errors:[],success:a.authToken}})),f}},function(e,t){e.exports=require("passport-google-oauth20")},function(e,t){e.exports=require("passport-local")},function(e,t,a){const s=a(3),i=a(0),r=a(9),o=a(24),n=a(5),c=a(4),d=a(8),l=a(13),p=a(6),u=a(2),h=a(1);e.exports=function(e){const t=e.chiConfig,a=e.io,g=e.helpers,f=g.chiAsyncWrap,m=g.getAuthAsync,w=e.taskRunner,y=g.getCode,k=t.system.dataFilePath,v=t.system.taskLogFolder,b=s.Router();return b.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(y("a011")),t.json(s);a()}),b.get("/api/task/list",f(async e=>{const t=e.session.passport.user.id;return await m(t,"bdp",8),{errors:[],success:(await r.find({}).exec()).map(e=>e.getModel())}})),b.get("/api/account/list",f(async e=>{const t=e.session.passport.user.id;return await m(t,"base",9),{errors:[],success:(await p.find({}).exec()).map(e=>e.getModel())}})),b.post("/api/user/:userId/approve",f(async e=>{const t={errors:[]},s=e.session.passport.user.id,r=parseInt(e.body.auth),o=e.body.authField?e.body.authField:"base",n=e.params.userId;if(isNaN(r))throw[y("a018")];if(s&&!i.Types.ObjectId.isValid(s))throw[y("a015",{details:"Invalid user id to change authority."})];await m(s,"base",9);const c=await p.findOne({_id:n}).exec();if(!c)throw[y("901")];if("base"===o&&9===c.auths[o])throw[y("a018",{details:"You may not change the admin's user auth."})];if(void 0===c.auths[o])throw[y("a018",{details:"Unknown user auth settings."})];if(isNaN(r))throw[y("a018",{details:"The user auth value should be a number."})];if(r>9)throw[y("a018",{details:"The user auth value should be less than 9."})];return c.auths[o]=r,await c.save(),t.success=c.getModel(),a.to(n).emit("dataChange",{type:"update",target:"User",data:t.success}),t})),b.delete("/api/user/:userId",f(async e=>{const t=e.session.passport.user.id,a=e.params.userId;if(!i.Types.ObjectId.isValid(a))throw[y("a015",{details:"The user id you request is invalid. Please check if you use the correct user id."})];if(await m(t,"base",9),t===a)throw[y("a018",{details:"Sorry Administrator can not be deleted."})];const s=await p.findOne({_id:a}).exec();if(!s)throw[y("a015",{details:"The user id you request is invalid. Please check if you use the correct user id."})];const r=await d.find({owner:a}).exec();if(r.length>0)for(let e=0;e<r.length;e++){const t=r[e];0===t.status?await w.deleteTaskInQueue(t.id):1===t.status&&-1!==t.pid&&await w.stopRunningTask(t.pid)}await n.remove({owner:a}).exec(),await d.remove({owner:a}).exec();try{await u.remove(h.resolve(k,a))}catch(e){throw[y("s001",{name:"Delete user folder failed",details:"You may want to delete the folder manually. The path: "+k,attached:e})]}return await s.remove(),{errors:[],success:s.getModel()}})),b.get("/api/tasklogs/cleanups",f(async e=>{const t=e.session.passport.user.id;await m(t,"base",9);const a=await d.find({}),s=await u.readdir(v),i=a.map(e=>e.id);let r=0;for(let e=0;e<s.length;e++){const t=s[e];i.indexOf(t)<0&&(r++,await u.remove(h.join(v,t)))}return{errors:[],success:{msg:r+" tasklog folders were removed."}}})),b.get("/api/temp/project_packages",f(async e=>{const t=e.session.passport.user.id;await m(t,"base",9);const a=await c.find();for(let e=0;e<a.length;e++){const t=a[e];t.packages=[t.package],await t.save()}return{errors:[],success:"ok"}})),b.get("/api/result/history/:range",f(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.range;let i;if(-1===["latest","week","twoWeeks","fourWeeks"].indexOf(s)&&(i=s.split("-"),2!==i.length))throw[y("903",{name:"Unknown date range",details:"The "+s+" is not a known range to request result histories. Please check again."})];if(await m(a,"bdp",9),"latest"===s){const e=await l.find().sort({createdAt:-1}).limit(20).populate("user").exec(),a=[];for(let t=0;t<e.length;t++){const s=e[t],i={id:s.id,title:s.title,desc:s.desc,status:s.status,timer:s.timer,taskName:s.taskName,projectName:s.projectName,projectDesc:s.projectDesc,project:s.project,result:s.result,user:s.user?s.user.getModel():"(deleted user)",createdAt:s.createdAt,updatedAt:s.updatedAt};a.push(i)}t.success=a}else{const e=(new Date).getTime();let a,r;switch(s){case"week":a=new Date(e-6048e5);break;case"twoWeeks":a=new Date(e-12096e5);break;case"fourWeeks":a=new Date(e-24192e5);break;default:i?(a=new Date(Number(i[0])),r=new Date(Number(i[1]))):a=new Date(e-6048e5)}r||(r=new Date);const o=await l.find({createdAt:{$gte:a,$lte:r}}).sort({createdAt:-1}).populate("user").exec(),n=[];for(let e=0;e<o.length;e++){const t=o[e],a={id:t.id,title:t.title,desc:t.desc,status:t.status,timer:t.timer,taskName:t.taskName,projectName:t.projectName,projectDesc:t.projectDesc,project:t.project,result:t.result,user:t.user?t.user.getModel():t.user,createdAt:t.createdAt,updatedAt:t.updatedAt};n.push(a)}t.success=n}return t})),b.get("/api/system-errors/list",f(async e=>{const t=e.session.passport.user.id;return await m(t,"base",9),{errors:[],success:(await o.find({}).sort({createdAt:-1}).populate("account")).map(e=>e.getModel())}})),b.delete("/api/system-errors/:sysErrId/remove",f(async e=>{const t=e.session.passport.user.id,s=e.params.sysErrId;if(!i.Types.ObjectId.isValid(s))throw[y("s004")];await m(t,"base",9);const r=await o.deleteOne({_id:s});return a.to(t).emit("dataChange",{type:"remove",target:"system-error",data:s}),{errors:[],success:r}})),b.delete("/api/system-errors/all",f(async e=>{const t=e.session.passport.user.id;return await m(t,"base",9),{errors:[],success:await o.deleteMany({})}})),b}},function(e,t,a){const s=a(3),i=a(0),r=a(4),o=a(10),n=a(8),c=a(5),d=a(6),l=a(7),p=a(28),u=a(1),h=a(2),g=a(29);e.exports=function(e){const t=e.chiConfig,a=t.system.dataFilePath,f=e.helpers,m=f.chiAsyncWrap,w=f.getCode,y=f.getAuthAsync,k=f.getProjectByID,v=f.socketBroadcast,b=f.makeResultDeleted,x=f.makeDataFileDeleted,S=p.diskStorage({destination:function(e,a,s){s(null,u.resolve(t.system.uploadFolder))},filename:function(e,t,a){a(null,"Data-"+Date.now())}}),O={fileSize:t.system.fileLimits||1/0},I=p({storage:S,limits:O}).array("file"),j=s.Router();return j.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(w("a011")),t.json(s);a()}),j.post("/api/create",m(async e=>{const t=e.session.passport.user.id,s=await y(t,"base",2),i=e.body.projectName,n=e.body.projectDesc,c=e.body.projectPackages,d=(await o.find({_id:c})).filter(e=>!(s.auths.base<8&&e.scope.indexOf("admin")>=0)&&e.scope.indexOf("utility")<0),l=new r({name:i,owner:t,desc:n,packages:c.map(e=>d.filter(t=>t.id===e)[0]).filter(e=>!!e).map(e=>e.id),dataFiles:[],results:[],managers:[],runners:[],viewers:[]});await h.ensureDir(u.resolve(a+"/"+l.id)),await l.save();const p=await k(l.id);return{success:p.getModel(p.getPrivilege(s)),errors:[]}})),j.post("/api/:pid/upload",m(async(e,a)=>{const s={errors:[]},r=e.session.passport.user.id,o=e.params.pid;if(!i.Types.ObjectId.isValid(o))throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];const n=await y(r,"bdp",2),d=await k(o);if(!d)throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(!d.getPrivilege(n).canAddFile)throw[w("38",{details:"Sorry, you can not create data files in this project."})];const l=d.packages;try{await((e,t)=>new Promise((a,s)=>I(e,t,e=>e?s(e):a())))(e,a)}catch(t){for(const t of e.files)await h.unlink(t.path);throw[w("13",{code:13,name:"File upload failed",attached:t})]}const p=e.body.folder?e.body.folder:null,g="true"===e.body.keepFileName,f=e.body.tags?e.body.tags.split(","):[],m=e.body.name||"",b=e.body.desc||"",x=e.body.prefix||"",S=e.body.suffix||"",O=[],j=[],F=await c.findOne({_id:p}).exec();for(let a=0;a<e.files.length;a++){const s=e.files[a],i=s.originalname,p=s.path,y=[...new Set([].concat.apply([],d.packages.map(e=>e.allowedFormats)))].map(e=>e.toString());let k=!1,I="",P=[];for(let e=0;e<y.length;e++){const t=y[e].replace(/\./g,"\\.").replace(/\-/g,"\\-").replace(/\_/g,"\\_"),a="*"===t?new RegExp(".*\\.(.*)$"):new RegExp(".*("+t+")$"),s=i.match(a);if(s){k=!0,I=s[1];for(let e=0;e<l.length;e++){const t=l[e].formatMapping;for(let e=0;e<t.length;e++){const a=t[e];if(a.ext===I){P=a.tags;break}}}break}}if(!k){await h.remove(p),console.log(i),O.push(w("16",{details:"The file ,"+i+", is invalid. Please check the format."}));continue}let T="";Array.isArray(f)&&(P.push.apply(P,f.map(e=>e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim())),P=P.filter(e=>!!e));const D=new c({name:m&&m.slice?m.slice(0,80):u.basename(i,"."+I),desc:b&&b.slice?b.slice(0,300):"",format:I,owner:r,project:o,tags:P,readOnly:!0,prefix:x.slice(0,36),suffix:S.slice(0,36)});if(F&&"Folder"===F.format?(D.parent=F.id,T=g?u.resolve(F.path+"/"+i):u.resolve(F.path+"/"+D.id+"."+I)):T=u.resolve(t.system.dataFilePath,o,D.id+"."+I),await h.pathExists(T)){O.push(w("604",{details:`The file name '${i}' has being used. Please change the file name and upload again.`})),await h.remove(p);continue}try{await h.stat(T)}catch(e){if("EEXIST"===e.code){D.status=3,await h.remove(p),O.push();continue}if("ENOENT"!==e.code){D.status=3,h.remove(p),O.push(w("604",{details:`The file '${i}' failed to be uploaded. Please try again.`,attached:e}));continue}try{await h.copy(u.resolve(p),T,{overwrite:!1}),await h.remove(p)}catch(e){await h.remove(p),O.push(w("605",{attached:e}));continue}}d.dataFiles.push(D.id),D.path=T,D.status=1,D.readOnly=!1,await D.save(),await d.save();const $=D.getModel();$.owner=n.getSlimModel(),$.project=o,v(d.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:$}),j.push($)}return s.errors=O,s.success=j,s})),j.post("/api/:pid/createFolder",m(async e=>{const t={errors:[]},s=e.session.passport.user.id,o=e.params.pid,n=e.body.folder||"",d=e.body.keepFileName,l=e.body.prefix||"",p=e.body.suffix||"",f=e.body.tags,m=e.body.name;if(!i.Types.ObjectId.isValid(o))throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(n&&!i.Types.ObjectId.isValid(n))throw[w("19",{details:`Sorry, we could not find valid parent id: ${n}.`})];const k=await y(s,"bdp",2),b=await r.findOne({_id:o}).populate("dataFiles results");if(!b)throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(!b.getPrivilege(k).canAddFile)throw[w("38",{details:"Sorry, you do NOT have privileges to create folders in this project."})];let x;if(n&&(x=await c.findOne({_id:n}),!x||"Folder"!==x.format))throw[w("19",{details:`Sorry, we could not find valid parent id: ${n}.`})];let S=[];Array.isArray(f)&&S.push.apply(S,f.map(e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim())),S=[...new Set(S)].map(e=>e.toString()),S.indexOf("Folder")<0&&S.unshift("Folder");const O=new c({name:m,format:"Folder",owner:s,project:o,tags:S,readOnly:!1,prefix:l.slice(0,36),suffix:p.slice(0,36)});let I=u.resolve(`${a}/${o}/${O.id}`);if(x){O.parent=x.parent?x.parent:x.id;const e=g(m,{replacement:"_"})||O.id;I=d?u.resolve(x.path,e):u.resolve(x.path,O.id)}await h.ensureDir(I),O.path=I,O.status=1;const j=(await O.save()).getModel();return t.success=j,b.dataFiles.push(O.id),await b.save(),v(b.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:j}),t})),j.post("/api/:pid/importFromPath",m(async(e,t)=>{const s={errors:[]},o=e.session.passport.user.id,n=e.params.pid,d=e.body.directLink;let p=e.body.importedPath;const g=e.body.name,f=e.body.prefix||"",m=e.body.suffix||"",k=e.body.desc||"",b=e.body.keepFileName,x=e.body.folder||"",S=e.body.tags;if(!p)throw[w("605",{name:"Data File creation failed",details:"The folder path is empty."})];if(!i.Types.ObjectId.isValid(n))throw[w("19",{name:"Invalid project ID",details:`We can not find the project id: ${n}. please check if this is the right ID.`})];if(x&&!i.Types.ObjectId.isValid(x))throw[w("19",{name:"Invalid parent folder ID",details:`The parent folder id, ${x}, is invalid. please check if this is the right ID.`})];const O=await y(o,"bdp",3),I=await r.findOne({_id:n}).populate("packages").exec();if(!I)throw[w("19",{details:`We can not find the project id: ${n}. please check if this is the right ID.`})];if(!I.getPrivilege(O).canAddFile)throw[w("38",{details:"Sorry, you do NOT have privileges to create folders in this project."})];let j;if(x&&(j=await c.findOne({_id:x}),!j||"Folder"!==j.format))throw[w("19",{name:"Invalid parent folder ID",details:`We can not find the valid parent folder id: ${x}. please check if this is the right ID.`})];const F=I.getListeners();let P;try{P=await h.stat(p),p=await h.realpath(p)}catch(e){throw[w("605",{details:"The folder does not exist or cannot be accessed.",attached:e})]}const T=u.parse(p),D=T.name,$=T.base,A=T.ext.replace(".","");let _=[];const M=[...new Set([].concat.apply([],I.packages.map(e=>e.allowedFormats)))].map(e=>e?e.toString():e);if(!P.isDirectory()){let e=!1;for(let t=0;t<M.length;t++){const a=M[t].replace(/\./g,"\\.").replace(/\-/g,"\\-").replace(/\_/g,"\\_"),s="*"===a?new RegExp(".*\\.(.*)$"):new RegExp(".*("+a+")$");if($.match(s)){e=!0;break}}if(!e)throw[w("605",{details:`The file, ${$}, has invalid extension.`})];if(Array.isArray(I.packages)&&I.packages.length>0){const e=[].concat.apply([],I.packages.map(e=>e.formatMapping));e&&e.length>0&&(_=e.filter(e=>e.ext===A).map(e=>e.tags)[0]||[])}}const C=new c({name:g?g.slice(0,80):D.slice(0,80),prefix:f.slice(0,36),suffix:m.slice(0,36),desc:k.slice(0,300),owner:o,project:n,tags:[],readOnly:!1,status:0});if(Array.isArray(S)){_.push.apply(_,S.map(e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim())),_=_.filter(e=>null!=e||""!==e);const e=_.indexOf("Folder");e>=0&&_.splice(e,1)}_=[...new Set(_)].map(e=>e.toString()),P.isDirectory()?(C.format="Folder",_.unshift("Folder")):C.format=A,C.tags=_;let E=u.resolve(a,n,C.id);if(j&&(C.parent=j.id,E=b?u.join(j.path,D):u.join(j.path,C.id)),"Folder"!==C.format&&(E+="."+A),C.path=E,await h.pathExists(E))throw[w("605",{details:`The path, ${E}, is already existed.`})];await C.save();const N=C.getModel();if(N.owner=O.getSlimModel(),I.dataFiles.push(C.id),await I.save(),s.success=N,v(F,"dataChange",{type:"insert",target:"DataFile",data:s.success}),t.json(s),!l(p,a)&&!d){let e=u.resolve(a,"shared",C.id);P.isDirectory()||(e+="."+A);try{await h.ensureDir(u.resolve(a,"shared")),await h.copy(p,e,{dereference:!0})}catch(t){return await h.remove(e),await C.remove(),console.log(t),void console.log("Failed")}p=e}try{d?P.isDirectory()?await h.ensureSymlink(p,E,"junction"):await h.ensureSymlink(p,E):await h.ensureSymlink(u.relative(u.dirname(E),p),E)}catch(e){return console.log(e),await h.remove(E),void await C.remove()}C.status=1,C.realPath=p,await C.save();const R=C.getModel();return R.owner=O.getSlimModel(),v(F,"dataChange",{type:"update",target:"DataFile",data:R}),!1})),j.post("/api/:pid/importFromDataFile",m(async(e,t)=>{const s=e.session.passport.user.id,o=e.params.pid,n=e.body.fileIDs,d=!!e.body.copy;if(!n||0===n.length)throw[w("605",{name:"Data File creation failed",details:"No data file to import."})];if(!i.Types.ObjectId.isValid(o))throw[w("19",{name:"Invalid project ID",details:`We can not find the project id: ${o}. please check if this is the right ID.`})];const p=await y(s,"bdp",2),g=await r.findOne({_id:o}).exec();if(!g)throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(!g.getPrivilege(p).canAddFile)throw[w("38",{details:"Sorry, you do NOT have privileges to create folders in this project."})];const f=g.getListeners(),m=p.getSlimModel(),k=(await c.find({_id:{$in:n}}).populate("project").exec()).filter(e=>e.project&&e.project.getPrivilege&&e.project.id!==o&&e.project.getPrivilege(p).canView&&1===e.status),b=[],x=[];for(let e=0;e<k.length;e++){const t=k[e],i=new c({name:t.name,owner:s,project:o,tags:t.tags,format:t.format,readOnly:t.readOnly,prefix:t.prefix||"",suffix:t.suffix||"",status:0});i.path=u.resolve(`${a}/${o}/${i.id}`),"Folder"!==t.format&&(i.path=i.path+"."+t.format),await i.save(),g.dataFiles.push(i.id),x.push({targetModel:i,sourceModel:t});const r=i.getModel();r.owner=m,r.project=o,v(f,"dataChange",{type:"insert",target:"DataFile",data:r}),b.push(r)}await g.save(),t.json({errors:[],success:b});for(const e of x){const t=e.targetModel,s=e.sourceModel,i=s.path,r=t.path;try{const e=await h.lstat(i);if(e.isDirectory()&&!d)await h.ensureSymlink(i,r,"junction"),t.realPath=i;else if(e.isSymbolicLink()){const e=await h.realpath(i);d?await h.copy(e,r):l(e,u.join(a,"shared"))?await h.ensureSymlink(u.relative(u.dirname(r),e),r):await h.ensureSymlink(e,r,"junction"),t.realPath=e}else if(d)await h.copy(i,r);else{let e=u.resolve(a,"shared",s.id);if("Folder"!==s.format&&(e=e+"."+s.format),await h.pathExists(e))throw[w("605",{name:"The shared source file already existed.",details:`Please contact the system admin. The source path: ${e}.`})];await h.move(i,e,{dereference:!0}),await h.ensureSymlink(u.relative(u.dirname(i),e),i),s.realPath=e,await s.save(),t.realPath=e,await h.ensureSymlink(u.relative(u.dirname(r),e),r)}t.status=1}catch(e){console.log(e),t.status=4}await t.save();const n=t.getModel();n.owner=m,n.project=o,v(f,"dataChange",{type:"update",target:"DataFile",data:n})}return!1})),j.get("/api/searchList",m(async e=>{const t={errors:[],success:[]},a=e.session.passport.user.id,s=await y(a,"bdp",2),i=decodeURIComponent(e.query.q),o=new RegExp(i);let n={};void 0===e.query.q||""==e.query.q?(n={$or:[{owner:a},{managers:a},{runners:a},{viewers:a}]},9===s.auths.bdp&&(n={})):(n={$and:[{name:{$regex:o,$options:"i"}},{$or:[{owner:a},{managers:a},{runners:a},{viewers:a}]}]},9===s.auths.bdp&&(n={name:{$regex:o,$options:"i"}}));const c=await r.find(n).populate("owner").exec();return t.success=c.map(e=>({id:e.id,name:e.name,owner:e.owner?e.owner.name:"Unknown",privilege:e.getPrivilege(s)})),t})),j.get("/api/list",m(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=void 0!==e.query.pageIndex?e.query.pageIndex:0,i=!isNaN(parseInt(e.query.pageSize))&&[2,5,10,30,50,100,300,500].indexOf(parseInt(e.query.pageSize))>=0?parseInt(e.query.pageSize):10,o=await y(a,"bdp",2),n=await r.countDocuments({owner:a}).exec(),c=n%i>0?Math.floor(n/i)+1:Math.floor(n/i),d=await r.find({owner:a}).sort({updatedAt:-1}).skip(i*s).limit(i).populate("owner managers runners viewers packages").populate({path:"packages",populate:{path:"owner"}}).exec();return t.success={records:d.map(e=>e.getModel(e.getPrivilege(o))),totalPage:c,pageIndex:s,totalCount:n,pageSize:i},t})),j.get("/api/sharedList",m(async e=>{const t=e.session.passport.user.id,a=void 0!==e.query.pageIndex?e.query.pageIndex:0,s=!isNaN(parseInt(e.query.pageSize))&&[5,10,30,50,100,300,500].indexOf(parseInt(e.query.pageSize))>=0?parseInt(e.query.pageSize):10,i=await y(t,"bdp",2),o=9===i.auths.bdp?{owner:{$ne:t}}:{$and:[{owner:{$ne:t}},{$or:[{managers:t},{runners:t},{viewers:t}]}]},n=await r.countDocuments(o).exec(),c=n%s>0?Math.floor(n/s)+1:Math.floor(n/s);return{errors:[],success:{records:(await r.find(o).sort({updatedAt:-1}).skip(s*a).limit(s).populate("owner managers runners viewers packages").populate({path:"packages",populate:{path:"owner"}}).exec()).map(e=>e.getModel(e.getPrivilege(i))),totalPage:c,pageIndex:a,totalCount:n,pageSize:s}}})),j.get("/api/publicList",m(async e=>{const t=e.session.passport.user.id,a=void 0!==e.query.pageIndex?e.query.pageIndex:0,s=!isNaN(parseInt(e.query.pageSize))&&[5,10,30,50,100,300,500].indexOf(parseInt(e.query.pageSize))>=0?parseInt(e.query.pageSize):10,i=await y(t,"bdp",2),o={public:!0},n=await r.countDocuments(o).exec(),c=n%s>0?Math.floor(n/s)+1:Math.floor(n/s);return{errors:[],success:{records:(await r.find(o).sort({updatedAt:-1}).skip(s*a).limit(s).populate("owner managers runners viewers packages").populate({path:"packages",populate:{path:"owner"}}).exec()).map(e=>e.getModel(e.getPrivilege(i))),totalPage:c,pageIndex:parseInt(a),totalCount:n,pageSize:s}}})),j.get("/api/:projectId/cleanup",m(async e=>{const t=e.session.passport.user.id,s=e.params.projectId,o=await y(t,"bdp",2);if(!i.Types.ObjectId.isValid(s))throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(o.id))throw[w("23",{details:"Please check if you use the correct userID."})];const d=await r.findOne({_id:s}).exec();if(!d)throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!d.getPrivilege(o).canEdit)throw[w("38",{details:"Sorry, you do not have privileges to process the cleanup procedure in this project."})];const l=d.dataFiles.map(e=>e.toString()),p=d.results.map(e=>e.toString()),u=await c.find({project:s}).exec(),h=u.map(e=>e.id),g=u.filter(e=>l.indexOf(e._id.toString())<0);for(let e=0;e<g.length;e++)await g[e].unlinkFileAndRemove();d.dataFiles=l.filter(e=>h.indexOf(e)>=0);const f=u.filter(e=>l.indexOf(e._id.toString())>=0);for(let e=0;e<f.length;e++)await f[e].ensureFile(a);const m=await n.find({project:s}).exec(),k=m.map(e=>e.id),v=m.filter(e=>p.indexOf(e._id.toString())<0);for(let e=0;e<v.length;e++)await b(v[e]);return d.results=p.filter(e=>k.indexOf(e)>=0),await d.save(),{errors:[],success:{orphanDataFiles:g.length,orphanResults:v.length,projectDataFiles:d.dataFiles.length,projectResults:d.results.length}}})),j.get("/api/:projectId",m(async e=>{const t=e.session.passport.user.id,a=e.params.projectId,s=await y(t,"bdp",2);if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(s.id))throw[w("23",{details:"Please check if you use the correct userID."})];const r=await k(a);if(!r)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const o=r.getPrivilege(s);if(!o.canView)throw[w("38",{details:"Sorry, you do not have privileges to view this project."})];return{errors:[],success:r.getModel(o)}})),j.patch("/api/:projectId",m(async e=>{const t=e.session.passport.user.id,a=e.params.projectId,s=e.body.name,n=e.body.desc,c=e.body.packageIDs,d=!!e.body.public;if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(t))throw[w("23",{details:"Please check if you use the correct userID."})];const l=c.map(e=>e&&i.Types.ObjectId.isValid(e)?e:null).filter(e=>null!==e),p=await y(t,"bdp",2),u=(await r.findOne({_id:a})).getPrivilege(p);if(!u.canEdit)throw[w("38",{details:"Sorry, you do not have privileges to view this project."})];let h;h=l.length>=1?await o.find({_id:{$in:l}}):[];const g=h.map(e=>e.id),f=h.map(e=>e.getPrivilege(p)),m={name:s,desc:n,public:d};m.packages=l.map(e=>{const t=g.indexOf(e);return t<0?null:f[t]&&f[t].canRun?e:null}).filter(e=>null!==e);const k=await r.findOneAndUpdate({_id:a},{$set:m},{new:!0}).populate("owner managers runners viewers packages").populate({path:"dataFiles",populate:{path:"owner"}}).populate({path:"results",populate:{path:"owner"}}).populate({path:"packages",populate:{path:"owner"}}).exec();if(!k)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];return{errors:[],success:k.getModel(u)}})),j.delete("/api/:projectId",m(async e=>{const t=e.session.passport.user.id,s=e.params.projectId;if(!i.Types.ObjectId.isValid(s))throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(t))throw[w("23",{desc:"Please check if you use the correct userID."})];const o=await y(t,"bdp",2),d=await r.findOne({_id:s}).populate("dataFiles").exec();if(!d)throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!d.getPrivilege(o).canDelete)throw[w("38",{details:"Sorry, you do NOT have privileges to delete this project."})];const l=await n.find({project:s}).populate("inFiles outFiles task").exec();for(const e of l)await b(e);const p=await c.find({project:s}).exec();for(const e of p)await x(e,d);await d.remove();const g=u.resolve(a+"/"+d.id);return await h.remove(g),{success:d.getModel(),errors:[]}})),j.post("/api/:projectId/setMembers",m(async e=>{const t=e.session.passport.user.id,a=e.params.projectId,s=e.body.changes,o=e.body.scope;if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:"The project ID is invalid, please check if this is the right ID."})];if(!s||0===s.length||!o||"runners"!==o&&"managers"!==o&&"viewers"!==o&&"owner"!==o)throw[w("402",{type:"warning",details:"No changing members. Please check if you input all correct member info."})];const n=await y(t,"bdp",2),c=await r.findOne({_id:a}).exec();if(!c)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const l=c.getPrivilege(n);if(!l.canSetMember||("owner"===o||"managers"===o)&&l.isManager)throw[w("38",{details:"Sorry, you do not have privileges to set members of this project."})];const p=s.map(e=>e.userID&&i.Types.ObjectId.isValid(e.userID)?e.userID:void 0).filter(e=>void 0!==e);if(0===p.length)throw[w("402",{type:"warning",details:"No changes."})];const u=c[o],h=await d.find({_id:{$in:p}}).exec();if(0===h.length)throw[w("402",{type:"warning",details:"No changes."})];for(let e=0;e<h.length;e++){const t=h[e];for(let e=0;e<s.length;e++){const a=s[e];if("owner"===o&&t.id===a.userID){"add"===a.action?c.owner=t.id:"remove"===a.action&&(c.owner=void 0);break}if(t.id===a.userID){if("add"===a.action&&u.indexOf(t.id)<0){c[o].push(t.id);break}if("remove"===a.action){const e=u.indexOf(t.id);e>=0&&c[o].splice(e,1)}}}}await c.save();const g=await k(a);if(!c)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const f=g.getPrivilege(n);if(!f.canView)throw[w("38",{details:"Sorry, you do not have privileges to view this project."})];return{errors:[],success:g.getModel(f)}})),j.get("/api/:projectId/relatedPackages",m(async e=>{const t=e.session.passport.user.id,a=e.params.projectId;if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(t))throw[w("23",{desc:"Please check if you use the correct userID."})];const s=await y(t,"bdp",2),n=await r.findOne({_id:a}).populate("dataFiles").exec();if(!n)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const c=await o.find({_id:{$in:n.packages}}).exec(),d=c.map(e=>e.getPrivilege(s)),l=c.filter((e,t)=>{const a=d[t];return a.canView||a.canRun}).map(e=>e.name.split("-").slice(0,-1).join("-"));l.push("all","utility");const p=await o.find({$or:[{_id:{$in:c.map(e=>e.id)}},{scope:{$in:l}}]}).exec(),u=[];for(let e=0;e<n.packages.length;e++){const t=n.packages[e].toString();for(let e=0;e<p.length;e++){if(p[e].id===t){u.push.apply(u,p.splice(e,1));break}}}return u.push.apply(u,p),{errors:[],success:u.filter(e=>!(e.scope.indexOf("admin")>=0)||s.auths.bdp>=8).map(e=>e.getModel(e.getPrivilege(s)))}})),j}},function(e,t,a){const s=a(3),i=a(0),r=a(9),o=a(5),n=a(1),c=a(14),d=a(8),l=a(4),p=a(2),u=a(10),h=a(68),g=a(22),f=a(13),m=h.createProxy({ws:!0});e.exports=function(e){const t=e.chiConfig,a=t.serverConfig,h=e.chiServer,w=e.proxyMapper,y=t.system.dataFilePath,k=t.system.taskLogFolder,v=t.system.docker_path,b=t.system.scriptFolder,x=e.helpers,S=x.chiAsyncWrap,O=x.getCode,I=x.issueAvailablePort,j=x.getAuthAsync,F=x.readTaskLogIndex,P=e.taskRunner,T=x.makeResultDeleted,D=x.makeResultStopped,$=x.getProjectByID,A=x.socketBroadcast,_=s.Router();return _.all("/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(O("a011")),t.json(s);a()}),_.get("/api/activities",S(async e=>{const t={errors:[],success:void 0},a=e.session.passport.user.id,s=e.query.pageIndex||0,i="shared"===e.query.type?"shared":"owner"===e.query.type?"owner":null;let r=parseInt(e.query.pageSize);r=!isNaN(r)&&[10,30].indexOf(r)>=0?r:10;const o=await j(a,"bdp",2),n={$or:[]};"shared"===i?n.$or.push({managers:a},{runners:a},{viewers:a}):"owner"===i?n.$or.push({owner:a}):n.$or.push({owner:a},{managers:a},{runners:a},{viewers:a});const c=await l.find(n).exec(),p=c.map(e=>e.results),u=[];for(let e=0;e<p.length;e++)Array.isArray(p[e])&&u.push.apply(u,p[e]);const h={};for(let e=0;e<c.length;e++){const t=c[e];h[t.id]=t.getPrivilege(o)}const g=await d.countDocuments({_id:{$in:u}}),f=g%r>0?Math.floor(g/r)+1:Math.floor(g/r),m=await d.find({_id:{$in:u},parent:{$exists:!1}}).sort({updatedAt:-1}).skip(r*s).limit(r).populate("owner inFiles outFiles task project").exec();return t.success={records:m.map(e=>{const t=P.getCurrentStdOutput(e.pid);return t&&(e.stdOut=t.stdOut,e.stdErr=t.stdErr),e.getModel(h[e.project.id])}),totalPage:f,pageIndex:s,totalCount:g,pageSize:r},t})),_.post("/api/task/:taskId/createResult",S(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.body.inputs,h=e.body.outputs,g=e.body.run,m=e.params.taskId,w=e.body.projectID,x=e.body.desc;let S=e.body.prefix||"",F=e.body.suffix||"";const T=e.body.name;if(!i.Types.ObjectId.isValid(m))throw[O("31")];if(!i.Types.ObjectId.isValid(w))throw[O("19",{details:`We can not find the project id: ${w}. please check if this is the right ID.`})];const D=await j(a,"bdp",2),$=await l.findOne({_id:w}).populate("package").exec();if(!$)throw[O("19")];if(!$.getPrivilege(D).canRun)throw[O("38",{details:"Sorry, you do not have privileges to run tasks in this project."})];const _=await r.findOne({_id:m}).exec(),M=await u.findOne({_id:_.package}).exec();if(!M)throw[O("19",{details:"We can not find the package of the task."})];if(!_)throw[O("31")];if("system"===_.type&&D.auths.bdp<8)throw[O("708")];S=S.replace(/\ +$/," ").replace(/^\ +/,""),F=F.replace(/^\ +/," ").replace(/\ +$/,"");const C=new d({name:T?T.trim():"Result from "+_.name,desc:x,type:_.type,task:_.id,taskSnapshot:_.getModel(),project:w,owner:a,script:_.script,cwd:_.cwd,status:g?"workflow"===_.type?1:0:-1,readOnly:!1,timer:[new Date],outFiles:[],inFiles:[],arguments:[],prefix:S,suffix:F});let E;if(_.proxy&&_.proxy.enabled&&(E=await I(C.id,_.proxy.port||void 0),!E))throw[O("32",{details:`Sorry the port ${_.proxy.port} is in use. Tyr using orther port numbers or a dynamic port`})];const N={PROJECT_FOLDER:n.resolve(y,$.id),SHARED_FOLDER:n.resolve(y,"shared"),PACKAGE_FOLDER:n.resolve(M.path),TASK_ID:_.id,TASK_KEY:_.key,TASK_NAME:c(_.name,{condense:!0}),TASKLOG_FOLDER:k,DOCKER_PATH:v,BDP_SYSTEM_FOLDER:process.env.BDP_SYSTEM_FOLDER,BDP_HOST_PORT:E,RESULT_ID:C._id.toString()};for(let e=0;e<_.arguments.length;e++){"inFile"==_.arguments[e].type&&C.inFiles.push(s[e])}const R=[],q=await o.find({_id:{$in:C.inFiles}}),L={},V={};for(const e of q)1===e.status&&(L[e.id]=e.path),e.realPath&&R.push(e.realPath),V[e.id]=e;const W=[];for(let e=0;e<_.arguments.length;e++){const t=_.arguments[e];if("value"===t.type){if("number"===t.format){if(!(null!==s[e]&&void 0!==s[e]||t.optional)){W[e]={type:"Can not be empty",data:s[e]};continue}if(isNaN(parseFloat(s[e]))){W[e]={type:"Number required",data:s[e]};continue}}C.arguments[e]={value:s[e]}}else if("static"===t.type)C.arguments[e]={static:t.default[0]};else if("inFile"===t.type){let a=L[s[e]];if(!a&&!t.optional){W[e]={type:"File not available",data:V[s[e]]};continue}!a&&t.optional&&(a=""),C.arguments[e]={inFile:a}}else if("list"===t.type){if(null===s[e]||void 0===s[e]){if(!t.optional){W[e]={type:"Can not be empty",data:s[e]};continue}s[e]=[]}else if("[object Array]"===Object.prototype.toString.call(s[e])&&0===s[e].length&&!t.optional){W[e]={type:"Can not be empty",data:s[e]};continue}C.arguments[e]={list:s[e]}}}if(W.length>0)throw[O("32",{attached:W})];const z=_.outputProvider(),B=[],G=[],U={};for(let e=0;e<z.length;e++){const t=z[e].index;U[z[e].index]=e;const i=new o(z[e]);let r="",c="";if(z[e].dependOn&&z[e].default){let t="";const a=z[e].dependOn.split(".");if("argv"!==a[0]){console.log("Error!");continue}{const r=_.arguments[+a[1]];if("outFile"===r.type&&"Folder"===r.format){const e=B[U[+a[1]]];if(!e)continue;t=e.path,i.parent=e.id}else"inFile"===r.type&&"Folder"===r.format&&(t=L[s[+a[1]]],i.parent=s[+a[1]]);z[e].default.indexOf("{$FolderName}")>=0&&(z[e].default=z[e].default.replace(/\{\$FolderName\}/g,n.basename(t))),i.path=n.resolve(t,z[e].default)}}else i.path=n.resolve(`${y}/${w}/${i.id}`);"Folder"!==i.format&&(i.path+="."+i.format),r=h[e]&&h[e].name?h[e].name:i.name+" of the "+_.name,h[e]&&h[e].desc&&(c=h[e].desc),z[e].outPreFolder&&"Folder"===z[e].format&&G.push(i.path),i.name=r,i.desc=c,i.owner=a,i.project=w,i.result=C.id,i.prefix=S,i.suffix=F,$.dataFiles.push(i.id),C.outFiles.push(i.id),B[e]=i,await B[e].save();const d=i.getModel();d.owner=D.getSlimModel(),A($.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:d}),"Folder"===i.format&&"name"===z[e].outFolderStyle&&"$ProjectFolder"===_.cwd?C.arguments[t]={outFile:n.basename(i.path)}:("Folder"===i.format&&z[e].outFolderStyle,C.arguments[t]={outFile:i.path})}const J=_.compose(C.arguments,N.PACKAGE_FOLDER,N.PROJECT_FOLDER,b);if(C.command=J.command,C.commandArgs=J.commandArgs,"workflow"!==_.type)if("$ProjectFolder"===_.cwd)C.cwd=n.resolve(y+"/"+w);else if(_.cwd.match(/^\$ScriptFolder/))C.cwd=n.resolve(_.cwd.replace(/^\$ScriptFolder/,b));else if(_.cwd.match(/^\$PackageFolder/))C.cwd=n.resolve(_.cwd.replace(/^\$PackageFolder/,N.PACKAGE_FOLDER));else if(0===_.cwd.indexOf("argv")){const e=_.cwd.split("."),t=parseInt(e[1]);if(isNaN(t))throw[O("32",{details:`The working directory setting has error(s): Current value: ${_.cwd}. Please contact the web admin to correct the task's working directory.`})];if(!_.arguments[t]||"inFile"!==_.arguments[t].type||"Folder"!==_.arguments[t].format)throw[O("32",{details:`The working directory setting has error(s): Current value: ${_.cwd}. Please contact the web admin to correct the task's working directory.`})];C.cwd=C.arguments[t].inFile}if(G.length>0)for(let e=0;e<G.length;e++){const t=G[e];await p.ensureDir(t)}await C.save(),$.results.push(C.id),await $.save();const K=new f({result:C.id,user:a,project:w,taskName:_.name,projectName:$.name,projectDesc:$.desc,title:C.name,desc:C.desc,status:0,timer:[new Date]});await K.save();const H=await d.findOne({_id:C.id}).populate("owner outFiles inFiles task project").exec();if(!H)throw[O("35",{details:`We can not find the result id: ${H.id}. please check if this is the right ID.`})];const Q=H.getModel(H.project.getPrivilege(D));return A($.getListeners(),"dataChange",{type:"insert",target:"Result",data:Q}),C.status>=0&&(C.env=N,C.extDirs=R,await P.addToQueue({id:C.id,command:C.command,commandArgs:C.commandArgs,cwd:C.cwd,type:C.type,owner:C.owner,project:C.project,env:C.env||{},extDirs:C.extDirs||[]})),t.success=Q,t})),_.get("/api/result/:resultId/resume",S(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.resultId;if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const o=await j(a,"bdp",2),l=await d.findOne({_id:s}).populate("owner inFiles outFiles").exec();if(!l)throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const p=await $(l.project);if(!p)throw[O("19",{details:"We can not find the project for this result, please check if this is the right ID."})];if(!p.getPrivilege(o).canRun)throw[O("38",{details:"Sorry, you do not have privilegs to view results in this project."})];if(!l.task)throw[O("711",{details:"Sorry, the task might have been removed."})];const h=await r.findOne({_id:l.task}).exec(),g=await u.findOne({_id:h.package}).exec();if(!g)throw[O("19",{details:"We can not find the package of the task."})];const m=l;let w;h.proxy&&(w=await I(l.id));const b={PROJECT_FOLDER:n.resolve(y,p.id),SHARED_FOLDER:n.resolve(y,"shared"),PACKAGE_FOLDER:n.resolve(g.path),TASK_ID:h.id,TASK_KEY:h.key,TASK_NAME:c(h.name,{condense:!0}),TASKLOG_FOLDER:k,DOCKER_PATH:v,BDP_HOST_PORT:w,RESULT_ID:m._id.toString()},x=h.arguments.filter(e=>"inFile"===e.type),S=l.inFiles.filter(e=>!!e);if(x.length!==S.length)throw[O("711",{name:"Input file number inconsistency",details:`The task require ${x.length} input files, but the previous run only has ${S.length} files.Please check if some files were removed or the task arguments were changed.`})];const F={},T={},D=[];S.forEach(e=>{1===e.status&&(F[e.id]=e.path,e.realPath&&D.push(e.realPath),T[e.id]=e)});const _=h.outputProvider(),M=l.outFiles.filter(e=>!!e);if(_.length!==M.length)throw[O("711",{name:"Output file inconsistency",details:"The task outputs "+_.length+" file records(s), but the previous run expects "+M.length+" record(s). Please check if some output records were removed or the task arguments were changed."})];l.status="workflow"===h.type?1:0,l.timer=[new Date],await l.save();const C=new f({result:m.id,user:a,project:p.id,taskName:h.name,projectName:p.name,projectDesc:p.desc,title:m.name,desc:m.desc,status:0,timer:[new Date]});await C.save();const E=l.getModel();return A(p.getListeners(),"dataChange",{type:"update",target:"Result",data:E}),m.env=b,m.extDirs=D,await P.addToQueue({id:m.id,command:m.command,commandArgs:m.commandArgs,cwd:m.cwd,type:m.type,owner:m.owner,project:m.project,env:m.env||{},extDirs:m.extDirs||[]}),t.success=E,t})),_.get("/api/:resultId",S(async e=>{const t=e.session.passport.user.id,a=e.params.resultId;if(!i.Types.ObjectId.isValid(a))throw[O("35",{details:`We can not find the result id: ${a}. please check if this is the right ID.`})];const s=await j(t,"bdp",2),r=await d.findOne({_id:a}).populate("owner inFiles outFiles task").exec();if(!r)throw[O("35",{details:`We can not find the result id: ${a}. please check if this is the right ID.`})];const o=await $(r.project);if(!o)throw[O("19",{details:"We can not find the project for this result, please check if this is the right ID."})];const n=o.getPrivilege(s);if(!n.canView)throw[O("38",{details:"Sorry, you do not have privilegs to view results in this project."})];if(1===r.status&&r.pid>=0){const e=P.getCurrentStdOutput(r.pid);e&&(r.stdOut=e.stdOut,r.stdErr=e.stdErr)}return r.project=o,{success:r.getModel(n),errors:[]}})),_.patch("/api/:resultId",S(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.resultId,r=e.body.name,o=e.body.desc,n=e.body.prefix||"",c=e.body.suffix||"";if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const p=await j(a,"bdp",2),u=await d.findOne({_id:s}).exec();if(!u)throw[O("35",{details:`We cannot find the result id: ${s}. please check if this is the right ID.`})];const h=await l.findOne({_id:u.project}).exec();if(!h.getPrivilege(p).canEditResult)throw[O("38",{details:"Sorry, you do not have privileges to edit results in this project."})];if(r.length>160)throw[O("36")];if(o.length>1e3)throw[O("37")];u.name=r,u.desc=o,u.prefix=n.slice(0,36),u.suffix=c.slice(0,36),await u.save();const g=await d.findOne({_id:u.id}).populate("owner outFiles inFiles task").exec();return t.success=g.getModel(),A(h.getListeners(),"dataChange",{type:"update",target:"Result",data:t.success}),t})),_.get("/api/:resultId/stop",S(async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,r=e.params.resultId;if(!i.Types.ObjectId.isValid(r))throw[O("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const o=await j(s,"bdp",2),n=await d.findOne({_id:r}).populate("owner outFiles inFiles task").exec();if(!n)throw[O("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];if(!(await l.findOne({_id:n.project}).exec()).getPrivilege(o).canRun)throw[O("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];return a.success=n.getModel(),t.json(a),await D(n),!1})),_.post("/api/:projectId/batchStopResult",S(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.projectId,r=e.body.resultIDs||[];if(!i.Types.ObjectId.isValid(s))throw[O("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(0===r.length)throw[O("709",{type:"warning",details:"No tasks to stop."})];if(r.filter(e=>!i.Types.ObjectId.isValid(e)).length>0)throw[O("709",{type:"warning",details:"There are invalid result ids in your request."})];const o=await j(a,"bdp",2),n=await l.findOne({_id:s}).exec();if(!n)throw[O("19",{details:"We can not find the project for this data file please check if this is the right ID."})];if(!n.getPrivilege(o).canRun)throw[O("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];const c=await d.find({project:s,_id:{$in:r},status:1}).populate("owner outFiles inFiles task").exec();t.json({success:c.map(e=>e.getModel()),errors:[]});for(const e of c)await D(e);return!1})),_.delete("/api/:resultId",S(async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,r=e.params.resultId;if(!i.Types.ObjectId.isValid(r))throw[O("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const o=await j(s,"bdp",2),n=await d.findOne({_id:r}).populate("owner outFiles inFiles task").exec();if(!n)throw[O("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];if(!(await l.findOne({_id:n.project}).exec()).getPrivilege(o).canDeleteResult)throw[O("38",{details:"Sorry, you do not have privileges to delete results in this project."})];return n.readOnly=!0,n.status=4,a.success=n.getModel(),t.json(a),await T(n),!1})),_.post("/api/:projectId/batchRemoveResult",S(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.projectId,r=e.body.resultIDs||[];if(!i.Types.ObjectId.isValid(s))throw[O("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(0===r.length)throw[O("709",{type:"warning",details:"No tasks to stop."})];if(r.filter(e=>!i.Types.ObjectId.isValid(e)).length>0)throw[O("709",{type:"warning",details:"There are invalid result ids in your request."})];const o=await j(a,"bdp",2),n=await l.findOne({_id:s}).exec();if(!n)throw[O("19",{details:"We can not find the project for this data file please check if this is the right ID."})];if(!n.getPrivilege(o).canDeleteResult)throw[O("38",{details:"Sorry, you do not have privileges to remove results in this project."})];const c=await d.find({project:s,_id:{$in:r}}).populate("owner outFiles inFiles task").exec();c.forEach(e=>{e.readOnly=!0,e.status=4}),t.json({success:c.map(e=>e.getModel()),errors:[]});for(const e of c)await T(e);return!1})),m.on("proxyReq",(function(e,t,a){const s=a.get("needPathRewrite"),i=t.originalUrl.match(/^\/result\/(.*?)\/proxy/);if("true"===s&&i){const a=i[1];e.path=t.originalUrl.replace(`/result/${a}/proxy`,"")}else e.path=t.originalUrl;const r=e.getHeader("Content-Type");if(t.body&&r)if(r&&r.indexOf("application/x-www-form-urlencoded")>=0){const a=Object.keys(t.body).map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(t.body[e])}`).join("&");e.setHeader("Content-Length",Buffer.byteLength(a)),e.write(a)}else if(r.indexOf("application/json")>=0){const a=JSON.stringify(t.body);e.setHeader("Content-Type","application/json"),e.setHeader("Content-Length",Buffer.byteLength(a)),e.write(a)}})),m.on("proxyRes",(function(e,t){let s="";const i=e.headers.location;if(e.headers["X-Frame-Options"]="SAMEORIGIN",e.headers["Content-Security-Policy"]="frame-ancestors 'self'",i&&(0===i.indexOf("http")||0===i.indexOf("https"))){const r=t.originalUrl.match(/^\/result\/(.*?)\/proxy/);s=URL?new URL(i):g.parse(i);const o=`${a.site_domain}:${a.port}/result/${r[1]}/proxy`;s.pathname&&i.indexOf(o+"/")<=0&&(e.headers.location=o+s.pathname,s.search,s.hash)}})),m.on("error",(function(e){console.log("Proxy Error"),console.log(e)})),h.on("upgrade",(function(e,t,a){if(!e.url)return;const s=e.url.match(/\/result\/(.*?)\/proxy/);if(s&&s[1]){const i=s[1],r=w[i];if(!r)return;r.pathRewrite,m.ws(e,t,a,{target:`${r.protocol}://${r.ip}:${r.port}`,ws:!0,autoRewrite:!0,changeOrigin:!0,cookieDomainRewrite:`${r.ip}:${r.port}`},(function(e){console.log(e)}))}})),_.all("/:resultId/proxy/*",S(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId;if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const r=await j(a,"bdp",2),o=await d.findOne({_id:s}).populate("task").exec();if(!o)throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(!(await l.findOne({_id:o.project}).exec()).getPrivilege(r).canView)throw[O("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];if(!w[s])throw[O("501",{details:`Sorry, the web proxy has NOT been set for this result. Please try the endpoint '/result/${s}/requestProxy' first.`})];const n=w[s];t.set("needPathRewrite",n.pathRewrite),m.web(e,t,{target:`${n.protocol}://${n.ip}:${n.port}/`,autoRewrite:!0,cookieDomainRewrite:`${n.ip}:${n.port}`,ws:!0,changeOrigin:!0,preserveHeaderKeyCase:!0,debug:!0},(function(e){t.write(JSON.stringify(e))}))})),_.get("/:resultId/requestProxy",S(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId;if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const r=await j(a,"bdp",2),o=await d.findOne({_id:s}).populate("task").exec();if(!o)throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(o.task||(o.task={}),!(await l.findOne({_id:o.project}).exec()).getPrivilege(r).canView)throw[O("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];if("workflow"===o.type)throw[O("501",{details:"We cannot proxy the workflow tasks."})];if(1!==o.status&&null===o.task.proxy)throw delete w[o.id],[O("501",{details:"This is an invalid result to make the proxy."})];let n={},c="/";n=o.task.proxy;try{const e=n.entryPath||"/",t=new URL("http://127.0.0.1"+e);c=`${t.pathname}${t.search}${t.hash}`}catch(e){A(a,"message",O("501",{details:"The proxy entry path is invalid. We redirect page to the proxy root."}))}if(!w[o.id])throw[O("501",{details:"We cannot do the web proxy because there is no proxy settings for this Result's task."})];{const e=w[o.id].hostPort;w[o.id]={ip:"localhost",hostPort:e,port:e,pathRewrite:n.pathRewrite,protocol:n.protocol,entryPath:c}}return t.redirect(`/result/${s}/proxy${c}`)})),_.get("/api/:resultId/taskLog",S(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId,r=e.query.jobID,o=e.query.stdoe;if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const c=await j(a,"bdp",2),u=await d.findOne({_id:s}).populate("owner outFiles inFiles task").exec();if(!u)throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(!(await l.findOne({_id:u.project}).exec()).getPrivilege(c).canView)throw[O("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];if("workflow"===u.type)throw[O("710",{details:"Workflow does not have task logs."})];let h="index.txt",g="",f=!1;if(r&&["stdout","stderr"].indexOf(o)>=0){if(g=n.resolve(k,s,h),f=await p.pathExists(g),!f&&(h="progress-index.txt",g=n.resolve(k,s,h),f=await p.pathExists(g),!f))throw[O("710",{details:"Sorry, we cannot find the task log index for this result."})];h=await F(g,r,o);let e=await p.pathExists(h);if(!e){const t=await F(g,r,"taskName");if(h=n.join(k,s,t,`${r}-${o}.txt`),e=await p.pathExists(h),!e)throw[O("710",{details:`Sorry, the ${o} file may have not been created for this result.`})]}t.setHeader("Content-type","text/plain"),t.sendFile(h)}else{let e=n.resolve(k,s,h);if(!await p.pathExists(e)){if(h="progress-index.txt",e=n.resolve(k,s,h),!await p.pathExists(e))throw[O("710",{details:"Sorry, we cannot find the task logs for this result."})]}t.sendFile(e)}return!1})),_}},function(e,t){e.exports=require("http-proxy")},function(e,t,a){const s=a(3),i=a(0),r=a(4),o=a(5),n=a(2),c=a(27),d=a(1),l=a(7),p=a(70),u=a(30),h=a(71),g=a(29),f=a(72);e.exports=function(e){const t=e.chiConfig.system.dataFilePath,m=e.helpers,w=m.chiAsyncWrap,y=m.getAuthAsync,k=m.isAuthenticated,v=m.getCode,b=s.Router(),x={};return b.use("/static/:dataFileId",c({methods:["GET","HEAD","OPTIONS"],allowedHeaders:["range","Cache-control","If-None-Match","Content-Type"],exposedHeaders:["Content-Length","Content-Range","Content-Type"],credentials:!0}),w(async(e,t,a)=>{const n=e.params.dataFileId;if(!i.Types.ObjectId.isValid(n))throw[v("27")];const c=await k(e,"bdp",2);if(!c)throw[v("12")];const d=await o.findOne({_id:n}).exec();if(!d)throw[v("27",{details:"Sorry, we can not find the file record for you."})];if(!(await r.findOne({_id:d.project}).exec()).getPrivilege(c).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];if(!x[n])return x[n]=d.realPath||d.path,b.use("/static/"+n,s.static(x[n]),h(x[n],{icons:!0,view:"details"})),t.redirect(`/data/static/${n}/${e.path}`),!1;a()})),b.post("/api/data/download",w(async(e,t)=>{if(!e.isAuthenticated())throw[v("12")];const a=e.session.passport.user.id,s=e.body.projectID,i=e.body.fileIDs,c=await y(a,"bdp",2),d=await r.findOne({_id:s}).exec();if(!d)throw[v("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!d.getPrivilege(c).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];const l=i.filter(e=>d.dataFiles.indexOf(e)>=0),p=await o.find({_id:{$in:l},project:d.id}).exec();t.header("Content-Type","application/zip"),t.header("Content-Disposition",'attachment; filename="bdp-download.zip"');const h=u("zip",{zlib:{level:1}});h.pipe(t);const f={},m={};for(const e of p){const t=await n.realpath(e.path);if(await n.pathExists(t)){const a=await n.stat(t),s=e.prefix+e.name+e.suffix;a.isDirectory()?void 0===m[s]?(m[s]=0,h.directory(t+"/",g(s,{replacement:"_"}))):(m[s]++,h.directory(t+"/",g(s+"("+m[s]+")",{replacement:"_"}))):a.isFile()&&(void 0===f[s]?(f[s]=0,h.file(t,{name:g(s,{replacement:"_"})+"."+e.format})):(f[s]++,h.file(t,{name:g(s+"("+f[s]+")",{replacement:"_"})+"."+e.format})))}}return h.finalize(),!1})),b.get("/api/dataFile/:dataFileId/:viewType",c({methods:["GET","HEAD","OPTIONS"],allowedHeaders:["range","Cache-control","If-None-Match","Content-Type"],exposedHeaders:["Content-Length","Content-Range","Content-Type"],credentials:!0}),w(async(e,c)=>{const p={errors:[]},g=e.params.dataFileId,m=e.params.viewType,w="true"===e.query.preview;let y=e.query.subPath;if(!i.Types.ObjectId.isValid(g))throw[v("27")];const S=await k(e,"bdp",2);if(!S)throw[v("12")];const O=await o.findOne({_id:g}).exec();if(!O)throw[v("27")];const I=await r.findOne({_id:O.project}).exec();if(!I.getPrivilege(S).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];const j=await O.checkFile();if(!j)throw[v("27",{name:"File does not exist"})];if("download"===m){if("Folder"!==O.format){const e=O.prefix+O.name+O.suffix+"."+O.format;c.set({"Content-disposition":f(e),"x-no-compression":!0,"Content-Length":j.size});const a=d.resolve(t+"/"+I.id);if(!l(O.path,a))throw[v("27",{details:"Invalid file to download."})];return c.sendFile(O.path),!1}{if(y){y=y.replace(/\.\./g,"");const e=d.join(O.path,y);if(l(e,O.path)){if(await n.pathExists(e)){const t=await n.stat(e);if(t.isFile())return c.set({"Content-disposition":`attachment; filename="${d.basename(e)}"`,"x-no-compression":!0,"Content-Length":t.size}),c.sendFile(e),!1}}throw[v("27",{details:"Invalid file to download"})]}c.header("Content-Type","application/zip"),c.header("Content-Disposition",`attachment; filename="${O.prefix}${O.name}${O.suffix}.zip"`);const e=u("zip",{zlib:{level:9}});return e.pipe(c),e.directory(O.path+"/",!1),e.finalize(),!1}}if("static"===m)return null==x[g]&&"Folder"===O.format&&(x[g]=O.realPath||O.path,b.use("/static/"+g,s.static(x[g]),h(x[g],{icons:!0,view:"details"}))),c.redirect("/data/static/"+g),!1;if("csv"==O.format){const e=O.path,t=[];let s=0;const i=a(17).createInterface({input:n.createReadStream(e)});return i.on("line",(function(e){s++;let a=e.split(",");"rownames"===m&&w?a=a.slice(0,5):"rownames"!==m||w||(a=a[0]),t.push(a),"colnames"===m&&w?s>=5&&i.close():"colnames"!==m||w||1===s&&i.close()})),void i.on("close",(function(){p.success={id:g,viewType:m,isPreview:w,data:t},c.json(p)}))}if("json"==O.format){const e=O.path;let t="";const s=a(17).createInterface({input:n.createReadStream(e)});return s.on("line",(function(e){t+=e})),void s.on("close",(function(){p.success={id:g,viewType:m,isPreview:w,data:JSON.parse(t)},c.json(p)}))}throw[v("-2",{name:"Data currently not supported"})]})),b.post("/api/dataFile/:dataFileId/glob",w(async e=>{const t={errors:[],success:[]};if(!e.isAuthenticated())throw[v("12")];const a=e.session.passport.user.id,s=e.params.dataFileId,n=e.body.globbyExprs,c=await y(a,"bdp",2);if(!i.Types.ObjectId.isValid(s))return t;const d=await o.findOne({_id:s}).exec();if(!d)throw[v("27")];if(!(await r.findOne({_id:d.project}).exec()).getPrivilege(c).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];return"Folder"!==d.format||(t.success=await p(n,{cwd:d.path,root:d.path,follow:!1})),t})),b}},function(e,t){e.exports=require("globby")},function(e,t){e.exports=require("serve-index")},function(e,t){e.exports=require("content-disposition")},function(e,t,a){const s=a(3),i=a(0),r=a(11),o=a(4),n=a(5),c=a(74),d=a(1),l=a(2),p=a(7),{google:u}=a(75),h=a(76),g=u.auth.OAuth2,f=/[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+(?:[A-Z]{2}|com|org|net|edu|gov|mil|biz|info|mobi|name|aero|asia|jobs|museum)\b/;e.exports=function(e){const t=e.io,a=e.chiConfig,m=e.helpers,w=m.chiAsyncWrap,y=m.getAuthAsync,k=m.errorHandler,v=m.logMessages,b=m.makeDataFileDeleted,x=a.system.dataFilePath,S=m.getProjectByID,O=m.getCode,I=m.socketBroadcast,j=s.Router(),F={"application/vnd.google-apps.document":["text/html","text/plain","application/rtf","application/vnd.oasis.opendocument.text","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/pdf"],"application/vnd.google-apps.spreadsheet":["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/x-vnd.oasis.opendocument.spreadsheet","text/csv","application/pdf"],"application/vnd.google-apps.drawing":["image/jpeg","image/png","image/svg+xml","application/pdf"],"application/vnd.google-apps.presentation":["application/vnd.openxmlformats-officedocument.presentationml.presentation","application/pdf","text/plain"]};j.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(O("a011")),t.json(s);a()}),j.get("/api/:dataFileId",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(a))throw[O("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const r=await y(s,"bdp",2),o=await n.findOne({_id:a}).populate("owner").populate({path:"result",populate:{path:"owner outFiles inFiles task"}});if(!o)throw[O("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if(o.project=await S(o.project),!o.project)throw[O("19",{details:"We can not find the project for this data file please check if this is the right ID."})];const c=o.project.getPrivilege(r);if(!c.canView)throw[O("38",{details:"Sorry, you do not have privileges to view the data file information."})];return t.success=o.getModel(c),t})),j.patch("/api/batchUpdate",w(async e=>{const t=e.body.dataFiles,a=e.session.passport.user.id,s=await y(a,"bdp",2),r=t.map(e=>i.Types.ObjectId.isValid(e.id)?e.id:null).filter(e=>null!==e),c=await n.find({_id:{$in:r}}).populate("owner result"),d=[...new Set(c.map(e=>e.project.toString()))],l=await o.find({_id:{$in:d}}),p=[];for(let e=0;e<c.length;e++){const a=c[e],i=t.filter(e=>e.id===a.id)[0],r=l.filter(e=>e.id===a.project.toString())[0];if(i&&r){if(!r.getPrivilege(s).canEditFile)continue;a.name=i.name.slice(0,80),a.desc=i.desc.slice(0,300),a.prefix=i.prefix.slice(0,36),a.suffix=i.suffix.slice(0,36);const e=a.tags.indexOf("Folder")>=0;a.tags=i.tags.map(e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-zA-Z0-9\.\-\_]/g,""));const t=a.tags.indexOf("Folder");e&&t<0&&a.tags.unshift("Folder"),!e&&t>=0&&(a.tags[t]=a.tags[t].toLowerCase());const o=(await a.save()).getModel();I(r.getListeners(),"dataChange",{type:"update",target:"DataFile",data:o}),p.push(o)}}return{errors:[],success:p}})),j.patch("/api/:dataFileId",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(a))throw[O("27",{details:"We can not find the data file id: "+a+". please check if this is the right ID."})];const r=await y(s,"bdp",2),c=await n.findOne({_id:a}).populate("owner result").exec();if(!c)throw[O("27",{details:"We can not find the data file id: "+a+". please check if this is the right ID."})];const d=await o.findOne({_id:c.project}).exec();if(!d.getPrivilege(r).canEditFile)throw[O("38",{details:"Sorry, you do not have privileges to edit files in this project."})];const l=e.body.name,p=e.body.desc,u=e.body.prefix||"",h=e.body.suffix||"";if(l.length>80)throw[O("28",{details:"The name for the data (id: "+a+") is too long. Please shorten the name and try saving again."})];if(p.length>300)throw[O("29",{details:"The description for the data file (id: "+a+") is too long. Please shorten the description and try saving again."})];const g=r.auths.bdp;if(c.name=l,c.desc=p,c.prefix=u.slice(0,36),c.suffix=h.slice(0,36),g>=2&&(e.body.format&&c.format,e.body.tags)){const t=c.tags.indexOf("Folder")>=0;c.tags=e.body.tags.map(e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-zA-Z0-9\.\-\_]/g,""));const a=c.tags.indexOf("Folder");t&&a<0&&c.tags.unshift("Folder"),!t&&a>=0&&(c.tags[a]=c.tags[a].toLowerCase())}return await c.save(),t.success=c.getModel(),I(d.getListeners(),"dataChange",{type:"update",target:"DataFile",data:t.success}),t})),j.delete("/api/:dataFileId",w(async(e,t)=>{const a={errors:[]},s=e.params.dataFileId,r=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(s))throw[O("27",{details:`We can not find the data file id: ${s}. please check if this is the right ID.`})];const o=await y(r,"bdp",2),c=await n.findOne({_id:s}).populate("owner").populate({path:"result",populate:{path:"owner outFiles inFiles task"}}).exec();if(!c)throw[O("27",{details:`We can not find the data file id: ${s}. Please check if this is the right ID.`})];const d=await S(c.project);if(!d)throw[O("19",{details:"We can not find the project for this data file please check if this is the right ID."})];if(!d.getPrivilege(o).canDeleteFile)throw[O("38",{details:"Sorry, you do not have privileges to edit files in this project."})];c.readOnly=!0,c.status=3;const l=c.getModel();return l.owner=o.getSlimModel(),a.success=l,await c.save(),t.json(a),I(d.getListeners(),"dataChange",{type:"update",target:"DataFile",data:l}),await b(c,d),!1})),j.post("/api/:projectId/batchRemoveFiles",w(async(e,t)=>{const a={errors:[]},s=e.params.projectId,r=e.body.fileIDs||[],c=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(s))throw[O("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(0===r.length)throw[O("612",{type:"warning",details:"No files to be removed."})];if(r.filter(e=>!i.Types.ObjectId.isValid(e)).length>0)throw[O("612",{type:"warning",details:"There are invalid data file ids in your request."})];const d=await y(c,"bdp",2),l=await o.findOne({_id:s}).exec();if(!l)throw[O("19",{details:"We can not find the project for this data file please check if this is the right ID."})];if(!l.getPrivilege(d).canDeleteFile)throw[O("38",{details:"Sorry, you do not have privileges to edit files in this project."})];const p=await n.find({project:l.id,_id:{$in:r}}).populate("owner result").exec();p.forEach(e=>{e.readOnly=!0,e.status=3});const u=p.map(e=>e.save());for(const e of u)await e;a.success=p.map(e=>{const t=e.getModel();return t.owner=d.getSlimModel(),t}),t.json(a);for(const e of a.success)I(l.getListeners(),"dataChange",{type:"update",target:"DataFile",data:e});for(const e of p)await b(e,l);return!1})),j.get("/api/:dataFileId/ls",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id;let r=e.query.p;if(r&&(r=decodeURIComponent(r)),!i.Types.ObjectId.isValid(a))throw[O("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const c=await y(s,"bdp",2),p=await n.findOne({_id:a}).exec();if(!p)throw[O("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if("Folder"!==p.format)throw[O("27",{name:"Failed to list files",details:`The file id: ${a} is not a folder. please check if this is the right ID.`})];if(!(await o.findOne({_id:p.project}).exec()).getPrivilege(c).canView)throw[O("38",{details:"Sorry, you do not have privileges to edit files in this project."})];let u="";try{u=await l.realpath(p.path)}catch(e){return{success:[],errors:[]}}if(r){const e=d.relative(p.path,r),t=d.relative(u,r);if(e.indexOf("..")>=0&&t.indexOf("..")>=0)throw[O("27",{name:"Invalid file path",details:"The path you are going to see is invalid. Please check if the path is correct."})];e.indexOf("..")<0&&(r=d.resolve(p.path,e)),t.indexOf("..")<0&&(r=d.resolve(u,t))}const h=r||u;let g=[];try{const e=await l.stat(h);let t=[];if(e.isDirectory()){const e=await l.readdir(h),a=[],s=[];for(const t of e)a.push(l.stat(d.resolve(h,t)));for(const e of a){const t=await e;s.push(t)}t=s.map((t,a)=>{const s=t.isDirectory()?"directory":t.isFile()?"file":t.isSymbolicLink()?"symlink":null,i={children:"directory"===s?[]:void 0,extensions:"file"===s||"symlink"===s?d.extname(e[a]):void 0,name:e[a],size:t.size,type:s,path:d.resolve(h,e[a])};return"directory"===s||"file"===s||"symlink"===s?i:void 0}).filter(e=>!!e),g=t}else g=[]}catch(e){g=[]}return t.success=g,t})),j.post("/api/:dataFileId/move",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id,r=e.body.dest;if(!i.Types.ObjectId.isValid(a))throw[O("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if(""!==r&&!i.Types.ObjectId.isValid(r))throw[O("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const c=await y(s,"bdp",3),u=await n.findOne({_id:a}).populate("owner").exec();if(!u)throw[O("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const g=await o.findOne({_id:u.project}).exec();if(!g.getPrivilege(c).canEditFile)throw[O("38",{details:"Sorry, you do not have privileges to edit files in this project."})];const f=await l.realpath(u.path),m=await l.lstat(u.path),w=d.join(x,g.id),k=d.join(x,"shared");let v=!1,b=!1;if(p(f,w)?v=!0:p(f,k)&&(b=!0),""===r){const e=d.extname(u.path),a=d.join(x,u.project.toString(),u.id.toString()+e);if(u.path===a)t.success=u.getModel();else{try{if(v&&!m.isSymbolicLink())await l.move(u.path,a);else{if(!b||!m.isSymbolicLink())throw"Invalid scenarios to move files.";await l.ensureSymlink(d.relative(d.dirname(a),f),a),await l.unlink(u.path)}}catch(e){throw[O("27",{name:"File movement error",details:e.toString()})]}u.path=a,u.parent=void 0,t.success=u.getModel(),await u.save()}}else{const e=await n.findOne({_id:r,format:"Folder"}).exec();if(!e)throw[O("27",{name:"File movement error",details:`We can not find the folder id: ${r}. please check if this is the right ID.`})];const a=d.extname(u.path),s=h(u.name)+(a||""),i=d.join(e.path,s);if(u.path===i)u.parent=e.id,u.path=i,t.success=u.getModel(),await u.save();else{try{if(v&&!m.isSymbolicLink())await l.move(u.path,i);else{if(!b||!m.isSymbolicLink())throw"Invalid scenarios to move files.";await l.ensureSymlink(d.relative(d.dirname(i),f),i),await l.unlink(u.path)}}catch(e){throw[O("27",{name:"File movement error",attached:e})]}u.parent=e.id,u.path=i,await u.save(),t.success=u.getModel()}}return t})),j.get("/api/:dataFileId/untrack",w(async(e,t)=>{const a={errors:[]},s=e.params.dataFileId,r=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(s))throw[O("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${s}. please check if this is the right ID.`})];const c=await y(r,"bdp",2),d=await n.findOne({_id:s}).populate("owner").exec();if(!d)throw[O("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${s}. please check if this is the right ID.`})];const p=await o.findOne({_id:d.project}).exec(),u=p.getListeners();if(!p.getPrivilege(c).canEditFile)throw[O("38",{details:"Sorry, you do not have privileges to untrack files in this project."})];if(!d.parent)throw[O("608",{name:"Failed to untrack the file",details:"You cannot untrack a file that belongs to no folders."})];if(!await n.findOne({_id:d.parent,project:d.project}).populate("owner").exec())throw[O("608",{name:"Failed to untrack the file",details:"We encountered an error that the file to be untracked belongs to a folder that does not exist in the database.Please contact admin. You might want to delete the datafile directly."})];if(d.readOnly=!0,d.status=3,await d.save(),a.success=d.getModel(),I(u,"dataChange",{type:"update",target:"DataFile",data:d.getModel()}),t.json(a),"Folder"===d.format){const e=await n.find({parent:d.id}).populate("owner").exec();for(let t=0;t<e.length;t++)e[t].parent=d.parent,await e[t].save(),I(u,"dataChange",{type:"update",target:"DataFile",data:e[t].getModel()})}d.realPath&&await l.remove(d.path);const h=d.getModel();await d.remove(),h.owner=c.getSlimModel(),p.dataFiles=p.dataFiles.filter(e=>e!==d.id),await p.save(),I(p.getListeners(),"dataChange",{type:"remove",target:"DataFile",data:h})})),j.post("/api/:dataFileId/track",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id,r=e.body.path;if(!i.Types.ObjectId.isValid(a))throw[O("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const o=await y(s,"bdp",2);let c=await n.findOne({_id:a}).populate("owner").populate({path:"project",populate:{path:"owner managers runners viewers dataFiles results package"}});if(!c)throw[O("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if("Folder"!==c.format)throw[O("607",{details:"Please track files in a folder."})];c.parent&&(c=await n.findOne({_id:c.parent}).populate("owner").populate({path:"project",populate:{path:"owner managers runners viewers dataFiles results package"}}));const u=c.project;if(!u)throw[O("608",{name:"Failed to untrack the file",details:"This data file does not belong to any project. Please check if the integrity of the data file."})];const h=u.getPrivilege(o);if(!h.canEditFile)throw[O("38",{details:"Sorry, you do not have privileges to track files in this project."})];let g=[];if(Array.isArray(u.packages)&&u.packages.length>0&&(g=[].concat.apply([],u.packages.map(e=>e.formatMapping)).filter(e=>null!=e)),await n.findOne({realPath:r,parent:c.id,project:u.id}).populate("owner").exec())throw[O("607",{details:"The path is already being tracked in this project."})];const f=await l.realpath(r);let m;try{m=await l.stat(r)}catch(e){throw[O("607",{details:"The file/folder path you are going to track does not exist or the system can not see the file/folder",attached:e.stacks})]}const w=await l.realpath(c.path);let k;try{k=await l.stat(w)}catch(e){throw[O("607",{details:"The folder has some errors",attached:e})]}if(!k.isDirectory())throw[O("607",{details:"The files to be tracked should be in a folder.Please check again since you are trying to track file(s) in a non-folder."})];if(!p(f,w))throw[O("607",{details:`The tracked file does not in the folder, ${c.getName()}.`})];const v=d.basename(f);let b=v.split(".").slice(-1)[0],S=["file"];m.isDirectory()?(b="Folder",S=["Folder"]):(S=g.filter(e=>v.match(new RegExp(".*("+e.ext.replace(/\./g,"\\.").replace(/\-/g,"\\-").replace(/\_/g,"\\_")+")$"))).map(e=>e.tags)[0],S&&S.length||(S=[]));const j=d.join(x,u.id),F=d.join(x,"shared"),P=new n({name:d.parse(r).name,desc:"",format:b,owner:s,realPath:"",path:"",parent:c.id,project:u.id,tags:S,status:1});let T="";p(f,j)?T=f:p(f,F)?(T="Folder"===b?d.join(x,u.id,P.id):d.join(x,u.id,P.id+"."+b),P.realPath=f,await l.ensureSymlink(d.relative(d.dirname(T),f),T)):(T="Folder"===b?d.resolve(x,u.id,P.id):d.resolve(x,u.id,P.id+"."+b),P.realPath=f,await l.ensureSymlink(f,T)),P.path=T,u.dataFiles.push(P.id),await P.save(),await u.save();const D=P.getModel(h);return D.owner=o.getSlimModel(),D.project=u.id,I(u.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:D}),t.success=D,t}));if(j.post("/api/import/gdrive/file",w(async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,p=e.body.fileID,u=e.body.name,h=e.body.dataFileName||null,g=e.body.desc,f=e.body.authToken,m=e.body.mimeType,w=e.body.projectID,b=e.body.tags||[],S=e.body.prefix||"",j=e.body.suffix||"",P=e.body.keepFileName,T=e.body.folder||null;if(!i.Types.ObjectId.isValid(w))throw[O("19",{details:`We can not find the project id: ${w}. please check if this is the right ID.`})];if(T&&!i.Types.ObjectId.isValid(T))throw[O("19",{details:"The parent folder id is invalid."})];const D=await y(s,"bdp",2),$=await o.findOne({_id:w}).populate("packages").exec();if(!$)throw[O("19",{details:`We can not find the project id: ${w}. please check if this is the right ID.`})];if(!$.getPrivilege(D).canAddFile)throw[O("38",{details:"Sorry, you do not have privileges to import files."})];let A;if(T&&(A=await n.findOne({_id:T}),!A||"Folder"!==A.format))throw[O("19",{details:"Sorry, we couldn't find the parent folder of the id: "+T})];const _=[...new Set([].concat.apply([],$.packages.map(e=>e.allowedFormats)))],M=function(e,t){const a=F[e];if(a){for(let e=0;e<t.length;e++)for(let s=0;s<a.length;s++)if(c.extensions[a[s]])for(let i=0;i<c.extensions[a[s]].length;i++){const r=c.extensions[a[s]][i];if(t[e]===r||t.indexOf("*")>=0)return{ext:r,mimeType:a[s]}}}else;}(m,_),C=function(e,t){const a=c.extensions[e];for(let e=0;e<a.length;e++)if(t.indexOf("*")>=0||t.indexOf(a[e])>=0)return a[e]}(m,_);if(!M&&!C)throw[O("unknown",{name:"Type not supported",details:`The mime file type, ${m}, is currently not supported`})];const E=M?`/drive/v3/files/${p}/export?alt=media&mimeType=${M.mimeType}`:`/drive/v3/files/${p}?alt=media`,N=M?M.mimeType:m,R=M?M.ext:C;let q=[];if(Array.isArray($.packages)&&$.packages.length>0){const e=[].concat.apply([],$.packages.map(e=>e.formatMapping)).filter(e=>null!=e);e&&e.length>0&&(q=e.filter(e=>e.ext===R).map(e=>e.tags)[0]||[])}Array.isArray(b)&&(q.push.apply(q,b.map(e=>e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim())),q=q.filter(e=>null!=e||""!==e));const L=new n({name:h?h.slice(0,80):u.slice(0,80),prefix:S.slice(0,36),suffix:j.slice(0,36),desc:g.slice(0,300),status:0,format:R,owner:s,project:w,tags:[...new Set(q)].map(e=>e.toString()),readOnly:!1});let V=d.resolve(`${x}/${w}/${L.id}.${R}`);A&&(L.parent=A.id,V=P?d.resolve(A.path,`${u}.${R}`):d.resolve(A.path,`${L.id}.${R}`)),L.path=V;const W=await L.save();$.dataFiles.push(L.id),await $.save();const z=W.getModel();a.success=z;const B=$.getListeners();I(B,"dataChange",{type:"insert",target:"DataFile",data:z}),t.json(a);try{await function(e,t,a,s,i){return new Promise((o,n)=>{const c={hostname:"www.googleapis.com",port:443,path:`/drive/v3/files/${e}/export?alt=media&mimeType=text/csv`,method:"GET",path:s,headers:{Authorization:"Bearer "+a}};r.request(c,e=>{const a=e.headers["content-type"]===i;if(a){const a=l.createWriteStream(t);e.pipe(a),e.on("end",(function(){a.end(),o()}))}else{let t="";e.on("data",e=>t+=e),e.on("end",(function(){let s;a||(-1!==e.headers["content-type"].indexOf("application/json")?(s=JSON.parse(t),s.error?n([O("unknown",{name:s.error.message,attached:s.error})]):n([O("unknown",{attached:s})])):n([O("unknown",{attached:t})]))}))}}).end()})}(p,V,f,E,N),L.status=1,L.readOnly=!1,await L.save();const e=L.getModel();e.owner=D.getSlimModel(),I(B,"dataChange",{type:"update",target:"DataFile",data:e})}catch(t){k(a,t),v(s,a.errors,e.route.path);for(const e of a.errors)I(B,"message",e)}return!1})),a.GoogleAuth&&a.GoogleAuth.Google_clientID&&a.GoogleAuth.Google_clientSecret){let e="";e=0===a.serverConfig.site_domain.indexOf("http://")&&80===a.serverConfig.port||0===a.serverConfig.site_domain.indexOf("https://")&&443===a.serverConfig.port?a.serverConfig.site_domain+"/datafile/export/gdrive/callback":`${a.serverConfig.site_domain}:${a.serverConfig.port}/datafile/export/gdrive/callback`;const s=new g(a.GoogleAuth.Google_clientID,a.GoogleAuth.Google_clientSecret,e),r=function(e){return new Promise((t,a)=>{s.getToken(e,(function(e,s){return e?a(e):t(s)}))})};j.get("/:dataFileId/export/gdrive",w(async(e,t)=>{if(!e.isAuthenticated())throw[O("a011")];const a=e.session.passport.user.id;await y(a,"bdp",2);const i={dataFileID:e.params.dataFileId},r=e.query.share;r&&(i.share=r);const o=s.generateAuthUrl({state:JSON.stringify(i),scope:["https://www.googleapis.com/auth/drive.file"]});return t.redirect(o),!1})),j.get("/export/gdrive/callback",w(async(e,a)=>{const c=e.query.code,d=JSON.parse(e.query.state),p=d.dataFileID,h=d.share;if(!e.isAuthenticated())throw[O("a011")];if(!i.Types.ObjectId.isValid(p))throw[O("27",{details:`We can not find the data file id: ${p}. please check if this is the right ID.`})];const g=e.session.passport.user.id,m=await y(g,"bdp",2),w=await n.findOne({_id:p}).populate("owner").exec();if(!w)throw[O("27",{details:`We can not find the data file id: ${p}. please check if this is the right ID.`})];const k=await o.findOne({_id:w.project}).exec(),v=k.getPrivilege(m),b=k.getListeners();if(!v.canEditFile)throw[O("38",{details:"Sorry, but you do not have privileges to edit files."})];const x=await r(c);s.setCredentials(x);const S=u.drive({version:"v3",auth:s}),j=w.path;let F="",P="";return"csv"===w.format&&(F="text/csv",P="application/vnd.google-apps.spreadsheet"),a.write("<script> window.open('', '_self', ''); window.close(); <\/script>"),t.to(g).emit("message",O("609",{name:"File exporting",details:`The datafile, <b>${w.getName()}</b>, is now exporting to GoogleDrive. Please wait.`})),a.end(),F&&P?S.files.create({resource:{name:w.getName(),mimeType:P},media:{mimeType:F,body:l.createReadStream(j)}},(e,a)=>{if(e)t.to(g).emit("message",O("600",{details:`The datafile, ${w.getName()}, failed to export to Google Drive. Please try again.`,attached:e}));else if(I(b,"message",O("601",{details:`The datafile, ${w.getName()}, has exported to your Google Drive.`})),h&&f.test(h)){const e=a.id;S.permissions.create({resource:{type:"user",role:"writer",emailAddress:h},fileId:e,fields:"id"},(function(e){e?t.to(g).emit("message",O("602",{details:`The datafile, ${w.getName()}, has exported to your Google Drive.`,attached:e})):I(b,"message",O("603",{details:`The datafile, ${w.getName()}, has been successfully shared to ${h}`}))}))}else h&&t.to(g).emit("message",O("602",{details:`Please check the email format (${h}) you are going to share.`}))}):t.to(g).emit("message",O("600",{details:`The datafile, ${w.getName()}, failed to export to Google Drive. This file type is currently not supported to export.`})),!1}))}return j}},function(e,t){e.exports=require("mime-types")},function(e,t){e.exports=require("googleapis")},function(e,t){e.exports=require("sanitize-filename")},function(e,t,a){const s=a(3),i=a(0),r=a(1),o=a(2),n=a(16),c=a(11),d=a(78),l=a(79),p=a(14),u=a(9),h=a(4),g=a(5),f=a(6),m=a(10),w=a(28),y=a(7),k=a(30),v=e=>e.isDirectory()?"directory":e.isFile()?"file":e.isSymbolicLink()?"shortcut":"other";e.exports=function(e){const t=e.io,a=e.chiConfig,b=e.helpers,x=b.chiAsyncWrap,S=b.getCode,O=b.getAuthAsync,I=b.pkgNameFormatter,j=a.system.packageFolder,F=a.system.docker_path,P=b.socketBroadcast,T=b.playbookHandler,D=b.getTaskByMap,$={},A={"under development":0,experimenting:1,stable:2,deprecated:3},_=w.diskStorage({destination:function(e,t,s){s(null,r.resolve(a.system.uploadFolder))},filename:function(e,t,a){a(null,"Data-"+Date.now())}}),M=function(e,t,s){s=s||a.system.fileLimits;const i=w({storage:_,limits:{fileSize:s}}).array("file");return new Promise((a,s)=>i(e,t,e=>e?s(e):a()))},C=async(e,t)=>{let a;return new Promise((s,i)=>{const r=e=>{const a=!t||t&&e.headers["content-type"]===t;let r="";e.on("data",e=>{r+=e}),e.on("end",()=>a?s(r):i(r))};e.match(/^https\:\/\//)?a=c.get(e,r):e.match(/^http\:\/\//)&&(a=n.get(e,r)),a.on("error",e=>i(e)),a.end()})},E=async function(e){const t=`https://spreadsheets.google.com/feeds/list/${e=e||"1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g"}/od6/public/values?alt=json`;try{const a=await C(t,"application/json; charset=UTF-8");return JSON.parse(a).feed.entry.filter(e=>e.gsx$name.$t.split("-").length>=2).map(t=>({category:t.gsx$category.$t,name:I(t.gsx$name.$t),author:t.gsx$author.$t,email:t.gsx$email.$t,fromPath:t.gsx$path.$t,desc:t.gsx$description.$t,link:t.gsx$link.$t,status:A[t.gsx$status.$t],sheetID:e}))}catch(e){throw[S("706",{attached:{response:e}})]}},N=async e=>{const t=`https://spreadsheets.google.com/feeds/worksheets/${e}/public/values?alt=json`;let a;try{a=await C(t,"application/json; charset=UTF-8")}catch(e){throw[S("706",{attached:{response:JSON.stringify(e)}})]}try{const e=JSON.parse(a);if(e&&e.feed&&e.feed.title)return e.feed.title.$t}catch(e){return"No name of this package list"}},R=async(e,t)=>{e=e||"1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g";try{const a=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/package-list?key=${t}`,s=await C(a,"application/json; charset=UTF-8"),i=JSON.parse(s),r=[],o=i.values[0];for(let t=1;t<i.values.length;t++){const a={};i.values[t].forEach((e,t)=>a[o[t]]=e),a.Name.split("-").length>=2&&r.push({category:a.Category,name:I(a.gsx$name.$t),author:a.Author,email:a.Email,status:A[a.Status],fromPath:a.Path,desc:a.Description,link:a.Link,scope:[],allowedFormats:[],formatMapping:[],sheetID:e})}return r}catch(e){throw[S("706",{attached:e})]}},q=async(e,t)=>{const a=`https://sheets.googleapis.com/v4/spreadsheets/${e}?fields=properties.title&key=${t}`;try{const e=await C(a,"application/json; charset=UTF-8"),t=JSON.parse(e);return t&&t.properties&&t.properties.title&&t.properties.title||"No name of this package list"}catch(e){throw[S("706",{attached:e})]}},L=s.Router();return L.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(S("a011")),t.json(s);a()}),L.get("/api/package/list",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=await O(a,"bdp",2),i=s.auths.bdp;let r={};if(i<2)throw[S("a017")];i<3?r={status:{$in:[2]}}:i<7&&(r={status:{$in:[1,2,3]}});const o=await m.find(r).populate("owner managers runners viewers").exec(),n=[];for(let e=0;e<o.length;e++){const t=o[e],a=t.getPrivilege(s);n.push(t.getModel(a))}return t.success=n,t})),L.post("/api/package/save",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=await O(a,"bdp",7),n=e.body.package,c=I(n.name+"-"+n.version),d=n.sheetID||"internal",l=n.sheetName||"Internal Package List",p=r.join(j,d,c),u=n.allowedFormats;if(Array.isArray(u)?u.indexOf("*")>=0?n.allowedFormats=["*"]:n.allowedFormats=u.map(e=>e.replace(/[^a-zA-Z0-9\.\-\_]/g,"")).filter(e=>e):n.allowedFormats=[],"internal"!==d){if((await m.find({sheetID:d}).exec()).filter(e=>e.sheetName!==l).length>0)throw[S("700",{details:"The sheetName and the sheet ID are inconsistent."})]}else if("Internal Package List"!==l)throw[S("700",{details:"The internal package can only have the name: Internal Package List"})];let h,g,f;if(n.id){if(!i.Types.ObjectId.isValid(n.id))throw[S("700")];const e=await m.findOne({_id:n.id}).exec();if(!e.getPrivilege(s).canEdit)throw[S("700",{details:"Sorry, you do not have privileges to save this package."})];let a=e.path;if(e.sheetID!==n.sheetID){if(await o.pathExists(p))throw[S("702",{details:"Sorry, this package name "+c+" has been used. Please try another."})];if(!await o.pathExists(e.path))throw[S("700",{details:"The original package folder path "+e.path+" is not existed."})];try{await o.move(e.path,p)}catch(e){throw[S("701",{attached:e})]}a=p}else if(e.name!==c){if(await o.pathExists(p))throw[S("702",{details:`Sorry, this package name ${c} has been used. Please try another.`})];if(!await o.pathExists(e.path))throw[S("700",{details:`The original package folder path ${e.path} is not existed.`})];try{await o.move(e.path,p)}catch(e){throw[S("701",{attached:e})]}a=p}h=await m.findByIdAndUpdate(n.id,{name:c,desc:n.desc,scope:n.scope,author:n.author,img:n.img,thumbnail:n.thumbnail,email:n.email,status:n.status,allowedFormats:n.allowedFormats,path:a,sheetID:n.sheetID,sheetName:n.sheetName,formatMapping:n.formatMapping,public:!!n.public},{new:!0}).populate("owner managers viewers runners").exec(),f="update",g=h.getModel(h.getPrivilege(s)),t.success=g}else{if(s.auths.bdp<7)throw[S("700",{details:"Sorry, you do not have privileges to create this package."})];if(await o.pathExists(p))throw[S("702",{details:`Sorry, this package name ${c} has been used. Please try another.`})];try{await o.ensureDir(p),await o.ensureDir(p+"/configs"),await o.ensureDir(p+"/scripts"),await o.ensureDir(p+"/tasks"),await o.ensureDir(p+"/db"),await o.ensureDir(p+"/client"),await o.ensureFile(p+"/task-index.yaml"),await o.outputFile(p+"/task-index.yaml","tasks:\n"),await o.outputFile(p+"/configs/package-config.json",'{"default":{"adapter":"docker","concurrency":1,"cpus":1,"memory":"4GB"}}')}catch(e){throw[S("701",{attached:e})]}const e=new m({name:c,desc:n.desc,author:n.author,email:n.email,img:n.img,thumbnail:n.thumbnail,path:p,scope:n.scope,status:n.status,allowedFormats:Array.isArray(n.allowedFormats)?n.allowedFormats:["*"],formatMapping:Array.isArray(n.formatMapping)?n.formatMapping:[],sheetID:d,sheetName:l,owner:s.id,runners:[],managers:[],viewers:[]});await e.save(),h=await m.findOne({_id:e.id}).populate("owner").exec(),f="insert",g=h.getModel(h.getPrivilege(s)),t.success=g}return P(s.id,"dataChange",{type:f,target:"Package",data:g}),["managers","viewers","runners"].forEach(e=>{h[e].forEach(e=>{P(e.id,"dataChange",{type:f,target:"Package",data:h.getModel(h.getPrivilege(e))})})}),t})),L.delete("/api/package/:packageId",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[S("700")];const r=await O(a,"bdp",8),n=await m.findOne({_id:s}).exec();if(!n)throw[S("700",{details:"This package may be already deleted."})];const c=n.getPrivilege(r);if(!c.canDelete)throw[S("700",{details:"Sorry, you do NOT have privileges to delete this package."})];const d=n.getListeners([r.id]);return o.remove(n.path).catch(e=>{console.log(e)}),await u.remove({package:s}).exec(),await n.remove(),t.success=n.getModel(c),P(d,"dataChange",{type:"delete",target:"Package",data:n.getModel()}),t})),L.get("/api/package/:packageId/save",x(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[S("700")];const n=await O(a,"bdp",7),c=await m.findOne({_id:s}).exec();if(!c)throw[S("700",{details:"This package does not exist."})];if(!c.getPrivilege(n).canView)throw[S("700",{details:"Sorry, you can not export this package."})];const d=c.path,l=r.resolve(d,"db"),p=r.resolve(d,"scripts");await o.ensureDir(p),await o.ensureDir(l);const h=await u.find({package:c.id}).exec(),g={package:{name:c.name,category:c.category,desc:c.desc,img:c.img,thumbnail:c.thumbnail,readme:c.readme,author:c.author,email:c.email,scope:c.scope,status:c.status,formatMapping:c.formatMapping,allowedFormats:c.allowedFormats,pages:c.pages},tasks:h},f=r.resolve(l,"bdp-package.json");await o.writeJson(f,g),t.header("Content-Type","application/zip"),t.header("Content-Disposition",`attachment; filename="${c.name}.zip"`);const w=k("zip",{zlib:{level:1}});return w.pipe(t),w.directory(d+"/","bdp-package"),w.finalize(),!1})),L.get("/api/package/:packageId/getRuntime",x(async e=>{const t=e.session.passport.user.id,a=e.params.packageId;if(!i.Types.ObjectId.isValid(a))throw[S("700")];const s=await O(t,"bdp",7),n=await m.findOne({_id:a}).exec();if(!n)throw[S("700",{details:"This package does not exist"})];if(!n.getPrivilege(s).canView)throw[S("700",{details:"Sorry, you do not have privileges to view the runtime configurations."})];const c=n.path,d=r.resolve(c,"configs","package-config.json");if(!await o.pathExists(d))return{errors:[],success:{}};const l=await o.readJson(d,{throws:!1});return l&&l.default?{errors:[],success:l.default}:{errors:[],success:{}}})),L.post("/api/package/:packageId/saveRuntime",x(async e=>{const t=e.session.passport.user.id,a=e.params.packageId,s=!!e.body.reset,n=e.body.runtime||{adapter:"docker",cpus:1,memory:"4gb",concurrency:1,dockerPath:"docker"};if(!i.Types.ObjectId.isValid(a))throw[S("700")];const c=await O(t,"bdp",7),d=await m.findOne({_id:a}).exec();if(!d)throw[S("700",{details:"This package does not exist"})];if(!d.getPrivilege(c).canEdit)throw[S("700",{details:"Sorry, you do not have privileges to edit the runtime configurations."})];const l=d.path,p=r.resolve(l,"configs","package-config.json");try{await o.ensureFile(p)}catch(e){throw[S("905",{details:`The runtime config cannot be accessed, please check if the path (${p}) is available.`})]}let u=await o.readJson(p,{throws:!1});u&&!s||(u={});let h=isNaN(parseFloat(n.cpus))?1:parseFloat(n.cpus);h=h>0?h:1;let g=n._memory||"4gb";g=g.toLowerCase().match(/^(\d+[mg])/),g=g?g[1]+"b":"4gb";const f=isNaN(parseInt(n.concurrency))?1:parseInt(n.concurrency),w=isNaN(parseInt(n.updateInterval))?2e4:parseInt(n.updateInterval),y=isNaN(parseInt(n.nodes))?1:parseInt(n.nodes),k=n.dockerPath||F;if(u.default={adapter:n.adapter,batch:!!n.batch,updateInterval:w,cpus:h,mem:g,concurrency:f,nodes:y,dockerPath:k,debug:n.debug},u.default=Object.assign({},u.default,n.overrides),9!==c.auths.bdp&&"local"===u.default.adapter)throw[S("905",{details:"Only the admin can specify the local adapter."})];return await o.writeJSON(p,u),{errors:[],success:u.default}})),L.post("/api/package/:packageID/setMembers",x(async e=>{const t=e.session.passport.user.id,a=e.params.packageID,s=e.body.changes,r=e.body.scope;if(!i.Types.ObjectId.isValid(a))throw[S("19",{details:`The package ID ${a} is invalid, please check if this is the right ID.`})];if(!s||0===s.length||!r||"runners"!==r&&"managers"!==r&&"viewers"!==r&&"owner"!==r)throw[S("402",{type:"warning",details:"No changing members. Please check if you input all correct member info."})];const o=await O(t,"bdp",8),n=await m.findOne({_id:a}).exec();if(!n)throw[S("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const c=n.getPrivilege(o);if(!c.canSetMember||("owner"===r||"managers"===r)&&c.isManager)throw[S("38",{details:"Sorry, you do not have privileges to set members of this package."})];const d=s.map(e=>e.userID&&i.Types.ObjectId.isValid(e.userID)?e.userID:void 0).filter(e=>void 0!==e);if(0===d.length)throw[S("402",{type:"warning",details:"No changes."})];const l=n[r],p=await f.find({_id:{$in:d}}).exec();if(0===p.length)throw[S("402",{type:"warning",details:"No changes."})];for(let e=0;e<p.length;e++){const t=p[e];for(let e=0;e<s.length;e++){const a=s[e];if("owner"===r&&t.id===a.userID){"add"===a.action?n.owner=t.id:"remove"===a.action&&(n.owner=void 0);break}if(t.id===a.userID){if("add"===a.action&&l.indexOf(t.id)<0){n[r].push(t.id);break}if("remove"===a.action){const e=l.indexOf(t.id);e>=0&&n[r].splice(e,1)}}}}await n.save();const u=await m.findOne({_id:a}).populate("owner managers runners viewers").exec();if(!u)throw[S("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const h=u.getPrivilege(o),g=u.getModel(h);if(P(o.id,"dataChange",{type:"update",target:"Package",data:u.getModel(h)}),["managers","viewers","runners"].forEach(e=>{u[e].forEach(e=>{P(e.id,"dataChange",{type:"update",target:"Package",data:u.getModel(u.getPrivilege(e))})})}),!h.canView)throw[S("38",{details:"Sorry, you do not have privileges to view this project."})];return{errors:[],success:g}})),L.get("/api/package/getList",x(async e=>{let t=e.query.s;const a=e.query.apiKey;let s,i=[];return t&&a?(i=await R(t,a),s=await q(t,a)):(t=t||"1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g",i=await E(t),s=await N(t)),{errors:[],success:{pkgList:i,sheetName:s}}})),L.post("/api/package/install",x(async e=>{const a={errors:[]},s=e.session.passport.user.id,i=I(e.body.packageName);let n=e.body.installAs;n&&(n=I(n));let c=e.body.s;c||(c="1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g");const d=e.body.apiKey,l=await O(s,"bdp",8),p=c&&d?await R(c,d):await E(c),u=c&&d?await q(c,d):await N(c);let h;for(let e=0;e<p.length;e++)if(p[e].name===i){h=p[e];break}if(!h)throw[S("707",{details:`We cannot find the package (name: ${i}). Please check the package name.`})];const g=await m.findOne({name:i,sheetID:c}).exec();if(g&&!n){const e=g.getPrivilege(l);if(!e.canEdit)throw[S("707",{details:`The ${i} in the package list (id: ${c}) is already existed and you do NOT have privilege to edit it. You may want to change a name and reinstall it.`})];g.setupSteps<1&&(g.setupSteps=1),g.desc=h.desc,g.author=h.author,g.email=h.email,g.setupSteps=1,g.sheetName=u,await g.save();const t=await m.findOne({_id:g.id}).populate("owner managers runners viewers").exec();return a.success=t.getDetailModel(e),a}if(n){const e=await m.findOne({name:n,sheetID:c}).exec();if(e){const t=e.getPrivilege(l);if(!t.canEdit)throw[S("707",{details:`The ${n} in the package list (id: ${c}) is already existed and you do NOT have privilege to edit it. You may want to change a name and reinstall it.`})];e.setupSteps<1&&(e.setupSteps=1),e.desc=h.desc,e.author=h.author,e.email=h.email,e.setupSteps=1,e.sheetName=u,await e.save();const s=await m.findOne({_id:e.id}).populate("owner managers runners viewers").exec();return a.success=s.getDetailModel(t),a}}a.success=void 0,c||d||(c="internal");const f=r.join(j,c,n||I(h.name));try{await o.ensureDir(f)}catch(e){throw[S("701",{attached:e})]}const w=new m({name:n||I(h.name),desc:h.desc,author:h.author,email:h.email,path:f,fromPath:h.fromPath,scope:h.scope,status:h.status,allowedFormats:h.allowedFormats,formatMapping:h.formatMapping,setupSteps:1,sheetID:c,sheetName:u,owner:l.id,runners:[],managers:[],viewers:[]});await w.save();const y=await m.findOne({_id:w.id}).populate("owner").exec(),k=y.getPrivilege(l);return a.success=y.getDetailModel(k),t.to(s).emit("dataChange",{type:"insert",target:"Package",data:a.success}),a})),L.post("/api/package/upload",x(async(e,a)=>{const s={errors:[]},i=e.session.passport.user.id,n=e.query.listID||"internal",c=await O(i,"bdp",8),d=await m.find({sheetID:n}).exec();if(d.length<1&&"internal"!==n)throw[S("701",{details:"Invalid package sheet ID"})];try{await M(e,a,5e8)}catch(t){throw e.files.map(async e=>{await o.unlink(e.path)}),[S("13",{code:13,name:"File upload failed",details:t.toString(),attached:t})]}const h="internal"===n?"Internal Package List":d[0].sheetName,g=I(e.query.pkgName||r.basename(e.files[0].originalname,".zip"));if(await m.findOne({name:g,sheetID:n}).exec())throw e.files.map(async e=>{await o.unlink(e.path)}),[S("702")];const f=r.join(j,n,g);if(await o.pathExists(f))throw[S("701",{details:"The package path already exists."})];const w={stdOut:"",stdErr:""};try{await o.createReadStream(e.files[0].path).pipe(l.Parse()).on("entry",e=>{const t=r.relative("bdp-package",e.path);if("Directory"===e.type)t?o.ensureDir(r.join(f,t),a=>{a&&(w.stdErr+=JSON.stringify(a)+"\n"),w.stdOut+=t+"\n",e.autodrain()}):(w.stdOut+="Extracting files ...\n",e.autodrain());else if("File"===e.type){w.stdOut+=t+"\n";const a=r.join(f,t);o.ensureFile(a).then(()=>e.pipe(o.createWriteStream(a)))}}).promise()}catch(t){throw e.files.map(async e=>{await o.unlink(e.path)}),await o.remove(f),[S("701",{details:"We encountered errors during package file compression: <br>"+t.toString()})]}e.files.map(async e=>{await o.unlink(e.path)});const y=r.join(f,"db","bdp-package.json");if(!await o.pathExists(y))throw await o.remove(f),[S("701",{details:"Your package zip file does not contain a '/bdp-package/db/bdp-package.json' file."})];const k=await o.readJSON(y,{throws:!1});if(!k||!k.package||!k.tasks)throw await o.remove(f),[S("701",{details:"Your package definition in '/bdp-package/db/bdp-package.json' has errors."})];const v=new m({name:g,desc:k.package.desc,author:k.package.author,email:k.package.email,path:f,fromPath:"",scope:k.package.scope,status:0,allowedFormats:k.package.allowedFormats,formatMapping:k.package.formatMapping,setupSteps:2,sheetID:n,sheetName:h,stdOut:w.stdOut,stdErr:w.stdErr,owner:c.id,runners:[],viewers:[],managers:[]});v.setPages(k.package.pages),await v.save();const b=k.tasks.filter(e=>"workflow"!==e.type),x=k.tasks.filter(e=>"workflow"===e.type),F={},P=[];for(let e=0;e<b.length;e++){const t=b[e],a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:v.id,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version,proxy:t.proxy||null});F[t._id]=a.id,P.push(a.save())}for(let e=0;e<x.length;e++){const t=x[e];for(let e=0;e<t.mapper.length;e++){const a=t.mapper[e];for(let s=0;s<a.length;s++){const i=a[s];t.mapper[e][s].id=F[i.id]}}const a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:v,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version});P.push(a.save())}for(const e of P)await e;v.setupSteps=3,await v.save();const T=await m.findOne({_id:v}).populate("owner").exec(),D=T.getPrivilege(c),$=T.getDetailModel(D);return t.to(i).emit("dataChange",{type:"insert",target:"Package",data:$}),s.success=$,s})),L.get("/api/package/:packageId/download",x(async(e,a)=>{const s={errors:[]},n=e.session.passport.user.id,c=e.params.packageId,p=e.query.restart;if(!i.Types.ObjectId.isValid(c))throw[S("700")];const u=await O(n,"bdp",8),h=await m.findOne({_id:c}).exec();if(!h)throw[S("707",{details:`We cannot find the package (id: ${c}). Please check the package id.`})];const g=h.getPrivilege(u);if(!g.canEdit)throw[S("707",{details:"Sorry, you do not have privileges to install this package."})];h.setupSteps=1;const f=await h.save();s.success=f.getDetailModel(g),s.success.stdOut="Recieving stdandard outputs ...\n",s.success.stdErr="Recieving stdandard errors ...\n",s.success.error={},a.json(s),await o.emptyDir(h.path),$[f.id]&&!p||($[h.id]={stdOut:"",stdErr:"",error:{},process:void 0}),$[h.id].stdOut+="Preparing download zip file\n",t.to(n).emit("packageOut",{type:"stdOut",target:h.id,data:$[h.id].stdOut});try{await d(h.fromPath).pipe(l.Parse()).on("entry",e=>{const a=r.relative("bdp-package",e.path);"Directory"===e.type?a?o.ensureDir(r.join(h.path,a),s=>{s&&($[h.id].stdErr+=JSON.stringify(s)+"\n",t.to(n).emit("packageOut",{type:"stdErr",target:h.id,data:$[h.id].stdErr})),$[h.id].stdOut+=a+"\n",t.to(n).emit("packageOut",{type:"stdOut",target:h.id,data:$[h.id].stdOut}),e.autodrain()}):($[h.id].stdOut+="Extracting files ...\n",t.to(n).emit("packageOut",{type:"stdErr",target:h.id,data:$[h.id].stdOut}),e.autodrain()):"File"===e.type&&($[h.id].stdOut+=a+"\n",t.to(n).emit("packageOut",{type:"stdOut",target:h.id,data:$[h.id].stdOut}),e.pipe(o.createWriteStream(r.join(h.path,a))))}).promise();const e=await m.findOne({_id:h.id}).exec();if(e){e.stdOut=$[e.id].stdOut,e.stdErr=$[e.id].stdErr,e.error={},e.setupSteps=2;const a=await e.save();t.to(n).emit("packageOut",{type:"stdOut",target:h.id,data:e.stdOut}),t.to(n).emit("packageOut",{type:"stdErr",target:h.id,data:e.stdErr}),t.to(n).emit("dataChange",{type:"update",target:"Package",data:a.getDetailModel(g)})}delete $[e.id]}catch(e){(async()=>{const a=await m.findOne({_id:h.id}).exec();a.stdOut=$[a.id].stdOut,a.stdErr=$[a.id].stdErr+e.stack,a.error={},a.setupSteps=1,delete $[a.id];const s=await a.save();t.to(n).emit("packageOut",{type:"stdOut",target:a.id,data:a.stdOut}),t.to(n).emit("packageOut",{type:"stdErr",target:a.id,data:a.stdErr}),t.to(n).emit("dataChange",{type:"update",target:"Package",data:s.getDetailModel(g)})})().then(()=>{t.to(n).emit("message",S("701",{name:"Package installation failed",details:`We failed to install the package, <b>${h.name}</b>.`,attached:e}))})}return!1})),L.get("/api/package/:packageId/importTasks",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[S("700")];const n=await O(a,"bdp",8),c=await m.findOne({_id:s}).exec();if(!c)throw[S("707",{details:`We cannot find the package (id: ${s}). Please check the package id.`})];const d=c.getPrivilege(n);if(!d.canEdit)throw[S("707",{details:"Sorry, you do not have privileges to import tasks to this package."})];const l=await o.readJSON(r.resolve(c.path,"db","bdp-package.json"));if(!l||!l.package||!l.tasks)throw[S("s001",{name:"Wrong backup file"})];c.setPages(l.package.pages);const h=c;h.scope=l.package.scope||[],h.formatMapping=l.package.formatMapping||[],h.allowedFormats=l.package.allowedFormats||[];const g=await m.findOneAndUpdate({_id:s},{name:c.name,desc:c.desc,author:c.author,email:c.email,container:c.container,scope:h.scope,status:c.status,link:c.link,formatMapping:h.formatMapping,allowedFormats:h.allowedFormats,pages:c.pages},{new:!0}).populate("owner managers runners viewers").exec();await u.remove({package:s}).exec();const f=l.tasks.filter(e=>"workflow"!==e.type),w=l.tasks.filter(e=>"workflow"===e.type),y={},k=[];for(let e=0;e<f.length;e++){const t=f[e],a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:s,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version,proxy:t.proxy||null});y[t._id]=a.id,k.push(a.save())}for(let e=0;e<w.length;e++){const t=w[e];for(let e=0;e<t.mapper.length;e++){const a=t.mapper[e];for(let s=0;s<a.length;s++){const i=a[s];t.mapper[e][s].id=y[i.id]}}const a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:s,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version});k.push(a.save())}for(const e of k)await e;return g.setupSteps=3,await g.save(),t.success=g.getDetailModel(d),t})),L.get("/api/package/:packageId",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[S("700")];const r=await O(a,"bdp",2),o=await m.findOne({_id:s}).populate("owner managers viewers runners").exec();if(o){const e=o.getPrivilege(r);if(!e.canView)throw[S("700",{details:"Sorry, you do not have privileges to view this task."})];r.auths&&r.auths.bdp>=8?(t.success=o.getDetailModel(e),$[o.id]&&(t.success.stdOut=$[o.id].stdOut,t.success.stdErr=$[o.id].stdErr)):t.success=o.getModel(e)}else t.success={};return t})),L.get("/api/package/:packageId/file/list",x(async e=>{const t={errors:[],success:[]},a=e.session.passport.user.id,s=e.params.packageId;let n=e.query.path||"";if(n=n.replace(/\\\\/g,"/").replace("\\","/"),!i.Types.ObjectId.isValid(s))throw[S("700")];const c=await O(a,"bdp",7),d=await m.findOne({_id:s}).exec();if(!d)throw[S("700",{details:"This package does not exist"})];if(!d.getPrivilege(c).canView)throw[S("700",{details:"Sorry, you do not have privilege to view the package files."})];const l=d.path,p=n?r.join(l,n):l;if(!y(p,l))return t;const u=await o.readdir(p),h=u.map(e=>o.stat(r.resolve(p,e))),g=[];for(const e of h){const t=await e;g.push(t)}return t.success=g.map((e,t)=>{let a="file";a=e.isDirectory()?"directory":e.isFile()?"file":e.isSymbolicLink()?"shortcut":"other";const s=u[t];return{name:u[t],size:e.size,type:a,path:n?n+"/"+s:s}}),t})),L.get("/api/package/:packageId/file/read",x(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.packageId,n=e.query.path;if(!i.Types.ObjectId.isValid(s))throw[S("700")];const c=await O(a,"bdp",7),d=await m.findOne({_id:s}).exec();if(!d)throw[S("700",{details:"This package does not exist"})];if(!d.getPrivilege(c).canView)throw[S("700",{details:"Sorry, you do not have privilege to view the package files."})];const l=d.path,p=n?r.resolve(l,n):l;if(!y(p,l))throw[S("713",{details:"The path to process is invalid."})];if(!await o.pathExists(p))throw[S("713",{details:"The path can not be accessed."})];const u=await o.stat(p);if(!u.isFile())throw[S("713",{details:"The path can not be accessed."})];if(u.size>5e7)throw[S("713",{details:"The file is too large."})];t.sendFile(p)})),L.post("/api/package/:packageId/file/handle",x(async e=>{const t=e.session.passport.user.id,a=e.params.packageId,s=e.query.type,n=e.query.path||"",c=e.body.fileItems;if(!i.Types.ObjectId.isValid(a))throw[S("700")];if(!s||["add","remove","update","move","rename"].indexOf(s)<0)throw[S("713",{details:"Invalid type to handle."})];const d=await O(t,"bdp",7),l=await m.findOne({_id:a}).exec();if(!l)throw[S("700",{details:"This package does not exist"})];if(!l.getPrivilege(d).canEdit)throw[S("700",{details:"Sorry, you do not have privilege to handle the package files."})];const p=l.path;if(n.match(/\./))throw[S("713",{details:"This query path is invalid."})];const u=n?r.join(p,n):p;if(!y(u,p))throw[S("713",{details:"The path to process is invalid."})];if(!y(r.resolve(u),r.resolve(p,"scripts"))&&!y(r.resolve(u),r.resolve(p,"client")))throw[S("713",{details:"The path to process is invalid."})];if(!c||0===c.length)throw[S("713",{details:"No file items to create"})];if(r.normalize(u)===r.normalize(p))throw[S("713",{details:"You cannot handle the package root folder."})];const h=[];for(let e=0;e<c.length;e++){const t=c[e],a={name:t.name,size:0,type:t.type,path:n?n+"/"+t.name:t.name};let i=r.join(u,t.name);switch(s){case"add":if("directory"===t.type)await o.ensureDir(i);else{if("file"!==t.type)throw[S("713",{details:"The file type is not supported."})];await o.ensureFile(i)}break;case"rename":const e=t.name,s=/^\.\./;if(e.match(s))throw[S("713",{details:`The filename, ${e}, is not valid.`})];const c=t.path,d=r.join(p,c),l=r.join(r.dirname(d),t.name);if(!y(r.resolve(d),r.resolve(p,"scripts"))&&!y(r.resolve(d),r.resolve(p,"client")))throw[S("713",{details:"The original path is invalid."})];if(!y(r.join(l),r.join(p,"scripts"))&&!y(r.join(l),r.join(p,"client")))throw[S("713",{details:"The new path is invalid."})];if(await o.pathExists(l))throw[S("713",{details:`The new path ${t.name} has been used.`})];try{await o.move(d,l)}catch(e){throw[S("713",{details:`Moving the file, '${t.path}', has errors.`,attached:e})]}const h=await o.stat(l);a.name=e;const g=c.split(/\//);g.pop(),a.path=g.join("/")+"/"+e,a.size=h.size,h.isDirectory()?a.type="directory":h.isFile()?a.type="file":h.isSymbolicLink()?a.type="shortcut":a.type="other";break;case"update":i=r.join(u);break;case"move":const f=r.resolve(p+"/"+t.path);if(!y(f,r.resolve(p,"scripts"))&&!y(f,r.resolve(p,"client")))throw[S("713",{details:`The file path, ${t.path} , is invalid.`})];if(f===r.resolve(p,"scripts")||f===r.resolve(p,"client"))throw[S("713",{details:"You cannot manipulate the Package root elements"})];try{await o.move(f,r.join(u,t.name))}catch(e){throw[S("713",{details:`Failed to move the file ${t.path}.`,attached:e})]}const m=await o.stat(r.join(u,t.name));a.name=t.name,a.path=n?n+"/"+t.name:t.name,a.size=m.size,a.type=v(m);break;case"remove":await o.remove(i)}h.push(a)}return{errors:[],success:h}})),L.post("/api/package/:packageId/file/upload",x(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.packageId,n=e.query.path;if(!i.Types.ObjectId.isValid(s))throw[S("700")];if(!n)throw[S("713",{details:"You cannot upload to the package root folder."})];const c=await O(a,"bdp",7),d=await m.findOne({_id:s}).exec();if(!d)throw[S("700",{details:"This package does not exist"})];if(!d.getPrivilege(c).canEdit)throw[S("700",{details:"Sorry, you do not have privilege to upload files to this package."})];const l=d.path,p=r.join(l,n);if(!y(r.join(l,n),l))throw[S("713",{details:"The path to process is invalid."})];if(!y(r.resolve(p),r.resolve(l,"scripts"))&&!y(r.resolve(p),r.resolve(l,"client")))throw[S("713",{details:"The path to process is invalid."})];if(!(await o.stat(p)).isDirectory())throw[S("713",{details:"The path is not a directory."})];try{await M(e,t)}catch(t){for(const t of e.files)await o.unlink(t.path);throw[S("13",{code:13,name:"File upload failed",details:"Please try again.",attached:t})]}const u=e.files[0],h=u.originalname,g=u.path,f=r.join(l,n,h);try{await o.move(g,f,{overwrite:!0})}catch(t){for(const t of e.files)await o.unlink(t.path);throw[S("713",{code:13,name:"File upload failed",details:`The file ${u.originalName} has been uploaded but we failed to move the file to its destinations.`,attached:t})]}const w=await o.stat(f);return{errors:[],success:[{name:h,size:w.size,type:v(w),path:n+"/"+h}]}})),L.get("/api/package/:packageId/file/unzip",x(async e=>{const t=e.session.passport.user.id,a=e.params.packageId,s=e.query.path;if(!i.Types.ObjectId.isValid(a))throw[S("700")];if(!s)throw[S("713",{details:"You cannot upload to the package root folder."})];const n=await O(t,"bdp",7),c=await m.findOne({_id:a}).exec();if(!c)throw[S("700",{details:"This package does not exist"})];if(!c.getPrivilege(n).canEdit)throw[S("700",{details:"Sorry, you do not have privilege to unzip files in this package."})];const d=c.path,p=r.resolve(d,s);if(!y(p,r.join(d,"scripts"))&&!y(p,r.join(d,"client")))throw[S("713",{details:"The path to process is invalid."})];if(!await o.pathExists(p))throw[S("713",{details:"The path to process is invalid."})];if(!(await o.stat(p)).isFile())throw[S("713",{details:"The path to process is invalid."})];if(".zip"!==r.extname(p).toLowerCase())throw[S("713",{details:"The path to process is invalid."})];const u=r.dirname(p),h=[];return await o.createReadStream(p).pipe(l.Parse()).on("entry",e=>{const t=e.path;if(t.indexOf("..")>=0)e.autodrain();else{const a=t.indexOf("/"),s=-1===a||a===t.length-1,i=r.join(u,t);"Directory"===e.type?t?o.ensureDir(i,a=>{a&&console.log(a),s&&h.push({name:r.basename(t),size:0,type:"directory",path:t}),e.autodrain()}):e.autodrain():"File"===e.type&&(s?e.pipe(o.createWriteStream(i)).on("finish",()=>{o.stat(i,(e,a)=>{e&&console.log(e),h.push({name:r.basename(t),size:a.size,type:a.isFile()?"file":a.isSymbolicLink()?"shortcut":"other",path:t})})}):e.pipe(o.createWriteStream(i)))}}).promise(),{errors:[],success:h}})),L.get("/api/task/bymap",x(async e=>{const t={errors:[],success:{}},a=e.session.passport.user.id,s={pkg:e.query.pkg,pkgid:e.query.pkgid,key:e.query.key,id:e.query.id,ver:e.query.ver},i=await O(a,"bdp",7),r=await D(s);if(r&&r.package){const e=r.package;if(e.getPrivilege){const a=e.getPrivilege(i);a.canRun?(t.success=r.getModelForViewer(),t.success.package=e.getModel(a)):a.canView&&(t.success=r.getModel(),t.success.package=e.getModel(a))}}return t})),L.post("/api/task/save",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.body.task;let i="update";if(!s)throw[S("900")];const o=await O(a,"bdp",7);["system","standard","child","workflow"].indexOf(s.type)<0&&(s.type="standard");const n=p(s._key,{condense:!0}),c=await m.findOne({_id:s.package.id}).exec();if(!c)throw[S("900",{details:"Sorry, the package id is not found."})];if(!c.getPrivilege(o).canEdit)throw[S("700",{details:"Sorry, you do not have privilege to edit tasks in this package."})];const d=s.proxy?{enabled:!0,protocol:"http",port:s.proxy.port,pathRewrite:!!s.proxy.pathRewrite,entryPath:s.proxy.entryPath||"/"}:null;if(s.id){i="update";const e=await u.findOne({_id:s.id}).populate("package").exec();if(!e)throw[S("900",{details:"Sorry, we cannot find a task of the id: "+s.id})];const a=r.resolve(e.package.path,"task-index.yaml");if("workflow"!==s.type)if("$SystemFolder/task-portal"===e.script&&"node"===e.exec)if("$SystemFolder/task-portal"===s.script&&"node"===s.exec&&void 0!==s.workflowPlaybook)try{e.key!==n?(await T(a,"delete",e.key),await T(a,"create",n,s.workflowPlaybook)):await T(a,"update",n,s.workflowPlaybook)}catch(e){throw[S("900",{details:e})]}else{if(o.auths.bdp<=8)throw[S("900",{title:"No priviledge!",details:"You are only allowed to define playbook-styled task."})];try{await T(a,"delete",n)}catch(e){throw[S("900",{details:e})]}}else if("$SystemFolder/task-portal"===s.script&&"node"===s.exec&&s.workflowPlaybook)try{await T(a,"create",n,s.workflowPlaybook)}catch(e){throw[S("900",{details:e})]}else if(o.auths.bdp<=8)throw[S("900",{title:"No priviledge!",details:"You are only allowed to define playbook-styled task."})];const l=await u.findByIdAndUpdate(s.id,{name:s.name,type:s.type,desc:s.desc,key:n,img:s.img,thumbnail:s.thumbnail,package:s.package&&""!==s.package.id?s.package.id:void 0,script:s.script,exec:s.exec,cwd:s.cwd,arguments:s.arguments,mapper:s.mapper,stepNames:Array.isArray(s.stepNames)?s.stepNames.map(e=>e.slice(0,60)):[],version:s.version,proxy:d||null},{new:!0}).exec();l.package=c,t.success=l.getModel(s.workflowPlaybook)}else{i="insert";const e=await u.findOne({key:n,package:c.id}).exec();if(e)throw[S("900",{details:"The task key, "+n+", was already used for the task named <b>"+e.name+"</b>."})];const a=new u({name:s.name,type:s.type,desc:s.desc,img:s.img,thumbnail:s.thumbnail,key:n,package:c.id,script:s.script,exec:s.exec,cwd:s.cwd,arguments:s.arguments,mapper:s.mapper,stepNames:Array.isArray(s.stepNames)?s.stepNames.map(e=>e.slice(0,60)):[],version:s.version,proxy:d||null});if("workflow"!==s.type&&"$SystemFolder/task-portal"===s.script&&"node"===s.exec){const e=s.workflowPlaybook;if(!e)throw[S("900",{details:"Please specify the playbook for this task."})];if(c.path){const t=c.path+"/task-index.yaml";try{await T(t,"create",n,e)}catch(e){throw[S("900",{details:e})]}}}else if(o.auths.bdp<=8&&"workflow"!==s.type)throw[S("900",{title:"No priviledge!",details:"You are only allowed to use playbook-styled task."})];const r=await a.save();r.package=c,t.success=r.getModel(s.workflowPlaybook||void 0)}const l=(await f.find({}).exec()).map(e=>e._id.toString());return P(l,"dataChange",{type:i,target:"Task",data:t.success}),t})),L.post("/api/task/:taskId/validInputs",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.taskId,r=e.body.projectID;if(!i.Types.ObjectId.isValid(r))throw[S("19",{details:"We can not find the project id: "+r+". please check if this is the right ID."})];if(!i.Types.ObjectId.isValid(a))throw[S("23")];if(!i.Types.ObjectId.isValid(s))throw[S("31")];const o=await O(a,"bdp",2),n=await u.findOne({_id:s});if(!n)throw[S("31")];if(!(await m.findOne({_id:n.package}).exec()).getPrivilege(o).canRun)throw[S("700",{details:"Sorry, you do not have privilege to handle the package files."})];const c=n.arguments,d=[];if(0===c.length)return t.success=[],t;const l=await h.findOne({_id:r}).exec();if(!l)throw[S("19",{details:"We can not find the project id: "+r+". please check if this is the right ID."})];if(!l.getPrivilege(o).canRun)throw[S("38",{details:"Sorry, you do not have privileges to view valid inputs in this project."})];for(let e=0;e<c.length;e++){const t=c[e],a=t.type,s=t.tags;if("inFile"===a){const a={};"or"===t.tagMatchRule?a.$in=s:("and"===t.tagMatchRule||"all"===t.tagMatchRule)&&(a.$all=s);const i=await g.find({project:r,tags:a}).sort({updatedAt:-1}).exec();i&&i.length>0?d.push({index:e,models:i.filter(e=>("all"!==t.tagMatchRule||e.tags.length===t.tags.length)&&1===e.status).map(e=>e.getModel())}):d.push({index:e,models:[]})}}return t.success=d,t})),L.get("/api/task/list",x(async e=>{const t={errors:[],success:[]};let a="";e.query.package?a=e.query.package:e.query.packages&&(a=e.query.packages);const s=e.query.only,i=e.session.passport.user.id,r=await f.findOne({_id:i}).exec();if(!r)throw[S("23")];const o=r.auths.bdp;if(!a)return t;if(a=a.split(","),!Array.isArray(a))return t;const n=await m.find({_id:{$in:a}}).exec(),c=n.map(e=>e.id),d=n.map(e=>e.getPrivilege(r)),l=n.filter((e,t)=>d[t].canView||d[t].canRun),p=l.map(e=>e.name.split("-").slice(0,-1).join("-"));p.push("all","utility");const h=await m.find({scope:{$in:p}}).exec();a=l.map(e=>e.id);for(const e of h)e.scope.indexOf("admin")>=0?o>=8&&a.push(e.id):a.push(e.id);const g={package:l.map(e=>e.id)};s||(g.package={$in:a}),o<8&&(g.type={$ne:"system"});const w=await u.find(g).populate("package").exec();return t.success=w.map(e=>{const t=c.indexOf(e.package.id);if(t<0)return null;const a=d[t];return a&&a.canView?e.getModel():e.getModelForViewer()}).filter(e=>null!==e),t})),L.delete("/api/task/:taskId",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.taskId;if(!i.Types.ObjectId.isValid(s))throw[S("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const o=await O(a,"bdp",7),n=await u.findOne({_id:s}).populate("package").exec();if(!n)throw[S("903",{details:"The task you request does not exist."})];if(!n.package.getPrivilege(o).canEdit)throw[S("903",{details:"Sorry, you do not have privileges to delete tasks in this package."})];const c=r.resolve(n.package.path,"task-index.yaml");try{await T(c,"delete",n.key)}catch(e){console.log(e)}await n.remove();const d=n.getModel();t.success=d;const l=(await f.find({}).exec()).map(e=>e._id.toString());return P(l,"dataChange",{type:"delete",target:"Task",data:t.success}),t})),L.get("/api/task/:taskId/playbook",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.taskId;if(!i.Types.ObjectId.isValid(s))throw[S("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const o=await O(a,"bdp",7),n=await u.findOne({_id:s}).populate("package").exec();if(!n.package.getPrivilege(o).canView)throw[S("903",{details:"Sorry, you do not have privileges to view the playbook content."})];const c=r.resolve(n.package.path,"./task-index.yaml"),d=n.key;try{t.success=await T(c,"read",d)}catch(e){t.success=""}return t})),L.get("/api/task/:taskId/getRuntime",x(async e=>{const t=e.session.passport.user.id,a=e.params.taskId;if(!i.Types.ObjectId.isValid(a))throw[S("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const s=await O(t,"bdp",7),n=await u.findOne({_id:a}).populate("package").exec(),c=n.key;if(!n.package||!n.package.path)throw[S("905",{details:"The runtime config cannot be accessed."})];if(!n.package.getPrivilege(s).canView)throw[S("903",{details:"Sorry, you do not have privileges to view the runtime config of this task."})];const d=r.resolve(n.package.path,"configs","package-config.json");if(!await o.pathExists(d))return{errors:[],success:{}};const l=await o.readJson(d,{throws:!1});if(!l||!l.default)throw[S("905",{details:"Please first set the runtime configs of package default."})];return{errors:[],success:l[c]||l.default}})),L.post("/api/task/:taskId/saveRuntime",x(async e=>{const t=e.session.passport.user.id,a=e.params.taskId,s=!!e.body.reset,n=e.body.runtime||null;if(!i.Types.ObjectId.isValid(a))throw[S("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const c=await O(t,"bdp",7),d=await u.findOne({_id:a}).populate("package").exec();if(!d||!d.package||!d.package.path)throw[S("905",{details:"The runtime config cannot be accessed."})];const l=d.key;if(!d.package.getPrivilege(c).canEdit)throw[S("903",{details:"Sorry, you do not have privileges to edit the runtime config of this task."})];const p=r.resolve(d.package.path,"configs","package-config.json"),h=await o.readJson(p,{throws:!1});if(!h||!h.default)throw[S("905",{details:"Please first set the runtime configs of package default."})];if(s||!n)return delete h[l],await o.writeJSON(p,h),{errors:[],success:{}};h[l]=n;let g=isNaN(parseFloat(n.cpus))?1:parseFloat(n.cpus);g=g>0?g:1;let f=n._memory||"4gb";f=f.toLowerCase().match(/^(\d+[mg])/),f=f?f[1]+"b":"4gb";const m=isNaN(parseInt(n.concurrency))?1:parseInt(n.concurrency),w=isNaN(parseInt(n.nodes))?1:parseInt(n.nodes),y=n.dockerPath||F,k=isNaN(parseInt(n.updateInterval))?2e4:parseInt(n.updateInterval);if(h[l]=Object.assign({},{adapter:n.adapter,batch:!!n.batch,updateInterval:k,cpus:g,mem:f,concurrency:m,nodes:w,dockerPath:y,debug:n.debug},n.overrides),9!==c.auths.bdp&&"local"===h[l].adapter)throw[S("905",{details:"Only the admin can specify the local adapter."})];return await o.writeJSON(p,h),{errors:[],success:h[l]}})),L}},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("unzipper")},function(e,t,a){const s=a(3),i=a(0),r=a(10),o=a(6),n=a(2),c=a(7),d=a(1);e.exports=function(e){const t=e.helpers,a=t.chiAsyncWrap,l=t.getAuthAsync,p=t.getCode,u=t.socketBroadcast,h=s.Router();return h.all("/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(p("a011")),t.json(s);a()}),h.post("/api/pages/save",a(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=await l(a,"bdp",7),n=e.body.package;if(!i.Types.ObjectId.isValid(n.id))throw[p("714")];const c=await r.findOne({_id:n.id}).exec();if(!c)throw[p("714")];if(!c.getPrivilege(s).canEdit)throw[p("714",{details:"Sorry, you have no privileges to edit the entry pages."})];const d=n.pages;if(!Array.isArray(d.indexPages)||!Array.isArray(d.resultPages)||!Array.isArray(d.filePages))throw[p("714")];let h="indexPages";const g=function(e){return{name:e.name||"unnamed",desc:e.desc||"(no description)",path:e.path||"/assets/pages/index.html",key:e.key||"",img:e.img||"",thumbnail:e.thumbnail||"",tasks:"resultPages"!==h?void 0:Array.isArray(e.tasks)?e.tasks.map(e=>e.toString()):[],tags:"filePages"!==h?void 0:Array.isArray(e.tags)?e.tags.map(e=>e.toString()):[],rule:"filePages"!==h?void 0:["or","and","all"].indexOf(e.rule)>=0?e.rule:"or",format:"filePages"!==h?void 0:e.format||""}};d.indexPages=d.indexPages.map(g),h="resultPages",d.resultPages=d.resultPages.map(g),h="filePages",d.filePages=d.filePages.map(g),c.pages=d;const f=await c.save(),m=f.getModel(f.getPrivilege(s)),w=(await o.find({"auths.bdp":{$gte:8}}).exec()).map(e=>e._id.toString());return u(w,"dataChange",{type:"update",target:"Package",data:m}),t.success=m,t})),h.get("/api/list",a(async e=>{const t={errors:[],success:[]},a=e.session.passport.user.id,s=await l(a,"bdp",2),o=e.query.only,n=e.query.package;if(!i.Types.ObjectId.isValid(n))throw[p("700")];const c=await r.findOne({_id:n}).exec();if(!c)throw[p("700",{details:"This package does not exist"})];const d=c.getPrivilege(s),u=c.name.split("-").slice(0,-1).join("-");if(!d.canView&&!d.canRun)return t;const h=s.auths.bdp,g=await r.find({scope:{$in:[u,"all","utility"]}}).exec(),f=[c.id];for(const e of g)e.scope.indexOf("admin")>=0?h>=8&&f.push(e.id):f.push(e.id);const m={_id:[c.id]};o||(m._id={$in:f});const w=await r.find(m).exec();return t.success=w.map(e=>e.getModel(e.getPrivilege(s))),t})),h.get("/api/:packageId/*",a(async(e,t)=>{const a=e.session.passport.user.id,s=await l(a,"bdp",2),o=e.params.packageId;if(!i.Types.ObjectId.isValid(o))throw[p("700")];const u=await r.findOne({_id:o}).exec();if(!u)throw[p("700",{details:"This package does not exist"})];if(!u.getPrivilege(s).canRun)throw[p("700",{details:"Sorry, you do not have privileges to view this entry page."})];const h=u.path,g=d.normalize(e.path.replace("/api/"+o,h+"/client"));if(c(g,h)){if(await n.pathExists(g)){if((await n.stat(g)).isFile())return void t.sendFile(g)}}const f=d.normalize(e.path.replace("/api/"+o,d.resolve(process.env.BDP_SYSTEM_FOLDER,"public")));if(c(f,d.resolve(process.env.BDP_SYSTEM_FOLDER,"public"))){if(await n.pathExists(f)){if((await n.stat(f)).isFile())return void t.sendFile(f)}}return t.redirect("/assets/pages/not-found.html"),!1})),h}},function(e,t,a){const s=a(3),i=a(82),r=a(83),o=a(26).spawnProcessAsync,n=["@big-data-processor/utilities","@big-data-processor/task-reader","@hapi/iron","archiver","babel-runtime","body-parser","compression","connect-mongo","content-disposition","cookie-parser","cors","dashify","detect-port","express","express-session","express-status-monitor","filenamify","find-package-json","fluent-ffmpeg","fs-extra","globby","googleapis","greenlock-express","helmet","http-proxy","js-yaml","mime-types","mongoose","morgan","multer","natural-orderby","nodemailer","passport","passport-google-oauth20","passport-local","path-is-inside","request","sanitize-filename","serve-index","socket.io","socket.io-redis","unzipper","uuid"];e.exports=function(e){const t=e.chiConfig,a=e.io,c=e.helpers,d=c.chiAsyncWrap,l=c.getCode,p=c.viewNpmPkg,u=c.getAuthAsync,h=s.Router();h.get("/api/info",d(async(e,a)=>{a.json({errors:[],success:{admin_email:t.serverConfig.admin_email,reCaptchaSiteKey:t.reCaptcha?t.reCaptcha.reCaptchaSiteKey:void 0,dropboxKey:t.Dropbox?t.Dropbox.appKey:void 0,googleClientID:t.GoogleAuth?t.GoogleAuth.clientID:void 0,googlePickerAPIKey:t.GooglePicker&&t.GooglePicker.apiKey?t.GooglePicker.apiKey:void 0,home:t.home?t.home:{},fileLimits:t.system.fileLimits.toString()}})})),h.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(l("a011")),t.json(s);a()}),h.get("/api/npmpkg/list",d(async e=>{const t={errors:[],success:{}},a=e.session.passport.user.id;await u(a,"base",9);const s=i(process.env.BDP_SYSTEM_FOLDER).next().value||null;return t.success=s&&s.dependencies?s.dependencies:{},t})),h.get("/api/module/list",d(async e=>{const t={errors:[],success:{}},a=e.session.passport.user.id;await u(a,"base",9);let s=await r.findOne({name:"big-data-processor"});return s||(s=new r({name:"big-data-processor",modules:[]}),await s.save()),t.success=s.getModel().modules,t})),h.get("/api/npmpkg/view",d(async e=>{const t={errors:[],success:{}},a=e.query.pkgName,s=e.query.pkgVersion,i=e.session.passport.user.id;if(await u(i,"base",9),t.success=await p(a,s),!t.success.pkgInfo)throw[l("s004",{details:`We cannot find the npm package (${a}).`})];return t}));const g=async function(e,t,s){const i={stdout:"",stderr:""},r=function(s,r){i[s]+=r,a.to(e).emit("packageOut",{type:"stdout"===s?"stdOut":"stdErr",target:t,data:i[s]})};let n=0;try{n=0===(await o("npm",["install","--save",`${t}@${s}`],"install-npm-pkg",{mode:"memory"},r)).exitCode?2:1}catch(e){console.log(e),n=1}return{stdout:i.stdout,stderr:i.stderr,status:n}};h.get("/api/npmpkg/install",d(async(e,t)=>{const s={errors:[],success:{}},i=e.query.pkgName,o=e.query.pkgVersion,c=e.session.passport.user.id;await u(c,"base",9);const d=await p(i,o);if(!d.pkgInfo)throw[l("s004",{details:`We cannot find the npm package (${i}).`})];if("@big-data-processor/task-reader"!==i&&n.indexOf(i)>=0)throw[l("s004",{details:`The npm package ${i} is required. You cannot install it.`})];let h="npm";if(d.bdp){const e=d.bdp.type;"adapter"===e?h="adapter":"filter"===e&&(h="filter")}n.indexOf(i)>=0&&(h="system");let f=await r.findOne({name:"big-data-processor"});f||(f=new r({name:"big-data-processor",modules:[]}));let m=-1;for(let e=0;e<f.modules.length;e++){if(f.modules[e].pkgName===i){m=e;break}}if(m<0)f.modules.push({name:d.bdp?d.bdp.name:d.pkgInfo.name,pkgName:i,moduleType:h,author:d.pkgInfo.author,email:d.pkgInfo.email,desc:d.pkgInfo.description,version:d.pkgInfo.version,status:0,stdout:"",stderr:""}),m=f.modules.length-1;else{const e=f.modules[m];e.name=d.bdp?d.bdp.name:d.pkgInfo.name,e.moduleType=h,e.author=d.pkgInfo.author,e.email=d.pkgInfo.email,e.desc=d.pkgInfo.description,e.status=0,e.stdout="",e.stderr=""}const w=await f.save();s.success=w.getModel(),a.to(c).emit("dataChange",{type:"module",target:"System",data:s.success.modules}),t.json(s);const y=await g(c,i,d.pkgInfo.version);try{const e=f.modules[m];e.name=d.bdp?d.bdp.name:d.pkgInfo.name,e.version=d.pkgInfo.version,e.moduleType=h,e.author=d.pkgInfo.author,e.email=d.pkgInfo.email,e.desc=d.pkgInfo.description,e.status=y.status,e.stdout=y.stdout,e.stderr=y.stderr;const t=await f.save();a.to(c).emit("dataChange",{type:"module",target:"System",data:t.getModel().modules})}catch(e){console.log(e)}})),h.get("/api/npmpkg/uninstall",d(async(e,t)=>{const s={errors:[],success:{}},c=e.query.pkgName,d=e.session.passport.user.id;if(await u(d,"base",9),n.indexOf(c)>=0)throw[l("s004",{details:`The npm package ${c} is required. You cannot uninstall it.`})];const p=i(__dirname).next().value||null,h=p&&p.dependencies?p.dependencies:{};let g=await r.findOne({name:"big-data-processor"});if(g){let e=-1;for(let t=0;t<g.modules.length;t++){if(g.modules[t].pkgName===c){e=t;break}}e>=0&&(h[c]?g.modules[e].status=3:g.modules.splice(e,1))}else g=new r({name:"big-data-processor",modules:[]});const f=await g.save();if(s.success=f.getModel(),t.json(s),!h[c])return;const m={stdout:"",stderr:""},w=function(e,t){m[e]+=t,a.to(d).emit("packageOut",{type:"stdout"===e?"stdOut":"stdErr",target:c,data:m[e]})};let y=!1;try{if(0===(await o("npm",["uninstall","--save",""+c],"uninstall-npm-pkg",{mode:"default"},w)).exitCode)for(let e=0;e<g.modules.length;e++){if(g.modules[e].pkgName===c){g.modules.splice(e,1);break}}else y=!0}catch(e){y=!0}if(y)for(let e=0;e<g.modules.length;e++){if(g.modules[e].pkgName===c){g.modules[e].status=1,g.modules[e].stdout=m.stdout,g.modules[e].stderr=m.stderr;break}}const k=await g.save();a.to(d).emit("dataChange",{type:"module",target:"System",data:k.getModel().modules})}));let f=!1;return h.get("/api/npmpkg/restore",d(async(e,t)=>{const s={errors:[],success:{}},o=e.session.passport.user.id;await u(o,"base",9);const n=(i(process.env.BDP_SYSTEM_FOLDER).next().value||null).dependencies||{};let c=await r.findOne({name:"big-data-processor"});c||(c=new r({name:"big-data-processor",modules:[]}));const d=await c.save();s.success=d.getModel(),t.json(s);const l=d.modules,p=[];if(f)a.to(o).emit("message",{code:"s004",name:"The package restoring is processing",type:"warning",details:"Please wait while we are reinstalling your packages."});else{f=!0;for(let e=0;e<l.length;e++){const t=l[e],s=t.pkgName;if(!n[s]){t.status=0,a.to(o).emit("dataChange",{type:"module",target:"System",data:c.getModel().modules}),await c.save();const e=await g(o,s,t.version);t.status=e.status,t.stdout=e.stdout,t.stderr=e.stderr,1===t.status&&p.push(t),await c.save(),a.to(o).emit("dataChange",{type:"module",target:"System",data:c.getModel().modules})}}a.to(o).emit("message",{code:"s004",name:p.length>0?"Failed to install some packages":"Finished restoring installed packages",type:p.length>0?"error":"success",details:p.length>0?"Several npm packages were failed to install: "+p.map(e=>e.pkgName).join(", "):"All previous installed packages were restored."}),f=!1}})),h}},function(e,t){e.exports=require("find-package-json")},function(e,t,a){const s=a(0),i=a(84),r=s.model("SystemInfo",i);e.exports=r},function(e,t,a){const s=new(0,a(0).Schema)({name:{type:String,unique:!0},modules:[{name:String,pkgName:String,moduleType:String,author:String,email:String,desc:String,version:String,status:Number,stdout:String,stderr:String}]},{timestamps:!0});s.methods.getModel=function(){return{modules:this.modules.map(e=>({name:e.name,pkgName:e.pkgName,moduleType:e.moduleType,author:e.author,email:e.email,desc:e.desc,version:e.version,status:e.status,stdout:e.stdout,stderr:e.stderr}))}},e.exports=s}]));
//# sourceMappingURL=big-data-processor.js.map