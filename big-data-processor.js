!function(e,t){for(var a in t)e[a]=t[a]}(exports,function(e){var t={};function a(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,a),i.l=!0,i.exports}return a.m=e,a.c=t,a.d=function(e,t,s){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(s,i,function(t){return e[t]}.bind(null,i));return s},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=30)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=require("express")},function(e,t,a){const s=a(0),i=a(50),r=s.model("Project",i);e.exports=r},function(e,t,a){var s=a(0),i=a(51),r=s.model("DataFile",i);e.exports=r},function(e,t,a){const s=a(0),i=a(47),r=s.model("Account",i);e.exports=r},function(e,t){e.exports=require("path-is-inside")},function(e,t,a){var s=a(0),i=a(52),r=s.model("Result",i);e.exports=r},function(e,t,a){const s=a(0),i=a(24),r=s.model("Task",i);e.exports=r},function(e,t,a){const s=a(0),i=a(54),r=s.model("Package",i);e.exports=r},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("socket.io")},function(e,t,a){var s=a(0),i=a(55),r=s.model("ResultHistory",i);e.exports=r},function(e,t){e.exports=require("dashify")},function(e,t){e.exports=require("child_process")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("readline")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("js-yaml")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("passport")},function(e,t,a){const s=a(0),i=a(49),r=s.model("SystemError",i);e.exports=r},function(e,t,a){const s=a(0),i=s.Schema,r=a(53),o=a(18),n=new s.Schema({name:{type:String,default:""},key:{type:String,default:""},desc:{type:String,default:""},package:{type:i.Types.ObjectId,ref:"Package"},img:{type:String,default:""},thumbnail:{type:String,default:""},script:{type:String},exec:{type:String},cwd:{type:String},type:{type:String},arguments:[r],tags:[{type:String}],mapper:[{type:i.Types.Mixed}],stepNames:[{type:String}],encodeArg:{type:Boolean},proxy:{enabled:{type:Boolean,default:!1},protocol:{type:String,default:"http"},pathRewrite:Boolean,port:Number,ip:String,entryPath:{type:String,default:"/"}}},{timestamps:!0}),d=function(e,t){if(t)return Buffer.from(String(e),"utf8").toString("base64");{let t=String(e).replace(/\\/g,"\\").replace(/\'/g,"'").replace(/\"/g,'"').replace(/\|/g,"|").replace(/\;/g,";").replace(/\(/g,"(").replace(/\)/g,")");return t="win32"===o.platform()?'"'+t+'"':"'"+t+"'",t}};n.methods.getScriptPath=function(e,t,a){return this.script?this.script.match(/^\$PackageFolder/)&&e?this.script.replace(/^\$PackageFolder/,e):this.script.match(/^\$ScriptFolder/)?this.script.replace(/^\$ScriptFolder/,a):this.script.match(/^\$ProjectFolder/)&&t?this.script.replace(/^\$ProjectFolder/,t):this.script.match(/^\$SystemFolder/)?this.script.replace(/^\$SystemFolder/,process.env.BDP_SYSTEM_FOLDER):this.script:""},n.methods.compose=function(e,t,a,s){const i=this.arguments;let r=[];const o=[],n=this.encodeArg;"workflow"!==this.type&&(r=[this.exec,'"'+this.getScriptPath(t,a,s)+'"']);for(let t=0;t<i.length;t++){const a=i[t],s=a.type;if(a.hidden)continue;const r=a.listSplitter?a.listSplitter:",";if(a.option&&o.push(d(String(a.option),n)),"value"===s){if(a.optional&&(null===e[t][s]||void 0===e[t][s])){a.option&&o.pop();continue}o.push(d(String(e[t][s]),n))}else if("static"===s)o.push(d(String(e[t][s]),n));else if("list"===s){if(a.optional&&(null===e[t][s]||void 0===e[t][s]||0===e[t][s].length)){a.option&&o.pop();continue}o.push(d(e[t][s].join(r),n))}else{if(a.optional&&(null===e[t][s]||void 0===e[t][s]||""===e[t][s])){a.option&&o.pop();continue}o.push(d(e[t][s],n))}}return{command:r.join(" "),commandArgs:o}},n.methods.outputProvider=function(){const e=[];for(let t=0;t<this.arguments.length;t++){const a=this.arguments[t];"outFile"==a.type&&(a.dependOn&&a.default?e.push({format:a.format,tags:a.tags,index:t,name:a.name,dependOn:a.dependOn,default:a.default[0],outPreFolder:a.outPreFolder,outFolderStyle:a.outFolderStyle}):e.push({format:a.format,tags:a.tags,index:t,name:a.name,outPreFolder:a.outPreFolder,dependOn:null,default:"",outFolderStyle:a.outFolderStyle}))}return e},n.methods.getModel=function(e){return{id:this.id,name:this.name,desc:this.desc,key:this.key,package:this.package,script:this.script,img:this.img,thumbnail:this.thumbnail,exec:this.exec,cwd:this.cwd,type:this.type,arguments:this.arguments,mapper:this.mapper,stepNames:Array.isArray(this.stepNames)?this.stepNames:[],version:this.version,encodeArg:!!this.encodeArg,workflowPlaybook:e||"",proxy:this.proxy&&this.proxy.enabled?{protocol:this.proxy.protocol,pathRewrite:!!this.proxy.pathRewrite,port:this.proxy.port,ip:this.proxy.ip,entryPath:this.proxy.entryPath||"/"}:null}},n.methods.getModelForViewer=function(){return{id:this.id,name:this.name,desc:this.desc,key:this.key,package:this.package&&this.package.getModel?this.package.getModel():this.package,img:this.img,thumbnail:this.thumbnail,type:this.type,arguments:this.arguments,mapper:this.mapper,stepNames:Array.isArray(this.stepNames)?this.stepNames:[],version:this.version,encodeArg:!!this.encodeArg,proxy:this.proxy&&this.proxy.enabled?{protocol:this.proxy.protocol,pathRewrite:!!this.proxy.pathRewrite,port:this.proxy.port,ip:this.proxy.ip,entryPath:this.proxy.entryPath||"/"}:null}},e.exports=n},function(e,t){e.exports=require("@big-data-processor/utilities")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("multer")},function(e,t){e.exports=require("filenamify")},function(e,t){e.exports=require("archiver")},function(e,t,a){"use strict";const s=a(3),i=a(1),r=a(31),o=a(11),n=a(19),d=a(2),c=a(32),l=a(20),p=a(33),u=a(34),h=a(15),g=function(e,t,a){return new Promise((s,i)=>{process.stderr.write(`[${(new Date).toString()}] ${a} starting.\n`),process.stderr.write(`[command] ${e} ${t.join(" ")}\n`);const r=h.spawn(e,t,{cwd:process.cwd(),stdio:"inherit",shell:!0});r.on("error",e=>{process.stderr.write(`[${(new Date).toString()}] ${a} has errors."`),process.stderr.write(JSON.stringify(e)),i(a+" failed.")}),r.on("exit",e=>(process.stderr.write(`[${(new Date).toString()}] ${a} Finished.\n`),e?i(a+" failed."):s(a+" Finished."))),r.on("SIGTERM",()=>r.kill()),r.on("SIGINT",()=>r.kill())})},f=e=>new Promise(t=>setTimeout(()=>t(),e)),m=async function(e){console.log("step 3. Connect to mongoDB.");const t=e.chiConfig.mongoDB;if(!t)throw"Invalid mongoDB configurations";const s=`mongodb://${t.mongoUser}:${t.mongoPwd}@${t.mongoHost}:${t.mongoPort}/`,i=t.db_name,r=a(0);r.Promise=global.Promise,await r.connect(s+i,{autoIndex:!1,useNewUrlParser:!0}),console.log("MongoDB connected!")},w=async function(){try{const e=await async function(){console.log("step 1. Reading configs");const e={encryption:{saltBits:256,algorithm:"aes-256-cbc",iterations:5},integrity:{saltBits:256,algorithm:"sha256",iterations:2},ttl:0,timestampSkewSec:60,localtimeOffsetMsec:0};let t;const a=await d.pathExists("./configs/server-config.yaml"),s=await d.pathExists("./configs/server-config-template.yaml");!a&&s&&await d.copy("./configs/server-config-template.yaml","./configs/server-config.yaml");try{t=l.safeLoad(r.readFileSync("./configs/server-config.yaml","utf8"))}catch(a){const s=await d.readJson("./configs/server-config.encrypt");if(!s)throw"No config file.";const i=await d.readFile("./configs/server-config.key");return t=await c.unseal(s.config,i.toString(),e),t}if(!t)throw"Invalid server-config.json file.";const o=n.randomBytes(256).toString("base64"),p=await c.seal(t,o,e);return await d.writeFile("./configs/server-config.key",o),await d.writeJson("./configs/server-config.encrypt",{config:p}),process.stdout.write("[Important]\n"),process.stdout.write('Please copy the files "./server-config.json" and "./server-config.key" to remote place(s).\n'),process.stdout.write('Each time you need to start the server, just copy the remote "./server-config.key" file to this folder.\n'),process.stdout.write('If you have updated version of "./server-config.json" file, just copy the updated config file to this folder.\n'),process.stdout.write('A new key "./server-config.key" will be generated for you.\n'),t.system||(t.system={docker_path:"docker",dataFilePath:"./datasets",scriptFolder:"./scripts",uploadFolder:"./uploads",packageFolder:"./packages",taskLogFolder:"./taskLogs",fileLimits:1/0,concurrentProcNumber:3}),t.system.dataFilePath=i.resolve(__dirname,t.system.dataFilePath),t.system.scriptFolder=i.resolve(__dirname,t.system.scriptFolder),t.system.uploadFolder=i.resolve(__dirname,t.system.uploadFolder),t.system.packageFolder=i.resolve(__dirname,t.system.packageFolder),t.system.taskLogFolder=i.resolve(__dirname,t.system.taskLogFolder),t.system.fileLimits=parseFloat(t.system.fileLimits),t.system.concurrentProcNumber=parseFloat(t.system.concurrentProcNumber),t}();await d.ensureDir(i.resolve(e.system.dataFilePath)),await d.ensureDir(i.resolve(e.system.scriptFolder)),await d.ensureDir(i.resolve(e.system.uploadFolder)),await d.ensureDir(i.resolve(e.system.packageFolder)),await d.ensureDir(i.resolve(e.system.taskLogFolder));const t=await function(e){console.log("step 2. Create server app.");const t=a(21).URL;return process.env.BDP_SYSTEM_FOLDER=i.resolve(__dirname),console.log(process.env.BDP_SYSTEM_FOLDER),new Promise((n,c)=>{let l;const h=s();if(h.use(p({contentSecurityPolicy:!1})),h.enable("trust proxy"),"https:"===new t(e.serverConfig.site_domain).protocol)if(e.https&&e.https.credentialKey&&e.https.credentialCertificate){const t={key:r.readFileSync(e.https.credentialKey),cert:r.readFileSync(e.https.credentialCertificate)};l=o.createServer(t,h);const s=a(12)(l);n({chiServer:l,chiConfig:e,app:h,io:s,helpers:{}})}else if(e.certbot){console.log("Using greenlock-expresss to start the https service.");const s=i.join(e.certbot.certbotStore,"config.json");d.ensureDir(i.dirname(s)).then(()=>d.pathExists(s)).then(a=>{if(!a){let a;try{const s=new t(e.serverConfig.site_domain);a=""+s.hostname,s.port&&(a+=":"+s.port)}catch(e){throw e}return d.writeJSON(s,{defaults:{},sites:[{subject:a}]})}}).then(()=>{a(35).init({cluster:!1,packageRoot:i.resolve("./"),packageAgent:`${u.name}/${u.version}`,maintainerEmail:e.serverConfig.admin_email,configDir:e.certbot.certbotStore,staging:!e.certbot.certbot_production}).ready((function(t){l=t.httpsServer(null,h),t.httpServer().listen(80,(function(t){if(t)return c(t);console.log("Listening for ACME http-01 challenges on",this.address());const s=a(12)(l);n({chiServer:l,chiConfig:e,app:h,io:s,helpers:{}})}))}))}).catch(e=>{c(e)})}else{console.log("Invalid https configurations. Switch to http protocol."),l=a(16).createServer(h);const t=a(12)(l);n({chiServer:l,chiConfig:e,app:h,io:t,helpers:{}})}else{l=a(16).createServer(h);const t=a(12)(l);n({chiServer:l,chiConfig:e,app:h,io:t,helpers:{}})}})}(e);try{await m(t)}catch(a){if(console.log(a),console.log("No database connections."),e.mongoDB.containerName){try{console.log("Trying to start "+e.mongoDB.containerName);const t=e.system.docker_path;await g(t,["start",e.mongoDB.containerName],"try-to-start-bdp-mongo")}catch(a){e.mongoDB.dockerVolumeName?(console.log("Trying to initiate a new MongoDB for you."),await async function(e){const t=e.chiConfig.mongoDB,a=e.chiConfig.system.docker_path,s=t.mongoUser,i=t.mongoPwd,r=t.db_name,o=t.dockerVolumeName,n=t.containerName,d=t.mongoPort,c=t.containerType;if(!o)throw"No dockerVolumeName to create the volume automatically.";try{await g(a,["volume","create",o],"create-docker-volume")}catch(e){console.log(e)}const l=`${n}-${(new Date).getTime()}-${Math.floor(1e6*Math.random())}`;await g(a,["run","-d","-v",o+":"+("windows"===c?"C:\\data\\db":"/data/db"),"--name",l,"mongo:4.4.2"],"create-a-temp-mongodb"),await f(1e4),console.log("Wait 10 sec for the docker service...");try{await g(a,["exec",l,"mongo",r,"--eval",'"db.createUser({ user: \\"'+s+'\\", pwd: \\"'+i+'\\", roles: [ { role: \\"readWrite\\", db: \\"'+r+'\\" } ] });"'],"create-db-user")}catch(e){console.log(e)}await g(a,["stop",l],"stop-the-temp-mongo"),await g(a,["rm",l],"remove-the-temp-mongo"),await g(a,["run","-d","-v",o+":"+("windows"===c?"C:\\data\\db":"/data/db"),"--restart","always","--name",n,"-p",d+":27017","mongo:4.4.2","mongod","--port",27017,"--auth"],"create-mongo-database")}(t)):console.log("You can set the mongoDB.dockerVolumeName to create a mongoDB database automatically (using Docker).")}console.log("Wait 10s for the mongoDB service..."),await f(1e4),await m(t)}else console.log("You can set the mongoDB.dockerVolumeName and the mongoDB.containerName in the server-config.yaml file. Then, we will use Docker MongoDB container to create the database for you.")}return await async function(e){const t=e.chiConfig,s=e.app,o=a(36);if(t.serverConfig.accessLog){console.log("step 4. Enable access logging.");const e=/^\/(admin|data|dataFile|user|project|result)\//;await d.ensureFile(i.resolve(t.serverConfig.accessLog));const a=r.createWriteStream(i.resolve(t.serverConfig.accessLog),{flags:"a"});o.token("route-api-route",(function(t){const a=e.exec(t.originalUrl);return a?a[1]:"public"})),o.token("ips",(function(e){return e.ips.join(",")})),o.token("ip",(function(e){return e.ip})),o.token("realclfdate",(function(){const e=function(e){const t=String(e);return(1===t.length?"0":"")+t},t=new Date,a=t.getDate(),s=t.getHours(),i=t.getMinutes(),r=t.getSeconds(),o=t.getFullYear();let n=t.getTimezoneOffset();const d=n>0?"-":"+";n=parseInt(Math.abs(n)/60);const c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getUTCMonth()];return e(a)+"/"+c+"/"+o+":"+e(s)+":"+e(i)+":"+e(r)+" "+d+e(n)+"00"})),s.use(o("[:realclfdate]\t:route-api-route\t:method\t:url\t:status\t:res[content-length]\t:response-time\t:ip\t:ips\t:referrer\t:user-agent",{stream:a})),process.stderr.write("Logging enabled. The log file: "+i.resolve(t.serverConfig.accessLog)+"\n")}else console.log("step 4. Disabled access logging: no setting the accessLog file path in serverConfig.");return e}(t),await async function(e){console.log("step 5. Setting middlewares.");const t=e.chiConfig,s=e.app,i=a(37),r=a(38),o=a(22),n=a(39),d=a(40)(n),c=a(41);s.use((function(e,a,s){t.serverConfig.development&&(a.header("Access-Control-Allow-Origin",t.serverConfig.devSite+(t.serverConfig.devPort?":"+t.serverConfig.devPort:"")),a.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),a.header("Access-Control-Allow-Headers","X-Requested-With, X-HTTP-Method-Override, Content-Type, Accept"),a.header("Access-Control-Allow-Credentials",!0)),s()})),s.use(c({filter:function(e,t){return!t.get("x-no-compression")&&c.filter(e,t)}})),s.use(r.urlencoded({extended:!1})),s.use(r.json()),s.use(r.raw()),s.use(i(t.serverConfig.sessionSecret));const l=t.mongoDB;l?s.use(n({secret:t.serverConfig.sessionSecret,store:new d({url:`mongodb://${l.mongoUser}:${l.mongoPwd}@${l.mongoHost}:${l.mongoPort}/${l.db_name}`}),saveUninitialized:!1,resave:!0,cookie:{maxAge:t.serverConfig.cookieMaxAge||void 0,secure:0===t.serverConfig.site_domain.indexOf("https://"),sameSite:0===t.serverConfig.site_domain.indexOf("https://")?"none":"lax"}})):console.log("No mongoDB configs, so sessions are not used. Maybe i will add 3rd party session store options."),s.use(o.initialize()),s.use(o.session());const p=a(42)({title:"Big Data Processor server status",path:"",websocket:e.io});s.use(p.middleware),s.get("/server-status",(e,t,a)=>e.isAuthenticated()?a():t.redirect("/"),p.pageRoute),e.proxyMapper={},e.helpers=await a(43)(e);const u=await a(58)(e);e.helpers.setTaskRunner(u);const h=t.system.concurrentProcNumber||3;return u.setConcurrentProcesses(h),e}(t),await function(e){console.log("step 6. Reading routing information");const t=e.app;return t.use(s.static(i.resolve("./public"))),t.use("/account",a(62)(e)),t.use("/admin",a(65)(e)),t.use("/project",a(66)(e)),t.use("/result",a(67)(e)),t.use("/data",a(69)(e)),t.use("/dataFile",a(73)(e)),t.use("/task",a(77)(e)),t.use("/page",a(80)(e)),t.use("/system",a(81)(e)),t.get("*",(e,t)=>{t.status(200).sendFile(i.resolve("./public/index.html"))}),e}(t),function(e){console.log("step 7. Enable socket connections.");const t=e.io;if(!t)throw"No socket.io";const a=function(){return Object.keys(t.sockets.sockets).length};t.on("connection",(function(s){s.on("signIn",(function(e){s.join(e)})),s.on("signOut",(function(e){s.to(e).emit("signOut",{user:e}),s.leave(e,(function(){}))}));const i=e.taskRunner;s.on("disconnect",()=>t.emit("serverStatus",{queue:i.getCurrentQueueNumber(),running:i.getCurrentProcessNumber(),online:a()})),t.emit("serverStatus",{queue:i.getCurrentQueueNumber(),running:i.getCurrentProcessNumber(),online:a()})}))}(t),t.chiServer.listen(e.serverConfig.port,(function(){console.log(`${e.serverConfig.title} server (${e.serverConfig.site_domain}) listening on port ${e.serverConfig.port}`),console.log(this.address())})),t}catch(e){console.log("Cannot create the server due to the error(s):"),console.log(e),process.exit(1)}};(async()=>{try{const e=await w();process.on("SIGTERM",()=>{console.log("Receiving stop signal SIGTERM.\n"),e.io.emit("message",{code:"default",name:"Server is shutting down",type:"default",details:"Please do not create new tasks."}),e.taskRunner.stopAllWithSIGINT().catch(e=>console.log(e)).finally(()=>process.exit(1)),setTimeout(()=>{console.log("Server stopped."),process.exit(0)},3e4)}),process.on("SIGINT",()=>{console.log("Receiving stop signal SIGINT. Stopping server now.\n"),e.io.emit("message",{code:"default",name:"Server is shutting down",type:"default",details:"Please do not create new tasks."}),e.taskRunner.stopAllWithSIGINT().catch(e=>console.log(e)).finally(()=>process.exit(1)),setTimeout(()=>{console.log("Server stopped."),process.exit(0)},3e5)}),process.on("uncaughtException",(function(e){console.log("Caught exception: "+e),console.log(e)}))}catch(e){console.log(e)}})()},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("@hapi/iron")},function(e,t){e.exports=require("helmet")},function(e){e.exports=JSON.parse('{"name":"big-data-processor","version":"1.0.0","description":"The next generation data science workbench","main":"index.js","scripts":{"start":"node big-data-processor.js","build":"webpack --config webpack.config.js","test":"echo \\"Error: no test specified\\" && exit 1"},"author":"Chi Yang","license":"MIT","dependencies":{"@big-data-processor/example-filters":"^0.8.1","@big-data-processor/task-adapter-docker":"^0.8.10","@big-data-processor/task-reader":"^0.8.10","@big-data-processor/utilities":"^0.8.7","@hapi/iron":"^6.0.0","archiver":"^3.1.1","body-parser":"^1.19.0","compression":"^1.7.4","connect-mongo":"^3.2.0","content-disposition":"^0.5.3","cookie-parser":"^1.4.5","cors":"^2.8.5","dashify":"^1.0.0","detect-port":"^1.3.0","express":"^4.17.1","express-session":"^1.17.1","express-status-monitor":"^1.3.3","filenamify":"^4.2.0","find-package-json":"^1.2.0","fs-extra":"^9.0.1","globby":"^11.0.1","googleapis":"^66.0.0","greenlock-express":"^4.0.3","helmet":"^4.3.1","http-proxy":"^1.18.1","js-yaml":"^3.14.1","mime-types":"^2.1.27","mongoose":"^5.11.9","morgan":"^1.10.0","multer":"^1.4.2","natural-orderby":"^2.0.3","nodemailer":"^6.4.17","passport":"^0.4.1","passport-google-oauth20":"^2.0.0","passport-local":"^1.0.0","path-is-inside":"^1.0.2","request":"^2.88.2","sanitize-filename":"^1.6.3","serve-index":"^1.9.1","socket.io":"^2.4.1","unzipper":"^0.10.11","uuid":"^8.3.2"},"devDependencies":{"@babel/compat-data":"^7.12.7","@babel/core":"^7.12.10","@babel/plugin-transform-runtime":"^7.12.10","@babel/preset-env":"^7.12.11","babel-loader":"^8.2.2","webpack":"^4.44.2","webpack-cli":"^3.3.12","webpack-node-externals":"^1.7.2"}}')},function(e,t){e.exports=require("greenlock-express")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("connect-mongo")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("express-status-monitor")},function(e,t,a){const s=a(44),i=a(45),r=a(2),o=a(1),n=a(11),d=a(17),c=a(46),l=a(18),p=a(15),u=a(6),h=a(23),g=a(4),f=a(5),m=a(8),w=a(9),y=a(10),k=a(13),v=a(14),b=a(20),S=a(56),x=a(57),O=a(25),I=O.sleep,F=O.httpGet;e.exports=async function(e){const t=e.io,a=e.chiConfig,O=a.system.docker_path,j=a.system.dataFilePath,T=a.system.taskLogFolder,D=await u.findOne({"auths.base":9}),P=async function(e,t){let a=-1;t&&(a=t.dataFiles.indexOf(e.id));try{await e.unlinkFileAndRemove(j),a>=0&&t.dataFiles.splice(a,1),_.socketBroadcast(t.getListeners(),"dataChange",{type:"remove",target:"DataFile",data:e.getModel()})}catch(e){console.log("Deleting files has errors"),console.log(e)}},A=async function(t){await e.taskRunner.deleteTaskInQueue(t.id),await e.taskRunner.stopRunningTask(t.pid)},$=async function(e){let t=!1,a=null;const s=e.outFiles;for(;!t;){a=await g.findOne({_id:e.project}).populate("owner managers runners viewers"),a||console.log("Can not find the project");let i=!0;for(;i&&(i=await A(e),i);)await I(3e3);let n=[];const d=a.results.indexOf(e.id);d>=0&&(n=a.results.splice(d,1));const c=a.dataFiles.length;a.dataFiles=a.dataFiles.filter(e=>{for(const t of s)if(e.toString()===t.toString())return!1;return!0});const l=a.dataFiles.length,p=o.resolve(T,e.id);await r.pathExists(p)&&await r.remove(p);try{(n.length>0||l!==c)&&await a.save(),t=!0}catch(e){t=!1}await I(1e3)}for(let e=0;e<s.length;e++){const t=s[e].getModel();try{await s[e].unlinkFileAndRemove(j),_.socketBroadcast(a.getListeners(),"dataChange",{type:"remove",target:"DataFile",data:t})}catch(e){}}const i=e.getModel();try{await m.deleteOne({_id:e._id}),_.socketBroadcast(a.getListeners(),"dataChange",{type:"remove",target:"Result",data:i})}catch(e){}},_={setTaskRunner:function(t){e.taskRunner=t},getCode:function(e,t){const a=s[e]?e:"unknown";t&&t.attached&&(t.attached=t.attached.stack?t.attached.stack:JSON.stringify(t.attached));return{code:a,name:t&&t.name?t.name:s[a].name,type:t&&t.type?t.type:s[a].type,details:t&&t.details?t.details:s[a].details,attached:t&&t.attached?t.attached:void 0}},errorHandler:function(e,t){return e.errors||(e.errors=[]),Array.isArray(t)?e.errors.push.apply(e.errors,t):t&&(console.log(t),"MongoError"===t.name?e.errors.push(_.getCode("s003",{attached:t.stack?t.stack:t})):e.errors.push(_.getCode("s002",{details:"Errors occur during this request. Please try again or report issues.",attached:t.stack?t.stack:t}))),e},isAuthenticated:async function(e,t,a){let s=e.query.authToken,i=null;if(s){s=s.toString();const e=await u.findOne({authToken:s});if(e){const t=e.authTime;((new Date).getTime()-t.getTime())/864e5<=3&&(i=e)}}if(!i&&e.isAuthenticated())try{const s=e.session.passport.user.id;i=await _.getAuthAsync(s,t||"base",a||2)}catch(e){console.log(e)}return i},escapeText:function(e){let t=String(e);return t=t.replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\"/g,'\\"').replace(/\|/g,"\\|").replace(/\;/g,"\\;").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\ /g,"\\ "),"win32"===l.platform()?`"${t}"`:`'${t}'`},logMessages:async function(e,a,s){const i=[];for(const t of a){const a=new h({account:e,code:t.code,name:t.name,type:t.type,routePath:s,details:t.details,attached:t.attached});i.push(a.save())}const r=i.map(async e=>{const t=await e;return h.findOne({_id:t.id}).populate("account")});if(D&&D.id)for(const e of r){const a=await e;t.to(D.id).emit("dataChange",{type:"insert",target:"system-error",data:a.getModel()})}},async getTaskByMap(e){let t=await w.findOne({_id:e.id,key:e.key}).populate("package");if(t)return t;if(t=await w.findOne({_id:e.id}).populate("package"),t)return t;const a=_.pkgNameFormatter(e.pkg+"-"+e.ver).split("-").slice(0,-1).join("-"),s=await y.find({$or:[{_id:e.pkgid},{name:{$regex:"^"+a}}]});if(0===s.length)return null;let i;const r=s.filter(t=>t.id===e.pkgid);if(1===r.length)i=r[0].id;else{const t=s.filter(t=>0===t.name.indexOf(e.pkg));if(1===t.length)i=t[0].id;else if(t.length>1){const a=t.filter(t=>t.name.split("-").slice(-1)[0]===e.ver);i=1===a.length?a[0].id:x(t,[e=>e.name.split("-").slice(-1)[0]],"desc")[0].id}}return t=await w.findOne({key:e.key,package:i}).populate("package"),t||null},chiAsyncWrap:function(e){return e.length<=3?function(t,a,s){return e(t,a,s).catch(e=>{let a={errors:[]};if(a=_.errorHandler(a,e),a.errors.length>0){const e=t.isAuthenticated()?t.session.passport.user.id:null;_.logMessages(e,a.errors,t.originalUrl).catch(console.log)}return a}).then(e=>e?a.json(e):"").catch(s)}:function(t,a,s,i){return e(t,a,s,i).catch(e=>{let t={errors:[]};if(t=_.errorHandler(t,e),t.errors.length>0){const e=a.isAuthenticated()?a.session.passport.user.id:null;_.logMessages(e,t.errors,a.originalUrl).catch(console.log)}return t}).then(s.json).catch(i)}},getAuthAsync:async function(e,t,a){let s;try{s=await u.findOne({_id:e})}catch(e){throw[_.getCode("s003",{attached:e})]}if(s){if(s.auths[t]<a)throw[_.getCode("a017")];return s}throw[_.getCode("a015")]},reCAPTCHA:function(e){const t={secret:a.reCaptcha.reCaptchaSecret,response:e},s=i.stringify(t),r={hostname:"www.google.com",port:443,path:"/recaptcha/api/siteverify",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":s.length}};return new Promise((e,t)=>{const a=n.request(r,a=>{let s="";a.on("data",e=>{s+=e}),a.on("end",(function(){const a=JSON.parse(s);return a.success?e(a):t([_.getCode("a012")])}))});a.write(s),a.end()})},sendVerifyEmail:function(e,t){if(a.email&&a.email.smtpConfig){const s=a.serverConfig.site_domain+"/account/email-verify?authToken="+t,i=S.createTransport(a.email.smtpConfig),r={to:e,from:"chiyang@mail.cgu.edu.tw",subject:"Verify your email for Bio-Data Processor",html:`${a.email.verificationContent||""}<hr><p>This is a verfication email for Bio-Data Processor.<br>\n            If you did not register to Bio-Data Processor, please skip this email and DO NOT click the following link.<br><br>\n            </p><br> <b><a target=_blank href='${s}'>Verify this email</a></b><br><br>Sincerely,<br>Big-Data Processor<br>`};return new Promise((e,t)=>i.sendMail(r,a=>a?t([{code:"a021",attached:a}]):e()))}return Promise.resolve()},userInList:function(e,t){for(let a=0;a<e.length;a++)if(e[a]===t||e[a]._id===t||e[a].id===t)return!0;return!1},makeResultStopped:async function(e){try{if(await k.errorRun(e.id),"workflow"===e.type){console.log("Starting to stop the workflow");const t=await m.find({parent:e.id}).populate("owner inFiles outFiles task");for(const e of t)await A(e)}await A(e),"workflow"===e.type&&(e.status=3),await e.save()}catch(e){console.log(e)}},makeResultDeleted:async function(t){try{if(t.status=4,await t.save(),await k.deleteRun(t.id),"workflow"===t.type){console.log(`Start deleting workflow (result: ${t.id})`),await e.taskRunner.deleteWorkflow(t.id);const a=await m.find({parent:t.id}).populate("owner inFiles outFiles task");for(const e of a)await A(e);await I(3e3);for(const e of a)console.log(`remove children => id: ${e.id}; status: ${e.status}.`),await $(e)}console.log(`removing result => id: ${t.id}; status: ${t.status}`),await $(t),console.log(`Result removed => id: ${t.id}.`)}catch(e){console.log(e)}},runProcessAsync:function(e,t,a){return new Promise((s,i)=>{process.stderr.write(`[${(new Date).toString()}] ${a} starting.\n`),process.stderr.write(`[command] ${e} ${t.join(" ")}\n`);const r=p.spawn(e,t,{cwd:process.cwd(),stdio:"inherit",shell:!0});r.on("error",e=>{process.stderr.write(`[${(new Date).toString()}] ${a} has errors.\n`),process.stderr.write(JSON.stringify(e)),i(a+" failed.")}),r.on("exit",e=>(process.stderr.write(`[${(new Date).toString()}] ${a} finished.\n`),e?i(a+" failed."):s(a+" Finished."))),r.on("SIGTERM",()=>r.kill()),r.on("SIGINT",()=>r.kill())})},getContainerIP:async function(e){return e?new Promise(t=>{let a="";const s=p.spawn(O,["inspect","--format='{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}'",e],{stdio:"pipe",shell:!0});s.on("error",()=>t(null)),s.stdout.on("data",e=>{a+=e.toString()}),s.on("exit",e=>t(0===e?a.replace(/\'/g,"").replace(/\n/g,""):null)),s.on("SIGTERM",()=>{s.kill(),t(null)}),s.on("SIGINT",()=>{s.kill(),t(null)})}):null},issueAvailablePort:async function(t,a){const s=e.proxyMapper,i=Object.keys(s),r={};for(let e=0;e<i.length;e++){const t=s[i[e]].hostPort;r[t]?r[t]++:r[t]=1}if(a&&a>0)return r[a]?null:(s[t]={hostPort:a},a);for(let e=20200;e<65535;e++){if(r[e])continue;const a=await c(e);if(!r[a])return s[t]={hostPort:a},a}return null},makeDataFileDeleted:async function(e,t){if("Folder"!==e.format)await P(e,t);else{const a=await f.find({parent:e.id});for(let e=0;e<a.length;e++)await P(a[e],t);await P(e,t)}return t.save()},getProjectByID:async function(e){return await g.findOne({_id:e}).populate("owner managers runners viewers package packages").populate({path:"dataFiles",populate:{path:"owner"}}).populate({path:"results",populate:{path:"owner"}}).populate({path:"packages",populate:{path:"owner"}})},socketBroadcast:function(e,a,s){if(Array.isArray(e)){if(0===e.length)t.emit(a,s);else if(e.length>=1){let i;e.forEach(e=>{i=t.to(e)}),i.emit(a,s)}}else e?t.to(e).emit(a,s):t.emit(a,s)},pkgNameFormatter:function(e){let t="";if(e.indexOf("-")<0)t=v(e,{condense:!0}).slice(0,220)+"-nover";else{const a=e.split("-"),s=a.pop();t=v(a.join("-"),{condense:!0}).slice(0,220)+"-"+s.slice(0,7)}return t},playbookHandler:async function(e,t,a,s){if(a&&(a=v(a,{condense:!0})).length>32)throw"The Task Key is too long. Please use a shorter text.";const i=await r.pathExists(e);let n={tasks:{}};if(i||"create"!==t){if(!i&&"created"!==t)throw"Task index file not found";{const t=await r.readFile(e,"utf8");n=b.safeLoad(t)}}else await r.ensureFile(e);n.tasks||(n={tasks:{}});const d=n.tasks;if("read"===t){if(!n.tasks[a])throw`The task key, ${a}, is not existed in the task-index file ${e}`;let t="";try{return t=await r.readFile(o.resolve(o.dirname(e),n.tasks[a]),"utf8"),t}catch(e){t=""}return t}switch(t){case"create":if(d[a])throw`The task key, ${a}, is existed in the task index file: ${e}`;d[a]="./tasks/"+a+".yaml",await r.outputFile(o.resolve(e,"../tasks/",a+".yaml"),s);break;case"update":d[a]="./tasks/"+a+".yaml",await r.outputFile(o.resolve(e,"../tasks/",a+".yaml"),s);break;case"delete":let t="";t=d[a]?o.resolve(o.dirname(e),d[a]):o.resolve(e,"../tasks/"+a+".yaml");await r.pathExists(t)&&await r.remove(t),delete d[a]}await r.outputFile(e,b.safeDump(n))},readTaskLogIndex:function(e,t,a){const s="stdout"===a?7:"stderr"===a?8:1;return new Promise(a=>{let i="";const o=r.createReadStream(e),n=d.createInterface({input:o});n.on("line",e=>{const a=e.split("\t");a[0]===t&&(i=a[s],n.close())}),n.on("close",()=>{o.close(),a(i)})})},getFirstTaskName:async function(e){if(!await r.pathExists(e))return null;let t=null;return new Promise(a=>{const s=r.createReadStream(e),i=d.createInterface({input:s});i.on("line",e=>{const a=e.split("\t");"process"!==a[0]&&null===t&&"null"==a[10]&&(t=a[0],i.close())}),i.on("close",()=>{s.close(),a(t)})})},viewNpmPkg:async function(e,t){const a="https://registry.npmjs.com/"+e;try{new URL(a)}catch(e){throw _.getCode("s004",{attached:e})}let s;try{s=await F(a)}catch(e){return{}}const i=JSON.parse(s),r=i["dist-tags"]&&i["dist-tags"].latest?i["dist-tags"].latest:null;let o=null;if(t?i.versions[t]&&(o=i.versions[t]):r&&i.versions[r]&&(o=i.versions[r]),!o)throw _.getCode("s004",{details:`Sorry, we cannot find the version, ${t}, of the package ${e}.`});delete o.dist;const n=o["big-data-processor"]||{},d="string"==typeof o.author?o.author:o.author?o.author.name:"",c=o.author&&o.author.email?o.author.email:null;return{versions:Object.keys(i.versions).reverse(),latest:r,pkgInfo:{name:o.name,version:o.version,description:n.description||o.description,author:n.author||d,email:n.email||c,link:"https://npmjs.com/package/"+o.name},bdp:n.type?n:null}},exportPackageDB:async function(e){const t=e.path,a=o.resolve(t,"db"),s=o.resolve(t,"scripts");await r.ensureDir(s),await r.ensureDir(a);const i=await w.find({package:e.id}),n={package:{name:e.name,category:e.category,desc:e.desc,img:e.img,thumbnail:e.thumbnail,readme:e.readme,author:e.author,email:e.email,scope:e.scope,status:e.status,formatMapping:e.formatMapping,allowedFormats:e.allowedFormats,pages:e.pages},tasks:i.map(e=>{const t=e.toObject();return delete t.createdAt,delete t.updatedAt,t})},d=o.resolve(a,"bdp-package.json");await r.writeJson(d,n)}};return _}},function(e,t){e.exports=require("./public/assets/message-code-table.js")},function(e,t){e.exports=require("querystring")},function(e,t){e.exports=require("detect-port")},function(e,t,a){const s=a(0),i=s.Schema,r=a(19),{v5:o}=a(48),n=new s.Schema({name:{type:String,default:""},email:{type:String,match:/[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+(?:[A-Z]{2}|com|org|net|edu|gov|mil|biz|info|mobi|name|aero|asia|jobs|museum)\b/},passwd:{type:String},isLoggedIn:{type:Boolean,default:!1},lastLoggedIn:{type:Date,default:Date.now()},auths:{base:{type:Number,default:0},bdp:{type:Number,default:0}},authToken:{type:String},authTime:{type:Date,default:Date.now()},providers:[{type:String,default:"local"}],providerIDs:{Google:{type:i.Types.Mixed},BaseSpace:{type:i.Types.Mixed}}},{timestamps:!0});n.methods.verifyPassword=function(e){return r.createHash("sha256","panelSelectionUser").update(e).digest("base64")===this.passwd},n.methods.register=async function(){const e=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if("local"===this.providers[0]){if(!e.test(this.email))throw[{code:"a002",details:"The email format has errors"}];if("string"!=typeof this.passwd||this.passwd.length<8||this.passwd.length>64)throw[{code:"a003",details:"The password has errors"}]}if(await this.model("Account").findOne({email:this.email}))throw[{code:1,msg:"The email has been used."}];if("local"===this.providers[0]){const e=r.createHash("sha256","panelSelectionUser"),t=this.passwd;this.passwd=e.update(t).digest("base64")}0===await this.model("Account").count({})&&(this.auths.base=9,this.auths.bdp=9),await this.save();return this.getModel()},n.methods.getModel=function(){const e=this.email.match(/((...).+?)\@(.*)\.(.*)/);if(!Array.isArray(e))return{id:this.id,name:this.name,email:this.email,lastLoggedIn:this.lastLoggedIn.getTime(),isLoggedIn:this.isLoggedIn,auths:this.auths,chiblogAuth:this.chiblogAuth,providers:this.providers,createdAt:this.createdAt,updatedAt:this.updatedAt,chiblogAuth:this.chiblogAuth};return{id:this.id,name:this.name,email:this.email,lastLoggedIn:this.lastLoggedIn.getTime(),isLoggedIn:this.isLoggedIn,auths:this.auths,chiblogAuth:this.chiblogAuth,providers:this.providers,createdAt:this.createdAt,updatedAt:this.updatedAt,chiblogAuth:this.chiblogAuth}},n.methods.getSlimModel=function(){return{id:this.id,name:this.name,lastLoggedIn:this.lastLoggedIn}},n.methods.getSimpleModel=function(){return{id:this.id,email:this.email,name:this.name,lastLoggedIn:this.lastLoggedIn}},n.methods.setAuthToken=async function(){let e=0;for(;e<1e3;){this.authTime=Date.now();const t=o(this.email+this.id+this.authTime,o.URL);if(0===(await this.model("Account").find({authToken:t})).length)return this.authToken=t,await this.save();e++}return null},n.methods.verifyEmail=async function(e){const t=await this.model("Account").count({}),a=await this.model("Account").findOne({authToken:e});if(!a)throw[{code:"a004",details:"Invalid auth token."}];const s=new Date,i=a.authTime;if((s.getTime()-i.getTime())/864e5>7)throw[{code:"a005",name:"Expired auth token",details:"This token has been expired. We have generated a new token for you. Please sign in and go to user profile page to resend the new token."}];return this.auths.base=1===t?9:1,await this.save(),this.getModel()},n.methods.signIn=async function(){return this.set("isLoggedIn",!0),await this.save(),this.getModel()},n.methods.signOut=async function(){return this.set("isLoggedIn",!1),await this.save(),!0},e.exports=n},function(e,t){e.exports=require("uuid")},function(e,t,a){const s=a(0),i=s.Schema,r=new s.Schema({account:{type:i.Types.ObjectId,ref:"Account"},code:String,type:String,name:String,details:String,routePath:String,attached:i.Types.Mixed},{timestamps:!0});r.methods.getModel=function(){return{id:this._id,account:this.account?this.account.getSimpleModel():null,code:this.code,type:this.type,name:this.name,details:this.details,attached:this.attached,routePath:this.routePath,createdAt:this.createdAt}},e.exports=r},function(e,t,a){const s=a(0),i=s.Schema,r=function(e,t){if(!t)return!1;for(let a=0;a<e.length;a++)if(e[a]==t||e[a]._id==t||e[a].id==t)return!0;return!1},o=new s.Schema({name:{type:String,default:""},owner:{type:i.Types.ObjectId,ref:"Account"},desc:{type:String,default:""},dataFiles:[{type:i.Types.ObjectId,ref:"DataFile"}],results:[{type:i.Types.ObjectId,ref:"Result"}],type:[{type:i.Types.String,default:""}],package:{type:i.Types.ObjectId,ref:"Package"},packages:[{type:i.Types.ObjectId,ref:"Package"}],managers:[{type:i.Types.ObjectId,ref:"Account"}],runners:[{type:i.Types.ObjectId,ref:"Account"}],viewers:[{type:i.Types.ObjectId,ref:"Account"}],public:{type:Boolean,default:!1},open:{type:Boolean,default:!1}},{timestamps:!0});o.methods.getModel=function(e){const t=function(t){return t.getSimpleModel||t.getSlimModel?e&&e.canSetMember?t.getSimpleModel():t.getSlimModel():t},a={id:this.id,name:this.name,desc:this.desc,type:this.type,packages:this.packages.map(e=>e&&e.getModel?e.getModel():e),dataFiles:this.dataFiles.map(e=>e&&e.getModel?e.getModel():e),results:this.results.map(e=>e&&e.getModel?e.getModel():e),owner:{},viewers:this.viewers.map(t),managers:this.managers.map(t),runners:this.runners.map(t),public:!!this.public,privilege:e||{},createdAt:this.createdAt,updatedAt:this.updatedAt};return this.owner&&(this.owner.getSimpleModel||this.owner.getSlimModel?a.owner=e&&e.setMember?this.owner.getSimpleModel():this.owner.getSlimModel():a.owner=this.owner),a},o.methods.getListeners=function(e){let t=[];return this.public||(this.owner&&this.owner._id?t.push(this.owner._id.toString()):this.owner&&t.push(this.owner),t.push.apply(t,this.managers.map(e=>e._id?e._id:e)),t.push.apply(t,this.runners.map(e=>e._id?e._id:e)),t.push.apply(t,this.viewers.map(e=>e._id?e._id:e)),t=t.map(e=>e.toString())),e&&Array.isArray(e)&&t.push.apply(t,e),t.length>=1?t:[]},o.methods.formatChecked=function(e){return this.rawData=e,this.formatCheck=1,this.save(),this},o.methods.getPrivilege=function(e){const t=e.auths.bdp,a=!(!this.owner||this.owner.toString()!==e.id&&this.owner.id!==e.id),s=r(this.managers,e.id),i=r(this.runners,e.id),o=r(this.viewers,e.id),n={canView:!1,canRun:!1,canEdit:!1,canDelete:!1,canDeleteResult:!1,canEditResult:!1,canDeleteFile:!1,canAddFile:!1,canEditFile:!1,canSetMember:!1,isOwner:a,isManager:s,isRunner:i,isViewer:o};return 9===t?Object.assign(n,{canView:!0,canRun:!0,canEdit:!0,canDelete:!0,canDeleteResult:!0,canEditResult:!0,canDeleteFile:!0,canAddFile:!0,canEditFile:!0,canSetMember:!0}):(n.canView=t>=2&&(a||s||i||o||this.public),n.canRun=t>=2&&(a||s||i),n.canEdit=t>=2&&(a||s),n.canDelete=t>=2&&a,n.canEditResult=t>=2&&(a||s||i),n.canDeleteResult=t>=2&&(a||s||i),n.canDeleteFile=t>=2&&(a||s||i),n.canAddFile=t>=2&&(a||s||i),n.canEditFile=t>=2&&(a||s||i),n.canSetMember=t>=2&&(a||s),n)},e.exports=o},function(e,t,a){const s=a(0),i=s.Schema,r=a(2),o=a(7),n=a(1),d=new s.Schema({name:{type:String,default:""},desc:{type:String,default:""},format:{type:String,default:""},path:{type:String,default:""},realPath:{type:String,default:""},tags:[String],parent:{type:i.Types.ObjectId},project:{type:i.Types.ObjectId,ref:"Project"},owner:{type:i.Types.ObjectId,ref:"Account"},result:{type:i.Types.ObjectId,ref:"Result"},status:{type:Number,default:0},additionInfo:{type:i.Types.Mixed,default:{}},size:{type:Number,default:0},hidden:{type:Boolean,default:!1},readOnly:{type:Boolean,default:!1},prefix:{type:String,default:""},suffix:{type:String,default:""}},{timestamps:!0});d.methods.getName=function(){return this.name?this.name:this.id},d.methods.getModel=function(){return{id:this.id,name:this.name,desc:this.desc,format:this.format,tags:this.tags,project:this.project,result:this.result&&this.result.getModel?this.result.getModel():this.result,status:this.status,addition:this.addition,parent:this.parent,hidden:this.hidden,size:this.size,path:this.path,realPath:this.realPath,owner:this.owner&&this.owner.getSlimModel?this.owner.getSlimModel():this.owner,prefix:this.prefix,suffix:this.suffix,createdAt:this.createdAt,updatedAt:this.updatedAt}},d.methods.checkFile=async function(){let e=!1,t=4;if(await r.pathExists(this.path))try{e=await r.stat(this.path),t=1}catch(e){t=4}else t=4;return t!==this.status&&(this.status=t,await this.save()),e},d.methods.ensureFile=async function(e){let t=!1,a=4,s=!1;if(await r.pathExists(this.path))try{t=await r.stat(this.path),a=1}catch(e){a=4}else a=4;if(4===a){const i=this.project._id?this.project._id.toString():this.project,o=this._id.toString(),d="Folder"===this.format?n.resolve(e,i,o):n.resolve(e,i,`${o}.${this.format}`);if(await r.pathExists(d))try{t=await r.stat(d),a=1,this.path=d,s=!0}catch(e){a=4}}return(a!==this.status||s)&&await this.save(),t},d.methods.unlinkFileAndRemove=async function(e){this.status=3;const t=await this.save();if(e){if(o(n.resolve(t.path),n.resolve(e)))try{let a="";a="Folder"===this.format?n.resolve(e,"shared",this.id):n.resolve(e,"shared",this.id+"."+this.format);await r.pathExists(a)&&await r.remove(a),await r.remove(t.path)}catch(e){console.log(e)}else console.log("The Path: "+t.path+" is outside of "+e)}await this.remove()},d.methods.move=async function(e){const t=this.path;this.status=2,await this.save(),await r.move(t,e)},d.methods.extractInfo=function(){this.tags.indexOf("subset")},e.exports=d},function(e,t,a){const s=a(0),i=s.Schema,r=a(24),o=new s.Schema({name:{type:String,required:!0},type:{type:String},desc:{type:String,default:""},owner:{type:i.Types.ObjectId,ref:"Account"},project:{type:i.Types.ObjectId,ref:"Project"},script:{type:String,default:""},children:[{type:i.Types.Mixed}],task:{type:i.Types.ObjectId,ref:"Task"},taskSnapshot:r,parent:{type:i.Types.ObjectId,ref:"Result"},arguments:[{type:i.Types.Mixed}],cwd:{type:String},command:{type:String,default:""},commandArgs:[{type:String}],outFiles:[{type:i.Types.ObjectId,ref:"DataFile"}],inFiles:[{type:i.Types.ObjectId,ref:"DataFile"}],status:{type:Number,default:-1},stdErr:{type:String,default:""},stdOut:{type:String,default:""},error:{type:i.Types.Mixed},readOnly:{type:Boolean,default:!1},timer:[{type:Date}],pid:{type:Number},workflowProgress:[],prefix:{type:String,default:""},suffix:{type:String,default:""}},{timestamps:!0});o.methods.getModel=function(){return{id:this.id,name:this.name,type:this.type,desc:this.desc,owner:this.owner&&this.owner.getSlimModel?this.owner.getSlimModel():this.owner,project:this.project,task:this.task&&this.task.getModel?this.task.getModel():this.task,taskSnapshot:this.taskSnapshot&&this.taskSnapshot.getModel?this.taskSnapshot.getModel():this.taskSnapshot,parent:this.parent,children:this.children,arguments:this.arguments,commandArgs:this.commandArgs,cwd:this.cwd,command:this.command,inFiles:this.inFiles.map(e=>e&&e.getModel?e.getModel():e),outFiles:this.outFiles.map(e=>e&&e.getModel?e.getModel():e),status:this.status,stdErr:this.stdErr,stdOut:this.stdOut,error:this.error,timer:this.timer,readOnly:this.readOnly,pid:this.pid,workflowProgress:[],createdAt:this.createdAt,updatedAt:this.updatedAt,prefix:this.prefix||"",suffix:this.suffix||""}},e.exports=o},function(e,t,a){const s=a(0),i=s.Schema,r=s.Schema({name:String,desc:String,type:{type:String,enum:["static","value","list","inFile","outFile","inDir","outDir"]},format:String,tags:[String],tagMatchRule:{type:String,enum:["or","and","all"],default:"or"},option:{type:String,default:""},optional:{type:Boolean,default:!1},multiple:{type:Boolean,default:!1},default:[{type:i.Types.Mixed}],list:[String],dependOn:String,listType:String,listSplitter:{type:String,default:","},component:{type:String,default:"default"},preview:Boolean,hidden:{type:Boolean,default:!1},outFolderStyle:{type:String,enum:["name","path"],default:"path"},outPreFolder:{type:Boolean,default:!1}},{_id:!1});e.exports=r},function(e,t,a){const s=a(0),i=s.Schema,r=s.Schema({ext:{type:String},tags:[{type:String}]},{_id:!1}),o=function(e,t){if(!t)return!1;for(let a=0;a<e.length;a++)if(e[a]==t||e[a]._id==t||e[a].id==t)return!0;return!1},n=function(e,t){return e.getSimpleModel||e.getSlimModel?t&&t.canSetMember?e.getSimpleModel():e.getSlimModel():e},d=new s.Schema({name:{type:String,required:!0,index:!0,unique:!0},desc:{type:String,default:""},author:{type:String,default:""},email:{type:String,default:""},category:{type:String,default:""},img:{type:String,default:""},thumbnail:{type:String,default:""},path:{type:String,required:!0},fromPath:{type:String,required:!1},scope:[{type:String}],status:{type:Number,default:0},allowedFormats:[{type:String,default:""}],formatMapping:[r],backups:[{type:String}],setupSteps:{type:Number,default:0},stdOut:{type:String},stdErr:{type:String},error:{type:i.Types.Mixed},link:{type:String,default:""},sheetID:{type:String,default:""},sheetName:{type:String,default:""},pages:{indexPages:[{name:{type:String,default:""},desc:{type:String,default:""},path:{type:String,default:""},thumbnail:{type:String,default:""},key:{type:String,default:""},img:{type:String,default:""}}],resultPages:[{name:{type:String,default:""},desc:{type:String,default:""},path:{type:String,default:""},tasks:[{type:String}],thumbnail:{type:String,default:""},key:{type:String,default:""},img:{type:String,default:""}}],filePages:[{name:{type:String,default:""},desc:{type:String,default:""},path:{type:String,default:""},tags:[{type:String}],rules:{type:String,default:"or"},format:{type:String,default:""},thumbnail:{type:String,default:""},key:{type:String,default:""},img:{type:String,default:""}}]},owner:{type:i.Types.ObjectId,ref:"Account"},managers:[{type:i.Types.ObjectId,ref:"Account"}],viewers:[{type:i.Types.ObjectId,ref:"Account"}],runners:[{type:i.Types.ObjectId,ref:"Account"}],public:{type:Boolean,default:!1},open:{type:Boolean,default:!1}},{timestamps:!0});d.methods.setPages=function(e){const t={indexPages:[],resultPages:[],filePages:[]};e&&(Array.isArray(e.indexPages)&&(t.indexPages=e.indexPages.map(e=>({name:e.name||"",desc:e.desc||"",path:e.path||"/assets/pages/index.html",thumbnail:e.thumbnail,key:e.key||"",img:e.img}))),Array.isArray(e.resultPages)&&(t.resultPages=e.resultPages.map(e=>({name:e.name||"",desc:e.desc||"",path:e.path||"/assets/pages/index.html",thumbnail:e.thumbnail,key:e.key||"",img:e.img,tasks:Array.isArray(e.tasks)?e.tasks:[]}))),Array.isArray(e.filePages)&&(t.filePages=e.filePages.map(e=>({name:e.name||"",desc:e.desc||"",path:e.path||"/assets/pages/index.html",thumbnail:e.thumbnail,key:e.key||"",img:e.img,tags:Array.isArray(e.tags)?e.tags.map(e=>e.replace(/[^a-z0-9\-\_]/g,"")):[],rules:-1===["and","or","all"].indexOf(e.rules)?"or":e.rules,format:e.format||""})))),this.pages=t},d.methods.getModel=function(e){const t={id:this.id,name:this.name.split("-").slice(0,-1).join("-"),desc:this.desc,author:this.author,email:this.email,img:this.img,thumbnail:this.thumbnail,status:this.status,scope:this.scope,allowedFormats:this.allowedFormats,formatMapping:this.formatMapping,pages:this.pages,version:this.name.split("-").slice(-1)[0],createdAt:this.createdAt,updatedAt:this.updatedAt,link:this.link,setupSteps:this.setupSteps,privilege:e||this.privilege||{},sheetID:this.sheetID,sheetName:this.sheetName,owner:{},viewers:this.viewers.map(n,e),managers:this.managers.map(n,e),runners:this.runners.map(n,e),public:this.public};return this.owner&&(this.owner.getSimpleModel||this.owner.getSlimModel?t.owner=e&&e.setMember?this.owner.getSimpleModel():this.owner.getSlimModel():t.owner=this.owner),t},d.methods.getDetailModel=function(e){const t={id:this.id,name:this.name.split("-").slice(0,-1).join("-"),desc:this.desc,author:this.author,email:this.email,status:this.status,img:this.img,thumbnail:this.thumbnail,scope:this.scope,allowedFormats:this.allowedFormats,formatMapping:this.formatMapping,pages:this.pages,version:this.name.split("-").slice(-1)[0],backups:this.backups,createdAt:this.createdAt,updatedAt:this.updatedAt,setupSteps:this.setupSteps,stdOut:this.stdOut,stdErr:this.stdErr,error:this.error,link:this.link,sheetID:this.sheetID,sheetName:this.sheetName,privilege:e||{},owner:{},viewers:this.viewers.map(n,e),managers:this.managers.map(n,e),runners:this.runners.map(n,e),public:this.public};return this.owner&&(this.owner.getSimpleModel||this.owner.getSlimModel?t.owner=e&&e.setMember?this.owner.getSimpleModel():this.owner.getSlimModel():t.owner=this.owner),t},d.methods.getListeners=function(e){let t=[];return this.public||(this.owner&&this.owner._id?t.push(this.owner._id.toString()):this.owner&&t.push(this.owner),t.push.apply(t,this.managers.map(e=>e._id?e._id:e)),t.push.apply(t,this.runners.map(e=>e._id?e._id:e)),t.push.apply(t,this.viewers.map(e=>e._id?e._id:e))),e&&Array.isArray(e)&&t.push.apply(t,e),t=t.map(e=>e.toString()),t.length>=1?t:[]},d.methods.getPrivilege=function(e){e&&e.auths||(e={id:"",auths:{bdp:0}});const t=e.auths.bdp,a=!(!this.owner||this.owner.toString()!==e.id&&this.owner.id!==e.id),s=o(this.managers,e.id),i=o(this.viewers,e.id),r=o(this.runners,e.id),n={canView:!1,canRun:!(this.runners&&this.runners.length>0),canEdit:!1,canDelete:!1,canSetMember:!1,isOwner:a,isManager:s,isRunner:r,isViewer:i};return 9===t?Object.assign(n,{canView:!0,canRun:!0,canEdit:!0,canDelete:!0,canSetMember:!0}):(n.canView=t>=7&&(a||s||i||this.public),n.canRun=t>=2&&(a||s||r||this.public),n.canEdit=t>=7&&(a||s),n.canDelete=t>=8&&a,n.canSetMember=t>=8&&(a||s),n)},e.exports=d},function(e,t,a){const s=a(0),i=s.Schema,r=new s.Schema({result:{type:i.Types.ObjectId,ref:"Result"},user:{type:i.Types.ObjectId,ref:"Account"},project:{type:i.Types.ObjectId,ref:"Project"},projectName:{type:String,default:""},projectDesc:{type:String,default:""},taskName:{type:String,default:""},title:{type:String,default:""},desc:{type:String,default:""},prefix:{type:String,default:""},suffix:{type:String,default:""},status:{type:Number,default:0},timer:[{type:Date}]},{timestamps:!0});r.methods.getModel=function(){return{id:this.id,title:this.title,prefix:this.prefix,suffix:this.suffix,desc:this.desc,status:this.status,timer:this.timer,taskName:this.taskName,projectName:this.projectName,projectDesc:this.projectDesc,project:this.project,result:this.result,user:this.user.getModel()}},r.statics.startRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1});return t.length>0&&(t[0].status=1,t[0].timer=[t[0].timer[0],new Date],t[0].markModified("timer"),await t[0].save())},r.statics.finishRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1});return t.length>0&&(t[0].status=2,t[0].timer=[t[0].timer[0],t[0].timer[1],new Date],t[0].markModified("timer"),await t[0].save())},r.statics.errorRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1});return t.length>0&&(t[0].status=3,t[0].timer=[t[0].timer[0],t[0].timer[1],new Date],t[0].markModified("timer"),await t[0].save())},r.statics.deleteRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1});return t.length>0&&(t[0].status=4,t[0].timer=[t[0].timer[0],t[0].timer[1],t[0].timer[2],new Date],t[0].markModified("timer"),await t[0].save())},e.exports=r},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("natural-orderby")},function(e,t,a){const s=a(15),i=a(5),r=a(8),o=a(59),n=a(9),d=a(4),c=a(6),l=a(13),p=a(18),u=a(14),h=a(2),g=a(1),f=a(61),m=function(e){switch(e){case 0:return"st";case 1:return"nd";case 2:return"rd";default:return"th"}};e.exports=async function(e){let t=[];const a={},w={},y={},k={};let v=10;const b=new f;let S=!1;const x=e.chiConfig,O=e.proxyMapper,I=x.system.dataFilePath,F=x.system.scriptFolder,j=x.system.taskLogFolder,T=x.system.shell,D=e.io,P=e.helpers,A=P.getCode,$=P.makeResultDeleted,_=P.socketBroadcast,M=P.getTaskByMap,C=P.issueAvailablePort,E={setConcurrentProcesses:function(e){v=e},pause:function(){S=!0},start:function(){S=!1,R().catch(e=>console.log(e))},addToQueue:async e=>{try{const a={id:e.id,cmd:e.command,args:e.commandArgs,cwd:e.cwd,type:e.type,user:e.owner,project:e.project,env:e.env,extDirs:e.extDirs};"workflow"!==a.type?(t.push(a),await o.updateOne({},{taskQueue:t}).exec().catch(e=>console.log(e)),S||await R(),D.emit("serverStatus",{queue:E.getCurrentQueueNumber(),running:E.getCurrentProcessNumber()})):await L(a)}catch(e){console.log(e)}},getQueue:function(){return t},getCurrentQueueNumber:function(){return t.length},getCurrentProcessNumber:function(){return Object.keys(a).length},getProcess:function(e){return a[e]},getCurrentStdOutput:function(e){return k[e]},deleteTaskInQueue:async e=>{for(let a=0;a<t.length;a++)if(t[a].id===e)return t.splice(a,1),D.emit("serverStatus",{queue:E.getCurrentQueueNumber(),running:E.getCurrentProcessNumber()}),void await o.updateOne({},{taskQueue:t})},stopAllWithSIGINT:async function(){S=!0;const e=Object.keys(a),t=e.length,s=[];for(let i=0;i<t;i++){const t=a[e[i]],r=t.pid;t&&s.push(new Promise(e=>{t.on("exit",()=>{console.log("pid exit: "+r),e()}),t.kill("SIGINT")}))}console.log(s.length+"tasks to be stopped"),await Promise.all(s).catch(e=>console.log(e))},stopRunningTask:function(e){const t=a[e];if(t){if(process.stdout.write("kill process "+e+"\n"),"win32"===p.platform()){try{t.stdin.write("bdp stop task\n")}catch(e){process.stdout.write((e.message?e.message:"")+"\n"+(e.stacks?e.stacks:e)+"\n")}setTimeout(()=>a[e]&&a[e].kill&&a[e].kill("SIGTERM"),3e5)}else t.kill("SIGTERM");setTimeout(()=>{if(!t||!t.killed){const t=w[e];if(!t)return;(async()=>{const a=await d.findOne({_id:t.project}),s=a?a.getListeners():[];await N("The process kill signal cannot be sent.",e,t.id,s),R().catch(e=>console.log(e))})().catch(e=>console.log(e))}},3e5)}return t},deleteWorkflow:async function(e){delete y[e],await o.updateOne({},{workflowProcess:y})}},N=async(e,t,s,i)=>{const n=await r.findOne({_id:s}).populate("owner inFiles outFiles task");if(n){if(t){const e=a[t];n.stdOut=k[e.pid].stdOut,n.stdErr=k[e.pid].stdErr}else n.stdErr="Can not spawn the child process\n"+e.toString();await n.save();const s=t?k[a[t].pid].stdOut:"",r=t?k[a[t].pid].stdErr:"";_(i,"resultOut",{type:"stdOut",target:n.project+":"+n.id,data:s}),_(i,"resultOut",{type:"stdErr",target:n.project+":"+n.id,data:r}),4===n.status?await $(n):await W(n,n.stdOut,n.stdErr,e)}delete w[t],delete a[t],delete k[t],await o.updateOne({},{processing:w}),D.emit("serverStatus",{queue:E.getCurrentQueueNumber(),running:E.getCurrentProcessNumber()})},R=async function(){try{if(S)return;if(Object.keys(a).length<v&&t.length>0){const e=t.shift();await o.updateOne({},{taskQueue:t});const i=await d.findOne({_id:e.project}),c=i?i.getListeners():[],f=await r.findOne({_id:e.id}).populate("owner");if(console.log(f?f.id:"cannot find result id: "+e.id),!f)return void await l.deleteRun(e.id);await l.startRun(f.id);const m=e.env,y=Object.keys(process.env);for(let e=0;e<y.length;e++){const t=y[e];m[t]=process.env[t]}m.EXTERNAL_FOLDERS=e.extDirs.join(","),m.TASKLOG_FOLDER=j,m.RESULT_ID=f.id;const v=await n.findOne({_id:f.task}).populate("package");v&&(m.TASK_ID=v.id,m.TASK_NAME=u(v.name,{condense:!0}),m.ARG_ENCODING=v.encodeArg?"base64":void 0,v.package&&(m.PACKAGE_FOLDER=g.resolve(v.package.path)));let b;await h.pathExists(e.cwd)||(e.cwd=p.tmpdir());try{const t=T||!0;b=s.spawn(e.cmd,e.args,{cwd:e.cwd,shell:t,env:m,windowsHide:!0})}catch(t){return console.log("cmd: "+e.cmd),console.log("args: "+e.args),console.log(t),void N("Child process failed to spawn",null,e.id,c).then(R).catch(e=>console.log(e))}k[b.pid]={stdOut:"",stdErr:"",err:{}},b.stdout.on("readable",()=>{const e=b.stdout.read();if(e&&k[b.pid]){k[b.pid].stdOut+=e.toString();k[b.pid].stdOut.length>=1e4&&(k[b.pid].stdOut="====== Skipped ======\n..."+k[b.pid].stdOut.slice(-1e4)),_(c,"resultOut",{type:"stdOut",target:f.project+":"+f.id,data:k[b.pid].stdOut})}}),b.stderr.on("readable",()=>{const e=b.stderr.read();if(e&&k[b.pid]){k[b.pid].stdErr+=e.toString();k[b.pid].stdErr.length>=1e4&&(k[b.pid].stdErr="====== Skipped ======\n..."+k[b.pid].stdErr.slice(-1e4)),_(c,"resultOut",{type:"stdErr",target:f.project+":"+f.id,data:k[b.pid].stdErr})}});const x=await r.findOneAndUpdate({_id:e.id},{pid:b.pid,status:1,$push:{timer:new Date}},{new:!0}).populate("owner inFiles outFiles task");x&&(_(c,"dataChange",{type:"update",target:"Result",data:x.getModel()}),D.emit("serverStatus",{queue:E.getCurrentQueueNumber(),running:E.getCurrentProcessNumber()})),b.on("error",t=>{console.log("process error:"+b.pid),console.log(t),N(t,b.pid,e.id,c).then(R).catch(console.log)}),b.on("exit",(t,s)=>{console.log("process exiting: "+t+"-"+s),delete O[f.id],w[b.pid]&&!S&&(0!==t?(console.log("process error:"+b.pid),N("Exit code is not 0.",b.pid,e.id,c).then(R).catch(console.log)):(async(e,t,s,i)=>{const n=a[s],d=w[s],c=await r.findOne({_id:d.id}).populate("owner inFiles outFiles task");if(c){const a=k[n.pid].stdOut,s=k[n.pid].stdErr;if(c.stdOut=a,c.stdErr=s,await c.save(),_(i,"resultOut",{type:"stdOut",target:c.project+":"+c.id,data:a}),_(i,"resultOut",{type:"stdErr",target:c.project+":"+c.id,data:s}),4===c.status)await $(c);else if(0!==e||t){const i={code:e,signal:t};await W(c,a,s,i)}else await V(c,a,s)}delete w[s],delete a[s],delete k[s],await o.updateOne({},{processing:w}),D.emit("serverStatus",{queue:E.getCurrentQueueNumber(),running:E.getCurrentProcessNumber()})})(t,s,b.pid,c).then(R).catch(console.log))}),a[b.pid]=b,w[b.pid]=e,await o.updateOne({},{processing:w}),R().catch(e=>console.log(e))}}catch(e){console.log(e)}},L=async function(e){try{if("workflow"!==e.type)return;const t=await r.findOne({_id:e.id}).populate("project owner inFiles outFiles task");if(!t)return;const a=t.project,s=a?a.getListeners():[],i=t.task.mapper,n=[];for(let e=0;e<i.length;e++){n[e]=[];for(let t=0;t<i[e].length;t++)n[e][t]=i[e][t].args}const d=[];for(let e=0;e<i.length;e++){if(!Array.isArray(i[e]))throw[A("32",{details:`This workflow has undefined step ${e}. Please check if the workflow is corrected set.`})];const t=[];for(let a=0;a<i[e].length;a++){const s=i[e][a];t.push(M(s))}const a=Promise.all(t);for(let t=0;t<a.length;t++){a[t]||d.push(`At step ${e}, we cannot find the ${t+1}${m(t)} task. It requires the task-key ${i[e][t].key} in the package ${i[e][t].pkg}`)}}d.length>0&&console.log("The workflow task has errors"),t.status=1,await l.startRun(e.id),_(s,"dataChange",{type:"update",target:"Result",data:t.getModel()});const c={id:e.id,name:e.name,desc:e.desc,user:e.user,project:e.project,mapper:i,args:t.arguments,argValues:n,progress:0,finished:[],commands:[],results:[],resultStatus:[],env:e.env};y[e.id]=c;for(let e=0;e<i.length;e++)c.results[e]=Array.isArray(t.children[e])?t.children[e]:[];await o.updateOne({},{workflowProcess:y}),await q(c)}catch(e){console.log(e)}},q=async function(e){try{const t=e.progress,a=e.id,s=e.mapper[t],n=e.user,l=e.project,p=await d.findOne({_id:l}),f=p?p.getListeners():[],m=await c.findOne({_id:n});if(!p)return console.log("Cannot find the project, the workflow will be deleted!"),void delete y[a];const w=[],k=await r.findOne({_id:a}).populate("owner inFiles outFiles task"),v=k.children,S=v[t];e.results[t]=v[t]||[],Array.isArray(e.resultStatus[t])||(e.resultStatus[t]=[]);let x={};const O=k.prefix||"",j=k.suffix||"";for(let o=0;o<s.length;o++){const d=s[o],c=await M(d);if(null===c){console.log("Cannot find the task by the task mapper object: "),console.log(d),e.resultStatus[t][o]=3,await W(k,"","Cannot find the task by the task mapper object: \n"+JSON.stringify(d,void 0,4));break}c.package||(e.resultStatus[t][o]=3,await W(k,"","Cannot find the task's package by the task mapper object: \n"+JSON.stringify(d,void 0,4)));c.package.getPrivilege(m).canRun||await W(k,"",`You have no privileges to execute the task, ${c.name}, at the step ${t}-${o+1}`);const y=c.getModel();let v,T;if(y.package=c.package.id,x=c.arguments,S&&S[o]&&(v=await r.findOne({_id:S[o]}),v.parent.toString()===a&&2===v.status)){e.results[t][o]=v.id,e.resultStatus[t][o]=2,v.arguments.forEach((a,s)=>{const i=Object.keys(a)[0];e.argValues[t][o][s]=a[i]}),b.emit("taskFinished",v);continue}T=new r({name:c.name,desc:c.desc,type:"child",task:c.id,taskSnapshot:y,parent:e.id,project:l,owner:n,script:c.script,cwd:c.cwd,status:0,readOnly:!1,timer:[new Date],inFiles:[],outFiles:[],arguments:[],prefix:O,suffix:j});const D=[];for(let a=0;a<x.length;a++){const i=x[a];T.arguments[a]={};const r=i.type;if("static"===r){T.arguments[a][r]=i.default[0];continue}const n=s[o].args[a].split(".");let d;if("argv"===n[0]){if(void 0===e.args[+n[1]])return void await W(k,"",`The workflow has undefined argument of position ${n[1]}. \n                Probably, the task has been updated so the argument does not match. This result cannot be resumed. \n                Please execute another NEW Task instead of resume this result.`);d=null==e.args[+n[1]][r]?e.args[+n[1]].static:e.args[+n[1]][r],e.argValues[t][o][a]=d,T.arguments[a][r]="outFile"===i.type&&"name"===i.outFolderStyle?g.basename(d):d}else if("map"===n[0]){try{d=e.argValues[+n[1]][+n[2]][+n[3]]}catch(e){return void await W(k,"","The task mapper may be updated. This result cannot be resumed. Please execute another NEW task instead of resume this result.")}e.argValues[t][o][a]=d,T.arguments[a][r]=d}"inFile"===r&&d&&D.push(d)}const P=[],A=await i.find({project:l,path:{$in:D}}),$={};A.forEach(e=>{T.inFiles.push(e.id),$[e.path]=e.id,e.realPath&&P.push(e.realPath)});const N=c.outputProvider(),R=[],L=[],q={};let V=0;for(let a=0;a<N.length;a++){const r=N[a].index;q[N[a].index]=a;if("outFile"===s[o].args[r].split(".")[0]){const s=new i(N[a]);if(N[a].dependOn&&N[a].default){let i="";const r=N[a].dependOn.split(".");if("argv"!==r[0]){console.log("Error");continue}{const n=c.arguments[+r[1]];if("outFile"===n.type&&"Folder"===n.format){const e=R[q[+r[1]]];if(!e)continue;i=e.path,s.parent=e.id}else"inFile"===n.type&&"Folder"===n.format&&(i=e.argValues[t][o][+r[1]],s.parent=$[i]);N[a].default.indexOf("{$FolderName}")>=0&&(N[a].default=N[a].default.replace(/\{\$FolderName\}/g,g.basename(i))),s.path=g.resolve(i,N[a].default)}}else s.path=g.resolve(`${I}/${l}/${s.id}`);"Folder"!==s.format&&(s.path+="."+s.format),N[a].outPreFolder&&"Folder"===N[a].format&&L.push(s.path),s.owner=m,s.project=l,s.result=T.id,s.hidden=!0,s.prefix=O,s.suffix=j,T.outFiles[V]=s.id,V++,R[a]=s,e.argValues[t][o][r]=s.path,"Folder"===s.format&&"name"===N[a].outFolderStyle&&"$ProjectFolder"===c.cwd?T.arguments[r]={outFile:g.basename(s.path)}:("Folder"===s.format&&N[a].outFolderStyle,T.arguments[r]={outFile:s.path})}}const z=c.compose(T.arguments,c.package.path,e.env.PROJECT_FOLDER,F);if(T.command=z.command,T.commandArgs=z.commandArgs,v){T=v,T.status=0,T.timer=[new Date],T.arguments.forEach((a,s)=>e.argValues[t][o][s]=a[Object.keys(a)[0]]);const a=c.compose(T.arguments,c.package.path,e.env.PROJECT_FOLDER,F);T.command=a.command,T.commandArgs=a.commandArgs}else{const e=R.filter(e=>e).map(e=>(p.dataFiles.push(e.id),e.save()));for(let t=0;t<e.length;t++)await e[t],R[t]&&R[t].getModel&&_(f,"dataChange",{type:"insert",target:"DataFile",data:R[t].getModel()})}if("$ProjectFolder"===c.cwd)T.cwd=I+"/"+p.id;else if(c.cwd.match(/^\$ScriptFolder/))T.cwd=g.resolve(c.cwd.replace(/^\$ScriptFolder/,F));else if(0===c.cwd.indexOf("argv")){const e=c.cwd.split("."),t=parseInt(e[1]);if(isNaN(t))return await T.save(),void b.emit("taskError",T);if(!c.arguments[t]||"inFile"!==c.arguments[t].type||"Folder"!==c.arguments[t].format)return await T.save(),void b.emit("taskError",T);T.cwd=T.arguments[t].inFile}if(L.length>0){const e=[];for(let t=0;t<L.length;t++){const a=L[t];try{await h.ensureDir(a)}catch(t){e.push(t)}}if(e.length>0)return await T.save(),void b.emit("taskError",T)}await T.save();const B=await r.findOne({_id:T.id}).populate("owner outFiles inFiles task project"),G=B.getModel(B.project.getPrivilege(m));if(_(f,"dataChange",{type:"insert",target:"Result",data:G}),0==T.status){let t;if(c.proxy&&c.proxy.enabled&&(t=await C(T.id,c.proxy.port||void 0),!t)){b.emit("taskError",T);continue}T.env={PROJECT_FOLDER:e.env.PROJECT_FOLDER,SHARED_FOLDER:g.resolve(I,"shared"),PACKAGE_FOLDER:c.package?c.package.path:e.env.PACKAGE_FOLDER,TASK_ID:c.id,TASK_KEY:c.key,TASK_NAME:u(c.name,{condense:!0}),DOCKER_PATH:e.env.DOCKER_PATH,RESULT_ID:T.id,BDP_SYSTEM_FOLDER:process.env.BDP_SYSTEM_FOLDER,BDP_HOST_PORT:t,ARG_ENCODING:c.encodeArg?"base64":void 0},T.extDirs=P,await E.addToQueue(T)}w.push(T.id),e.results[t][o]=T.id,e.resultStatus[t][o]=0}const T=await r.findOneAndUpdate({_id:e.id},{children:e.results},{new:!0}).populate("owner outFiles inFiles task");T&&_(f,"dataChange",{type:"update",target:"Result",data:T.getModel()}),p.results.push.apply(p.results,w),await p.save(),await o.updateOne({},{workflowProcess:y})}catch(e){console.log(e)}};b.on("taskFinished",e=>{if(e.parent){const t=y[e.parent];if(!t)return;const a=t.progress,s=t.mapper[a].map(e=>e.id);if(t.results[a].forEach((s,i)=>{s===e.id&&(t.resultStatus[a][i]=e.status)}),t.resultStatus[a].filter(e=>2===e).length===s.length){t.progress++;const e={};e["workflowProcess."+t.id]=t,async function(){if(await o.updateOne({},e),t.progress<t.mapper.length)q(t).catch(e=>console.log(e));else if(t.progress===t.mapper.length){const e=await r.findOne({_id:t.id}).populate("owner inFiles outFiles task");e&&await V(e)}}().catch(e=>console.log(e))}}}),b.on("taskError",e=>{if(e&&e.parent){console.log("Workflow Error");const t=y[e.parent];if(t){const a=t.progress,s=t.results[a];for(let i=0;i<s.length;i++)if(s[i]===e.id){t.resultStatus[a][i]=e.status;break}t.resultStatus[a].filter(e=>e>=2).length>=t.mapper[a].length&&async function(){const t=await r.findOne({_id:e.parent}).populate("owner inFiles outFiles task");await W(t)}().catch(e=>console.log(e))}else(async function(){const t=await r.findOne({_id:e.parent}).populate("owner inFiles outFiles task");await W(t)})().catch(e=>console.log(e))}});const V=async function(e,t,a){e.timer.push(new Date),t&&(e.stdOut=t),a&&(e.stdErr=a),await l.finishRun(e.id);const s=await d.findOne({_id:e.project}),i=s?s.getListeners():[],r=e.owner.getSlimModel(),n=e.outFiles,c=[];for(const e of n){if(!await e.checkFile()){c.push(e.id);continue}const t=e.getModel();t.owner=r,_(i,"dataChange",{type:"update",target:"DataFile",data:t})}e.status=0===c.length?2:3,c.length>0&&(e.error||(e.error={}),e.error.notes=["The task is correctly executed BUT NOT ALL outputs are generated. Please check if the corresponding task is correctly configured."]);const p=await e.save(),u=e.name?e.name:e.id;if(_(i,"dataChange",{type:"update",target:"Result",data:p.getModel()}),e.parent||2!==e.status?e.parent||3!==e.status||_(i,"message",A("34",{details:`The task: <b>${e.task?e.task.name:"(unknown)"}</b> is failed.Some output files are not existed as expected.Please see the error messages on the result page (<b>${u}</b>)`})):_(i,"message",A("33",{details:`The task: <b>${e.task?e.task.name:"(unknown)"} </b> is performed and finished.The result, <b>${u}</b> , is created and ready for visualization.`})),"workflow"!==e.type)return 2===p.status?b.emit("taskFinished",e):b.emit("taskError",e);delete y[e.id],await o.updateOne({},{workflowProcess:y})},W=async function(e,t,a,s){e.error=s,e.stdOut=t||"",e.stdErr=a||"",e.timer.push(new Date),e.status=3,await l.errorRun(e.id);const i=await d.findOne({_id:e.project}),r=i?i.getListeners():[],n=e.outFiles,c=n.map(e=>e.checkFile());for(let e=0;e<n.length;e++)await c[e],_(r,"dataChange",{type:"update",target:"DataFile",data:n[e].getModel()});const p=await e.save(),u=p.name?p.name:p.id;_(r,"dataChange",{type:"update",target:"Result",data:p.getModel()}),e.parent||_(r,"message",A("34",{details:`The task: <b>${e.task&&e.task.name?e.task.name:"(unknown)"}</b> is failed.Please see the error messages on the result info page (<b>"${u}</b>)`,attached:s})),e.parent||"workflow"!==e.type?b.emit("taskError",e):(delete y[e.id],await o.updateOne({},{workflowProcess:y}))};try{const e=await o.findOne({});if(e){const a=e.processing,s=e.taskQueue,i=e.workflowProcess,r=[],o=Object.keys(a);for(let e=0;e<o.length;e++){const t=a[o[e]];r.push(t)}if(i){const e=Object.keys(i);if(e.length>0)for(let t=0;t<e.length;t++){const a=i[e[t]];y[a.id]=a}}s.forEach(e=>{r.push(e)}),t=r,e.taskQueue=t,e.processing={},0===e.taskQueue.length&&(e.workflowProcess={}),e.markModified("processing"),await e.save(),R().catch(e=>console.log(e))}else{const e=new o;await e.save()}}catch(e){console.log(e)}return E}},function(e,t,a){var s=a(0),i=a(60),r=s.model("taskQueue",i);e.exports=r},function(e,t,a){const s=a(0),i=s.Schema,r=new s.Schema({taskQueue:[],processing:{type:i.Types.Mixed,default:{}},workflowProcess:{type:i.Types.Mixed,default:{}}});e.exports=r},function(e,t){e.exports=require("events")},function(e,t,a){const s=a(3),i=a(22),r=a(26),o=a(63).Strategy,n=a(64).Strategy;e.exports=function(e){const t=e.chiConfig,d=e.io,c=e.helpers,l=c.chiAsyncWrap,p=c.sendVerifyEmail,u=c.reCAPTCHA,h=c.getCode,g=c.getAuthAsync,f=s.Router(),m=a(6);i.serializeUser((function(e,t){t(null,{id:e.id,auth:e.auths.base})})),i.deserializeUser((function(e,t){m.findById(e.id,(function(e,a){t(e,a)}))})),i.use("local",new n({usernameField:"email",passwordField:"passwd"},(function(e,t,a){m.findOne({email:e},(function(e,s){return e?a(e):s&&s.verifyPassword(t)?a(null,s):a(null,!1)}))})));const w=function(e,t){return new Promise((a,s)=>{e.login(t,e=>e?s([h("a009",{details:"Failed to login. Please try again.",attached:e})]):a())})};if(t.GoogleAuth&&t.GoogleAuth.clientID&&t.GoogleAuth.clientSecret){let e="";e=0===t.serverConfig.site_domain.indexOf("http://")&&80===t.serverConfig.port||0===t.serverConfig.site_domain.indexOf("https://")&&443===t.serverConfig.port?t.serverConfig.site_domain+"/account/auth/google/callback":t.serverConfig.site_domain+":"+t.serverConfig.port+"/account/auth/google/callback",i.use(new o({clientID:t.GoogleAuth.clientID,clientSecret:t.GoogleAuth.clientSecret,callbackURL:e},(function(e,t,a,s){const i=a.emails[0].value,r=a.displayName;m.findOne({email:i},(function(o,n){if(n){if(-1!==n.providers.indexOf("Google"))return s(o,n.getModel());n.providers.push("Google"),n.providerIDs.Google={id:a.id,accessToken:e,refreshToken:t},n.save((function(){return s(o,n.getModel())}))}else{new m({email:i,name:r,auths:{base:1},providerIDs:{Google:{id:a.id,accessToken:e,refreshToken:t}},providers:["Google"]}).register().then(e=>s(null,e)).catch(e=>{s(e)})}}))}))),f.get("/auth/google",i.authenticate("google",{scope:["email","openid"]})),f.get("/auth/google/callback",i.authenticate("google",{failureRedirect:"/account/signIn"}),(function(e,t){t.redirect("/project/list")}),(function(e,t,a,s){e&&(console.log("XD"),console.log(e)),s()}))}return f.post("/register",l(async e=>{const a={errors:[]},s=e.body.token;if(t.reCaptcha&&t.reCaptcha.reCaptchaSecret){if(!(await u(s)).success)throw[h("a004",{name:"reCaptcha challenge failed",details:"We do not accept a robot to sign up our site."})]}const i=await new m({email:e.body.email,passwd:e.body.passwd,providers:["local"]});await i.register();const r=await i.setAuthToken();return t.email&&t.email.smtpConfig?await p(r.email,r.authToken):9!==i.auths.base&&(i.auths.base=1,await i.save()),await w(e,r),a.success=await r.signIn(),a})),f.get("/email-resend",l(async e=>{const a={errors:[]};if(!e.isAuthenticated())throw[h("a011")];const s=e.session.passport.user.id,i=await m.findById(s);if(!i)return e.logout(),a.success={isLoggedIn:!1},a;if(0!==i.auths.base||!t.email||!t.email.smtpConfig)throw 0===i.auths.base?(i.auths.base=1,await i.save(),d.to(i.id).emit("dataChange",{type:"update",target:"User",data:i.getModel()}),[h("a008")]):[h("a008")];return await p(i.email,i.authToken),a.success={resend:!0},a})),f.get("/email-verify",l(async(e,t)=>{const a=e.query.authToken;if(void 0!==e.query.authToken){const e=await m.findOne({authToken:a});if(e)if(0===e.auths.base){try{await e.verifyEmail(a)}catch(e){if(!Array.isArray(e))throw e;t.redirect("/account/email-verifying?code="+e[0].code)}t.redirect("/account/email-verifying?code=a006")}else t.redirect("/account/email-verifying?code=a008");else t.redirect("/account/email-verifying?code=a004")}else t.redirect("/account/email-verifying")})),f.post("/rename",l(async e=>{const t={errors:[]};if(!e.isAuthenticated())throw[h("a011")];const a=e.session.passport.user.id,s=e.body.newName,i=await m.findById(a);if(!i)throw[h("a015",{details:"The user account does not exist. Please check if you use the correct user ID."})];return s?s.length>60?t.errors.push(h("a022",{details:"The new name is too long. Please use a name with fewer than 61 characters."})):s.length<2?t.errors.push(h("a022",{details:"The new name is too short. Please use a name with more than 5 characters."})):(i.name=s,await i.save(),t.success=i.getModel()):t.errors.push(h("a022",{details:"The new name is empty. Please specify at least 6 characters as your name."})),t})),f.get("/checkSignIn",l(async e=>{const t={errors:[]};if(!e.isAuthenticated())return e.logout(),t.success={isLoggedIn:!1},t;e.session.touch();const a=await m.findById(e.session.passport.user.id);return a?t.success=await a.signIn():(e.logout(),t.success={isLoggedIn:!1}),t})),f.get("/signOut",l(async e=>{if(e.isAuthenticated()){const t=e.session.passport.user.id;await m.update({_id:t},{$set:{isLoggedIn:!1}})}e.logout();const t={errors:[],success:{isLoggedIn:!1}};return t})),f.post("/signIn",l(async(e,a,s)=>{const r={errors:[]},o=e.body.token;if(t.reCaptcha&&t.reCaptcha.reCaptchaSecret){if(!(await u(o)).success)throw[h("a004",{name:"reCaptcha challenge failed",details:"We do not accept a robot to sign up our site."})]}const n=await function(e,t,a,s){return new Promise((r,o)=>{i.authenticate(e,(e,t)=>e?o([h("a009",{details:"Failed to authenticate your account. Please try again.",attached:e})]):r(t))(t,a,s)})}("local",e,a,s);if(!n)throw[h("a009")];return await w(e,n),r.success=await n.signIn(),r})),f.get("/api/login",r(),l(async e=>{const t=e.query.authToken.toString();if(!t)throw[h("a009")];const a=await m.findOne({authToken:t});if(!a)throw[h("a009",{details:"Invalid auth token."})];const s=a.authTime;if(((new Date).getTime()-s.getTime())/864e5>7)throw[h("a009",{details:"The auth token is expired."})];if(!a.auths||a.auths.base<2||a.auths.bdp<2)throw[h("a009",{details:"Sorry, you do not have privileges to login with the authToken."})];return await w(e,a),{errors:[],success:await a.signIn()}})),f.get("/api/search",l(async e=>{const t={errors:[]},a=decodeURIComponent(e.query.q),s=e.session.passport.user.id;await g(s,"base",2);const i=new RegExp(a),r=await m.find({name:{$regex:i,$options:"i"}});return t.success=r.map(e=>e.getSlimModel()),t})),f.get("/api/getAuthToken",l(async e=>{if(!e.isAuthenticated())throw[h("12")];const t=e.session.passport.user.id,a=await g(t,"base",2);if(a.auths.bdp<2)throw[h("a017",{details:"Sorry, you do not have enough priviledges to get the auth token."})];const s=a.authTime;let i;return((new Date).getTime()-s.getTime())/864e5>3&&(i=await a.setAuthToken()),i&&i.authToken?{errors:[],success:i.authToken}:{errors:[],success:a.authToken}})),f}},function(e,t){e.exports=require("passport-google-oauth20")},function(e,t){e.exports=require("passport-local")},function(e,t,a){const s=a(3),i=a(0),r=a(9),o=a(23),n=a(5),d=a(4),c=a(8),l=a(13),p=a(6),u=a(2),h=a(1);e.exports=function(e){const t=e.chiConfig,a=e.io,g=e.helpers,f=g.chiAsyncWrap,m=g.getAuthAsync,w=e.taskRunner,y=g.getCode,k=t.system.dataFilePath,v=t.system.taskLogFolder,b=s.Router();return b.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(y("a011")),t.json(s);a()}),b.get("/api/task/list",f(async e=>{const t=e.session.passport.user.id;await m(t,"bdp",8);return{errors:[],success:(await r.find({})).map(e=>e.getModel())}})),b.get("/api/account/list",f(async e=>{const t=e.session.passport.user.id;await m(t,"base",9);return{errors:[],success:(await p.find({})).map(e=>e.getModel())}})),b.post("/api/user/:userId/approve",f(async e=>{const t={errors:[]},s=e.session.passport.user.id,r=parseInt(e.body.auth),o=e.body.authField?e.body.authField:"base",n=e.params.userId;if(isNaN(r))throw[y("a018")];if(s&&!i.Types.ObjectId.isValid(s))throw[y("a015",{details:"Invalid user id to change authority."})];await m(s,"base",9);const d=await p.findOne({_id:n});if(!d)throw[y("901")];if("base"===o&&9===d.auths[o])throw[y("a018",{details:"You may not change the admin's user auth."})];if(void 0===d.auths[o])throw[y("a018",{details:"Unknown user auth settings."})];if(isNaN(r))throw[y("a018",{details:"The user auth value should be a number."})];if(r>9)throw[y("a018",{details:"The user auth value should be less than 9."})];return d.auths[o]=r,await d.save(),t.success=d.getModel(),a.to(n).emit("dataChange",{type:"update",target:"User",data:t.success}),t})),b.delete("/api/user/:userId",f(async e=>{const t=e.session.passport.user.id,a=e.params.userId;if(!i.Types.ObjectId.isValid(a))throw[y("a015",{details:"The user id you request is invalid. Please check if you use the correct user id."})];if(await m(t,"base",9),t===a)throw[y("a018",{details:"Sorry Administrator can not be deleted."})];const s=await p.findOne({_id:a});if(!s)throw[y("a015",{details:"The user id you request is invalid. Please check if you use the correct user id."})];const r=await c.find({owner:a});if(r.length>0)for(let e=0;e<r.length;e++){const t=r[e];0===t.status?await w.deleteTaskInQueue(t.id):1===t.status&&-1!==t.pid&&await w.stopRunningTask(t.pid)}await n.remove({owner:a}),await c.remove({owner:a});try{await u.remove(h.resolve(k,a))}catch(e){throw[y("s001",{name:"Delete user folder failed",details:"You may want to delete the folder manually. The path: "+k,attached:e})]}return await s.remove(),{errors:[],success:s.getModel()}})),b.get("/api/tasklogs/cleanups",f(async e=>{const t=e.session.passport.user.id;await m(t,"base",9);const a=await c.find({}),s=await u.readdir(v),i=a.map(e=>e.id);let r=0;for(let e=0;e<s.length;e++){const t=s[e];i.indexOf(t)<0&&(r++,await u.remove(h.join(v,t)))}return{errors:[],success:{msg:r+" tasklog folders were removed."}}})),b.get("/api/temp/project_packages",f(async e=>{const t=e.session.passport.user.id;await m(t,"base",9);const a=await d.find();for(let e=0;e<a.length;e++){const t=a[e];t.packages=[t.package],await t.save()}return{errors:[],success:"ok"}})),b.get("/api/result/history/:range",f(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.range;let i;if(-1===["latest","week","twoWeeks","fourWeeks"].indexOf(s)&&(i=s.split("-"),2!==i.length))throw[y("903",{name:"Unknown date range",details:"The "+s+" is not a known range to request result histories. Please check again."})];if(await m(a,"bdp",9),"latest"===s){const e=await l.find().sort({createdAt:-1}).limit(20).populate("user"),a=[];for(let t=0;t<e.length;t++){const s=e[t],i={id:s.id,title:s.title,desc:s.desc,status:s.status,timer:s.timer,taskName:s.taskName,projectName:s.projectName,projectDesc:s.projectDesc,project:s.project,result:s.result,user:s.user?s.user.getModel():"(deleted user)",createdAt:s.createdAt,updatedAt:s.updatedAt};a.push(i)}t.success=a}else{const e=(new Date).getTime();let a,r;switch(s){case"week":a=new Date(e-6048e5);break;case"twoWeeks":a=new Date(e-12096e5);break;case"fourWeeks":a=new Date(e-24192e5);break;default:i?(a=new Date(Number(i[0])),r=new Date(Number(i[1]))):a=new Date(e-6048e5)}r||(r=new Date);const o=await l.find({createdAt:{$gte:a,$lte:r}}).sort({createdAt:-1}).populate("user"),n=[];for(let e=0;e<o.length;e++){const t=o[e],a={id:t.id,title:t.title,desc:t.desc,status:t.status,timer:t.timer,taskName:t.taskName,projectName:t.projectName,projectDesc:t.projectDesc,project:t.project,result:t.result,user:t.user?t.user.getModel():t.user,createdAt:t.createdAt,updatedAt:t.updatedAt};n.push(a)}t.success=n}return t})),b.get("/api/system-errors/list",f(async e=>{const t=e.session.passport.user.id;await m(t,"base",9);return{errors:[],success:(await o.find({}).sort({createdAt:-1}).populate("account")).map(e=>e.getModel())}})),b.delete("/api/system-errors/:sysErrId/remove",f(async e=>{const t=e.session.passport.user.id,s=e.params.sysErrId;if(!i.Types.ObjectId.isValid(s))throw[y("s004")];await m(t,"base",9);const r=await o.deleteOne({_id:s});return a.to(t).emit("dataChange",{type:"remove",target:"system-error",data:s}),{errors:[],success:r}})),b.delete("/api/system-errors/all",f(async e=>{const t=e.session.passport.user.id;await m(t,"base",9);return{errors:[],success:await o.deleteMany({})}})),b}},function(e,t,a){const s=a(3),i=a(0),r=a(4),o=a(10),n=a(8),d=a(5),c=a(6),l=a(7),p=a(27),u=a(1),h=a(2),g=a(28);e.exports=function(e){const t=e.chiConfig,a=t.system.dataFilePath,f=e.helpers,m=f.chiAsyncWrap,w=f.getCode,y=f.getAuthAsync,k=f.getProjectByID,v=f.socketBroadcast,b=f.makeResultDeleted,S=f.makeDataFileDeleted,x=p.diskStorage({destination:function(e,a,s){s(null,u.resolve(t.system.uploadFolder))},filename:function(e,t,a){a(null,"Data-"+Date.now())}}),O={fileSize:t.system.fileLimits||1/0},I=p({storage:x,limits:O}).array("file"),F=s.Router();return F.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(w("a011")),t.json(s);a()}),F.post("/api/create",m(async e=>{const t=e.session.passport.user.id,s=await y(t,"base",2),i=e.body.projectName,n=e.body.projectDesc,d=e.body.projectPackages,c=e.body.isPublic,l=(await o.find({_id:d})).filter(e=>!(s.auths.base<8&&e.scope.indexOf("admin")>=0)&&e.scope.indexOf("utility")<0),p=new r({name:i.slice(0,160),owner:t,desc:n.slice(0,1e3),packages:d.map(e=>l.filter(t=>t.id===e)[0]).filter(e=>!!e).map(e=>e.id),dataFiles:[],results:[],managers:[],runners:[],viewers:[],public:!!c});await h.ensureDir(u.resolve(a+"/"+p.id)),await p.save();const g=await k(p.id);return{success:g.getModel(g.getPrivilege(s)),errors:[]}})),F.post("/api/:pid/upload",m(async(e,a)=>{const s={errors:[]},r=e.session.passport.user.id,o=e.params.pid;if(!i.Types.ObjectId.isValid(o))throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];const n=await y(r,"bdp",2),c=await k(o);if(!c)throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(!c.getPrivilege(n).canAddFile)throw[w("38",{details:"Sorry, you can not create data files in this project."})];const l=c.packages;try{await((e,t)=>new Promise((a,s)=>I(e,t,e=>e?s(e):a())))(e,a)}catch(t){for(const t of e.files)await h.unlink(t.path);throw[w("13",{code:13,name:"File upload failed",attached:t})]}const p=e.body.folder?e.body.folder:null,g="true"===e.body.keepFileName,f=e.body.tags?e.body.tags.split(","):[],m=e.body.name||"",b=e.body.desc||"",S=e.body.prefix||"",x=e.body.suffix||"",O=[],F=[],j=await d.findOne({_id:p});for(let a=0;a<e.files.length;a++){const s=e.files[a],i=s.originalname,p=s.path,y=[...new Set([].concat.apply([],c.packages.map(e=>e.allowedFormats)))].map(e=>e.toString());let k=!1,I="",T=[];for(let e=0;e<y.length;e++){const t=y[e].replace(/\./g,"\\.").replace(/\-/g,"\\-").replace(/\_/g,"\\_"),a="*"===t?new RegExp(".*\\.(.*)$"):new RegExp(".*("+t+")$"),s=i.match(a);if(s){k=!0,I=s[1];for(let e=0;e<l.length;e++){const t=l[e].formatMapping;for(let e=0;e<t.length;e++){const a=t[e];if(a.ext===I){T=a.tags;break}}}break}}if(!k){await h.remove(p),console.log(i),O.push(w("16",{details:"The file ,"+i+", is invalid. Please check the format."}));continue}let D="";Array.isArray(f)&&(T.push.apply(T,f.map(e=>e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim())),T=T.filter(e=>!!e));const P=new d({name:m&&m.slice?m.slice(0,80):u.basename(i,"."+I),desc:b&&b.slice?b.slice(0,300):"",format:I,owner:r,project:o,tags:T,readOnly:!0,prefix:S.slice(0,36),suffix:x.slice(0,36)});j&&"Folder"===j.format?(P.parent=j.id,D=g?u.resolve(j.path+"/"+i):u.resolve(j.path+"/"+P.id+"."+I)):D=u.resolve(t.system.dataFilePath,o,P.id+"."+I);if(await h.pathExists(D)){O.push(w("604",{details:`The file name '${i}' has being used. Please change the file name and upload again.`})),await h.remove(p);continue}try{await h.stat(D)}catch(e){if("EEXIST"===e.code){P.status=3,await h.remove(p),O.push();continue}if("ENOENT"!==e.code){P.status=3,h.remove(p),O.push(w("604",{details:`The file '${i}' failed to be uploaded. Please try again.`,attached:e}));continue}try{await h.copy(u.resolve(p),D,{overwrite:!1}),await h.remove(p)}catch(e){await h.remove(p),O.push(w("605",{attached:e}));continue}}c.dataFiles.push(P.id),P.path=D,P.status=1,P.readOnly=!1,await P.save(),await c.save();const A=P.getModel();A.owner=n.getSlimModel(),A.project=o,v(c.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:A}),F.push(A)}return s.errors=O,s.success=F,s})),F.post("/api/:pid/createFolder",m(async e=>{const t={errors:[]},s=e.session.passport.user.id,o=e.params.pid,n=e.body.folder||"",c=e.body.keepFileName,l=e.body.prefix||"",p=e.body.suffix||"",f=e.body.tags,m=e.body.name;if(!i.Types.ObjectId.isValid(o))throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(n&&!i.Types.ObjectId.isValid(n))throw[w("19",{details:`Sorry, we could not find valid parent id: ${n}.`})];const k=await y(s,"bdp",2),b=await r.findOne({_id:o}).populate("dataFiles results");if(!b)throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(!b.getPrivilege(k).canAddFile)throw[w("38",{details:"Sorry, you do NOT have privileges to create folders in this project."})];let S;if(n&&(S=await d.findOne({_id:n}),!S||"Folder"!==S.format))throw[w("19",{details:`Sorry, we could not find valid parent id: ${n}.`})];let x=[];Array.isArray(f)&&x.push.apply(x,f.map(e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim())),x=[...new Set(x)].map(e=>e.toString()),x.indexOf("Folder")<0&&x.unshift("Folder");const O=new d({name:m,format:"Folder",owner:s,project:o,tags:x,readOnly:!1,prefix:l.slice(0,36),suffix:p.slice(0,36)});let I=u.resolve(`${a}/${o}/${O.id}`);if(S){O.parent=S.parent?S.parent:S.id;const e=g(m,{replacement:"_"})||O.id;I=c?u.resolve(S.path,e):u.resolve(S.path,O.id)}await h.ensureDir(I),O.path=I,O.status=1;const F=(await O.save()).getModel();return t.success=F,b.dataFiles.push(O.id),await b.save(),v(b.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:F}),t})),F.post("/api/:pid/importFromPath",m(async(e,t)=>{const s={errors:[]},o=e.session.passport.user.id,n=e.params.pid,c=e.body.directLink;let p=e.body.importedPath;const g=e.body.name,f=e.body.prefix||"",m=e.body.suffix||"",k=e.body.desc||"",b=e.body.keepFileName,S=e.body.folder||"",x=e.body.tags;if(!p)throw[w("605",{name:"Data File creation failed",details:"The folder path is empty."})];if(!i.Types.ObjectId.isValid(n))throw[w("19",{name:"Invalid project ID",details:`We can not find the project id: ${n}. please check if this is the right ID.`})];if(S&&!i.Types.ObjectId.isValid(S))throw[w("19",{name:"Invalid parent folder ID",details:`The parent folder id, ${S}, is invalid. please check if this is the right ID.`})];const O=await y(o,"bdp",3),I=await r.findOne({_id:n}).populate("packages");if(!I)throw[w("19",{details:`We can not find the project id: ${n}. please check if this is the right ID.`})];if(!I.getPrivilege(O).canAddFile)throw[w("38",{details:"Sorry, you do NOT have privileges to create folders in this project."})];let F;if(S&&(F=await d.findOne({_id:S}),!F||"Folder"!==F.format))throw[w("19",{name:"Invalid parent folder ID",details:`We can not find the valid parent folder id: ${S}. please check if this is the right ID.`})];const j=I.getListeners();let T;try{T=await h.stat(p),p=await h.realpath(p)}catch(e){throw[w("605",{details:"The folder does not exist or cannot be accessed.",attached:e})]}const D=u.parse(p),P=D.name,A=D.base,$=D.ext.replace(".","");let _=[];const M=[...new Set([].concat.apply([],I.packages.map(e=>e.allowedFormats)))].map(e=>e?e.toString():e);if(!T.isDirectory()){let e=!1;for(let t=0;t<M.length;t++){const a=M[t].replace(/\./g,"\\.").replace(/\-/g,"\\-").replace(/\_/g,"\\_"),s="*"===a?new RegExp(".*\\.(.*)$"):new RegExp(".*("+a+")$");if(A.match(s)){e=!0;break}}if(!e)throw[w("605",{details:`The file, ${A}, has invalid extension.`})];if(Array.isArray(I.packages)&&I.packages.length>0){const e=[].concat.apply([],I.packages.map(e=>e.formatMapping));e&&e.length>0&&(_=e.filter(e=>e.ext===$).map(e=>e.tags)[0]||[])}}const C=new d({name:g?g.slice(0,80):P.slice(0,80),prefix:f.slice(0,36),suffix:m.slice(0,36),desc:k.slice(0,300),owner:o,project:n,tags:[],readOnly:!1,status:0});if(Array.isArray(x)){_.push.apply(_,x.map(e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim())),_=_.filter(e=>null!=e||""!==e);const e=_.indexOf("Folder");e>=0&&_.splice(e,1)}_=[...new Set(_)].map(e=>e.toString()),T.isDirectory()?(C.format="Folder",_.unshift("Folder")):C.format=$,C.tags=_;let E=u.resolve(a,n,C.id);F&&(C.parent=F.id,E=b?u.join(F.path,P):u.join(F.path,C.id)),"Folder"!==C.format&&(E+="."+$),C.path=E;if(await h.pathExists(E))throw[w("605",{details:`The path, ${E}, is already existed.`})];await C.save();const N=C.getModel();N.owner=O.getSlimModel(),I.dataFiles.push(C.id),await I.save(),s.success=N,v(j,"dataChange",{type:"insert",target:"DataFile",data:s.success}),t.json(s);if(!l(p,a)&&!c){let e=u.resolve(a,"shared",C.id);T.isDirectory()||(e+="."+$);try{await h.ensureDir(u.resolve(a,"shared")),await h.copy(p,e,{dereference:!0})}catch(t){return await h.remove(e),await C.remove(),console.log(t),void console.log("Failed")}p=e}try{if(c)if(T.isDirectory()){await h.ensureSymlink(p,E,"junction");try{await h.stat(E)}catch(e){await h.remove(E),await h.ensureSymlink(p,E)}}else await h.ensureSymlink(p,E);else await h.ensureSymlink(u.relative(u.dirname(E),p),E)}catch(e){return console.log(e),await h.remove(E),void await C.remove()}C.status=1,C.realPath=p,await C.save();const R=C.getModel();return R.owner=O.getSlimModel(),v(j,"dataChange",{type:"update",target:"DataFile",data:R}),!1})),F.post("/api/:pid/importFromDataFile",m(async(e,t)=>{const s=e.session.passport.user.id,o=e.params.pid,n=e.body.fileIDs,c=!!e.body.copy;if(!n||0===n.length)throw[w("605",{name:"Data File creation failed",details:"No data file to import."})];if(!i.Types.ObjectId.isValid(o))throw[w("19",{name:"Invalid project ID",details:`We can not find the project id: ${o}. please check if this is the right ID.`})];const p=await y(s,"bdp",2),g=await r.findOne({_id:o});if(!g)throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(!g.getPrivilege(p).canAddFile)throw[w("38",{details:"Sorry, you do NOT have privileges to create folders in this project."})];const f=g.getListeners(),m=p.getSlimModel(),k=(await d.find({_id:{$in:n}}).populate("project")).filter(e=>e.project&&e.project.getPrivilege&&e.project.id!==o&&e.project.getPrivilege(p).canView&&1===e.status),b=[],S=[];for(let e=0;e<k.length;e++){const t=k[e],i=new d({name:t.name,owner:s,project:o,tags:t.tags,format:t.format,readOnly:t.readOnly,prefix:t.prefix||"",suffix:t.suffix||"",status:0});i.path=u.resolve(`${a}/${o}/${i.id}`),"Folder"!==t.format&&(i.path=i.path+"."+t.format),await i.save(),g.dataFiles.push(i.id),S.push({targetModel:i,sourceModel:t});const r=i.getModel();r.owner=m,r.project=o,v(f,"dataChange",{type:"insert",target:"DataFile",data:r}),b.push(r)}await g.save(),t.json({errors:[],success:b});for(const e of S){const t=e.targetModel,s=e.sourceModel,i=s.path,r=t.path;try{const e=await h.lstat(i);if(e.isDirectory()&&!c){await h.ensureSymlink(i,r,"junction");try{await h.stat(r)}catch(e){await h.remove(r),await h.ensureSymlink(i,r)}t.realPath=i}else if(e.isSymbolicLink()){const e=await h.realpath(i);if(c)await h.copy(e,r);else if(l(e,u.join(a,"shared")))await h.ensureSymlink(u.relative(u.dirname(r),e),r);else{await h.ensureSymlink(e,r,"junction");try{await h.stat(r)}catch(t){await h.remove(r),await h.ensureSymlink(e,r)}}t.realPath=e}else if(c)await h.copy(i,r);else{let e=u.resolve(a,"shared",s.id);"Folder"!==s.format&&(e=e+"."+s.format);if(await h.pathExists(e))throw[w("605",{name:"The shared source file already existed.",details:`Please contact the system admin. The source path: ${e}.`})];await h.move(i,e,{dereference:!0}),await h.ensureSymlink(u.relative(u.dirname(i),e),i),s.realPath=e,await s.save(),t.realPath=e,await h.ensureSymlink(u.relative(u.dirname(r),e),r)}t.status=1}catch(e){console.log(e),t.status=4}await t.save();const n=t.getModel();n.owner=m,n.project=o,v(f,"dataChange",{type:"update",target:"DataFile",data:n})}return!1})),F.get("/api/searchList",m(async e=>{const t={errors:[],success:[]},a=e.session.passport.user.id,s=await y(a,"bdp",2),i=decodeURIComponent(e.query.q),o=new RegExp(i);let n={};void 0===e.query.q||""==e.query.q?(n={$or:[{owner:a},{managers:a},{runners:a},{viewers:a}]},9===s.auths.bdp&&(n={})):(n={$and:[{name:{$regex:o,$options:"i"}},{$or:[{owner:a},{managers:a},{runners:a},{viewers:a}]}]},9===s.auths.bdp&&(n={name:{$regex:o,$options:"i"}}));const d=await r.find(n).populate("owner");return t.success=d.map(e=>({id:e.id,name:e.name,owner:e.owner?e.owner.name:"Unknown",privilege:e.getPrivilege(s)})),t})),F.get("/api/list",m(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=void 0!==e.query.pageIndex?e.query.pageIndex:0,i=!isNaN(parseInt(e.query.pageSize))&&[5,10,30,50,100,300,500].indexOf(parseInt(e.query.pageSize))>=0?parseInt(e.query.pageSize):10,o=await y(a,"bdp",2),n=await r.countDocuments({owner:a}),d=n%i>0?Math.floor(n/i)+1:Math.floor(n/i),c=await r.find({owner:a}).sort({updatedAt:-1}).skip(i*s).limit(i).populate("owner managers runners viewers packages").populate({path:"packages",populate:{path:"owner"}});return t.success={records:c.map(e=>e.getModel(e.getPrivilege(o))),totalPage:d,pageIndex:s,totalCount:n,pageSize:i},t})),F.get("/api/sharedList",m(async e=>{const t=e.session.passport.user.id,a=void 0!==e.query.pageIndex?e.query.pageIndex:0,s=!isNaN(parseInt(e.query.pageSize))&&[5,10,30,50,100,300,500].indexOf(parseInt(e.query.pageSize))>=0?parseInt(e.query.pageSize):10,i=await y(t,"bdp",2),o=9===i.auths.bdp?{owner:{$ne:t}}:{$and:[{owner:{$ne:t}},{$or:[{managers:t},{runners:t},{viewers:t}]}]},n=await r.countDocuments(o),d=n%s>0?Math.floor(n/s)+1:Math.floor(n/s);return{errors:[],success:{records:(await r.find(o).sort({updatedAt:-1}).skip(s*a).limit(s).populate("owner managers runners viewers packages").populate({path:"packages",populate:{path:"owner"}})).map(e=>e.getModel(e.getPrivilege(i))),totalPage:d,pageIndex:a,totalCount:n,pageSize:s}}})),F.get("/api/publicList",m(async e=>{const t=e.session.passport.user.id,a=void 0!==e.query.pageIndex?e.query.pageIndex:0,s=!isNaN(parseInt(e.query.pageSize))&&[5,10,30,50,100,300,500].indexOf(parseInt(e.query.pageSize))>=0?parseInt(e.query.pageSize):10,i=await y(t,"bdp",2),o={public:!0},n=await r.countDocuments(o),d=n%s>0?Math.floor(n/s)+1:Math.floor(n/s);return{errors:[],success:{records:(await r.find(o).sort({updatedAt:-1}).skip(s*a).limit(s).populate("owner managers runners viewers packages").populate({path:"packages",populate:{path:"owner"}})).map(e=>e.getModel(e.getPrivilege(i))),totalPage:d,pageIndex:parseInt(a),totalCount:n,pageSize:s}}})),F.get("/api/:projectId/cleanup",m(async e=>{const t=e.session.passport.user.id,s=e.params.projectId,o=await y(t,"bdp",2);if(!i.Types.ObjectId.isValid(s))throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(o.id))throw[w("23",{details:"Please check if you use the correct userID."})];const c=await r.findOne({_id:s});if(!c)throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!c.getPrivilege(o).canEdit)throw[w("38",{details:"Sorry, you do not have privileges to process the cleanup procedure in this project."})];const l=c.dataFiles.map(e=>e.toString()),p=c.results.map(e=>e.toString()),u=await d.find({project:s}),h=u.map(e=>e.id),g=u.filter(e=>l.indexOf(e._id.toString())<0);for(let e=0;e<g.length;e++)await g[e].unlinkFileAndRemove();c.dataFiles=l.filter(e=>h.indexOf(e)>=0);const f=u.filter(e=>l.indexOf(e._id.toString())>=0);for(let e=0;e<f.length;e++)await f[e].ensureFile(a);const m=await n.find({project:s}),k=m.map(e=>e.id),v=m.filter(e=>p.indexOf(e._id.toString())<0);for(let e=0;e<v.length;e++)await b(v[e]);return c.results=p.filter(e=>k.indexOf(e)>=0),await c.save(),{errors:[],success:{orphanDataFiles:g.length,orphanResults:v.length,projectDataFiles:c.dataFiles.length,projectResults:c.results.length}}})),F.get("/api/:projectId",m(async e=>{const t=e.session.passport.user.id,a=e.params.projectId,s=await y(t,"bdp",2);if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(s.id))throw[w("23",{details:"Please check if you use the correct userID."})];const r=await k(a);if(!r)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const o=r.getPrivilege(s);if(!o.canView)throw[w("38",{details:"Sorry, you do not have privileges to view this project."})];return{errors:[],success:r.getModel(o)}})),F.patch("/api/:projectId",m(async e=>{const t=e.session.passport.user.id,a=e.params.projectId,s=e.body.name,n=e.body.desc,d=e.body.packageIDs,c=!!e.body.public;if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(t))throw[w("23",{details:"Please check if you use the correct userID."})];const l=d.map(e=>e&&i.Types.ObjectId.isValid(e)?e:null).filter(e=>null!==e),p=await y(t,"bdp",2),u=(await r.findOne({_id:a})).getPrivilege(p);if(!u.canEdit)throw[w("38",{details:"Sorry, you do not have privileges to view this project."})];let h;h=l.length>=1?await o.find({_id:{$in:l}}):[];const g=h.map(e=>e.id),f=h.map(e=>e.getPrivilege(p)),m={name:s,desc:n,public:c};m.packages=l.map(e=>{const t=g.indexOf(e);return t<0?null:f[t]&&f[t].canRun?e:null}).filter(e=>null!==e);const k=await r.findOneAndUpdate({_id:a},{$set:m},{new:!0}).populate("owner managers runners viewers packages").populate({path:"dataFiles",populate:{path:"owner"}}).populate({path:"results",populate:{path:"owner"}}).populate({path:"packages",populate:{path:"owner"}});if(!k)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];return{errors:[],success:k.getModel(u)}})),F.delete("/api/:projectId",m(async e=>{const t=e.session.passport.user.id,s=e.params.projectId;if(!i.Types.ObjectId.isValid(s))throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(t))throw[w("23",{desc:"Please check if you use the correct userID."})];const o=await y(t,"bdp",2),c=await r.findOne({_id:s}).populate("dataFiles");if(!c)throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!c.getPrivilege(o).canDelete)throw[w("38",{details:"Sorry, you do NOT have privileges to delete this project."})];const l=await n.find({project:s}).populate("inFiles outFiles task");for(const e of l)await b(e);const p=await d.find({project:s});for(const e of p)await S(e,c);await c.remove();const g=u.resolve(a+"/"+c.id);return await h.remove(g),{success:c.getModel(),errors:[]}})),F.post("/api/:projectId/setMembers",m(async e=>{const t=e.session.passport.user.id,a=e.params.projectId,s=e.body.changes,o=e.body.scope;if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:"The project ID is invalid, please check if this is the right ID."})];if(!s||0===s.length||!o||"runners"!==o&&"managers"!==o&&"viewers"!==o&&"owner"!==o)throw[w("402",{type:"warning",details:"No changing members. Please check if you input all correct member info."})];const n=await y(t,"bdp",2),d=await r.findOne({_id:a});if(!d)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const l=d.getPrivilege(n);if(!l.canSetMember||("owner"===o||"managers"===o)&&l.isManager)throw[w("38",{details:"Sorry, you do not have privileges to set members of this project."})];const p=s.map(e=>e.userID&&i.Types.ObjectId.isValid(e.userID)?e.userID:void 0).filter(e=>void 0!==e);if(0===p.length)throw[w("402",{type:"warning",details:"No changes."})];const u=d[o],h=await c.find({_id:{$in:p}});if(0===h.length)throw[w("402",{type:"warning",details:"No changes."})];for(let e=0;e<h.length;e++){const t=h[e];for(let e=0;e<s.length;e++){const a=s[e];if("owner"===o&&t.id===a.userID){"add"===a.action?d.owner=t.id:"remove"===a.action&&(d.owner=void 0);break}if(t.id===a.userID){if("add"===a.action&&u.indexOf(t.id)<0){d[o].push(t.id);break}if("remove"===a.action){const e=u.indexOf(t.id);e>=0&&d[o].splice(e,1)}}}}await d.save();const g=await k(a);if(!d)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const f=g.getPrivilege(n);if(!f.canView)throw[w("38",{details:"Sorry, you do not have privileges to view this project."})];return{errors:[],success:g.getModel(f)}})),F.get("/api/:projectId/relatedPackages",m(async e=>{const t=e.session.passport.user.id,a=e.params.projectId;if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(t))throw[w("23",{desc:"Please check if you use the correct userID."})];const s=await y(t,"bdp",2),n=await r.findOne({_id:a}).populate("dataFiles");if(!n)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const d=await o.find({_id:{$in:n.packages}}),c=d.map(e=>e.getPrivilege(s)),l=d.filter((e,t)=>{const a=c[t];return a.canView||a.canRun}).map(e=>e.name.split("-").slice(0,-1).join("-"));l.push("all","utility");const p=await o.find({$or:[{_id:{$in:d.map(e=>e.id)}},{scope:{$in:l}}]}),u=[];for(let e=0;e<n.packages.length;e++){const t=n.packages[e].toString();for(let e=0;e<p.length;e++){if(p[e].id===t){u.push.apply(u,p.splice(e,1));break}}}return u.push.apply(u,p),{errors:[],success:u.filter(e=>!(e.scope.indexOf("admin")>=0)||s.auths.bdp>=8).map(e=>e.getModel(e.getPrivilege(s)))}})),F}},function(e,t,a){const s=a(3),i=a(0),r=a(9),o=a(5),n=a(1),d=a(14),c=a(8),l=a(4),p=a(2),u=a(10),h=a(68),g=a(21),f=a(13),m=h.createProxy({ws:!0});e.exports=function(e){const t=e.chiConfig,a=t.serverConfig,h=e.chiServer,w=e.proxyMapper,y=t.system.dataFilePath,k=t.system.taskLogFolder,v=t.system.docker_path,b=t.system.scriptFolder,S=e.helpers,x=S.chiAsyncWrap,O=S.getCode,I=S.issueAvailablePort,F=S.getAuthAsync,j=S.readTaskLogIndex,T=e.taskRunner,D=S.makeResultDeleted,P=S.makeResultStopped,A=S.socketBroadcast,$=s.Router();return $.all("/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(O("a011")),t.json(s);a()}),$.get("/api/activities",x(async e=>{const t={errors:[],success:void 0},a=e.session.passport.user.id,s=e.query.pageIndex||0,i="shared"===e.query.type?"shared":"owner"===e.query.type?"owner":null;let r=parseInt(e.query.pageSize);r=!isNaN(r)&&[10,30].indexOf(r)>=0?r:10;const o=await F(a,"bdp",2),n={$or:[]};"shared"===i?n.$or.push({managers:a},{runners:a},{viewers:a}):"owner"===i?n.$or.push({owner:a}):n.$or.push({owner:a},{managers:a},{runners:a},{viewers:a});const d=await l.find(n),p=d.map(e=>e.results),u=[];for(let e=0;e<p.length;e++)Array.isArray(p[e])&&u.push.apply(u,p[e]);const h={};for(let e=0;e<d.length;e++){const t=d[e];h[t.id]=t.getPrivilege(o)}const g=await c.countDocuments({_id:{$in:u}}),f=g%r>0?Math.floor(g/r)+1:Math.floor(g/r),m=await c.find({_id:{$in:u},parent:{$exists:!1}}).sort({updatedAt:-1}).skip(r*s).limit(r).populate("owner inFiles outFiles task project");return t.success={records:m.map(e=>{const t=T.getCurrentStdOutput(e.pid);return t&&(e.stdOut=t.stdOut,e.stdErr=t.stdErr),e.getModel(h[e.project.id])}),totalPage:f,pageIndex:s,totalCount:g,pageSize:r},t})),$.post("/api/task/:taskId/createResult",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.body.inputs,h=e.body.outputs,g=e.body.run,m=e.params.taskId,w=e.body.projectID,S=e.body.desc;let x=e.body.prefix||"",j=e.body.suffix||"";const D=e.body.name;if(!i.Types.ObjectId.isValid(m))throw[O("31")];if(!i.Types.ObjectId.isValid(w))throw[O("19",{details:`We can not find the project id: ${w}. please check if this is the right ID.`})];const P=await F(a,"bdp",2),$=await l.findOne({_id:w}).populate("package");if(!$)throw[O("19")];if(!$.getPrivilege(P).canRun)throw[O("38",{details:"Sorry, you do not have privileges to run tasks in this project."})];const _=await r.findOne({_id:m}),M=await u.findOne({_id:_.package});if(!M)throw[O("19",{details:"We can not find the package of the task."})];if(!_)throw[O("31")];if("system"===_.type&&P.auths.bdp<8)throw[O("708")];x=x.replace(/\ +$/," ").replace(/^\ +/,""),j=j.replace(/^\ +/," ").replace(/\ +$/,"");const C=new c({name:D?D.trim():"Result from "+_.name,desc:S,type:_.type,task:_.id,taskSnapshot:_.getModel(),project:w,owner:a,script:_.script,cwd:_.cwd,status:g?"workflow"===_.type?1:0:-1,readOnly:!1,timer:[new Date],outFiles:[],inFiles:[],arguments:[],prefix:x,suffix:j});let E;if(_.proxy&&_.proxy.enabled&&(E=await I(C.id,_.proxy.port||void 0),!E))throw[O("32",{details:`Sorry the port ${_.proxy.port} is in use. Tyr using orther port numbers or a dynamic port`})];const N={PROJECT_FOLDER:n.resolve(y,$.id),SHARED_FOLDER:n.resolve(y,"shared"),PACKAGE_FOLDER:n.resolve(M.path),TASK_ID:_.id,TASK_KEY:_.key,TASK_NAME:d(_.name,{condense:!0}),TASKLOG_FOLDER:k,DOCKER_PATH:v,BDP_SYSTEM_FOLDER:process.env.BDP_SYSTEM_FOLDER,BDP_HOST_PORT:E,ARG_ENCODING:_.encodeArg?"base64":void 0,RESULT_ID:C._id.toString()};for(let e=0;e<_.arguments.length;e++){"inFile"==_.arguments[e].type&&C.inFiles.push(s[e])}const R=[],L=await o.find({_id:{$in:C.inFiles}}),q={},V={};for(const e of L)1===e.status&&(q[e.id]=e.path),e.realPath&&R.push(e.realPath),V[e.id]=e;const W=[];for(let e=0;e<_.arguments.length;e++){const t=_.arguments[e];if("value"===t.type){if("number"===t.format){if(!(null!==s[e]&&void 0!==s[e]||t.optional)){W[e]={type:"Can not be empty",data:s[e]};continue}if(isNaN(parseFloat(s[e]))){W[e]={type:"Number required",data:s[e]};continue}}C.arguments[e]={value:s[e]}}else if("static"===t.type)C.arguments[e]={static:t.default[0]};else if("inFile"===t.type){let a=q[s[e]];if(!a&&!t.optional){W[e]={type:"File not available",data:V[s[e]]};continue}!a&&t.optional&&(a=""),C.arguments[e]={inFile:a}}else if("list"===t.type){if(null===s[e]||void 0===s[e]){if(!t.optional){W[e]={type:"Can not be empty",data:s[e]};continue}s[e]=[]}else if("[object Array]"===Object.prototype.toString.call(s[e])&&0===s[e].length&&!t.optional){W[e]={type:"Can not be empty",data:s[e]};continue}C.arguments[e]={list:s[e]}}}if(W.length>0)throw[O("32",{attached:W})];const z=_.outputProvider(),B=[],G=[],U={};for(let e=0;e<z.length;e++){const t=z[e].index;U[z[e].index]=e;const i=new o(z[e]);let r="",d="";if(z[e].dependOn&&z[e].default){let t="";const a=z[e].dependOn.split(".");if("argv"!==a[0]){console.log("Error!");continue}{const r=_.arguments[+a[1]];if("outFile"===r.type&&"Folder"===r.format){const e=B[U[+a[1]]];if(!e)continue;t=e.path,i.parent=e.id}else"inFile"===r.type&&"Folder"===r.format&&(t=q[s[+a[1]]],i.parent=s[+a[1]]);z[e].default.indexOf("{$FolderName}")>=0&&(z[e].default=z[e].default.replace(/\{\$FolderName\}/g,n.basename(t))),i.path=n.resolve(t,z[e].default)}}else i.path=n.resolve(`${y}/${w}/${i.id}`);"Folder"!==i.format&&(i.path+="."+i.format),r=h[e]&&h[e].name?h[e].name:i.name+" of the "+_.name,h[e]&&h[e].desc&&(d=h[e].desc),z[e].outPreFolder&&"Folder"===z[e].format&&G.push(i.path),i.name=r,i.desc=d,i.owner=a,i.project=w,i.result=C.id,i.prefix=x,i.suffix=j,$.dataFiles.push(i.id),C.outFiles.push(i.id),B[e]=i,await B[e].save();const c=i.getModel();c.owner=P.getSlimModel(),A($.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:c}),"Folder"===i.format&&"name"===z[e].outFolderStyle&&"$ProjectFolder"===_.cwd?C.arguments[t]={outFile:n.basename(i.path)}:("Folder"===i.format&&z[e].outFolderStyle,C.arguments[t]={outFile:i.path})}const J=_.compose(C.arguments,N.PACKAGE_FOLDER,N.PROJECT_FOLDER,b);if(C.command=J.command,C.commandArgs=J.commandArgs,"workflow"!==_.type)if("$ProjectFolder"===_.cwd)C.cwd=n.resolve(y+"/"+w);else if(_.cwd.match(/^\$ScriptFolder/))C.cwd=n.resolve(_.cwd.replace(/^\$ScriptFolder/,b));else if(_.cwd.match(/^\$PackageFolder/))C.cwd=n.resolve(_.cwd.replace(/^\$PackageFolder/,N.PACKAGE_FOLDER));else if(0===_.cwd.indexOf("argv")){const e=_.cwd.split("."),t=parseInt(e[1]);if(isNaN(t))throw[O("32",{details:`The working directory setting has error(s): Current value: ${_.cwd}. Please contact the web admin to correct the task's working directory.`})];if(!_.arguments[t]||"inFile"!==_.arguments[t].type||"Folder"!==_.arguments[t].format)throw[O("32",{details:`The working directory setting has error(s): Current value: ${_.cwd}. Please contact the web admin to correct the task's working directory.`})];C.cwd=C.arguments[t].inFile}if(G.length>0)for(let e=0;e<G.length;e++){const t=G[e];await p.ensureDir(t)}await C.save(),$.results.push(C.id),await $.save();const K=new f({result:C.id,user:a,project:w,taskName:_.name,projectName:$.name,projectDesc:$.desc,title:C.name,desc:C.desc,prefix:C.prefix,suffix:C.suffix,status:0,timer:[new Date]});await K.save();const H=await c.findOne({_id:C.id}).populate("owner outFiles inFiles task");if(!H)throw[O("35",{details:`We can not find the result id: ${H.id}. please check if this is the right ID.`})];const Q=H.getModel();return A($.getListeners(),"dataChange",{type:"insert",target:"Result",data:Q}),C.status>=0&&(C.env=N,C.extDirs=R,await T.addToQueue({id:C.id,command:C.command,commandArgs:C.commandArgs,cwd:C.cwd,type:C.type,owner:C.owner,project:C.project,env:C.env||{},extDirs:C.extDirs||[]})),t.success=Q,t})),$.get("/api/result/:resultId/resume",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.resultId;if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const o=await F(a,"bdp",2),p=await c.findOne({_id:s}).populate("owner inFiles outFiles");if(!p)throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const h=await l.findOne({_id:p.project});if(!h)throw[O("19",{details:"We can not find the project for this result, please check if this is the right ID."})];if(!h.getPrivilege(o).canRun)throw[O("38",{details:"Sorry, you do not have privilegs to view results in this project."})];if(!p.task)throw[O("711",{details:"Sorry, the task might have been removed."})];const g=await r.findOne({_id:p.task});if(!g)throw[O("19",{details:"Sorry, the task does not exist."})];const m=await u.findOne({_id:g.package});if(!m)throw[O("19",{details:"We can not find the package of the task."})];const w=p;let b;g.proxy&&(b=await I(p.id));const S={PROJECT_FOLDER:n.resolve(y,h.id),SHARED_FOLDER:n.resolve(y,"shared"),PACKAGE_FOLDER:n.resolve(m.path),TASK_ID:g.id,TASK_KEY:g.key,TASK_NAME:d(g.name,{condense:!0}),TASKLOG_FOLDER:k,DOCKER_PATH:v,BDP_HOST_PORT:b,ARG_ENCODING:g.encodeArg?"base64":void 0,RESULT_ID:w._id.toString()},x=g.arguments.filter(e=>"inFile"===e.type&&!e.optional),j=p.inFiles.filter(e=>!!e);if(x.length>j.length)throw[O("711",{name:"Input file number inconsistency",details:`The task require ${x.length} input files, but the previous run only has ${j.length} files.Please check if some files were removed or the task arguments were changed.`})];const D={},P={},$=[];j.forEach(e=>{1===e.status&&(D[e.id]=e.path,e.realPath&&$.push(e.realPath),P[e.id]=e)});const _=g.outputProvider(),M=p.outFiles.filter(e=>!!e);if(_.length!==M.length)throw[O("711",{name:"Output file inconsistency",details:"The task outputs "+_.length+" file records(s), but the previous run expects "+M.length+" record(s). Please check if some output records were removed or the task arguments were changed."})];p.status="workflow"===g.type?1:0,p.timer=[new Date],await p.save();const C=new f({result:w.id,user:a,project:h.id,taskName:g.name,projectName:h.name,projectDesc:h.desc,title:w.name,prefix:w.prefix,suffix:w.suffix,desc:w.desc,status:0,timer:[new Date]});await C.save();const E=p.getModel();return A(h.getListeners(),"dataChange",{type:"update",target:"Result",data:E}),w.env=S,w.extDirs=$,await T.addToQueue({id:w.id,command:w.command,commandArgs:w.commandArgs,cwd:w.cwd,type:w.type,owner:w.owner,project:w.project,env:w.env||{},extDirs:w.extDirs||[]}),t.success=E,t})),$.get("/api/:resultId",x(async e=>{const t=e.session.passport.user.id,a=e.params.resultId;if(!i.Types.ObjectId.isValid(a))throw[O("35",{details:`We can not find the result id: ${a}. please check if this is the right ID.`})];const s=await F(t,"bdp",2),r=await c.findOne({_id:a}).populate("owner inFiles outFiles task");if(!r)throw[O("35",{details:`We can not find the result id: ${a}. please check if this is the right ID.`})];const o=await l.findOne({_id:r.project});if(!o)throw[O("19",{details:"We can not find the project for this result, please check if this is the right ID."})];const n=o.getPrivilege(s);if(!n.canView)throw[O("38",{details:"Sorry, you do not have privilegs to view results in this project."})];if(1===r.status&&r.pid>=0){const e=T.getCurrentStdOutput(r.pid);e&&(r.stdOut=e.stdOut,r.stdErr=e.stdErr)}return{success:r.getModel(n),errors:[]}})),$.patch("/api/:resultId",x(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.resultId,r=e.body.name,o=e.body.desc,n=e.body.prefix||"",d=e.body.suffix||"";if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const p=await F(a,"bdp",2),u=await c.findOne({_id:s}).populate("owner");if(!u)throw[O("35",{details:`We cannot find the result id: ${s}. please check if this is the right ID.`})];const h=await l.findOne({_id:u.project}),g=h.getPrivilege(p);if(!g.canEditResult)throw[O("38",{details:"Sorry, you do not have privileges to edit results in this project."})];if(g.isRunner&&(!u.owner||u.owner.id!==a))throw[O("38",{details:"Sorry, you can only update information of your own Results. This Result is not created by you."})];if(r.length>160)throw[O("36")];if(o.length>1e3)throw[O("37")];u.name=r||u.name,u.desc=o||u.desc,u.prefix=n.slice(0,36),u.suffix=d.slice(0,36),await u.save();const f=await c.findOne({_id:u.id}).populate("owner outFiles inFiles task");return t.success=f.getModel(),A(h.getListeners(),"dataChange",{type:"update",target:"Result",data:t.success}),t})),$.get("/api/:resultId/stop",x(async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,r=e.params.resultId;if(!i.Types.ObjectId.isValid(r))throw[O("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const o=await F(s,"bdp",2),n=await c.findOne({_id:r}).populate("owner outFiles inFiles task");if(!n)throw[O("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const d=(await l.findOne({_id:n.project})).getPrivilege(o);if(!d.canRun)throw[O("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];if(d.isRunner&&(!n.owner||n.owner.id!==s))throw[O("38",{details:"Sorry, you can only stop the task of your own Result. This Result is not created by you."})];return a.success=n.getModel(),t.json(a),await P(n),!1})),$.post("/api/:projectId/batchStopResult",x(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.projectId,r=e.body.resultIDs||[];if(!i.Types.ObjectId.isValid(s))throw[O("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(0===r.length)throw[O("709",{type:"warning",details:"No tasks to stop."})];if(r.filter(e=>!i.Types.ObjectId.isValid(e)).length>0)throw[O("709",{type:"warning",details:"There are invalid result ids in your request."})];const o=await F(a,"bdp",2),n=await l.findOne({_id:s});if(!n)throw[O("19",{details:"We can not find the project for this data file please check if this is the right ID."})];const d=n.getPrivilege(o);if(!d.canRun)throw[O("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];const p={project:s,_id:{$in:r},status:1};d.isRunner&&(p.owner=a);const u=await c.find(p).populate("owner outFiles inFiles task");t.json({success:u.map(e=>e.getModel()),errors:[]});for(const e of u)await P(e);return!1})),$.delete("/api/:resultId",x(async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,r=e.params.resultId;if(!i.Types.ObjectId.isValid(r))throw[O("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const o=await F(s,"bdp",2),n=await c.findOne({_id:r}).populate("owner outFiles inFiles task");if(!n)throw[O("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const d=(await l.findOne({_id:n.project})).getPrivilege(o);if(!d.canDeleteResult)throw[O("38",{details:"Sorry, you do not have privileges to delete results in this project."})];if(d.isRunner&&(!n.owner||n.owner.id!==s))throw[O("38",{details:"Sorry, you can only delete your own Result. This Result is not created by you."})];return n.readOnly=!0,n.status=4,a.success=n.getModel(),t.json(a),await D(n),!1})),$.post("/api/:projectId/batchRemoveResult",x(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.projectId,r=e.body.resultIDs||[];if(!i.Types.ObjectId.isValid(s))throw[O("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(0===r.length)throw[O("709",{type:"warning",details:"No tasks to stop."})];if(r.filter(e=>!i.Types.ObjectId.isValid(e)).length>0)throw[O("709",{type:"warning",details:"There are invalid result ids in your request."})];const o=await F(a,"bdp",2),n=await l.findOne({_id:s});if(!n)throw[O("19",{details:"We can not find the project for this data file please check if this is the right ID."})];const d=n.getPrivilege(o);if(!d.canDeleteResult)throw[O("38",{details:"Sorry, you do not have privileges to remove results in this project."})];const p={project:s,_id:{$in:r}};d.isRunner&&(p.owner=a);const u=await c.find(p).populate("owner outFiles inFiles task");u.forEach(e=>{e.readOnly=!0,e.status=4}),t.json({success:u.map(e=>e.getModel()),errors:[]});for(const e of u)await D(e);return!1})),m.on("proxyReq",(function(e,t,a){const s=a.get("needPathRewrite"),i=t.originalUrl.match(/^\/result\/(.*?)\/proxy/);if("true"===s&&i){const a=i[1];e.path=t.originalUrl.replace(`/result/${a}/proxy`,"")}else e.path=t.originalUrl;const r=e.getHeader("Content-Type");if(t.body&&r)if(r&&r.indexOf("application/x-www-form-urlencoded")>=0){const a=Object.keys(t.body).map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(t.body[e])}`).join("&");e.setHeader("Content-Length",Buffer.byteLength(a)),e.write(a)}else if(r.indexOf("application/json")>=0){const a=JSON.stringify(t.body);e.setHeader("Content-Type","application/json"),e.setHeader("Content-Length",Buffer.byteLength(a)),e.write(a)}})),m.on("proxyRes",(function(e,t){let s="";const i=e.headers.location;if(e.headers["X-Frame-Options"]="SAMEORIGIN",e.headers["Content-Security-Policy"]="frame-ancestors 'self'",i&&(0===i.indexOf("http")||0===i.indexOf("https"))){const r=t.originalUrl.match(/^\/result\/(.*?)\/proxy/);s=URL?new URL(i):g.parse(i);const o=`${a.site_domain}:${a.port}/result/${r[1]}/proxy`;s.pathname&&i.indexOf(o+"/")<=0&&(e.headers.location=o+s.pathname+s.search+s.hash)}})),m.on("error",(function(e){console.log("Proxy Error"),console.log(e)})),h.on("upgrade",(function(e,t,a){if(!e.url)return;const s=e.url.match(/\/result\/(.*?)\/proxy/);if(s&&s[1]){const i=s[1],r=w[i];if(!r)return;r.pathRewrite?(e.url=e.url.replace(`/result/${i}/proxy`,""),m.ws(e,t,a,{target:`${r.protocol}://${r.ip}:${r.port}`},(function(e){console.log(e)}))):m.ws(e,t,a,{target:`${r.protocol}://${r.ip}:${r.port}`},(function(e){console.log(e)}))}})),$.all("/:resultId/proxy/*",x(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId;if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const r=await F(a,"bdp",2),o=await c.findOne({_id:s}).populate("task");if(!o)throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(!(await l.findOne({_id:o.project})).getPrivilege(r).canView)throw[O("38",{details:"Sorry, you do not have privileges to view this Page in this project."})];if(!w[s])throw[O("501",{details:`Sorry, the web proxy has NOT been set for this result. Please try the endpoint '/result/${s}/requestProxy' first.`})];const n=w[s];t.set("needPathRewrite",n.pathRewrite),m.web(e,t,{target:`${n.protocol}://${n.ip}:${n.port}/`,autoRewrite:!0,cookieDomainRewrite:`${n.ip}:${n.port}`,ws:!0,changeOrigin:!0,preserveHeaderKeyCase:!0,debug:!0},(function(e){t.write(JSON.stringify(e))}))})),$.get("/:resultId/requestProxy",x(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId;if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const r=await F(a,"bdp",2),o=await c.findOne({_id:s}).populate("task");if(!o)throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];o.task||(o.task={});if(!(await l.findOne({_id:o.project})).getPrivilege(r).canView)throw[O("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];if("workflow"===o.type)throw[O("501",{details:"We cannot proxy the workflow tasks."})];if(1!==o.status&&null===o.task.proxy)throw delete w[o.id],[O("501",{details:"This is an invalid result to make the proxy."})];let n={},d="/";n=o.task.proxy,n.ip=n.ip||"localhost";try{const e=n.entryPath||"/",t=new URL(`http://${n.ip}${e}`);d=`${t.pathname}${t.search}${t.hash}`}catch(e){A(a,"message",O("501",{details:"The proxy entry path is invalid. We redirect page to the proxy root."}))}if(!w[o.id])throw[O("501",{details:"We cannot do the web proxy because there is no proxy settings for this Result's task."})];{const e=w[o.id].hostPort;w[o.id]={ip:n.ip,hostPort:e,port:e,pathRewrite:n.pathRewrite,protocol:n.protocol,entryPath:d}}return t.redirect(`/result/${s}/proxy${d}`)})),$.get("/api/:resultId/taskLog",x(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId,r=e.query.jobID,o=e.query.stdoe;if(!i.Types.ObjectId.isValid(s))throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const d=await F(a,"bdp",2),u=await c.findOne({_id:s}).populate("owner outFiles inFiles task");if(!u)throw[O("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(!(await l.findOne({_id:u.project})).getPrivilege(d).canView)throw[O("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];if("workflow"===u.type)throw[O("710",{details:"Workflow does not have task logs."})];let h="index.txt",g="",f=!1;if(r&&["stdout","stderr"].indexOf(o)>=0){if(g=n.resolve(k,s,h),f=await p.pathExists(g),!f&&(h="progress-index.txt",g=n.resolve(k,s,h),f=await p.pathExists(g),!f))throw[O("710",{details:"Sorry, we cannot find the task log index for this result."})];h=await j(g,r,o);let e=await p.pathExists(h);if(!e){const t=await j(g,r,"taskName");if(h=n.join(k,s,t,`${r}-${o}.txt`),e=await p.pathExists(h),!e)throw[O("710",{details:`Sorry, the ${o} file may have not been created for this result.`})]}t.setHeader("Content-type","text/plain"),t.sendFile(h)}else{let e=n.resolve(k,s,h);if(!await p.pathExists(e)){h="progress-index.txt",e=n.resolve(k,s,h);if(!await p.pathExists(e))throw[O("710",{details:"Sorry, we cannot find the task logs for this result."})]}t.sendFile(e)}return!1})),$}},function(e,t){e.exports=require("http-proxy")},function(e,t,a){const s=a(3),i=a(0),r=a(4),o=a(5),n=a(2),d=a(26),c=a(1),l=a(7),p=a(70),u=a(29),h=a(71),g=a(28),f=a(72);e.exports=function(e){const t=e.chiConfig.system.dataFilePath,m=e.helpers,w=m.chiAsyncWrap,y=m.getAuthAsync,k=m.isAuthenticated,v=m.getCode,b=s.Router(),S={};return b.use("/static/:dataFileId",d({methods:["GET","HEAD","OPTIONS"],allowedHeaders:["range","Cache-control","If-None-Match","Content-Type"],exposedHeaders:["Content-Length","Content-Range","Content-Type"],credentials:!0}),w(async(e,t,a)=>{const n=e.params.dataFileId;if(!i.Types.ObjectId.isValid(n))throw[v("27")];const d=await k(e,"bdp",2);if(!d)throw[v("12")];const c=await o.findOne({_id:n});if(!c)throw[v("27",{details:"Sorry, we can not find the file record for you."})];if(!(await r.findOne({_id:c.project})).getPrivilege(d).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];if(!S[n])return S[n]=c.realPath||c.path,b.use("/static/"+n,s.static(S[n]),h(S[n],{icons:!0,view:"details"})),t.redirect(`/data/static/${n}/${e.path}`),!1;a()})),b.post("/api/data/download",w(async(e,t)=>{if(!e.isAuthenticated())throw[v("12")];const a=e.session.passport.user.id,s=e.body.projectID,i=e.body.fileIDs,d=await y(a,"bdp",2),c=await r.findOne({_id:s});if(!c)throw[v("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!c.getPrivilege(d).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];const l=i.filter(e=>c.dataFiles.indexOf(e)>=0),p=await o.find({_id:{$in:l},project:c.id});t.header("Content-Type","application/zip"),t.header("Content-Disposition",'attachment; filename="bdp-download.zip"');const h=u("zip",{zlib:{level:1}});h.pipe(t);const f={},m={};for(const e of p){const t=await n.realpath(e.path);if(await n.pathExists(t)){const a=await n.stat(t),s=e.prefix+e.name+e.suffix;a.isDirectory()?void 0===m[s]?(m[s]=0,h.directory(t+"/",g(s,{replacement:"_"}))):(m[s]++,h.directory(t+"/",g(s+"("+m[s]+")",{replacement:"_"}))):a.isFile()&&(void 0===f[s]?(f[s]=0,h.file(t,{name:g(s,{replacement:"_"})+"."+e.format})):(f[s]++,h.file(t,{name:g(s+"("+f[s]+")",{replacement:"_"})+"."+e.format})))}}return h.finalize(),!1})),b.get("/api/dataFile/:dataFileId/:viewType",d({methods:["GET","HEAD","OPTIONS"],allowedHeaders:["range","Cache-control","If-None-Match","Content-Type"],exposedHeaders:["Content-Length","Content-Range","Content-Type"],credentials:!0}),w(async(e,d)=>{const p={errors:[]},g=e.params.dataFileId,m=e.params.viewType,w="true"===e.query.preview;let y=e.query.subPath;if(!i.Types.ObjectId.isValid(g))throw[v("27")];const x=await k(e,"bdp",2);if(!x)throw[v("12")];const O=await o.findOne({_id:g});if(!O)throw[v("27")];const I=await r.findOne({_id:O.project});if(!I.getPrivilege(x).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];const F=await O.checkFile();if(!F)throw[v("27",{name:"File does not exist"})];if("download"===m){if("Folder"!==O.format){const e=O.prefix+O.name+O.suffix+"."+O.format;d.set({"Content-disposition":f(e),"x-no-compression":!0,"Content-Length":F.size});const a=c.resolve(t+"/"+I.id);if(!l(O.path,a))throw[v("27",{details:"Invalid file to download."})];return d.sendFile(O.path),!1}{if(y){y=y.replace(/\.\./g,"");const e=c.join(O.path,y);if(l(e,O.path)){if(await n.pathExists(e)){const t=await n.stat(e);if(t.isFile())return d.set({"Content-disposition":`attachment; filename="${c.basename(e)}"`,"x-no-compression":!0,"Content-Length":t.size}),d.sendFile(e),!1}}throw[v("27",{details:"Invalid file to download"})]}d.header("Content-Type","application/zip"),d.header("Content-Disposition",`attachment; filename="${O.prefix}${O.name}${O.suffix}.zip"`);const e=u("zip",{zlib:{level:9}});return e.pipe(d),e.directory(O.path+"/",!1),e.finalize(),!1}}if("static"===m)return null==S[g]&&"Folder"===O.format&&(S[g]=O.realPath||O.path,b.use("/static/"+g,s.static(S[g]),h(S[g],{icons:!0,view:"details"}))),d.redirect("/data/static/"+g),!1;if("csv"==O.format){const e=O.path,t=[];let s=0;const i=a(17).createInterface({input:n.createReadStream(e)});return i.on("line",(function(e){s++;let a=e.split(",");"rownames"===m&&w?a=a.slice(0,5):"rownames"!==m||w||(a=a[0]),t.push(a),"colnames"===m&&w?s>=5&&i.close():"colnames"!==m||w||1===s&&i.close()})),void i.on("close",(function(){p.success={id:g,viewType:m,isPreview:w,data:t},d.json(p)}))}if("json"==O.format){const e=O.path;let t="";const s=a(17).createInterface({input:n.createReadStream(e)});return s.on("line",(function(e){t+=e})),void s.on("close",(function(){p.success={id:g,viewType:m,isPreview:w,data:JSON.parse(t)},d.json(p)}))}throw[v("-2",{name:"Data currently not supported"})]})),b.post("/api/dataFile/:dataFileId/glob",w(async e=>{const t={errors:[],success:[]};if(!e.isAuthenticated())throw[v("12")];const a=e.session.passport.user.id,s=e.params.dataFileId,n=e.body.globbyExprs,d=await y(a,"bdp",2);if(!i.Types.ObjectId.isValid(s))return t;const c=await o.findOne({_id:s});if(!c)throw[v("27")];if(!(await r.findOne({_id:c.project})).getPrivilege(d).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];return"Folder"!==c.format||(t.success=await p(n,{cwd:c.path,root:c.path,follow:!1})),t})),b}},function(e,t){e.exports=require("globby")},function(e,t){e.exports=require("serve-index")},function(e,t){e.exports=require("content-disposition")},function(e,t,a){const s=a(3),i=a(0),r=a(11),o=a(4),n=a(5),d=a(74),c=a(1),l=a(2),p=a(7),{google:u}=a(75),h=a(76),g=u.auth.OAuth2,f=/[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+(?:[A-Z]{2}|com|org|net|edu|gov|mil|biz|info|mobi|name|aero|asia|jobs|museum)\b/;e.exports=function(e){const t=e.io,a=e.chiConfig,m=e.helpers,w=m.chiAsyncWrap,y=m.getAuthAsync,k=m.errorHandler,v=m.logMessages,b=m.makeDataFileDeleted,S=a.system.dataFilePath,x=m.getCode,O=m.socketBroadcast,I=s.Router(),F={"application/vnd.google-apps.document":["text/html","text/plain","application/rtf","application/vnd.oasis.opendocument.text","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/pdf"],"application/vnd.google-apps.spreadsheet":["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/x-vnd.oasis.opendocument.spreadsheet","text/csv","application/pdf"],"application/vnd.google-apps.drawing":["image/jpeg","image/png","image/svg+xml","application/pdf"],"application/vnd.google-apps.presentation":["application/vnd.openxmlformats-officedocument.presentationml.presentation","application/pdf","text/plain"]};I.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(x("a011")),t.json(s);a()}),I.get("/api/:dataFileId",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(a))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const r=await y(s,"bdp",2),d=await n.findOne({_id:a}).populate("owner").populate({path:"result",populate:{path:"owner outFiles inFiles task"}});if(!d)throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const c=await o.findOne({_id:d.project});if(!c)throw[x("19",{details:"We can not find the project for this data file please check if this is the right ID."})];if(!c.getPrivilege(r).canView)throw[x("38",{details:"Sorry, you do not have privileges to view the data file information."})];return t.success=d.getModel(),t})),I.patch("/api/batchUpdate",w(async e=>{const t=e.body.dataFiles,a=e.session.passport.user.id,s=await y(a,"bdp",2),r=t.map(e=>i.Types.ObjectId.isValid(e.id)?e.id:null).filter(e=>null!==e),d=await n.find({_id:{$in:r}}).populate("owner result"),c=[...new Set(d.map(e=>e.project.toString()))],l=await o.find({_id:{$in:c}}),p=[];for(let e=0;e<d.length;e++){const i=d[e],r=t.filter(e=>e.id===i.id)[0],o=l.filter(e=>e.id===i.project.toString())[0];if(r&&o){const e=o.getPrivilege(s);if(!e.canEditFile)continue;if(e.isRunner&&(!i.owner||i.owner.id!==a))continue;i.name=r.name.slice(0,80),i.desc=r.desc.slice(0,300),i.prefix=r.prefix.slice(0,36),i.suffix=r.suffix.slice(0,36);const t=i.tags.indexOf("Folder")>=0;i.tags=r.tags.map(e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-zA-Z0-9\.\-\_]/g,""));const n=i.tags.indexOf("Folder");t&&n<0&&i.tags.unshift("Folder"),!t&&n>=0&&(i.tags[n]=i.tags[n].toLowerCase());const d=(await i.save()).getModel();O(o.getListeners(),"dataChange",{type:"update",target:"DataFile",data:d}),p.push(d)}}return{errors:[],success:p}})),I.patch("/api/:dataFileId",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(a))throw[x("27",{details:"We can not find the data file id: "+a+". please check if this is the right ID."})];const r=await y(s,"bdp",2),d=await n.findOne({_id:a}).populate("owner result");if(!d)throw[x("27",{details:"We can not find the data file id: "+a+". please check if this is the right ID."})];const c=await o.findOne({_id:d.project}),l=c.getPrivilege(r);if(!l.canEditFile)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];if(l.isRunner&&(!d.owner||d.owner.id!==s))throw[x("38",{details:"Sorry, you can only update information of your own DataFiles. This DataFile is not created by you."})];const p=e.body.name,u=e.body.desc,h=e.body.prefix||"",g=e.body.suffix||"";if(p.length>80)throw[x("28",{details:"The name for the data (id: "+a+") is too long. Please shorten the name and try saving again."})];if(u.length>300)throw[x("29",{details:"The description for the data file (id: "+a+") is too long. Please shorten the description and try saving again."})];const f=r.auths.bdp;if(d.name=p,d.desc=u,d.prefix=h.slice(0,36),d.suffix=g.slice(0,36),f>=2&&(e.body.format&&d.format,e.body.tags)){const t=d.tags.indexOf("Folder")>=0;d.tags=e.body.tags.map(e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-zA-Z0-9\.\-\_]/g,""));const a=d.tags.indexOf("Folder");t&&a<0&&d.tags.unshift("Folder"),!t&&a>=0&&(d.tags[a]=d.tags[a].toLowerCase())}return await d.save(),t.success=d.getModel(),O(c.getListeners(),"dataChange",{type:"update",target:"DataFile",data:t.success}),t})),I.delete("/api/:dataFileId",w(async(e,t)=>{const a={errors:[]},s=e.params.dataFileId,r=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(s))throw[x("27",{details:`We can not find the data file id: ${s}. please check if this is the right ID.`})];const d=await y(r,"bdp",2),c=await n.findOne({_id:s}).populate("owner").populate({path:"result",populate:{path:"owner outFiles inFiles task"}});if(!c)throw[x("27",{details:`We can not find the data file id: ${s}. Please check if this is the right ID.`})];const l=await o.findOne({_id:c.project});if(!l)throw[x("19",{details:"We can not find the project for this data file please check if this is the right ID."})];const p=l.getPrivilege(d);if(!p.canDeleteFile)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];if(p.isRunner&&(!c.owner||c.owner.id!==r))throw[x("38",{details:"Sorry, you can only delete your own DataFiles. This DataFile is not created by you."})];c.readOnly=!0,c.status=3;const u=c.getModel();return u.owner=d.getSlimModel(),a.success=u,await c.save(),t.json(a),O(l.getListeners(),"dataChange",{type:"update",target:"DataFile",data:u}),await b(c,l),!1})),I.post("/api/:projectId/batchRemoveFiles",w(async(e,t)=>{const a={errors:[]},s=e.params.projectId,r=e.body.fileIDs||[],d=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(s))throw[x("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(0===r.length)throw[x("612",{type:"warning",details:"No files to be removed."})];if(r.filter(e=>!i.Types.ObjectId.isValid(e)).length>0)throw[x("612",{type:"warning",details:"There are invalid data file ids in your request."})];const c=await y(d,"bdp",2),l=await o.findOne({_id:s});if(!l)throw[x("19",{details:"We can not find the project for this data file please check if this is the right ID."})];const p=l.getPrivilege(c);if(!p.canDeleteFile)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];const u={project:l.id,_id:{$in:r}};p.isRunner&&(u.owner=d);const h=await n.find(u).populate("owner result");h.forEach(e=>{e.readOnly=!0,e.status=3});const g=h.map(e=>e.save());for(const e of g)await e;a.success=h.map(e=>{const t=e.getModel();return t.owner=c.getSlimModel(),t}),t.json(a);for(const e of a.success)O(l.getListeners(),"dataChange",{type:"update",target:"DataFile",data:e});for(const e of h)await b(e,l);return!1})),I.get("/api/:dataFileId/ls",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id;let r=e.query.p;if(r&&(r=decodeURIComponent(r)),!i.Types.ObjectId.isValid(a))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const d=await y(s,"bdp",2),p=await n.findOne({_id:a});if(!p)throw[x("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if("Folder"!==p.format)throw[x("27",{name:"Failed to list files",details:`The file id: ${a} is not a folder. please check if this is the right ID.`})];if(!(await o.findOne({_id:p.project})).getPrivilege(d).canView)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];let u="";try{u=await l.realpath(p.path)}catch(e){return{success:[],errors:[]}}if(r){const e=c.relative(p.path,r),t=c.relative(u,r);if(e.indexOf("..")>=0&&t.indexOf("..")>=0)throw[x("27",{name:"Invalid file path",details:"The path you are going to see is invalid. Please check if the path is correct."})];e.indexOf("..")<0&&(r=c.resolve(p.path,e)),t.indexOf("..")<0&&(r=c.resolve(u,t))}const h=r||u;let g=[];try{if((await l.stat(h)).isDirectory()){const e=(await l.readdir(h)).slice(0,5e3);for(const t of e){const e=await l.stat(c.resolve(h,t)),a=e.isDirectory()?"directory":e.isFile()?"file":e.isSymbolicLink()?"symlink":null;"directory"!==a&&"file"!==a&&"symlink"!==a||g.push({children:"directory"===a?[]:void 0,extensions:"file"===a||"symlink"===a?c.extname(t):void 0,name:t,size:e.size,type:a,path:c.resolve(h,t)})}}else g=[]}catch(e){console.log(e),g=[]}return t.success=g,t})),I.post("/api/:dataFileId/move",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id,r=e.body.dest;if(!i.Types.ObjectId.isValid(a))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if(""!==r&&!i.Types.ObjectId.isValid(r))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const d=await y(s,"bdp",3),u=await n.findOne({_id:a}).populate("owner");if(!u)throw[x("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const g=await o.findOne({_id:u.project}),f=g.getPrivilege(d);if(!f.canEditFile)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];if(f.isRunner&&(!u.owner||u.owner.id!==s))throw[x("38",{details:"Sorry, you can only move your own DataFiles. This DataFile is not created by you."})];const m=await l.realpath(u.path),w=await l.lstat(u.path),k=c.join(S,g.id),v=c.join(S,"shared");let b=!1,O=!1;if(p(m,k)?b=!0:p(m,v)&&(O=!0),""===r){const e=c.extname(u.path),a=c.join(S,u.project.toString(),u.id.toString()+e);if(u.path===a)t.success=u.getModel();else{try{if(b&&!w.isSymbolicLink())await l.move(u.path,a);else{if(!O||!w.isSymbolicLink())throw"Invalid scenarios to move files.";await l.ensureSymlink(c.relative(c.dirname(a),m),a),await l.unlink(u.path)}}catch(e){throw[x("27",{name:"File movement error",details:e.toString()})]}u.path=a,u.parent=void 0,t.success=u.getModel(),await u.save()}}else{const e=await n.findOne({_id:r,format:"Folder"});if(!e)throw[x("27",{name:"File movement error",details:`We can not find the folder id: ${r}. please check if this is the right ID.`})];const a=c.extname(u.path),s=h(u.name)+(a||""),i=c.join(e.path,s);if(u.path===i)u.parent=e.id,u.path=i,t.success=u.getModel(),await u.save();else{try{if(b&&!w.isSymbolicLink())await l.move(u.path,i);else{if(!O||!w.isSymbolicLink())throw"Invalid scenarios to move files.";await l.ensureSymlink(c.relative(c.dirname(i),m),i),await l.unlink(u.path)}}catch(e){throw[x("27",{name:"File movement error",attached:e})]}u.parent=e.id,u.path=i,await u.save(),t.success=u.getModel()}}return t})),I.get("/api/:dataFileId/untrack",w(async(e,t)=>{const a={errors:[]},s=e.params.dataFileId,r=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(s))throw[x("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${s}. please check if this is the right ID.`})];const d=await y(r,"bdp",2),c=await n.findOne({_id:s}).populate("owner");if(!c)throw[x("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${s}. please check if this is the right ID.`})];const p=await o.findOne({_id:c.project}),u=p.getListeners(),h=p.getPrivilege(d);if(!h.canEditFile)throw[x("38",{details:"Sorry, you do not have privileges to untrack files in this project."})];if(h.isRunner&&(!c.owner||c.owner.id!==r))throw[x("38",{details:"Sorry, you can only untrack your own DataFiles. This DataFile is not created by you."})];if(!c.parent)throw[x("608",{name:"Failed to untrack the file",details:"You cannot untrack a file that belongs to no folders."})];if(!await n.findOne({_id:c.parent,project:c.project}).populate("owner"))throw[x("608",{name:"Failed to untrack the file",details:"We encountered an error that the file to be untracked belongs to a folder that does not exist in the database.Please contact admin. You might want to delete the datafile directly."})];if(c.readOnly=!0,c.status=3,await c.save(),a.success=c.getModel(),O(u,"dataChange",{type:"update",target:"DataFile",data:c.getModel()}),t.json(a),"Folder"===c.format){const e=await n.find({parent:c.id}).populate("owner");for(let t=0;t<e.length;t++)e[t].parent=c.parent,await e[t].save(),O(u,"dataChange",{type:"update",target:"DataFile",data:e[t].getModel()})}c.realPath&&await l.remove(c.path);const g=c.getModel();await c.remove(),g.owner=d.getSlimModel(),p.dataFiles=p.dataFiles.filter(e=>e!==c.id),await p.save(),O(p.getListeners(),"dataChange",{type:"remove",target:"DataFile",data:g})})),I.post("/api/:dataFileId/track",w(async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id,r=e.body.path;if(!i.Types.ObjectId.isValid(a))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const o=await y(s,"bdp",2);let d=await n.findOne({_id:a}).populate("owner").populate({path:"project",populate:{path:"owner managers runners viewers dataFiles results package"}});if(!d)throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if("Folder"!==d.format)throw[x("607",{details:"Please track files in a folder."})];d.parent&&(d=await n.findOne({_id:d.parent}).populate("owner").populate({path:"project",populate:{path:"owner managers runners viewers dataFiles results package"}}));const u=d.project;if(!u)throw[x("608",{name:"Failed to untrack the file",details:"This data file does not belong to any project. Please check if the integrity of the data file."})];const h=u.getPrivilege(o);if(!h.canEditFile)throw[x("38",{details:"Sorry, you do not have privileges to track files in this project."})];if(h.isRunner&&(!d.owner||d.owner.id!==s))throw[x("38",{details:"Sorry, you can only track your own DataFiles. This DataFile is not created by you."})];let g=[];Array.isArray(u.packages)&&u.packages.length>0&&(g=[].concat.apply([],u.packages.map(e=>e.formatMapping)).filter(e=>null!=e));if(await n.findOne({realPath:r,parent:d.id,project:u.id}).populate("owner"))throw[x("607",{details:"The path is already being tracked in this project."})];const f=await l.realpath(r);let m;try{m=await l.stat(r)}catch(e){throw[x("607",{details:"The file/folder path you are going to track does not exist or the system can not see the file/folder",attached:e.stacks})]}const w=await l.realpath(d.path);let k;try{k=await l.stat(w)}catch(e){throw[x("607",{details:"The folder has some errors",attached:e})]}if(!k.isDirectory())throw[x("607",{details:"The files to be tracked should be in a folder.Please check again since you are trying to track file(s) in a non-folder."})];if(!p(f,w))throw[x("607",{details:`The tracked file does not in the folder, ${d.getName()}.`})];const v=c.basename(f);let b=v.split(".").slice(-1)[0],I=["file"];m.isDirectory()?(b="Folder",I=["Folder"]):(I=g.filter(e=>v.match(new RegExp(".*("+e.ext.replace(/\./g,"\\.").replace(/\-/g,"\\-").replace(/\_/g,"\\_")+")$"))).map(e=>e.tags)[0],I&&I.length||(I=[]));const F=c.join(S,u.id),j=c.join(S,"shared"),T=new n({name:c.parse(r).name,desc:"",format:b,owner:s,realPath:"",path:"",parent:d.id,project:u.id,tags:I,status:1});let D="";p(f,F)?D=f:p(f,j)?(D="Folder"===b?c.join(S,u.id,T.id):c.join(S,u.id,T.id+"."+b),T.realPath=f,await l.ensureSymlink(c.relative(c.dirname(D),f),D)):(D="Folder"===b?c.resolve(S,u.id,T.id):c.resolve(S,u.id,T.id+"."+b),T.realPath=f,await l.ensureSymlink(f,D)),T.path=D,u.dataFiles.push(T.id),await T.save(),await u.save();const P=T.getModel(h);return P.owner=o.getSlimModel(),P.project=u.id,O(u.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:P}),t.success=P,t}));if(I.post("/api/import/gdrive/file",w(async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,p=e.body.fileID,u=e.body.name,h=e.body.dataFileName||null,g=e.body.desc,f=e.body.authToken,m=e.body.mimeType,w=e.body.projectID,b=e.body.tags||[],I=e.body.prefix||"",j=e.body.suffix||"",T=e.body.keepFileName,D=e.body.folder||null;if(!i.Types.ObjectId.isValid(w))throw[x("19",{details:`We can not find the project id: ${w}. please check if this is the right ID.`})];if(D&&!i.Types.ObjectId.isValid(D))throw[x("19",{details:"The parent folder id is invalid."})];const P=await y(s,"bdp",2),A=await o.findOne({_id:w}).populate("packages");if(!A)throw[x("19",{details:`We can not find the project id: ${w}. please check if this is the right ID.`})];if(!A.getPrivilege(P).canAddFile)throw[x("38",{details:"Sorry, you do not have privileges to import files."})];let $;if(D&&($=await n.findOne({_id:D}),!$||"Folder"!==$.format))throw[x("19",{details:"Sorry, we couldn't find the parent folder of the id: "+D})];const _=[...new Set([].concat.apply([],A.packages.map(e=>e.allowedFormats)))],M=function(e,t){const a=F[e];if(a){for(let e=0;e<t.length;e++)for(let s=0;s<a.length;s++)if(d.extensions[a[s]])for(let i=0;i<d.extensions[a[s]].length;i++){const r=d.extensions[a[s]][i];if(t[e]===r||t.indexOf("*")>=0)return{ext:r,mimeType:a[s]}}}else;}(m,_),C=function(e,t){const a=d.extensions[e];for(let e=0;e<a.length;e++)if(t.indexOf("*")>=0||t.indexOf(a[e])>=0)return a[e]}(m,_);if(!M&&!C)throw[x("unknown",{name:"Type not supported",details:`The mime file type, ${m}, is currently not supported`})];const E=M?`/drive/v3/files/${p}/export?alt=media&mimeType=${M.mimeType}`:`/drive/v3/files/${p}?alt=media`,N=M?M.mimeType:m,R=M?M.ext:C;let L=[];if(Array.isArray(A.packages)&&A.packages.length>0){const e=[].concat.apply([],A.packages.map(e=>e.formatMapping)).filter(e=>null!=e);e&&e.length>0&&(L=e.filter(e=>e.ext===R).map(e=>e.tags)[0]||[])}Array.isArray(b)&&(L.push.apply(L,b.map(e=>e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim())),L=L.filter(e=>null!=e||""!==e));const q=new n({name:h?h.slice(0,80):u.slice(0,80),prefix:I.slice(0,36),suffix:j.slice(0,36),desc:g.slice(0,300),status:0,format:R,owner:s,project:w,tags:[...new Set(L)].map(e=>e.toString()),readOnly:!1});let V=c.resolve(`${S}/${w}/${q.id}.${R}`);$&&(q.parent=$.id,V=T?c.resolve($.path,`${u}.${R}`):c.resolve($.path,`${q.id}.${R}`)),q.path=V;const W=await q.save();A.dataFiles.push(q.id),await A.save();const z=W.getModel();a.success=z;const B=A.getListeners();O(B,"dataChange",{type:"insert",target:"DataFile",data:z}),t.json(a);try{await function(e,t,a,s,i){return new Promise((o,n)=>{const d={hostname:"www.googleapis.com",port:443,path:`/drive/v3/files/${e}/export?alt=media&mimeType=text/csv`,method:"GET",path:s,headers:{Authorization:"Bearer "+a}};r.request(d,e=>{const a=e.headers["content-type"]===i;if(a){const a=l.createWriteStream(t);e.pipe(a),e.on("end",(function(){a.end(),o()}))}else{let t="";e.on("data",e=>t+=e),e.on("end",(function(){let s;a||(-1!==e.headers["content-type"].indexOf("application/json")?(s=JSON.parse(t),s.error?n([x("unknown",{name:s.error.message,attached:s.error})]):n([x("unknown",{attached:s})])):n([x("unknown",{attached:t})]))}))}}).end()})}(p,V,f,E,N),q.status=1,q.readOnly=!1,await q.save();const e=q.getModel();e.owner=P.getSlimModel(),O(B,"dataChange",{type:"update",target:"DataFile",data:e})}catch(t){k(a,t),v(s,a.errors,e.route.path);for(const e of a.errors)O(B,"message",e)}return!1})),a.GoogleAuth&&a.GoogleAuth.Google_clientID&&a.GoogleAuth.Google_clientSecret){let e="";e=0===a.serverConfig.site_domain.indexOf("http://")&&80===a.serverConfig.port||0===a.serverConfig.site_domain.indexOf("https://")&&443===a.serverConfig.port?a.serverConfig.site_domain+"/datafile/export/gdrive/callback":`${a.serverConfig.site_domain}:${a.serverConfig.port}/datafile/export/gdrive/callback`;const s=new g(a.GoogleAuth.Google_clientID,a.GoogleAuth.Google_clientSecret,e),r=function(e){return new Promise((t,a)=>{s.getToken(e,(function(e,s){return e?a(e):t(s)}))})};I.get("/:dataFileId/export/gdrive",w(async(e,t)=>{if(!e.isAuthenticated())throw[x("a011")];const a=e.session.passport.user.id;await y(a,"bdp",2);const i={dataFileID:e.params.dataFileId},r=e.query.share;r&&(i.share=r);const o=s.generateAuthUrl({state:JSON.stringify(i),scope:["https://www.googleapis.com/auth/drive.file"]});return t.redirect(o),!1})),I.get("/export/gdrive/callback",w(async(e,a)=>{const d=e.query.code,c=JSON.parse(e.query.state),p=c.dataFileID,h=c.share;if(!e.isAuthenticated())throw[x("a011")];if(!i.Types.ObjectId.isValid(p))throw[x("27",{details:`We can not find the data file id: ${p}. please check if this is the right ID.`})];const g=e.session.passport.user.id,m=await y(g,"bdp",2),w=await n.findOne({_id:p}).populate("owner");if(!w)throw[x("27",{details:`We can not find the data file id: ${p}. please check if this is the right ID.`})];const k=await o.findOne({_id:w.project}),v=k.getPrivilege(m),b=k.getListeners();if(!v.canEditFile)throw[x("38",{details:"Sorry, but you do not have privileges to edit files."})];const S=await r(d);s.setCredentials(S);const I=u.drive({version:"v3",auth:s}),F=w.path;let j="",T="";return"csv"===w.format&&(j="text/csv",T="application/vnd.google-apps.spreadsheet"),a.write("<script> window.open('', '_self', ''); window.close(); <\/script>"),t.to(g).emit("message",x("609",{name:"File exporting",details:`The datafile, <b>${w.getName()}</b>, is now exporting to GoogleDrive. Please wait.`})),a.end(),j&&T?I.files.create({resource:{name:w.getName(),mimeType:T},media:{mimeType:j,body:l.createReadStream(F)}},(e,a)=>{if(e)t.to(g).emit("message",x("600",{details:`The datafile, ${w.getName()}, failed to export to Google Drive. Please try again.`,attached:e}));else if(O(b,"message",x("601",{details:`The datafile, ${w.getName()}, has exported to your Google Drive.`})),h&&f.test(h)){const e=a.id;I.permissions.create({resource:{type:"user",role:"writer",emailAddress:h},fileId:e,fields:"id"},(function(e){e?t.to(g).emit("message",x("602",{details:`The datafile, ${w.getName()}, has exported to your Google Drive.`,attached:e})):O(b,"message",x("603",{details:`The datafile, ${w.getName()}, has been successfully shared to ${h}`}))}))}else h&&t.to(g).emit("message",x("602",{details:`Please check the email format (${h}) you are going to share.`}))}):t.to(g).emit("message",x("600",{details:`The datafile, ${w.getName()}, failed to export to Google Drive. This file type is currently not supported to export.`})),!1}))}return I}},function(e,t){e.exports=require("mime-types")},function(e,t){e.exports=require("googleapis")},function(e,t){e.exports=require("sanitize-filename")},function(e,t,a){const s=a(3),i=a(0),r=a(1),o=a(2),n=a(16),d=a(11),c=a(78),l=a(79),p=a(14),u=a(9),h=a(4),g=a(5),f=a(6),m=a(10),w=a(27),y=a(7),k=a(29),v=e=>e.isDirectory()?"directory":e.isFile()?"file":e.isSymbolicLink()?"shortcut":"other";e.exports=function(e){const t=e.io,a=e.chiConfig,b=e.helpers,S=b.chiAsyncWrap,x=b.getCode,O=b.getAuthAsync,I=b.pkgNameFormatter,F=a.system.packageFolder,j=a.system.docker_path,T=b.socketBroadcast,D=b.playbookHandler,P=b.getTaskByMap,A=b.exportPackageDB,$={},_={"under development":0,experimenting:1,stable:2,deprecated:3},M=w.diskStorage({destination:function(e,t,s){s(null,r.resolve(a.system.uploadFolder))},filename:function(e,t,a){a(null,"Data-"+Date.now())}}),C=function(e,t,s){s=s||a.system.fileLimits;const i=w({storage:M,limits:{fileSize:s}}).array("file");return new Promise((a,s)=>i(e,t,e=>e?s(e):a()))},E=async(e,t)=>{let a;return new Promise((s,i)=>{const r=e=>{const a=!t||t&&e.headers["content-type"]===t;let r="";e.on("data",e=>{r+=e}),e.on("end",()=>a?s(r):i(r))};e.match(/^https\:\/\//)?a=d.get(e,r):e.match(/^http\:\/\//)&&(a=n.get(e,r)),a.on("error",e=>i(e)),a.end()})},N=async function(e){const t=`https://spreadsheets.google.com/feeds/list/${e=e||"1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g"}/od6/public/values?alt=json`;try{const a=await E(t,"application/json; charset=UTF-8");return JSON.parse(a).feed.entry.filter(e=>e.gsx$name.$t.split("-").length>=2).map(t=>({category:t.gsx$category.$t,name:I(t.gsx$name.$t),author:t.gsx$author.$t,email:t.gsx$email.$t,fromPath:t.gsx$path.$t,desc:t.gsx$description.$t,link:t.gsx$link.$t,status:_[t.gsx$status.$t],sheetID:e}))}catch(e){throw[x("706",{attached:{response:e}})]}},R=async e=>{const t=`https://spreadsheets.google.com/feeds/worksheets/${e}/public/values?alt=json`;let a;try{a=await E(t,"application/json; charset=UTF-8")}catch(e){throw[x("706",{attached:{response:JSON.stringify(e)}})]}try{const e=JSON.parse(a);if(e&&e.feed&&e.feed.title)return e.feed.title.$t}catch(e){return"No name of this package list"}},L=async(e,t)=>{e=e||"1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g";try{const a=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/package-list?key=${t}`,s=await E(a,"application/json; charset=UTF-8"),i=JSON.parse(s),r=[],o=i.values[0];for(let t=1;t<i.values.length;t++){const a={};i.values[t].forEach((e,t)=>a[o[t]]=e),a.Name.split("-").length>=2&&r.push({category:a.Category,name:I(a.gsx$name.$t),author:a.Author,email:a.Email,status:_[a.Status],fromPath:a.Path,desc:a.Description,link:a.Link,scope:[],allowedFormats:[],formatMapping:[],sheetID:e})}return r}catch(e){throw[x("706",{attached:e})]}},q=async(e,t)=>{const a=`https://sheets.googleapis.com/v4/spreadsheets/${e}?fields=properties.title&key=${t}`;try{const e=await E(a,"application/json; charset=UTF-8"),t=JSON.parse(e);return t&&t.properties&&t.properties.title&&t.properties.title||"No name of this package list"}catch(e){throw[x("706",{attached:e})]}},V=s.Router();return V.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(x("a011")),t.json(s);a()}),V.get("/api/package/list",S(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=await O(a,"bdp",2),i=s.auths.bdp;let r={};if(i<2)throw[x("a017")];i<3?r={status:{$in:[2]}}:i<7&&(r={status:{$in:[1,2,3]}});const o=await m.find(r).populate("owner managers runners viewers"),n=[];for(let e=0;e<o.length;e++){const t=o[e],a=t.getPrivilege(s);n.push(t.getModel(a))}return t.success=n,t})),V.post("/api/package/save",S(async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,n=await O(s,"bdp",7),d=e.body.package,c=I(d.name+"-"+d.version),l=d.sheetID||"internal",p=d.sheetName||"Internal Package List",u=r.join(F,l,c),h=d.allowedFormats;if(Array.isArray(h)?h.indexOf("*")>=0?d.allowedFormats=["*"]:d.allowedFormats=h.map(e=>e.replace(/[^a-zA-Z0-9\.\-\_]/g,"")).filter(e=>e):d.allowedFormats=[],"internal"!==l){const e=await m.find({sheetID:l});if(0===e.length)throw[x("700",{details:"The sheet ID does not exist."})];if(e.filter(e=>e.sheetName!==p).length>0)throw[x("700",{details:"The sheetName and the sheet ID are inconsistent."})]}else if("Internal Package List"!==p)throw[x("700",{details:"The internal package can only have the name: Internal Package List"})];let g,f,w;if(d.id){if(!i.Types.ObjectId.isValid(d.id))throw[x("700")];const e=await m.findOne({_id:d.id});if(!e.getPrivilege(n).canEdit)throw[x("700",{details:"Sorry, you do not have privileges to save this package."})];let t=e.path;if(!await o.pathExists(e.path))throw[x("700",{details:`The original package folder path ${e.path} is not existed.`})];if(e.sheetID!==d.sheetID||e.name!==c){if(await o.pathExists(u))throw[x("702",{details:`Sorry, this package name ${c} has been used. Please try another.`})];try{await o.move(e.path,u)}catch(e){throw[x("701",{attached:e})]}t=u}g=await m.findByIdAndUpdate(d.id,{name:c,desc:d.desc,scope:d.scope,author:d.author,img:d.img,thumbnail:d.thumbnail,email:d.email,status:d.status,allowedFormats:d.allowedFormats,path:t,sheetID:d.sheetID,sheetName:d.sheetName,formatMapping:d.formatMapping,public:!!d.public},{new:!0}).populate("owner managers viewers runners"),w="update",f=g.getModel(g.getPrivilege(n)),a.success=f}else{if(n.auths.bdp<7)throw[x("700",{details:"Sorry, you do not have privileges to create this package."})];if(await o.pathExists(u))throw[x("702",{details:`Sorry, this package name ${c} has been used. Please try another.`})];try{await o.ensureDir(u),await o.ensureDir(u+"/configs"),await o.ensureDir(u+"/scripts"),await o.ensureDir(u+"/tasks"),await o.ensureDir(u+"/db"),await o.ensureDir(u+"/client"),await o.ensureFile(u+"/task-index.yaml"),await o.outputFile(u+"/task-index.yaml","tasks:\n"),await o.outputFile(u+"/configs/package-config.json",'{"default":{"adapter":"docker","concurrency":1,"cpus":1,"memory":"4GB"}}')}catch(e){throw[x("701",{attached:e})]}g=new m({name:c,desc:d.desc,author:d.author,email:d.email,img:d.img,thumbnail:d.thumbnail,path:u,scope:d.scope,status:d.status,allowedFormats:Array.isArray(d.allowedFormats)?d.allowedFormats:["*"],formatMapping:Array.isArray(d.formatMapping)?d.formatMapping:[],sheetID:l,sheetName:p,owner:n.id,runners:[],managers:[],viewers:[]}),await g.save(),g=await m.findOne({_id:g.id}).populate("owner"),w="insert",f=g.getModel(g.getPrivilege(n)),a.success=f}t.json(a),T(n.id,"dataChange",{type:w,target:"Package",data:f}),["managers","viewers","runners"].forEach(e=>{g[e].forEach(e=>{T(e.id,"dataChange",{type:w,target:"Package",data:g.getModel(g.getPrivilege(e))})})}),A(g)})),V.delete("/api/package/:packageId",S(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const r=await O(a,"bdp",8),n=await m.findOne({_id:s});if(!n)throw[x("700",{details:"This package may be already deleted."})];const d=n.getPrivilege(r);if(!d.canDelete)throw[x("700",{details:"Sorry, you do NOT have privileges to delete this package."})];const c=n.getListeners([r.id]);return o.remove(n.path).catch(e=>{console.log(e)}),await u.remove({package:s}),await n.remove(),t.success=n.getModel(d),T(c,"dataChange",{type:"delete",target:"Package",data:n.getModel()}),t})),V.get("/api/package/:packageId/save",S(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const r=await O(a,"bdp",7),o=await m.findOne({_id:s});if(!o)throw[x("700",{details:"This package does not exist."})];if(!o.getPrivilege(r).canView)throw[x("700",{details:"Sorry, you can not export this package."})];await A(o),t.header("Content-Type","application/zip"),t.header("Content-Disposition",`attachment; filename="${o.name}.zip"`);const n=k("zip",{zlib:{level:1}});return n.pipe(t),n.directory(o.path+"/","bdp-package"),n.finalize(),!1})),V.get("/api/package/:packageId/getRuntime",S(async e=>{const t=e.session.passport.user.id,a=e.params.packageId;if(!i.Types.ObjectId.isValid(a))throw[x("700")];const s=await O(t,"bdp",7),n=await m.findOne({_id:a});if(!n)throw[x("700",{details:"This package does not exist"})];if(!n.getPrivilege(s).canView)throw[x("700",{details:"Sorry, you do not have privileges to view the runtime configurations."})];const d=n.path,c=r.resolve(d,"configs","package-config.json");if(!await o.pathExists(c))return{errors:[],success:{}};const l=await o.readJson(c,{throws:!1});return l&&l.default?{errors:[],success:l.default}:{errors:[],success:{}}})),V.post("/api/package/:packageId/saveRuntime",S(async e=>{const t=e.session.passport.user.id,a=e.params.packageId,s=!!e.body.reset,n=e.body.runtime||{adapter:"docker",cpus:1,memory:"4gb",concurrency:1,dockerPath:"docker"};if(!i.Types.ObjectId.isValid(a))throw[x("700")];const d=await O(t,"bdp",7),c=await m.findOne({_id:a});if(!c)throw[x("700",{details:"This package does not exist"})];if(!c.getPrivilege(d).canEdit)throw[x("700",{details:"Sorry, you do not have privileges to edit the runtime configurations."})];const l=c.path,p=r.resolve(l,"configs","package-config.json");try{await o.ensureFile(p)}catch(e){throw[x("905",{details:`The runtime config cannot be accessed, please check if the path (${p}) is available.`})]}let u=await o.readJson(p,{throws:!1});u&&!s||(u={});let h=isNaN(parseFloat(n.cpus))?1:parseFloat(n.cpus);h=h>0?h:1;let g=n._memory||"4gb";g=g.toLowerCase().match(/^(\d+[mg])/),g=g?g[1]+"b":"4gb";const f=isNaN(parseInt(n.concurrency))?1:parseInt(n.concurrency),w=isNaN(parseInt(n.updateInterval))?2e4:parseInt(n.updateInterval),y=isNaN(parseInt(n.nodes))?1:parseInt(n.nodes),k=n.dockerPath||j;if(u.default={adapter:n.adapter,batch:!!n.batch,updateInterval:w,cpus:h,mem:g,concurrency:f,nodes:y,dockerPath:k,debug:n.debug},u.default=Object.assign({},u.default,n.overrides),9!==d.auths.bdp&&"local"===u.default.adapter)throw[x("905",{details:"Only the admin can specify the local adapter."})];return await o.writeJSON(p,u),{errors:[],success:u.default}})),V.post("/api/package/:packageID/setMembers",S(async e=>{const t=e.session.passport.user.id,a=e.params.packageID,s=e.body.changes,r=e.body.scope;if(!i.Types.ObjectId.isValid(a))throw[x("19",{details:`The package ID ${a} is invalid, please check if this is the right ID.`})];if(!s||0===s.length||!r||"runners"!==r&&"managers"!==r&&"viewers"!==r&&"owner"!==r)throw[x("402",{type:"warning",details:"No changing members. Please check if you input all correct member info."})];const o=await O(t,"bdp",8),n=await m.findOne({_id:a});if(!n)throw[x("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const d=n.getPrivilege(o);if(!d.canSetMember||("owner"===r||"managers"===r)&&d.isManager)throw[x("38",{details:"Sorry, you do not have privileges to set members of this package."})];const c=s.map(e=>e.userID&&i.Types.ObjectId.isValid(e.userID)?e.userID:void 0).filter(e=>void 0!==e);if(0===c.length)throw[x("402",{type:"warning",details:"No changes."})];const l=n[r],p=await f.find({_id:{$in:c}});if(0===p.length)throw[x("402",{type:"warning",details:"No changes."})];for(let e=0;e<p.length;e++){const t=p[e];for(let e=0;e<s.length;e++){const a=s[e];if("owner"===r&&t.id===a.userID){"add"===a.action?n.owner=t.id:"remove"===a.action&&(n.owner=void 0);break}if(t.id===a.userID){if("add"===a.action&&l.indexOf(t.id)<0){n[r].push(t.id);break}if("remove"===a.action){const e=l.indexOf(t.id);e>=0&&n[r].splice(e,1)}}}}await n.save();const u=await m.findOne({_id:a}).populate("owner managers runners viewers");if(!u)throw[x("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const h=u.getPrivilege(o),g=u.getModel(h);if(T(o.id,"dataChange",{type:"update",target:"Package",data:u.getModel(h)}),["managers","viewers","runners"].forEach(e=>{u[e].forEach(e=>{T(e.id,"dataChange",{type:"update",target:"Package",data:u.getModel(u.getPrivilege(e))})})}),!h.canView)throw[x("38",{details:"Sorry, you do not have privileges to view this project."})];return{errors:[],success:g}})),V.get("/api/package/getList",S(async e=>{let t=e.query.s;const a=e.query.apiKey;let s,i=[];return t&&a?(i=await L(t,a),s=await q(t,a)):(t=t||"1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g",i=await N(t),s=await R(t)),{errors:[],success:{pkgList:i,sheetName:s}}})),V.post("/api/package/install",S(async e=>{const a={errors:[]},s=e.session.passport.user.id,i=I(e.body.packageName);let n=e.body.installAs;n&&(n=I(n));let d=e.body.s;d||(d="1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g");const c=e.body.apiKey,l=await O(s,"bdp",8),p=d&&c?await L(d,c):await N(d),u=d&&c?await q(d,c):await R(d);let h;for(let e=0;e<p.length;e++)if(p[e].name===i){h=p[e];break}if(!h)throw[x("707",{details:`We cannot find the package (name: ${i}). Please check the package name.`})];const g=await m.findOne({name:i,sheetID:d});if(g&&!n){const e=g.getPrivilege(l);if(!e.canEdit)throw[x("707",{details:`The ${i} in the package list (id: ${d}) is already existed and you do NOT have privilege to edit it. You may want to change a name and reinstall it.`})];g.setupSteps<1&&(g.setupSteps=1),g.desc=h.desc,g.author=h.author,g.email=h.email,g.setupSteps=1,g.sheetName=u,await g.save();const t=await m.findOne({_id:g.id}).populate("owner managers runners viewers");return a.success=t.getDetailModel(e),a}if(n){const e=await m.findOne({name:n,sheetID:d});if(e){const t=e.getPrivilege(l);if(!t.canEdit)throw[x("707",{details:`The ${n} in the package list (id: ${d}) is already existed and you do NOT have privilege to edit it. You may want to change a name and reinstall it.`})];e.setupSteps<1&&(e.setupSteps=1),e.desc=h.desc,e.author=h.author,e.email=h.email,e.setupSteps=1,e.sheetName=u,await e.save();const s=await m.findOne({_id:e.id}).populate("owner managers runners viewers");return a.success=s.getDetailModel(t),a}}a.success=void 0,d||c||(d="internal");const f=r.join(F,d,n||I(h.name));try{await o.ensureDir(f)}catch(e){throw[x("701",{attached:e})]}const w=new m({name:n||I(h.name),desc:h.desc,author:h.author,email:h.email,path:f,fromPath:h.fromPath,scope:h.scope,status:h.status,allowedFormats:h.allowedFormats,formatMapping:h.formatMapping,setupSteps:1,sheetID:d,sheetName:u,owner:l.id,runners:[],managers:[],viewers:[]});await w.save();const y=await m.findOne({_id:w.id}).populate("owner"),k=y.getPrivilege(l);return a.success=y.getDetailModel(k),t.to(s).emit("dataChange",{type:"insert",target:"Package",data:a.success}),a})),V.post("/api/package/upload",S(async(e,a)=>{const s={errors:[]},i=e.session.passport.user.id,n=e.query.listID||"internal",d=await O(i,"bdp",8),c=await m.find({sheetID:n});if(c.length<1&&"internal"!==n)throw[x("701",{details:"Invalid package sheet ID"})];try{await C(e,a,5e8)}catch(t){throw e.files.map(async e=>{await o.unlink(e.path)}),[x("13",{code:13,name:"File upload failed",details:t.toString(),attached:t})]}const h="internal"===n?"Internal Package List":c[0].sheetName,g=I(e.query.pkgName||r.basename(e.files[0].originalname,".zip"));if(await m.findOne({name:g,sheetID:n}))throw e.files.map(async e=>{await o.unlink(e.path)}),[x("702")];const f=r.join(F,n,g);if(await o.pathExists(f))throw[x("701",{details:"The package path already exists."})];const w={stdOut:"",stdErr:""};try{await o.createReadStream(e.files[0].path).pipe(l.Parse()).on("entry",e=>{const t=r.relative("bdp-package",e.path);if("Directory"===e.type)t?o.ensureDir(r.join(f,t),a=>{a&&(w.stdErr+=JSON.stringify(a)+"\n"),w.stdOut+=t+"\n",e.autodrain()}):(w.stdOut+="Extracting files ...\n",e.autodrain());else if("File"===e.type){w.stdOut+=t+"\n";const a=r.join(f,t);o.ensureFile(a).then(()=>e.pipe(o.createWriteStream(a)))}}).promise()}catch(t){throw e.files.map(async e=>{await o.unlink(e.path)}),await o.remove(f),[x("701",{details:"We encountered errors during package file compression: "+t.toString()})]}e.files.map(async e=>{await o.unlink(e.path)});const y=r.join(f,"db","bdp-package.json");if(!await o.pathExists(y))throw await o.remove(f),[x("701",{details:"Your package zip file does not contain a '/bdp-package/db/bdp-package.json' file."})];const k=await o.readJSON(y,{throws:!1});if(!k||!k.package||!k.tasks)throw await o.remove(f),[x("701",{details:"Your package definition in '/bdp-package/db/bdp-package.json' has errors."})];const v=new m({name:g,desc:k.package.desc,author:k.package.author,email:k.package.email,path:f,fromPath:"",scope:k.package.scope,status:0,allowedFormats:k.package.allowedFormats,formatMapping:k.package.formatMapping,setupSteps:2,sheetID:n,sheetName:h,stdOut:w.stdOut,stdErr:w.stdErr,owner:d.id,runners:[],viewers:[],managers:[]});v.setPages(k.package.pages),await v.save();const b=k.tasks.filter(e=>"workflow"!==e.type),S=k.tasks.filter(e=>"workflow"===e.type),j={},T=[];for(let e=0;e<b.length;e++){const t=b[e],a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:v.id,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version,proxy:t.proxy||null});j[t._id]=a.id,T.push(a.save())}for(let e=0;e<S.length;e++){const t=S[e];for(let e=0;e<t.mapper.length;e++){const a=t.mapper[e];for(let s=0;s<a.length;s++){const i=a[s];t.mapper[e][s].id=j[i.id]}}const a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:v,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version});T.push(a.save())}for(const e of T)await e;v.setupSteps=3,await v.save();const D=await m.findOne({_id:v}).populate("owner"),P=D.getPrivilege(d),A=D.getDetailModel(P);return t.to(i).emit("dataChange",{type:"insert",target:"Package",data:A}),s.success=A,s})),V.get("/api/package/:packageId/download",S(async(e,a)=>{const s={errors:[]},n=e.session.passport.user.id,d=e.params.packageId,p=e.query.restart;if(!i.Types.ObjectId.isValid(d))throw[x("700")];const u=await O(n,"bdp",8),h=await m.findOne({_id:d});if(!h)throw[x("707",{details:`We cannot find the package (id: ${d}). Please check the package id.`})];const g=h.getPrivilege(u);if(!g.canEdit)throw[x("707",{details:"Sorry, you do not have privileges to install this package."})];h.setupSteps=1;const f=await h.save();s.success=f.getDetailModel(g),s.success.stdOut="Recieving stdandard outputs ...\n",s.success.stdErr="Recieving stdandard errors ...\n",s.success.error={},a.json(s),await o.emptyDir(h.path),$[f.id]&&!p||($[h.id]={stdOut:"",stdErr:"",error:{},process:void 0}),$[h.id].stdOut+="Preparing download zip file\n",t.to(n).emit("packageOut",{type:"stdOut",target:h.id,data:$[h.id].stdOut});try{await c(h.fromPath).pipe(l.Parse()).on("entry",e=>{const a=r.relative("bdp-package",e.path);"Directory"===e.type?a?o.ensureDir(r.join(h.path,a),s=>{s&&($[h.id].stdErr+=JSON.stringify(s)+"\n",t.to(n).emit("packageOut",{type:"stdErr",target:h.id,data:$[h.id].stdErr})),$[h.id].stdOut+=a+"\n",t.to(n).emit("packageOut",{type:"stdOut",target:h.id,data:$[h.id].stdOut}),e.autodrain()}):($[h.id].stdOut+="Extracting files ...\n",t.to(n).emit("packageOut",{type:"stdErr",target:h.id,data:$[h.id].stdOut}),e.autodrain()):"File"===e.type&&($[h.id].stdOut+=a+"\n",t.to(n).emit("packageOut",{type:"stdOut",target:h.id,data:$[h.id].stdOut}),e.pipe(o.createWriteStream(r.join(h.path,a))))}).promise();const e=await m.findOne({_id:h.id});if(e){e.stdOut=$[e.id].stdOut,e.stdErr=$[e.id].stdErr,e.error={},e.setupSteps=2;const a=await e.save();t.to(n).emit("packageOut",{type:"stdOut",target:h.id,data:e.stdOut}),t.to(n).emit("packageOut",{type:"stdErr",target:h.id,data:e.stdErr}),t.to(n).emit("dataChange",{type:"update",target:"Package",data:a.getDetailModel(g)})}delete $[e.id]}catch(e){(async()=>{const a=await m.findOne({_id:h.id});a.stdOut=$[a.id].stdOut,a.stdErr=$[a.id].stdErr+e.stack,a.error={},a.setupSteps=1,delete $[a.id];const s=await a.save();t.to(n).emit("packageOut",{type:"stdOut",target:a.id,data:a.stdOut}),t.to(n).emit("packageOut",{type:"stdErr",target:a.id,data:a.stdErr}),t.to(n).emit("dataChange",{type:"update",target:"Package",data:s.getDetailModel(g)})})().then(()=>{t.to(n).emit("message",x("701",{name:"Package installation failed",details:`We failed to install the package, <b>${h.name}</b>.`,attached:e}))})}return!1})),V.get("/api/package/:packageId/importTasks",S(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const n=await O(a,"bdp",8),d=await m.findOne({_id:s});if(!d)throw[x("707",{details:`We cannot find the package (id: ${s}). Please check the package id.`})];const c=d.getPrivilege(n);if(!c.canEdit)throw[x("707",{details:"Sorry, you do not have privileges to import tasks to this package."})];const l=await o.readJSON(r.resolve(d.path,"db","bdp-package.json"));if(!l||!l.package||!l.tasks)throw[x("s001",{name:"Wrong backup file"})];d.setPages(l.package.pages);const h=d;h.scope=l.package.scope||[],h.formatMapping=l.package.formatMapping||[],h.allowedFormats=l.package.allowedFormats||[];const g=await m.findOneAndUpdate({_id:s},{name:d.name,desc:d.desc,author:d.author,email:d.email,container:d.container,scope:h.scope,status:d.status,link:d.link,formatMapping:h.formatMapping,allowedFormats:h.allowedFormats,pages:d.pages},{new:!0}).populate("owner managers runners viewers");await u.remove({package:s});const f=l.tasks.filter(e=>"workflow"!==e.type),w=l.tasks.filter(e=>"workflow"===e.type),y={},k=[];for(let e=0;e<f.length;e++){const t=f[e],a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:s,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version,proxy:t.proxy||null});y[t._id]=a.id,k.push(a.save())}for(let e=0;e<w.length;e++){const t=w[e];for(let e=0;e<t.mapper.length;e++){const a=t.mapper[e];for(let s=0;s<a.length;s++){const i=a[s];t.mapper[e][s].id=y[i.id]}}const a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:s,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version});k.push(a.save())}for(const e of k)await e;return g.setupSteps=3,await g.save(),t.success=g.getDetailModel(c),t})),V.get("/api/package/:packageId",S(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const r=await O(a,"bdp",2),o=await m.findOne({_id:s}).populate("owner managers viewers runners");if(o){const e=o.getPrivilege(r);if(!e.canView)throw[x("700",{details:"Sorry, you do not have privileges to view this task."})];r.auths&&r.auths.bdp>=8?(t.success=o.getDetailModel(e),$[o.id]&&(t.success.stdOut=$[o.id].stdOut,t.success.stdErr=$[o.id].stdErr)):t.success=o.getModel(e)}else t.success={};return t})),V.get("/api/package/:packageId/file/list",S(async e=>{const t={errors:[],success:[]},a=e.session.passport.user.id,s=e.params.packageId;let n=e.query.path||"";if(n=n.replace(/\\\\/g,"/").replace("\\","/"),!i.Types.ObjectId.isValid(s))throw[x("700")];const d=await O(a,"bdp",7),c=await m.findOne({_id:s});if(!c)throw[x("700",{details:"This package does not exist"})];if(!c.getPrivilege(d).canView)throw[x("700",{details:"Sorry, you do not have privilege to view the package files."})];const l=c.path,p=n?r.join(l,n):l;if(!y(p,l))return t;const u=await o.readdir(p),h=u.map(e=>o.stat(r.resolve(p,e))),g=[];for(const e of h){const t=await e;g.push(t)}return t.success=g.map((e,t)=>{let a="file";a=e.isDirectory()?"directory":e.isFile()?"file":e.isSymbolicLink()?"shortcut":"other";const s=u[t];return{name:u[t],size:e.size,type:a,path:n?n+"/"+s:s}}),t})),V.get("/api/package/:packageId/file/read",S(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.packageId,n=e.query.path;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const d=await O(a,"bdp",7),c=await m.findOne({_id:s});if(!c)throw[x("700",{details:"This package does not exist"})];if(!c.getPrivilege(d).canView)throw[x("700",{details:"Sorry, you do not have privilege to view the package files."})];const l=c.path,p=n?r.resolve(l,n):l;if(!y(p,l))throw[x("713",{details:"The path to process is invalid."})];if(!await o.pathExists(p))throw[x("713",{details:"The path can not be accessed."})];const u=await o.stat(p);if(!u.isFile())throw[x("713",{details:"The path can not be accessed."})];if(u.size>5e7)throw[x("713",{details:"The file is too large."})];t.sendFile(p)})),V.post("/api/package/:packageId/file/handle",S(async e=>{const t=e.session.passport.user.id,a=e.params.packageId,s=e.query.type,n=e.query.path||"",d=e.body.fileItems;if(!i.Types.ObjectId.isValid(a))throw[x("700")];if(!s||["add","remove","update","move","rename"].indexOf(s)<0)throw[x("713",{details:"Invalid type to handle."})];const c=await O(t,"bdp",7),l=await m.findOne({_id:a});if(!l)throw[x("700",{details:"This package does not exist"})];if(!l.getPrivilege(c).canEdit)throw[x("700",{details:"Sorry, you do not have privilege to handle the package files."})];const p=l.path;if(n.match(/\./))throw[x("713",{details:"This query path is invalid."})];const u=n?r.join(p,n):p;if(!y(u,p))throw[x("713",{details:"The path to process is invalid."})];if(!y(r.resolve(u),r.resolve(p,"scripts"))&&!y(r.resolve(u),r.resolve(p,"client")))throw[x("713",{details:"The path to process is invalid."})];if(!d||0===d.length)throw[x("713",{details:"No file items to create"})];if(r.normalize(u)===r.normalize(p))throw[x("713",{details:"You cannot handle the package root folder."})];const h=[];for(let e=0;e<d.length;e++){const t=d[e],a={name:t.name,size:0,type:t.type,path:n?n+"/"+t.name:t.name};let i=r.join(u,t.name);switch(s){case"add":if("directory"===t.type)await o.ensureDir(i);else{if("file"!==t.type)throw[x("713",{details:"The file type is not supported."})];await o.ensureFile(i)}break;case"rename":const e=t.name,s=/^\.\./;if(e.match(s))throw[x("713",{details:`The filename, ${e}, is not valid.`})];const d=t.path,c=r.join(p,d),l=r.join(r.dirname(c),t.name);if(!y(r.resolve(c),r.resolve(p,"scripts"))&&!y(r.resolve(c),r.resolve(p,"client")))throw[x("713",{details:"The original path is invalid."})];if(!y(r.join(l),r.join(p,"scripts"))&&!y(r.join(l),r.join(p,"client")))throw[x("713",{details:"The new path is invalid."})];if(await o.pathExists(l))throw[x("713",{details:`The new path ${t.name} has been used.`})];try{await o.move(c,l)}catch(e){throw[x("713",{details:`Moving the file, '${t.path}', has errors.`,attached:e})]}const h=await o.stat(l);a.name=e;const g=d.split(/\//);g.pop(),a.path=g.join("/")+"/"+e,a.size=h.size,h.isDirectory()?a.type="directory":h.isFile()?a.type="file":h.isSymbolicLink()?a.type="shortcut":a.type="other";break;case"update":i=r.join(u);break;case"move":const f=r.resolve(p+"/"+t.path);if(!y(f,r.resolve(p,"scripts"))&&!y(f,r.resolve(p,"client")))throw[x("713",{details:`The file path, ${t.path} , is invalid.`})];if(f===r.resolve(p,"scripts")||f===r.resolve(p,"client"))throw[x("713",{details:"You cannot manipulate the Package root elements"})];try{await o.move(f,r.join(u,t.name))}catch(e){throw[x("713",{details:`Failed to move the file ${t.path}.`,attached:e})]}const m=await o.stat(r.join(u,t.name));a.name=t.name,a.path=n?n+"/"+t.name:t.name,a.size=m.size,a.type=v(m);break;case"remove":await o.remove(i)}h.push(a)}return{errors:[],success:h}})),V.post("/api/package/:packageId/file/upload",S(async(e,t)=>{const a=e.session.passport.user.id,s=e.params.packageId,n=e.query.path;if(!i.Types.ObjectId.isValid(s))throw[x("700")];if(!n)throw[x("713",{details:"You cannot upload to the package root folder."})];const d=await O(a,"bdp",7),c=await m.findOne({_id:s});if(!c)throw[x("700",{details:"This package does not exist"})];if(!c.getPrivilege(d).canEdit)throw[x("700",{details:"Sorry, you do not have privilege to upload files to this package."})];const l=c.path,p=r.join(l,n);if(!y(r.join(l,n),l))throw[x("713",{details:"The path to process is invalid."})];if(!y(r.resolve(p),r.resolve(l,"scripts"))&&!y(r.resolve(p),r.resolve(l,"client")))throw[x("713",{details:"The path to process is invalid."})];if(!(await o.stat(p)).isDirectory())throw[x("713",{details:"The path is not a directory."})];try{await C(e,t)}catch(t){for(const t of e.files)await o.unlink(t.path);throw[x("13",{code:13,name:"File upload failed",details:"Please try again.",attached:t})]}const u=e.files[0],h=u.originalname,g=u.path,f=r.join(l,n,h);try{await o.move(g,f,{overwrite:!0})}catch(t){for(const t of e.files)await o.unlink(t.path);throw[x("713",{code:13,name:"File upload failed",details:`The file ${u.originalName} has been uploaded but we failed to move the file to its destinations.`,attached:t})]}const w=await o.stat(f);return{errors:[],success:[{name:h,size:w.size,type:v(w),path:n+"/"+h}]}})),V.get("/api/package/:packageId/file/unzip",S(async e=>{const t=e.session.passport.user.id,a=e.params.packageId,s=e.query.path;if(!i.Types.ObjectId.isValid(a))throw[x("700")];if(!s)throw[x("713",{details:"You cannot upload to the package root folder."})];const n=await O(t,"bdp",7),d=await m.findOne({_id:a});if(!d)throw[x("700",{details:"This package does not exist"})];if(!d.getPrivilege(n).canEdit)throw[x("700",{details:"Sorry, you do not have privilege to unzip files in this package."})];const c=d.path,p=r.resolve(c,s);if(!y(p,r.join(c,"scripts"))&&!y(p,r.join(c,"client")))throw[x("713",{details:"The path to process is invalid."})];if(!await o.pathExists(p))throw[x("713",{details:"The path to process is invalid."})];if(!(await o.stat(p)).isFile())throw[x("713",{details:"The path to process is invalid."})];if(".zip"!==r.extname(p).toLowerCase())throw[x("713",{details:"The path to process is invalid."})];const u=r.dirname(p),h=[];return await o.createReadStream(p).pipe(l.Parse()).on("entry",e=>{const t=e.path;if(t.indexOf("..")>=0)e.autodrain();else{const a=t.indexOf("/"),s=-1===a||a===t.length-1,i=r.join(u,t);"Directory"===e.type?t?o.ensureDir(i,a=>{a&&console.log(a),s&&h.push({name:r.basename(t),size:0,type:"directory",path:t}),e.autodrain()}):e.autodrain():"File"===e.type&&(s?e.pipe(o.createWriteStream(i)).on("finish",()=>{o.stat(i,(e,a)=>{e&&console.log(e),h.push({name:r.basename(t),size:a.size,type:a.isFile()?"file":a.isSymbolicLink()?"shortcut":"other",path:t})})}):e.pipe(o.createWriteStream(i)))}}).promise(),{errors:[],success:h}})),V.get("/api/task/bymap",S(async e=>{const t={errors:[],success:{}},a=e.session.passport.user.id,s={pkg:e.query.pkg,pkgid:e.query.pkgid,key:e.query.key,id:e.query.id,ver:e.query.ver},i=await O(a,"bdp",7),r=await P(s);if(r&&r.package){const e=r.package;if(e.getPrivilege){const a=e.getPrivilege(i);a.canRun?(t.success=r.getModelForViewer(),t.success.package=e.getModel(a)):a.canView&&(t.success=r.getModel(),t.success.package=e.getModel(a))}}return t})),V.post("/api/task/save",S(async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,i=e.body.task;let o="update";if(!i)throw[x("900")];const n=await O(s,"bdp",7);["system","standard","child","workflow"].indexOf(i.type)<0&&(i.type="standard");const d=p(i._key,{condense:!0}),c=await m.findOne({_id:i.package});if(!c)throw[x("900",{details:"Sorry, the package id is not found."})];if(!c.getPrivilege(n).canEdit)throw[x("700",{details:"Sorry, you do not have privilege to edit tasks in this package."})];const l=i.proxy?{enabled:!0,protocol:"http",port:i.proxy.port,ip:i.proxy.ip||"localhost",pathRewrite:!!i.proxy.pathRewrite,entryPath:i.proxy.entryPath||"/"}:null;if(i.id){o="update";const e=await u.findOne({_id:i.id,package:i.package});if(!e)throw[x("900",{details:"Sorry, we cannot find a task of the id: "+i.id})];const t=r.resolve(c.path,"task-index.yaml");if("workflow"!==i.type)if("$SystemFolder/task-portal"===e.script&&"node"===e.exec)if("$SystemFolder/task-portal"===i.script&&"node"===i.exec&&void 0!==i.workflowPlaybook)try{e.key!==d?(await D(t,"delete",e.key),await D(t,"create",d,i.workflowPlaybook)):await D(t,"update",d,i.workflowPlaybook)}catch(e){throw[x("900",{details:e})]}else{if(n.auths.bdp<=8)throw[x("900",{title:"No priviledge!",details:"You are only allowed to define playbook-styled task."})];try{await D(t,"delete",d)}catch(e){throw[x("900",{details:e})]}}else if("$SystemFolder/task-portal"===i.script&&"node"===i.exec&&i.workflowPlaybook)try{await D(t,"create",d,i.workflowPlaybook)}catch(e){throw[x("900",{details:e})]}else if(n.auths.bdp<=8)throw[x("900",{title:"No priviledge!",details:"You are only allowed to define playbook-styled task."})];const s=await u.findByIdAndUpdate(i.id,{name:i.name,type:i.type,desc:i.desc,key:d,img:i.img,thumbnail:i.thumbnail,package:i.package,script:i.script,exec:i.exec,cwd:i.cwd,arguments:i.arguments,encodeArg:!!i.encodeArg,mapper:i.mapper,stepNames:Array.isArray(i.stepNames)?i.stepNames.map(e=>e.slice(0,60)):[],version:i.version,proxy:l||null},{new:!0});a.success=s.getModel(i.workflowPlaybook)}else{o="insert";const e=await u.findOne({key:d,package:c.id});if(e)throw[x("900",{details:`The task key, ${d}, was already used for the task named <b>${e.name}</b>.`})];const t=new u({name:i.name,type:i.type,desc:i.desc,img:i.img,thumbnail:i.thumbnail,key:d,package:c.id,script:i.script,exec:i.exec,cwd:i.cwd,arguments:i.arguments,encodeArg:!!i.encodeArg,mapper:i.mapper,stepNames:Array.isArray(i.stepNames)?i.stepNames.map(e=>e.slice(0,60)):[],version:i.version,proxy:l||null});if("workflow"!==i.type&&"$SystemFolder/task-portal"===i.script&&"node"===i.exec){const e=i.workflowPlaybook;if(!e)throw[x("900",{details:"Please specify the playbook for this task."})];if(c.path){const t=c.path+"/task-index.yaml";try{await D(t,"create",d,e)}catch(e){throw[x("900",{details:e})]}}}else if(n.auths.bdp<=8&&"workflow"!==i.type)throw[x("900",{title:"No priviledge!",details:"You are only allowed to use playbook-styled task."})];const s=await t.save();a.success=s.getModel(i.workflowPlaybook||void 0)}t.json(a);const h=(await f.find({})).map(e=>e._id.toString());T(h,"dataChange",{type:o,target:"Task",data:a.success}),A(c)})),V.post("/api/task/:taskId/validInputs",S(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.taskId,r=e.body.projectID;if(!i.Types.ObjectId.isValid(r))throw[x("19",{details:"We can not find the project id: "+r+". please check if this is the right ID."})];if(!i.Types.ObjectId.isValid(a))throw[x("23")];if(!i.Types.ObjectId.isValid(s))throw[x("31")];const o=await O(a,"bdp",2),n=await u.findOne({_id:s});if(!n)throw[x("31")];if(!(await m.findOne({_id:n.package})).getPrivilege(o).canRun)throw[x("700",{details:"Sorry, you do not have privilege to handle the package files."})];const d=n.arguments,c=[];if(0===d.length)return t.success=[],t;const l=await h.findOne({_id:r});if(!l)throw[x("19",{details:"We can not find the project id: "+r+". please check if this is the right ID."})];if(!l.getPrivilege(o).canRun)throw[x("38",{details:"Sorry, you do not have privileges to view valid inputs in this project."})];for(let e=0;e<d.length;e++){const t=d[e],a=t.type,s=t.tags;if("inFile"===a){const a={};"or"===t.tagMatchRule?a.$in=s:("and"===t.tagMatchRule||"all"===t.tagMatchRule)&&(a.$all=s);const i=await g.find({project:r,tags:a}).sort({updatedAt:-1});i&&i.length>0?c.push({index:e,models:i.filter(e=>("all"!==t.tagMatchRule||e.tags.length===t.tags.length)&&1===e.status).map(e=>e.getModel())}):c.push({index:e,models:[]})}}return t.success=c,t})),V.get("/api/task/list",S(async e=>{const t={errors:[],success:[]};let a="";e.query.package?a=e.query.package:e.query.packages&&(a=e.query.packages);const s=e.query.only,i=e.session.passport.user.id,r=await f.findOne({_id:i});if(!r)throw[x("23")];const o=r.auths.bdp;if(!a)return t;if(a=a.split(","),!Array.isArray(a))return t;const n=await m.find({_id:{$in:a}}),d=n.map(e=>e.id),c=n.map(e=>e.getPrivilege(r)),l=n.filter((e,t)=>c[t].canView||c[t].canRun),p=l.map(e=>e.name.split("-").slice(0,-1).join("-"));p.push("all","utility");const h=await m.find({scope:{$in:p}});a=l.map(e=>e.id);for(const e of h)e.scope.indexOf("admin")>=0?o>=8&&a.push(e.id):a.push(e.id);const g={package:l.map(e=>e.id)};s||(g.package={$in:a}),o<8&&(g.type={$ne:"system"});const w=await u.find(g);return t.success=w.map(e=>{const t=d.indexOf(e.package.toString());if(t<0)return null;const a=c[t];return a&&a.canView?e.getModel():e.getModelForViewer()}).filter(e=>null!==e),t})),V.delete("/api/task/:taskId",S(async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,o=e.params.taskId;if(!i.Types.ObjectId.isValid(o))throw[x("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const n=await O(s,"bdp",7),d=await u.findOne({_id:o}).populate("package");if(!d)throw[x("903",{details:"The task you request does not exist."})];if(!d.package||!d.package.getPrivilege)throw[x("903",{details:"The task belongs to no packages."})];if(!d.package.getPrivilege(n).canEdit)throw[x("903",{details:"Sorry, you do not have privileges to delete tasks in this package."})];const c=r.resolve(d.package.path,"task-index.yaml");try{await D(c,"delete",d.key)}catch(e){console.log(e)}await d.remove();const l=d.getModel();l.package=l.package.id,a.success=l,t.json(a);const p=(await f.find({})).map(e=>e._id.toString());T(p,"dataChange",{type:"delete",target:"Task",data:a.success}),A(d.package)})),V.get("/api/task/:taskId/playbook",S(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.taskId;if(!i.Types.ObjectId.isValid(s))throw[x("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const o=await O(a,"bdp",7),n=await u.findOne({_id:s}).populate("package");if(!n.package.getPrivilege(o).canView)throw[x("903",{details:"Sorry, you do not have privileges to view the playbook content."})];const d=r.resolve(n.package.path,"./task-index.yaml"),c=n.key;try{t.success=await D(d,"read",c)}catch(e){t.success=""}return t})),V.get("/api/task/:taskId/getRuntime",S(async e=>{const t=e.session.passport.user.id,a=e.params.taskId;if(!i.Types.ObjectId.isValid(a))throw[x("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const s=await O(t,"bdp",7),n=await u.findOne({_id:a}).populate("package"),d=n.key;if(!n.package||!n.package.path)throw[x("905",{details:"The runtime config cannot be accessed."})];if(!n.package.getPrivilege(s).canView)throw[x("903",{details:"Sorry, you do not have privileges to view the runtime config of this task."})];const c=r.resolve(n.package.path,"configs","package-config.json");if(!await o.pathExists(c))return{errors:[],success:{}};const l=await o.readJson(c,{throws:!1});if(!l||!l.default)throw[x("905",{details:"Please first set the runtime configs of package default."})];return{errors:[],success:l[d]||l.default}})),V.post("/api/task/:taskId/saveRuntime",S(async e=>{const t=e.session.passport.user.id,a=e.params.taskId,s=!!e.body.reset,n=e.body.runtime||null;if(!i.Types.ObjectId.isValid(a))throw[x("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const d=await O(t,"bdp",7),c=await u.findOne({_id:a}).populate("package");if(!c||!c.package||!c.package.path)throw[x("905",{details:"The runtime config cannot be accessed."})];const l=c.key;if(!c.package.getPrivilege(d).canEdit)throw[x("903",{details:"Sorry, you do not have privileges to edit the runtime config of this task."})];const p=r.resolve(c.package.path,"configs","package-config.json"),h=await o.readJson(p,{throws:!1});if(!h||!h.default)throw[x("905",{details:"Please first set the runtime configs of package default."})];if(s||!n)return delete h[l],await o.writeJSON(p,h),{errors:[],success:{}};h[l]=n;let g=isNaN(parseFloat(n.cpus))?1:parseFloat(n.cpus);g=g>0?g:1;let f=n._memory||"4gb";f=f.toLowerCase().match(/^(\d+[mg])/),f=f?f[1]+"b":"4gb";const m=isNaN(parseInt(n.concurrency))?1:parseInt(n.concurrency),w=isNaN(parseInt(n.nodes))?1:parseInt(n.nodes),y=n.dockerPath||j,k=isNaN(parseInt(n.updateInterval))?2e4:parseInt(n.updateInterval);if(h[l]=Object.assign({},{adapter:n.adapter,batch:!!n.batch,updateInterval:k,cpus:g,mem:f,concurrency:m,nodes:w,dockerPath:y,debug:n.debug},n.overrides),9!==d.auths.bdp&&"local"===h[l].adapter)throw[x("905",{details:"Only the admin can specify the local adapter."})];return await o.writeJSON(p,h),{errors:[],success:h[l]}})),V}},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("unzipper")},function(e,t,a){const s=a(3),i=a(0),r=a(10),o=a(6),n=a(2),d=a(7),c=a(1);e.exports=function(e){const t=e.helpers,a=e.chiConfig.serverConfig,l=t.chiAsyncWrap,p=t.getAuthAsync,u=t.getCode,h=t.socketBroadcast,g=s.Router();return g.get("/api/:packageId/*",l(async(e,t)=>{const s=0===a.site_domain.indexOf("https://"),o=e.params.packageId;if(!i.Types.ObjectId.isValid(o))throw[u("700")];const l=await r.findOne({_id:o});if(!l)throw[u("700",{details:"This package does not exist"})];if(s){if(!e.isAuthenticated())throw[u("a011")];const t=e.session.passport.user.id,a=await p(t,"bdp",2);if(!l.getPrivilege(a).canRun)throw[u("700",{details:"Sorry, you do not have privileges to view this entry page."})]}const h=l.path,g=c.normalize(e.path.replace("/api/"+o,h+"/client"));if(d(g,h)){if(await n.pathExists(g)){if((await n.stat(g)).isFile())return void t.sendFile(g)}}const f=c.normalize(e.path.replace("/api/"+o,c.resolve(process.env.BDP_SYSTEM_FOLDER,"public")));if(d(f,c.resolve(process.env.BDP_SYSTEM_FOLDER,"public"))){if(await n.pathExists(f)){if((await n.stat(f)).isFile())return void t.sendFile(f)}}return t.redirect("/assets/pages/not-found.html"),!1})),g.all("/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(u("a011")),t.json(s);a()}),g.post("/api/pages/save",l(async e=>{const t={errors:[]},a=e.session.passport.user.id,s=await p(a,"bdp",7),n=e.body.package;if(!i.Types.ObjectId.isValid(n.id))throw[u("714")];const d=await r.findOne({_id:n.id});if(!d)throw[u("714")];if(!d.getPrivilege(s).canEdit)throw[u("714",{details:"Sorry, you have no privileges to edit the entry pages."})];const c=n.pages;if(!Array.isArray(c.indexPages)||!Array.isArray(c.resultPages)||!Array.isArray(c.filePages))throw[u("714")];let l="indexPages";const g=function(e){return{name:e.name||"unnamed",desc:e.desc||"(no description)",path:e.path||"/assets/pages/index.html",key:e.key||"",img:e.img||"",thumbnail:e.thumbnail||"",tasks:"resultPages"!==l?void 0:Array.isArray(e.tasks)?e.tasks.map(e=>e.toString()):[],tags:"filePages"!==l?void 0:Array.isArray(e.tags)?e.tags.map(e=>e.toString()):[],rule:"filePages"!==l?void 0:["or","and","all"].indexOf(e.rule)>=0?e.rule:"or",format:"filePages"!==l?void 0:e.format||""}};c.indexPages=c.indexPages.map(g),l="resultPages",c.resultPages=c.resultPages.map(g),l="filePages",c.filePages=c.filePages.map(g),d.pages=c;const f=await d.save(),m=f.getModel(f.getPrivilege(s)),w=(await o.find({"auths.bdp":{$gte:8}})).map(e=>e._id.toString());return h(w,"dataChange",{type:"update",target:"Package",data:m}),t.success=m,t})),g.get("/api/list",l(async e=>{const t={errors:[],success:[]},a=e.session.passport.user.id,s=await p(a,"bdp",2),o=e.query.only,n=e.query.package;if(!i.Types.ObjectId.isValid(n))throw[u("700")];const d=await r.findOne({_id:n});if(!d)throw[u("700",{details:"This package does not exist"})];const c=d.getPrivilege(s),l=d.name.split("-").slice(0,-1).join("-");if(!c.canView&&!c.canRun)return t;const h=s.auths.bdp,g=await r.find({scope:{$in:[l,"all","utility"]}}),f=[d.id];for(const e of g)e.scope.indexOf("admin")>=0?h>=8&&f.push(e.id):f.push(e.id);const m={_id:[d.id]};o||(m._id={$in:f});const w=await r.find(m);return t.success=w.map(e=>e.getModel(e.getPrivilege(s))),t})),g}},function(e,t,a){const s=a(3),i=a(82),r=a(83),o=a(25).spawnProcessAsync,n=["@big-data-processor/utilities","@big-data-processor/task-reader","@hapi/iron","archiver","babel-runtime","body-parser","compression","connect-mongo","content-disposition","cookie-parser","cors","dashify","detect-port","express","express-session","express-status-monitor","filenamify","find-package-json","fluent-ffmpeg","fs-extra","globby","googleapis","greenlock-express","helmet","http-proxy","js-yaml","mime-types","mongoose","morgan","multer","natural-orderby","nodemailer","passport","passport-google-oauth20","passport-local","path-is-inside","request","sanitize-filename","serve-index","socket.io","socket.io-redis","unzipper","uuid"];e.exports=function(e){const t=e.chiConfig,a=e.io,d=e.helpers,c=d.chiAsyncWrap,l=d.getCode,p=d.viewNpmPkg,u=d.getAuthAsync,h=s.Router();h.get("/api/info",c(async(e,a)=>{a.json({errors:[],success:{admin_email:t.serverConfig.admin_email,reCaptchaSiteKey:t.reCaptcha?t.reCaptcha.reCaptchaSiteKey:void 0,dropboxKey:t.Dropbox?t.Dropbox.appKey:void 0,googleClientID:t.GoogleAuth?t.GoogleAuth.clientID:void 0,googlePickerAPIKey:t.GooglePicker&&t.GooglePicker.apiKey?t.GooglePicker.apiKey:void 0,home:t.home?t.home:{},fileLimits:t.system.fileLimits.toString()}})})),h.all("/api/*",(e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(l("a011")),t.json(s);a()}),h.get("/api/npmpkg/list",c(async e=>{const t={errors:[],success:{}},a=e.session.passport.user.id;await u(a,"base",9);const s=i(process.env.BDP_SYSTEM_FOLDER).next().value||null;return t.success=s&&s.dependencies?s.dependencies:{},t})),h.get("/api/module/list",c(async e=>{const t={errors:[],success:{}},a=e.session.passport.user.id;await u(a,"bdp",7);let s=await r.findOne({name:"big-data-processor"});return s||(s=new r({name:"big-data-processor",modules:[]}),await s.save()),t.success=s.getModel().modules,t})),h.get("/api/npmpkg/view",c(async e=>{const t={errors:[],success:{}},a=e.query.pkgName,s=e.query.pkgVersion,i=e.session.passport.user.id;if(await u(i,"base",9),t.success=await p(a,s),!t.success.pkgInfo)throw[l("s004",{details:`We cannot find the npm package (${a}).`})];return t}));const g=async function(e,t,s){const i={stdout:"",stderr:""},r=function(s,r){i[s]+=r,a.to(e).emit("packageOut",{type:"stdout"===s?"stdOut":"stdErr",target:t,data:i[s]})};let n=0;try{n=0===(await o("npm",["install","--save",`${t}@${s}`],"install-npm-pkg",{mode:"memory"},r)).exitCode?2:1}catch(e){console.log(e),n=1}return{stdout:i.stdout,stderr:i.stderr,status:n}};h.get("/api/npmpkg/install",c(async(e,t)=>{const s={errors:[],success:{}},i=e.query.pkgName,o=e.query.pkgVersion,d=e.session.passport.user.id;await u(d,"base",9);const c=await p(i,o);if(!c.pkgInfo)throw[l("s004",{details:`We cannot find the npm package (${i}).`})];if("@big-data-processor/task-reader"!==i&&n.indexOf(i)>=0)throw[l("s004",{details:`The npm package ${i} is required. You cannot install it.`})];let h="npm";if(c.bdp){const e=c.bdp.type;"adapter"===e?h="adapter":"filter"===e&&(h="filter")}n.indexOf(i)>=0&&(h="system");let f=await r.findOne({name:"big-data-processor"});f||(f=new r({name:"big-data-processor",modules:[]}));let m=-1;for(let e=0;e<f.modules.length;e++){if(f.modules[e].pkgName===i){m=e;break}}if(m<0)f.modules.push({name:c.bdp?c.bdp.name:c.pkgInfo.name,pkgName:i,moduleType:h,author:c.pkgInfo.author,email:c.pkgInfo.email,desc:c.pkgInfo.description,version:c.pkgInfo.version,status:0,stdout:"",stderr:""}),m=f.modules.length-1;else{const e=f.modules[m];e.name=c.bdp?c.bdp.name:c.pkgInfo.name,e.moduleType=h,e.author=c.pkgInfo.author,e.email=c.pkgInfo.email,e.desc=c.pkgInfo.description,e.status=0,e.stdout="",e.stderr=""}const w=await f.save();s.success=w.getModel(),a.to(d).emit("dataChange",{type:"module",target:"System",data:s.success.modules}),t.json(s);const y=await g(d,i,c.pkgInfo.version);try{const e=f.modules[m];e.name=c.bdp?c.bdp.name:c.pkgInfo.name,e.version=c.pkgInfo.version,e.moduleType=h,e.author=c.pkgInfo.author,e.email=c.pkgInfo.email,e.desc=c.pkgInfo.description,e.status=y.status,e.stdout=y.stdout,e.stderr=y.stderr;const t=await f.save();a.to(d).emit("dataChange",{type:"module",target:"System",data:t.getModel().modules})}catch(e){console.log(e)}})),h.get("/api/npmpkg/uninstall",c(async(e,t)=>{const s={errors:[],success:{}},d=e.query.pkgName,c=e.session.passport.user.id;if(await u(c,"base",9),n.indexOf(d)>=0)throw[l("s004",{details:`The npm package ${d} is required. You cannot uninstall it.`})];const p=i(__dirname).next().value||null,h=p&&p.dependencies?p.dependencies:{};let g=await r.findOne({name:"big-data-processor"});if(g){let e=-1;for(let t=0;t<g.modules.length;t++){if(g.modules[t].pkgName===d){e=t;break}}e>=0&&(h[d]?g.modules[e].status=3:g.modules.splice(e,1))}else g=new r({name:"big-data-processor",modules:[]});const f=await g.save();if(s.success=f.getModel(),t.json(s),!h[d])return;const m={stdout:"",stderr:""},w=function(e,t){m[e]+=t,a.to(c).emit("packageOut",{type:"stdout"===e?"stdOut":"stdErr",target:d,data:m[e]})};let y=!1;try{if(0===(await o("npm",["uninstall","--save",""+d],"uninstall-npm-pkg",{mode:"default"},w)).exitCode)for(let e=0;e<g.modules.length;e++){if(g.modules[e].pkgName===d){g.modules.splice(e,1);break}}else y=!0}catch(e){y=!0}if(y)for(let e=0;e<g.modules.length;e++){if(g.modules[e].pkgName===d){g.modules[e].status=1,g.modules[e].stdout=m.stdout,g.modules[e].stderr=m.stderr;break}}const k=await g.save();a.to(c).emit("dataChange",{type:"module",target:"System",data:k.getModel().modules})}));let f=!1;return h.get("/api/npmpkg/restore",c(async(e,t)=>{const s={errors:[],success:{}},o=e.session.passport.user.id;await u(o,"base",9);const n=(i(process.env.BDP_SYSTEM_FOLDER).next().value||null).dependencies||{};let d=await r.findOne({name:"big-data-processor"});d||(d=new r({name:"big-data-processor",modules:[]}));const c=await d.save();s.success=c.getModel(),t.json(s);const l=c.modules,p=[];if(f)a.to(o).emit("message",{code:"s004",name:"The package restoring is processing",type:"warning",details:"Please wait while we are reinstalling your packages."});else{f=!0;for(let e=0;e<l.length;e++){const t=l[e],s=t.pkgName;if(!n[s]){t.status=0,a.to(o).emit("dataChange",{type:"module",target:"System",data:d.getModel().modules}),await d.save();const e=await g(o,s,t.version);t.status=e.status,t.stdout=e.stdout,t.stderr=e.stderr,1===t.status&&p.push(t),await d.save(),a.to(o).emit("dataChange",{type:"module",target:"System",data:d.getModel().modules})}}a.to(o).emit("message",{code:"s004",name:p.length>0?"Failed to install some packages":"Finished restoring installed packages",type:p.length>0?"error":"success",details:p.length>0?"Several npm packages were failed to install: "+p.map(e=>e.pkgName).join(", "):"All previous installed packages were restored."}),f=!1}})),h}},function(e,t){e.exports=require("find-package-json")},function(e,t,a){const s=a(0),i=a(84),r=s.model("SystemInfo",i);e.exports=r},function(e,t,a){const s=new(0,a(0).Schema)({name:{type:String,unique:!0},modules:[{name:String,pkgName:String,moduleType:String,author:String,email:String,desc:String,version:String,status:Number,stdout:String,stderr:String}]},{timestamps:!0});s.methods.getModel=function(){return{modules:this.modules.map(e=>({name:e.name,pkgName:e.pkgName,moduleType:e.moduleType,author:e.author,email:e.email,desc:e.desc,version:e.version,status:e.status,stdout:e.stdout,stderr:e.stderr}))}},e.exports=s}]));
//# sourceMappingURL=big-data-processor.js.map